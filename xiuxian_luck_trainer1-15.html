<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹æ°£è¨“ç·´å·¥å…· V9-0ï¼ˆä¿®ä»™ç¶²é ç‰ˆï¼‰</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #545b62;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gold-color: #DAA520;
            --teal-color: #20c997;
            --purple-color: #6f42c1;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #app-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            text-align: center;
            margin-top: 0;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: var(--primary-color);
            color: white;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤è¡Œå‹•è£ç½®é»æ“Šé«˜äº® */
        }
        button:hover {
            background-color: var(--primary-hover);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #b22a38; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }


        .info-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .info-section p {
            margin: 6px 0;
        }

        progress {
            width: 100%;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            border: none;
        }
        progress::-webkit-progress-bar {
            background-color: #e9ecef;
        }
        progress::-webkit-progress-value {
            background-color: var(--success-color);
            transition: width 0.5s ease-in-out;
        }
        progress::-moz-progress-bar {
            background-color: var(--success-color);
        }

        .game-grid {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .grid-btn {
            width: 100%;
            height: 60px;
            font-size: 24px;
            padding: 0;
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid #ccc;
        }
        .grid-btn:hover {
            background-color: #e2e6ea;
        }
        .grid-btn.selected {
            border-color: var(--primary-color);
            background-color: #e0f7fa;
            box-shadow: 0 0 5px var(--primary-color);
        }
        .grid-btn.hint-correct {
            border: 2px solid var(--gold-color);
            background-color: #fff7d6;
        }
        .grid-btn.hint-wrong {
            border: 2px solid var(--danger-color);
            background-color: #ffe6e6;
        }
        .grid-btn.checked {
            background-color: #d1ecf1;
            border-color: var(--info-color);
        }


        .feedback {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .feedback.success { color: var(--success-color); }
        .feedback.error { color: var(--danger-color); }
        .feedback.info { color: var(--info-color); }
        
        .message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .msg-daily { color: #004085; background-color: #cce5ff; border: 1px solid #b8daff; }
        .msg-shop { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .msg-shop-fail { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .msg-levelup { color: var(--purple-color); font-weight: bold; }
        .msg-reward { color: var(--gold-color); font-weight: bold; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-item-row label { flex-grow: 1; }
        .modal-item-row input[type="number"] {
            width: 70px;
            padding: 5px;
            text-align: right;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .modal-footer {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: #000; }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="app"></div>
    </div>

    <!-- Modal Template -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="close-btn" id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>

<script>
// =================================================================================
// é‹æ°£è¨“ç·´å·¥å…· V9-0 - JavaScript é›¢ç·šç¶²é ç‰ˆ
// ä½œè€…ï¼šGemini (ç§»æ¤è‡ªä½¿ç”¨è€…æä¾›çš„ Python è…³æœ¬)
// ç‰ˆæœ¬ï¼š1.2 - ä¿®æ­£è¨“ç·´æ¨¡å¼ä¸­ç­”æ¡ˆä½ç½®è¦å¾‹æ’åˆ—çš„å•é¡Œï¼Œå¯¦ç¾çœŸæ­£éš¨æ©Ÿã€‚
// =================================================================================

document.addEventListener('DOMContentLoaded', () => {

// ===================== éŠæˆ²æ ¸å¿ƒè¨­å®šèˆ‡æ•¸æ“š (ä¾†è‡ª Python) =====================
const SCORE_FILE = "max_scores"; // localStorage key
const STATS_FILE = "training_stats"; // localStorage key

const DIFFICULTY_WIN_RATE = {1:90, 2:80, 3:65, 4:50, 5:35, 6:25, 7:15, 8:10, 9:7, 10:5};
const REDEEM_1_COST = 50;
const REDEEM_5_COST = 200;
const STONE_EXCHANGE_COST = 100;

const TRAINING_MILESTONES = {
    5: {"rewards": 1, "title": "1.å®—é–€çš„åŸºçŸ³"}, 10: {"rewards": 1, "title": "2.è¦‹ç¿’å¼Ÿå­"}, 25: {"rewards": 2, "title": "3.å¤–é–€é›œå½¹"}, 50: {"rewards": 2, "title": "4.å¤–é–€å¼Ÿå­"}, 75: {"rewards": 3, "title": "5.å¤–é–€å¸«å…„"}, 100: {"rewards": 5, "title": "6.å¤–é–€èè‹±"}, 150: {"rewards": 3, "title": "7.å…§é–€å€™è£œ"}, 200: {"rewards": 4, "title": "8.å…§é–€å¼Ÿå­"}, 300: {"rewards": 5, "title": "9.å…§é–€å¸«å…„"}, 400: {"rewards": 5, "title": "10.å…§é–€èè‹±"}, 500: {"rewards": 10, "title": "11.å®—é–€åŸ·äº‹"}, 600: {"rewards": 5, "title": "12.ä»»å‹™å ‚å¼Ÿå­"}, 700: {"rewards": 5, "title": "13.å‚³æ³•å ‚å¼Ÿå­"}, 800: {"rewards": 5, "title": "14.ç…‰ä¸¹é–£å¼Ÿå­"}, 900: {"rewards": 5, "title": "15.ç…‰å™¨åŠå¼Ÿå­"}, 1000: {"rewards": 15, "title": "16.è¦ªå‚³å¼Ÿå­"}, 1200: {"rewards": 6, "title": "17.æˆ’å¾‹å ‚åŸ·äº‹"}, 1400: {"rewards": 6, "title": "18.è—ç¶“é–£åŸ·äº‹"}, 1600: {"rewards": 6, "title": "19.ç™¾è‰åœ’ç®¡äº‹"}, 1800: {"rewards": 6, "title": "20.è¬ç¸å±±ç®¡äº‹"}, 2000: {"rewards": 20, "title": "21.é¦–å¸­å¤§å¼Ÿå­"}, 2500: {"rewards": 10, "title": "22.ä»»å‹™å ‚é•·è€"}, 3000: {"rewards": 10, "title": "23.å‚³æ³•å ‚é•·è€"}, 3500: {"rewards": 10, "title": "24.ç…‰ä¸¹é–£é•·è€"}, 4000: {"rewards": 10, "title": "25.ç…‰å™¨åŠé•·è€"}, 5000: {"rewards": 25, "title": "26.å®—é–€é•·è€"}, 6000: {"rewards": 12, "title": "27.åˆ‘æ³•é•·è€"}, 7000: {"rewards": 12, "title": "28.å‚³åŠŸé•·è€"}, 8000: {"rewards": 12, "title": "29.å®¢å¿é•·è€"}, 9000: {"rewards": 12, "title": "30.å·¡å±±é•·è€"}, 10000: {"rewards": 30, "title": "31.å®—é–€è­·æ³•"}, 12500: {"rewards": 15, "title": "32.ä¸¹é“å³°ä¸»"}, 15000: {"rewards": 15, "title": "33.å™¨é“å³°ä¸»"}, 17500: {"rewards": 15, "title": "34.åŠé“å³°ä¸»"}, 20000: {"rewards": 40, "title": "35.å¤ªä¸Šé•·è€"}, 25000: {"rewards": 20, "title": "36.å®—é–€è–å­"}, 30000: {"rewards": 20, "title": "37.å®—é–€è–å¥³"}, 35000: {"rewards": 20, "title": "38.è¡Œèµ°çš„å‚³èªª"}, 40000: {"rewards": 20, "title": "39.è­·é“äºº"}, 50000: {"rewards": 50, "title": "40.ä»£å®—ä¸»"}, 60000: {"rewards": 25, "title": "41.é®æ´¾è€ç¥–"}, 70000: {"rewards": 25, "title": "42.é–‹æ´¾ç¥–å¸«"}, 80000: {"rewards": 25, "title": "43.æ¸¡åŠ«çœŸä»™"}, 90000: {"rewards": 25, "title": "44.é£›å‡ä¹‹äºº"}, 100000: {"rewards": 100, "title": "45.äººé–“ä¹‹ç¥"}, 120000: {"rewards": 50, "title": "46.å¤©ç•Œè¡Œè€…"}, 140000: {"rewards": 50, "title": "47.æ˜Ÿç•ŒéŠç¥"}, 160000: {"rewards": 50, "title": "48.ä½é¢ä¹‹ä¸»"}, 180000: {"rewards": 50, "title": "49.æ™‚ç©ºæ—…è€…"}, 200000: {"rewards": 100, "title": "50.è¬å¤å‚³èªª"}, 250000: {"rewards": 100, "title": "51.å› æœä¹‹æ‰‹"}, 300000: {"rewards": 100, "title": "52.å‘½é‹ç·¨ç¹”è€…"}, 400000: {"rewards": 100, "title": "53è¦å‰‡åˆ¶å®šè€…"}, 500000: {"rewards": 100, "title": "54.å¤§é“ä¹‹æº"}, 1000000: {"rewards": 500, "title": "55.çµ‚æ¥µé€ ç‰©ä¸»"},
};

const CULTIVATION_STAGES = (() => {
    let stages = [[0, 0, "å‡¡äººåˆå…¥é“"]];
    const LEVELS_PER_STAGE = 10;
    const score_cycle = Object.values(DIFFICULTY_WIN_RATE);
    let base_need_exp = 0;
    let need_step = 10;
    const stage_names = ["1.å‡¡äºº", "2.ç·´æ°£", "3.ç¯‰åŸº", "4.çµä¸¹", "5.å…ƒå¬°", "6.åŒ–ç¥", "7.ç…‰è™›", "8.åˆé«”", "9.å¤§ä¹˜", "10.æ¸¡åŠ«", "11.çœŸä»™", "12.é‡‘ä»™", "13.å¤ªä¹™é‡‘ä»™", "14.å¤§ç¾…é‡‘ä»™", "15.æ··å…ƒå¤§ç¾…", "16.ä»™ç‹", "17.ä»™å¸", "18.å¤©å°Š", "19.ç¥–ä»™", "20.ç„¡ä¸Š", "21.è¶…è„«è¼ªè¿´", "22.ç„¡ä¸Šæ¥µå¢ƒ", "23.æ··æ²Œç„¡æ¥µ", "24.å¤§é“æ­¸ä¸€", "25.å®‡å®™ä¹‹ä¸»", "26.å‰µä¸–çœŸç¥", "27.ç•Œå¤–å¤©å°Š", "28.æ··å…ƒé“å°Š", "29.å§‹æºå¸å°Š", "30.å¤ªåˆè–çš‡", "31.æ°¸æ†ä¹‹ç¥", "32.æ··æ²Œä¸»å®°", "33.è¬é“æ­¸å®—", "34.çµ‚æ¥µé€ ç‰©ä¸»", "35.ç„¡é™æ°¸å­˜è€…", "36.è¶…ç¶­è§€å¯Ÿè€…", "37.è¶…è¶Šè€…", "38.çœŸç†åŒ–èº«", "39.è™›ç„¡ä¹‹ç¥", "40.ç•Œä¸Šç•Œä¸»", "41.å”¯ä¸€çœŸç¥","42.å¤ªä¸Šé“ç¥–","43.æ°¸åŠ«ä¸æœ½","44.ç„¡æ¥µæœ¬æº","45.å¤šå…ƒå½¼å²¸ä¸»","46.åŸåˆæ„å¿—", "47.è¬ç•Œå§‹ç¥–","48.çµ‚ç„‰å‰µä¸–è€…","49.çµ•å°çœŸç†","50.è¶…è¶Šå”¯ä¸€","51.æ°¸æ†ç‹åº§"];
    stage_names.forEach(stage => {
        for (let sub = 1; sub <= LEVELS_PER_STAGE; sub++) {
            base_need_exp += need_step;
            const need_score = score_cycle[stages.length % score_cycle.length];
            stages.push([base_need_exp, need_score, `${stage}${sub}å±¤`]);
        }
        need_step = Math.max(need_step + 1, Math.floor(need_step * 1.5));
    });
    return stages;
})();

const GRADE_NAMES = ["å…¥å“", "ä¸‹å“", "ä¸­å“", "ä¸Šå“", "æ¥µå“", "è¶…å“", "çµ•å“", "å¯¶å“", "åœ°å“", "å¤©å“"];
const ITEM_TYPE_ORDER = ['å…µå™¨', 'åŠŸæ³•', 'é™£æ³•', 'ä»™ä¸¹', 'éˆå™¨', 'éˆç¬¦'];

const WEAPONS = {
    "å…¥å“é’ç«¹åŠ": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"}, "å…¥å“éŠ…èƒŒåˆ€": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"}, "å…¥å“ç¢é›²æ§": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸‹å“å¯’é‹’åŠ": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸‹å“è£‚çŸ³åˆ€": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸‹å“æ¸¸é¾æ§": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸­å“é’éœœåŠ": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸­å“èµ¤ç„°åˆ€": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸­å“éœ†ç½¡æ§": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸Šå“æµå…‰åŠ": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸Šå“è’¼é¯¨åˆ€": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸Šå“ç ´è»æ§": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"},
    "æ¥µå“é›¢ç«é£›åŠ": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"}, "æ¥µå“ç„å†¥é¬¼åˆ€": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"}, "æ¥µå“ç´«é›»ç¥æ§": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"},
    "è¶…å“å¤ªè™›åŠèƒš": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"}, "è¶…å“ç„¡ç›¸åˆ€èƒ": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"}, "è¶…å“å¤©ç½¡æ§é­‚": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"},
    "çµ•å“å¤ªç™½æ˜ŸåŠ": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"}, "çµ•å“ç„æ­¦é®æµ·åˆ€": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"}, "çµ•å“é’é¾é©šé›·æ§": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"},
    "å¯¶å“æ‡¸å¤©é£›ä»™åŠ": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¯¶å“ç ´ç•Œéé‡‘æ§": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"},
    "åœ°å“å´‘å´™æ–¬é‚ªåŠ": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"}, "åœ°å“åšåœŸé®å²³åˆ€": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"}, "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"},
    "å¤©å“å¤ªæ¸…èª…ä»™åŠ": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¤©å“å¤©é“å¯©åˆ‘åˆ€": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¤©å“ä¹¾å¤å®šæµ·æ§": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"},
};
const TECHNIQUES = {
    "å…¥å“ç¯‰åŸºåç´è¨£": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "é¡¯ç¾1å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å…¥å“æ¾é¹¤é•·é’åŠŸ": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "é¡¯ç¾1å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸‹å“å°å‘¨å¤©è¡Œæ°£": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "é¡¯ç¾2å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "é¡¯ç¾2å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸­å“ç„æ¯æ­¸ä¸€è¨£": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "é¡¯ç¾3å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "é¡¯ç¾3å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "é¡¯ç¾4å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸Šå“ç´«åºœé‚„çœŸç¶“": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "é¡¯ç¾4å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "æ¥µå“å¤ªé™°ç…‰æœˆç¶“": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "é¡¯ç¾5å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "æ¥µå“é›¢ç«å†¥é›·ç¶“": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "é¡¯ç¾5å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "é¡¯ç¾6å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "è¶…å“ç„¡ç›¸ç„åŠŸ": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "é¡¯ç¾6å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "çµ•å“ä¹è½‰é‡‘èº«è¨£": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "é¡¯ç¾7å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "çµ•å“äº”é›·æ­£æ³•": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "é¡¯ç¾7å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å¯¶å“æ´å¤©é€ åŒ–ç¶“": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "é¡¯ç¾8å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "é¡¯ç¾8å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "åœ°å“åœ°è—å†¥å¿ƒç¶“": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "é¡¯ç¾9å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "åœ°å“åšåœŸç„¡ç–†è¨£": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "é¡¯ç¾9å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å¤©å“å¤§é“æ··å…ƒè—": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "é¡¯ç¾10å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¤©å“ç„¡æ¥µæœ¬æºç¶“": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "é¡¯ç¾10å€‹éŒ¯èª¤ç­”æ¡ˆ"},
};
const FORMATIONS = {
    "å…¥å“ä¸‰æ‰èšéˆé™£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "å¢åŠ 1ç§’ä½œç­”æ™‚é–“"}, "å…¥å“å››é–€é™·æ•µé™£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "å¢åŠ 1ç§’ä½œç­”æ™‚é–“"},
    "ä¸‹å“äº”è¡Œè­·å±±é™£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "å¢åŠ 2ç§’ä½œç­”æ™‚é–“"}, "ä¸‹å“å…­ç”²è¿·è¸ªé™£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "å¢åŠ 2ç§’ä½œç­”æ™‚é–“"},
    "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "å¢åŠ 3ç§’ä½œç­”æ™‚é–“"}, "ä¸­å“å…«é–€é‡‘é–é™£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "å¢åŠ 3ç§’ä½œç­”æ™‚é–“"},
    "ä¸Šå“ä¹å®®å¹»å¤©é™£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "å¢åŠ 4ç§’ä½œç­”æ™‚é–“"}, "ä¸Šå“åäºŒå¤©ç½¡é™£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "å¢åŠ 4ç§’ä½œç­”æ™‚é–“"},
    "æ¥µå“ç„æ­¦é®æµ·é™£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "å¢åŠ 5ç§’ä½œç­”æ™‚é–“"}, "æ¥µå“ç™½è™è£‚å¤©é™£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "å¢åŠ 5ç§’ä½œç­”æ™‚é–“"},
    "è¶…å“é’é¾é¨°é›²é™£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "å¢åŠ 6ç§’ä½œç­”æ™‚é–“"}, "è¶…å“æœ±é›€ç„šå¤©é™£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "å¢åŠ 6ç§’ä½œç­”æ™‚é–“"},
    "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "å¢åŠ 7ç§’ä½œç­”æ™‚é–“"}, "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "å¢åŠ 7ç§’ä½œç­”æ™‚é–“"},
    "å¯¶å“è¬éˆæ­¸æºé™£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "å¢åŠ 8ç§’ä½œç­”æ™‚é–“"}, "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "å¢åŠ 8ç§’ä½œç­”æ™‚é–“"},
    "åœ°å“ä¹åœ°é®é­”å¤§é™£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "å¢åŠ 9ç§’ä½œç­”æ™‚é–“"}, "åœ°å“åšåœŸæ­¸å¢Ÿé™£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "å¢åŠ 9ç§’ä½œç­”æ™‚é–“"},
    "å¤©å“å…ˆå¤©ä¸€ç‚åŒ–åŠ«å¤§é™£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "å¢åŠ 10ç§’ä½œç­”æ™‚é–“"}, "å¤©å“ç„¡æ¥µä¹¾å¤ç•ŒåŸŸé™£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "å¢åŠ 10ç§’ä½œç­”æ™‚é–“"},
};

const UPGRADE_PATHS = {
    "å…¥å“é’ç«¹åŠ": "ä¸‹å“å¯’é‹’åŠ", "ä¸‹å“å¯’é‹’åŠ": "ä¸­å“é’éœœåŠ", "ä¸­å“é’éœœåŠ": "ä¸Šå“æµå…‰åŠ", "ä¸Šå“æµå…‰åŠ": "æ¥µå“é›¢ç«é£›åŠ", "æ¥µå“é›¢ç«é£›åŠ": "è¶…å“å¤ªè™›åŠèƒš", "è¶…å“å¤ªè™›åŠèƒš": "çµ•å“å¤ªç™½æ˜ŸåŠ", "çµ•å“å¤ªç™½æ˜ŸåŠ": "å¯¶å“æ‡¸å¤©é£›ä»™åŠ", "å¯¶å“æ‡¸å¤©é£›ä»™åŠ": "åœ°å“å´‘å´™æ–¬é‚ªåŠ", "åœ°å“å´‘å´™æ–¬é‚ªåŠ": "å¤©å“å¤ªæ¸…èª…ä»™åŠ",
    "å…¥å“éŠ…èƒŒåˆ€": "ä¸‹å“è£‚çŸ³åˆ€", "ä¸‹å“è£‚çŸ³åˆ€": "ä¸­å“èµ¤ç„°åˆ€", "ä¸­å“èµ¤ç„°åˆ€": "ä¸Šå“è’¼é¯¨åˆ€", "ä¸Šå“è’¼é¯¨åˆ€": "æ¥µå“ç„å†¥é¬¼åˆ€", "æ¥µå“ç„å†¥é¬¼åˆ€": "è¶…å“ç„¡ç›¸åˆ€èƒ", "è¶…å“ç„¡ç›¸åˆ€èƒ": "çµ•å“ç„æ­¦é®æµ·åˆ€", "çµ•å“ç„æ­¦é®æµ·åˆ€": "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€", "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€": "åœ°å“åšåœŸé®å²³åˆ€", "åœ°å“åšåœŸé®å²³åˆ€": "å¤©å“å¤©é“å¯©åˆ‘åˆ€",
    "å…¥å“ç¢é›²æ§": "ä¸‹å“æ¸¸é¾æ§", "ä¸‹å“æ¸¸é¾æ§": "ä¸­å“éœ†ç½¡æ§", "ä¸­å“éœ†ç½¡æ§": "ä¸Šå“ç ´è»æ§", "ä¸Šå“ç ´è»æ§": "æ¥µå“ç´«é›»ç¥æ§", "æ¥µå“ç´«é›»ç¥æ§": "è¶…å“å¤©ç½¡æ§é­‚", "è¶…å“å¤©ç½¡æ§é­‚": "çµ•å“é’é¾é©šé›·æ§", "çµ•å“é’é¾é©šé›·æ§": "å¯¶å“ç ´ç•Œéé‡‘æ§", "å¯¶å“ç ´ç•Œéé‡‘æ§": "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§", "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§": "å¤©å“ä¹¾å¤å®šæµ·æ§",
    "å…¥å“ç¯‰åŸºåç´è¨£": "ä¸‹å“å°å‘¨å¤©è¡Œæ°£", "ä¸‹å“å°å‘¨å¤©è¡Œæ°£": "ä¸­å“ç„æ¯æ­¸ä¸€è¨£", "ä¸­å“ç„æ¯æ­¸ä¸€è¨£": "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£", "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£": "æ¥µå“å¤ªé™°ç…‰æœˆç¶“", "æ¥µå“å¤ªé™°ç…‰æœˆç¶“": "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“", "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“": "çµ•å“ä¹è½‰é‡‘èº«è¨£", "çµ•å“ä¹è½‰é‡‘èº«è¨£": "å¯¶å“æ´å¤©é€ åŒ–ç¶“", "å¯¶å“æ´å¤©é€ åŒ–ç¶“": "åœ°å“åœ°è—å†¥å¿ƒç¶“", "åœ°å“åœ°è—å†¥å¿ƒç¶“": "å¤©å“å¤§é“æ··å…ƒè—",
    "å…¥å“æ¾é¹¤é•·é’åŠŸ": "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“", "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“": "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡", "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡": "ä¸Šå“ç´«åºœé‚„çœŸç¶“", "ä¸Šå“ç´«åºœé‚„çœŸç¶“": "æ¥µå“é›¢ç«å†¥é›·ç¶“", "æ¥µå“é›¢ç«å†¥é›·ç¶“": "è¶…å“ç„¡ç›¸ç„åŠŸ", "è¶…å“ç„¡ç›¸ç„åŠŸ": "çµ•å“äº”é›·æ­£æ³•", "çµ•å“äº”é›·æ­£æ³•": "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£", "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£": "åœ°å“åšåœŸç„¡ç–†è¨£", "åœ°å“åšåœŸç„¡ç–†è¨£": "å¤©å“ç„¡æ¥µæœ¬æºç¶“",
    "å…¥å“ä¸‰æ‰èšéˆé™£": "ä¸‹å“äº”è¡Œè­·å±±é™£", "ä¸‹å“äº”è¡Œè­·å±±é™£": "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£", "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£": "ä¸Šå“ä¹å®®å¹»å¤©é™£", "ä¸Šå“ä¹å®®å¹»å¤©é™£": "æ¥µå“ç„æ­¦é®æµ·é™£", "æ¥µå“ç„æ­¦é®æµ·é™£": "è¶…å“é’é¾é¨°é›²é™£", "è¶…å“é’é¾é¨°é›²é™£": "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£", "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£": "å¯¶å“è¬éˆæ­¸æºé™£", "å¯¶å“è¬éˆæ­¸æºé™£": "åœ°å“ä¹åœ°é®é­”å¤§é™£", "åœ°å“ä¹åœ°é®é­”å¤§é™£": "å¤©å“å…ˆå¤©ä¸€ç‚åŒ–åŠ«å¤§é™£",
    "å…¥å“å››é–€é™·æ•µé™£": "ä¸‹å“å…­ç”²è¿·è¸ªé™£", "ä¸‹å“å…­ç”²è¿·è¸ªé™£": "ä¸­å“å…«é–€é‡‘é–é™£", "ä¸­å“å…«é–€é‡‘é–é™£": "ä¸Šå“åäºŒå¤©ç½¡é™£", "ä¸Šå“åäºŒå¤©ç½¡é™£": "æ¥µå“ç™½è™è£‚å¤©é™£", "æ¥µå“ç™½è™è£‚å¤©é™£": "è¶…å“æœ±é›€ç„šå¤©é™£", "è¶…å“æœ±é›€ç„šå¤©é™£": "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£", "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£": "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£", "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£": "åœ°å“åšåœŸæ­¸å¢Ÿé™£", "åœ°å“åšåœŸæ­¸å¢Ÿé™£": "å¤©å“ç„¡æ¥µä¹¾å¤ç•ŒåŸŸé™£",
};

const ITEM_EFFECTS = {
    "å…¥å“ä»™ä¸¹": {"type": "exp", "n": 10, "desc": "å¢åŠ  10 ä¿®ç…‰ç¶“é©—"}, "ä¸‹å“ä»™ä¸¹": {"type": "exp", "n": 30, "desc": "å¢åŠ  30 ä¿®ç…‰ç¶“é©—"}, "ä¸­å“ä»™ä¸¹": {"type": "exp", "n": 70, "desc": "å¢åŠ  70 ä¿®ç…‰ç¶“é©—"}, "ä¸Šå“ä»™ä¸¹": {"type": "exp", "n": 150, "desc": "å¢åŠ  150 ä¿®ç…‰ç¶“é©—"}, "æ¥µå“ä»™ä¸¹": {"type": "exp", "n": 310, "desc": "å¢åŠ  310 ä¿®ç…‰ç¶“é©—"}, "è¶…å“ä»™ä¸¹": {"type": "exp", "n": 630, "desc": "å¢åŠ  630 ä¿®ç…‰ç¶“é©—"}, "çµ•å“ä»™ä¸¹": {"type": "exp", "n": 1270, "desc": "å¢åŠ  1270 ä¿®ç…‰ç¶“é©—"}, "å¯¶å“ä»™ä¸¹": {"type": "exp", "n": 2550, "desc": "å¢åŠ  2550 ä¿®ç…‰ç¶“é©—"}, "åœ°å“ä»™ä¸¹": {"type": "exp", "n": 5110, "desc": "å¢åŠ  5110 ä¿®ç…‰ç¶“é©—"}, "å¤©å“ä»™ä¸¹": {"type": "exp", "n": 10230, "desc": "å¢åŠ  10230 ä¿®ç…‰ç¶“é©—"},
    "å…¥å“éˆç¬¦": {"type": "wrong", "n": 1, "desc": "æ’é™¤ 1 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸‹å“éˆç¬¦": {"type": "wrong", "n": 2, "desc": "æ’é™¤ 2 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸­å“éˆç¬¦": {"type": "wrong", "n": 3, "desc": "æ’é™¤ 3 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸Šå“éˆç¬¦": {"type": "wrong", "n": 4, "desc": "æ’é™¤ 4 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "æ¥µå“éˆç¬¦": {"type": "wrong", "n": 5, "desc": "æ’é™¤ 5 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "è¶…å“éˆç¬¦": {"type": "wrong", "n": 6, "desc": "æ’é™¤ 6 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "çµ•å“éˆç¬¦": {"type": "wrong", "n": 7, "desc": "æ’é™¤ 7 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¯¶å“éˆç¬¦": {"type": "wrong", "n": 8, "desc": "æ’é™¤ 8 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "åœ°å“éˆç¬¦": {"type": "wrong", "n": 9, "desc": "æ’é™¤ 9 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¤©å“éˆç¬¦": {"type": "wrong", "n": 10, "desc": "æ’é™¤ 10 å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å…¥å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸‹å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸­å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸Šå“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "æ¥µå“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "è¶…å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "çµ•å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "å¯¶å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "åœ°å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "å¤©å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"},
    ...WEAPONS, ...TECHNIQUES, ...FORMATIONS
};

const ITEM_STONE_PRICES = {
    "å…¥å“ä»™ä¸¹": 3, "ä¸‹å“ä»™ä¸¹": 6, "ä¸­å“ä»™ä¸¹": 12, "ä¸Šå“ä»™ä¸¹": 24, "æ¥µå“ä»™ä¸¹": 48, "è¶…å“ä»™ä¸¹": 96, "çµ•å“ä»™ä¸¹": 192, "å¯¶å“ä»™ä¸¹": 384, "åœ°å“ä»™ä¸¹": 768, "å¤©å“ä»™ä¸¹": 1536,
    "å…¥å“éˆç¬¦": 1, "ä¸‹å“éˆç¬¦": 2, "ä¸­å“éˆç¬¦": 4, "ä¸Šå“éˆç¬¦": 8, "æ¥µå“éˆç¬¦": 16, "è¶…å“éˆç¬¦": 32, "çµ•å“éˆç¬¦": 64, "å¯¶å“éˆç¬¦": 128, "åœ°å“éˆç¬¦": 256, "å¤©å“éˆç¬¦": 512,
    "å…¥å“éˆå™¨": 5, "ä¸‹å“éˆå™¨": 10, "ä¸­å“éˆå™¨": 20, "ä¸Šå“éˆå™¨": 40, "æ¥µå“éˆå™¨": 80, "è¶…å“éˆå™¨": 160, "çµ•å“éˆå™¨": 320, "å¯¶å“éˆå™¨": 640, "åœ°å“éˆå™¨": 1280, "å¤©å“éˆå™¨": 2560,
};

const ITEM_RENAME_MAP = {
    "æ™®é€šä»™ä¸¹": "å…¥å“ä»™ä¸¹", "æ™®é€šéˆç¬¦": "å…¥å“éˆç¬¦", "æ™®é€šéˆå™¨": "å…¥å“éˆå™¨",
};

const EMOJIS = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜¡","ğŸ˜­","ğŸ˜","ğŸ˜±","ğŸ˜´","ğŸ˜‡","ğŸ¤–"];
const ANIMALS = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ¦„","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤"];
const FOODS = ["ğŸ","ğŸŠ","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ¥‘","ğŸ","ğŸ¥","ğŸ’","ğŸ”","ğŸŸ","ğŸ•","ğŸŒ­","ğŸ¥ª","ğŸ¥—","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸœ"];
const COLORS = ["ğŸ”´","ğŸŸ ","ğŸŸ¡","ğŸŸ¢","ğŸ”µ","ğŸŸ£","âš«","âšª","ğŸŸ¤","ğŸŸ¥","ğŸŸ§","ğŸŸ¨","ğŸŸ©","ğŸŸ¦","ğŸŸª","â¬›","â¬œ","ğŸŸ«","ğŸ”¶","ğŸ”·"];
const SHAPES = ["ğŸ”º","ğŸ”µ","â¬›","â­","ğŸŸ©","ğŸŸ§","ğŸŸ¥","â¬œ","ğŸ”¶","ğŸ”·","ğŸ”³","ğŸ”²","ğŸŸ«","ğŸ”¸","ğŸ”¹","â¬Ÿ","â¬¢","â¬£","âº","â¹"];
const PLACES = ["ğŸ ","ğŸ¢","ğŸ¬","ğŸ­","ğŸ°","ğŸ¯","ğŸï¸","ğŸ–ï¸","â›©ï¸","ğŸ¡","ğŸ¢","ğŸ ","ğŸ—½","ğŸ—¼","â›²","ğŸ•Œ","â›ª","ğŸ›•","ğŸ•ï¸"];
const FLAGS = ["ğŸ‡¹ğŸ‡¼","ğŸ‡¯ğŸ‡µ","ğŸ‡°ğŸ‡·","ğŸ‡¨ğŸ‡³","ğŸ‡ºğŸ‡¸","ğŸ‡¬ğŸ‡§","ğŸ‡«ğŸ‡·","ğŸ‡©ğŸ‡ª","ğŸ‡®ğŸ‡¹","ğŸ‡ªğŸ‡¸","ğŸ‡§ğŸ‡·","ğŸ‡¨ğŸ‡¦","ğŸ‡¦ğŸ‡º","ğŸ‡³ğŸ‡¿","ğŸ‡·ğŸ‡º","ğŸ‡¸ğŸ‡ª","ğŸ‡³ğŸ‡´","ğŸ‡®ğŸ‡³","ğŸ‡²ğŸ‡½","ğŸ‡¿ğŸ‡¦"];
const NATURE = ["ğŸŒ","ğŸŒ","ğŸŒ§ï¸","â›ˆï¸","ğŸŒªï¸","ğŸŒˆ","ğŸŒŠ","ğŸŒ‹","â„ï¸","ğŸƒ"];
const CARDS = ["ğŸ‚±","ğŸ‚²","ğŸ‚³","ğŸ‚´","ğŸ‚µ","ğŸ‚¶","ğŸ‚·","ğŸ‚¸","ğŸ‚¹","ğŸ‚º","ğŸ‚»","ğŸ‚¼","ğŸ‚½","ğŸ‚¾","ğŸ‚¡","ğŸ‚¢","ğŸ‚£","ğŸ‚¤","ğŸ‚¥","ğŸ‚¦","ğŸ‚§","ğŸ‚¨","ğŸ‚©","ğŸ‚ª","ğŸ‚«","ğŸ‚¬","ğŸ‚­","ğŸ‚®","ğŸƒ","ğŸƒ‚","ğŸƒƒ","ğŸƒ„","ğŸƒ…","ğŸƒ†","ğŸƒ‡","ğŸƒˆ","ğŸƒ‰","ğŸƒŠ","ğŸƒ‹","ğŸƒŒ","ğŸƒ","ğŸƒ","ğŸƒ‘","ğŸƒ’","ğŸƒ“","ğŸƒ”","ğŸƒ•","ğŸƒ–","ğŸƒ—","ğŸƒ˜","ğŸƒ™","ğŸƒš","ğŸƒ›","ğŸƒœ","ğŸƒ","ğŸƒ","ğŸ‚ ","ğŸƒ","ğŸƒŸ"];
const MAHJONG = ["ğŸ€‡","ğŸ€ˆ","ğŸ€‰","ğŸ€Š","ğŸ€‹","ğŸ€Œ","ğŸ€","ğŸ€","ğŸ€","ğŸ€™","ğŸ€š","ğŸ€›","ğŸ€œ","ğŸ€","ğŸ€","ğŸ€Ÿ","ğŸ€ ","ğŸ€¡","ğŸ€","ğŸ€‘","ğŸ€’","ğŸ€“","ğŸ€”","ğŸ€•","ğŸ€–","ğŸ€—","ğŸ€˜","ğŸ€€","ğŸ€","ğŸ€‚","ğŸ€ƒ","ğŸ€„","ğŸ€…","ğŸ€†"];
const VEHICLES = ["ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸï¸","ğŸš“","ğŸš‘","ğŸš’","ğŸš","ğŸšš","ğŸš›","ğŸšœ","ğŸ›»","ğŸ›º","ğŸš²","ğŸ›µ","ğŸï¸","ğŸš”","ğŸš","âœˆï¸","ğŸ›«","ğŸ›¬","ğŸ›©ï¸","ğŸš","ğŸ›¶","ğŸš¤","â›µ","ğŸ›³ï¸","ğŸš€"];
const ZODIACS = ["â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“"];
const CLOCKS = ["ğŸ•›","ğŸ•","ğŸ•‘","ğŸ•’","ğŸ•“","ğŸ•”","ğŸ••","ğŸ•–","ğŸ•—","ğŸ•˜","ğŸ•™","ğŸ•š"];
const PROFESSIONS = ["ğŸ§‘â€âš•ï¸","ğŸ§‘â€ğŸ«","ğŸ§‘â€ğŸ³","ğŸ§‘â€ğŸ’»","ğŸ§‘â€ğŸ”¬","ğŸ§‘â€ğŸ¨","ğŸ§‘â€ğŸš’","ğŸ§‘â€âœˆï¸","ğŸ§‘â€ğŸš€","ğŸ§‘â€ğŸ”§","ğŸ§‘â€ğŸŒ¾","ğŸ§‘â€ğŸ­","ğŸ§‘â€âš–ï¸","ğŸ§‘â€ğŸ¤","ğŸ§‘â€ğŸ“","ğŸ‘®â€â™‚ï¸","ğŸ‘·â€â™‚ï¸"];
const SPORTS = ["ğŸ–ï¸","ğŸ†","ğŸ…","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","âš¾","ğŸ¥","ğŸ€","ğŸ","ğŸˆ","ğŸ‰","ğŸ¾","ğŸ¥","ğŸ³","ğŸ","ğŸ‘","ğŸ’","ğŸ¥","ğŸ“","ğŸ¸","ğŸ¥Š","ğŸ¥‹","ğŸ¥…","â›³","â›¸ï¸","ğŸ£","ğŸ¤¿","ğŸ½","ğŸ¿","ğŸ›·","ğŸ¥Œ","ğŸ¯"];
const OFFICE = ["ğŸ“”","ğŸ“•","ğŸ“–","ğŸ“—","ğŸ“˜","ğŸ“™","ğŸ“š","ğŸ““","ğŸ“’","ğŸ“ƒ","ğŸ“œ","ğŸ“„","ğŸ“°","ğŸ—ï¸","ğŸ“‘","ğŸ”–","ğŸ·ï¸","âœ‰ï¸","ğŸ“§","ğŸ“¨","ğŸ“©","ğŸ“¤","ğŸ“¥","ğŸ“¦","ğŸ“«","ğŸ“ª","ğŸ“¬","ğŸ“­","ğŸ“®","ğŸ—³ï¸","âœï¸","âœ’ï¸","ğŸ–‹ï¸","ğŸ–Šï¸","ğŸ–Œï¸","ğŸ–ï¸","ğŸ“","ğŸ’¼","ğŸ“","ğŸ“‚","ğŸ—‚ï¸","ğŸ“…","ğŸ“†","ğŸ—’ï¸","ğŸ—“ï¸","ğŸ“‡","ğŸ“ˆ","ğŸ“‰","ğŸ“Š","ğŸ“‹","ğŸ“Œ","ğŸ“","ğŸ“","ğŸ–‡ï¸","ğŸ“","ğŸ“","âœ‚ï¸","ğŸ—ƒï¸","ğŸ—„ï¸","ğŸ—‘ï¸","ğŸªª"];
const TOOLS = ["ğŸ§³","ğŸŒ¡ï¸","ğŸ§¸","ğŸ§¶","ğŸª¢","ğŸ”","ğŸ”","ğŸ•¯ï¸","ğŸ’¡","ğŸ”¦","ğŸ”’","ğŸ”“","ğŸ”","ğŸ”","ğŸ”‘","ğŸ—ï¸","ğŸ”¨","ğŸª“","â›ï¸","âš’ï¸","ğŸ› ï¸","ğŸ—¡ï¸","âš”ï¸","ğŸ’£","ğŸªƒ","ğŸ¹","ğŸ›¡ï¸","ğŸªš","ğŸ”§","ğŸª›","ğŸ”©","âš™ï¸","ğŸ—œï¸","âš–ï¸","ğŸ”—","â›“ï¸","ğŸ’¥","â›“ï¸","ğŸª","ğŸ§°","ğŸ§²","ğŸªœ","ğŸª","âš—ï¸","ğŸ§ª","ğŸ§«","ğŸ”¬","ğŸ”­","ğŸ“¡","ğŸ’‰","ğŸ©¹","ğŸ©¼","ğŸ©º","ğŸ©»","ğŸšª","ğŸª","ğŸªŸ","ğŸ›ï¸","ğŸ›‹ï¸","ğŸª‘","ğŸš½","ğŸª ","ğŸš¿","ğŸ›","ğŸª¤","ğŸª’","ğŸ§´","ğŸ§·","ğŸ§¹","ğŸ§º","ğŸ§»","ğŸª£","ğŸ§¼","ğŸ«§","ğŸª¥","ğŸ§½","ğŸ§¯","ğŸ›’","ğŸš¬","âš°ï¸","ğŸª¦","âš±ï¸","ğŸª§"];
// è‡ªå‹•æ‹†åˆ†è¾¦å…¬æ–‡å…·èˆ‡å·¥å…·/å®¶å±…ç”¨å“ç‚ºå‰åŠ(A)èˆ‡å¾ŒåŠ(B)
const OFFICE_A = OFFICE.slice(0, Math.ceil(OFFICE.length / 2));
const OFFICE_B = OFFICE.slice(Math.ceil(OFFICE.length / 2));
const TOOLS_A = TOOLS.slice(0, Math.ceil(TOOLS.length / 2));
const TOOLS_B = TOOLS.slice(Math.ceil(TOOLS.length / 2));


const ALL_GAMES = [
    { name: "å¾ 1ï½10 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_hidden" }, { name: "å¾ 1ï½20 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_20" }, { name: "å¾ 1ï½30 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_30" }, { name: "å¯¶ç®±è¨“ç·´ï¼šé¸å‡ºæ­£ç¢ºçš„", func: "game_treasure_box" }, { name: "é¸å‡ºå¥½é‹è¡¨æƒ…ç¬¦è™Ÿ", func: "game_emoji_pick" }, { name: "é¸å‡ºå¹¸é‹å‹•ç‰©", func: "game_animals" }, { name: "é¸å‡ºå¹¸é‹é£Ÿç‰©", func: "game_foods" }, { name: "é¸å‡ºå¹¸é‹åœ°é»", func: "game_places" }, { name: "é¸å‡ºå¹¸é‹åœ–å½¢", func: "game_shape_select" }, { name: "æ‰¾å‡ºå¹¸é‹é¡è‰²", func: "game_color_select" }, { name: "é¸å‡ºå¹¸é‹åœ‹æ——", func: "game_flags" }, { name: "é¸å‡ºå¹¸é‹è‡ªç„¶ç¾è±¡", func: "game_nature" }, { name: "é¸å‡ºå¹¸é‹æ’²å…‹ç‰Œç¬¦è™Ÿ", func: "game_cards" }, { name: "é¸å‡ºå¹¸é‹éº»å°‡åœ–æ¡ˆ", func: "game_mahjong" }, { name: "é¸å‡ºå¹¸é‹äº¤é€šå·¥å…·", func: "game_vehicles" }, { name: "é¸å‡ºå¹¸é‹æ˜Ÿåº§ç¬¦è™Ÿ", func: "game_zodiacs" }, { name: "ç¦®ç‰©è¨“ç·´ï¼šé¸å‡ºå¹¸é‹ç¦®ç‰©è™Ÿç¢¼", func: "game_gift_box" }, { name: "æŒ‘é¸ä»Šå¤©å¹¸é‹æ™‚æ®µ", func: "game_lucky_period" }, { name: "é¸å‡ºå¹¸é‹è·æ¥­", func: "game_professions" }, { name: "é¸å‡ºé«”è‚²èˆ‡çé …", func: "game_sports_awards" }, { name: "é¸å‡ºè¾¦å…¬æ–‡å…·A", func: "game_office_a" }, { name: "é¸å‡ºè¾¦å…¬æ–‡å…·B", func: "game_office_b" }, { name: "é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–A", func: "game_tools_a" }, { name: "é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–B", func: "game_tools_b" }, 
];


// ===================== éŠæˆ²ç‹€æ…‹ç®¡ç† =====================
let gameState;
let maxScores;
let trainingState;
let timers = {
    answer: null,
    nextRound: null,
};

// é è¨­éŠæˆ²ç‹€æ…‹
const defaultStats = {
    total: 0, exp: 0, bonus: 0, luck_tests_total: 0,
    luck_history: [], luck_tickets: 0, luck_tickets_total: 0,
    stage_idx: 0, last_daily_ticket_date: "", inventory: {},
    inventory_order: [], stones: 0, current_title: "1.å®—é–€çš„åŸºçŸ³",
    last_luck_date: "", last_luck_reward_msg: ""
};

function saveToLocalStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save to localStorage", e);
    }
}

function loadFromLocalStorage(key, defaultValue = {}) {
    const data = localStorage.getItem(key);
    try {
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error("Failed to parse from localStorage", e);
        return defaultValue;
    }
}

function saveGameState() {
    saveToLocalStorage(STATS_FILE, gameState);
    saveToLocalStorage(SCORE_FILE, maxScores);
}

function loadGameState() {
    gameState = loadFromLocalStorage(STATS_FILE, JSON.parse(JSON.stringify(defaultStats)));
    maxScores = loadFromLocalStorage(SCORE_FILE, {});
    // å…¼å®¹èˆŠç‰ˆé“å…·åç¨±
    const newInv = {};
    for (const [key, value] of Object.entries(gameState.inventory)) {
        const newName = ITEM_RENAME_MAP[key] || key;
        newInv[newName] = (newInv[newName] || 0) + value;
    }
    gameState.inventory = newInv;
    gameState.stage_idx = getStageIndex(gameState.exp);
}


// ===================== æ ¸å¿ƒé‚è¼¯å‡½å¼ (ç§»æ¤è‡ª Python) =====================
// ä¾æ“šæ‰€éœ€ä¿®ç…‰ç¶“é©—è¨ˆç®—è¨“ç·´æ¬¡æ•¸é–€æª»ï¼ˆååˆ†ä¹‹ä¸€ï¼Œå‘ä¸Šå–æ•´ï¼Œè‡³å°‘ç‚º 1ï¼‰ã€‚
// ä¾‹å¦‚éœ€è¦ 10 EXP çš„å±¤ç´šï¼Œéœ€è¦ 1 æ¬¡è¨“ç·´ï¼›éœ€è¦ 25 EXP çš„å±¤ç´šï¼Œéœ€è¦ 3 æ¬¡è¨“ç·´ã€‚
function getRequiredTrainingsForExp(needExp) {
    // needExp å¯èƒ½ç‚º undefined æˆ– 0ï¼Œçš†è¿”å› 1
    if (!needExp || needExp <= 0) return 1;
    return Math.max(1, Math.ceil(needExp / 10));
}

function getStageIndex(exp) {
    // æ ¹æ“šç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸é–€æª»åˆ¤æ–·ç©å®¶ç•¶å‰ä¿®ç‚ºå±¤ç´šã€‚
    // å¿…é ˆåŒæ™‚æ»¿è¶³ç¶“é©—å€¼èˆ‡è¨“ç·´æ¬¡æ•¸æ¢ä»¶æ‰å¯é€²å…¥ä¸‹ä¸€å±¤ã€‚
    let idx = 0;
    for (let i = 0; i < CULTIVATION_STAGES.length; i++) {
        const [need_exp] = CULTIVATION_STAGES[i];
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp >= need_exp && gameState.total >= requiredTrain) {
            idx = i;
        } else {
            break;
        }
    }
    return idx;
}

function getCultivationStage(exp) {
    return CULTIVATION_STAGES[getStageIndex(exp)][2];
}

function getNextCultivationInfo(exp) {
    // æ ¹æ“šç¶“é©—å€¼èˆ‡ç¸½è¨“ç·´æ¬¡æ•¸ï¼Œè¨ˆç®—è·é›¢ä¸‹ä¸€å±¤æ‰€éœ€çš„ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸
    for (const [need_exp,, name] of CULTIVATION_STAGES) {
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp < need_exp || gameState.total < requiredTrain) {
            return {
                next_stage: name,
                exp_needed: Math.max(0, need_exp - exp),
                train_needed: Math.max(0, requiredTrain - gameState.total)
            };
        }
    }
    return null;
}

function getCultivationBonusExp(score, requiredScore) {
    const diff = score - requiredScore;
    if (diff < 5) return [0, ""];
    const capped = Math.min(diff, 95);
    const n = Math.floor(capped / 5);
    const exp = Math.pow(2, n - 1);
    return [Math.floor(exp), `åˆ†æ•¸è¶…éé–€æª» ${capped} åˆ†ï¼Œç²å¾—é¡å¤– +${Math.floor(exp)} ä¿®ç…‰ç¶“é©—ï¼`];
}

function getItemSortKey(itemName) {
    let itemType = 'æœªçŸ¥', itemGrade = 'æœªçŸ¥';
    for (const t of ITEM_TYPE_ORDER) {
        if (t === 'å…µå™¨') {
            if (itemName.includes('åŠ') || itemName.includes('åˆ€') || itemName.includes('æ§')) {
                itemType = t; break;
            }
        } else if (itemName.includes(t)) {
            itemType = t; break;
        }
    }
    for (const g of GRADE_NAMES) {
        if (itemName.includes(g)) {
            itemGrade = g; break;
        }
    }
    const typeIndex = ITEM_TYPE_ORDER.includes(itemType) ? ITEM_TYPE_ORDER.indexOf(itemType) : ITEM_TYPE_ORDER.length;
    const gradeIndex = GRADE_NAMES.includes(itemGrade) ? GRADE_NAMES.indexOf(itemGrade) : GRADE_NAMES.length;
    return [typeIndex, gradeIndex, itemName];
}
// æ¯”è¼ƒé“å…·åç¨±çš„å‡½å¼ï¼šä¾ç…§é¡å‹ç´¢å¼•ã€å“éšç´¢å¼•ã€æœ€å¾Œä»¥åç¨±ï¼ˆå­—å…¸åºï¼‰æ’åºã€‚
// èˆ‡ 8-8 ç‰ˆ Python get_item_sort_key é…åˆï¼Œé¿å…ä½¿ç”¨ join æ¯”å°é€ æˆæ’åºéŒ¯äº‚ã€‚
function compareItemNames(nameA, nameB) {
    const keyA = getItemSortKey(nameA);
    const keyB = getItemSortKey(nameB);
    // å…ˆæ¯”é¡å‹
    if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
    // å†æ¯”å“éš
    if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
    // æœ€å¾Œæ¯”åç¨±
    return nameA.localeCompare(nameB, 'zh-Hant');
}

function getGradeByDifficulty(difficulty) {
    const idx = Math.max(0, Math.min(GRADE_NAMES.length - 1, difficulty - 1));
    return GRADE_NAMES[idx];
}


// ===================== éŠæˆ²æµç¨‹æ§åˆ¶ =====================
const app = document.getElementById('app');
let temporaryMessages = []; // ç”¨æ–¼é¡¯ç¤ºè‡¨æ™‚è¨Šæ¯ï¼Œä¾‹å¦‚æ¯æ—¥çå‹µ

function clearApp() {
    app.innerHTML = '';
    Object.values(timers).forEach(timer => clearTimeout(timer));
}

function addTemporaryMessage(html, type) {
    temporaryMessages.push({ html, type });
}

function showTemporaryMessages() {
    temporaryMessages.forEach(({html, type}) => {
        const p = document.createElement('p');
        p.className = `message ${type}`;
        p.innerHTML = html;
        app.appendChild(p);
    });
    temporaryMessages = [];
}

function handleLevelUp(prevExp, newExp) {
    const prevIdx = getStageIndex(prevExp);
    const newIdx = getStageIndex(newExp);
    if (newIdx <= prevIdx) {
        gameState.stage_idx = newIdx;
        saveGameState();
        return "";
    }
    
    let ticketsGain = 0;
    for (let k = prevIdx + 1; k <= newIdx; k++) {
        const prevName = CULTIVATION_STAGES[k - 1][2];
        const match = prevName.match(/(\d+)å±¤$/);
        ticketsGain += match ? parseInt(match[1], 10) : 1;
    }
    
    const stonesGain = newIdx - prevIdx;
    
    gameState.stage_idx = newIdx;
    gameState.luck_tickets += ticketsGain;
    gameState.luck_tickets_total += ticketsGain;
    gameState.stones += stonesGain;
    saveGameState();

    // æ’­æ”¾å‡ç´šéŸ³æ•ˆ
    try {
        if (typeof playLevelUp === 'function') {
            playLevelUp();
        }
    } catch (e) {}
    
    let parts = [];
    if (ticketsGain > 0) parts.push(`+${ticketsGain} ç¥¨`);
    if (stonesGain > 0) parts.push(`+${stonesGain} éˆçŸ³`);

    return `ğŸŸï¸ å‡å±¤çå‹µï¼š${parts.join('ã€')}ï¼ˆç›®å‰ç¥¨ ${gameState.luck_tickets}ï¼ŒéˆçŸ³ ${gameState.stones}ï¼‰`;
}

function grantDailyTicketIfNeeded() {
    // ä½¿ç”¨æœ¬åœ°æ™‚é–“
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_daily_ticket_date !== today) {
        gameState.luck_tickets += 1;
        gameState.luck_tickets_total += 1;
        gameState.stones += 1;
        gameState.last_daily_ticket_date = today;
        saveGameState();
        addTemporaryMessage(`ğŸ ä»Šæ—¥ç™»å…¥è´ˆé€ +1 æ¸¬è©¦æ©ŸæœƒåŠ +1 éˆçŸ³ï¼ˆç›®å‰ç¥¨ ${gameState.luck_tickets}ï¼ŒéˆçŸ³ ${gameState.stones}ï¼‰`, 'msg-daily');
    }
}

// ===================== ä¸»é¸å–®æ¸²æŸ“ =====================
function renderMainMenu() {
    clearApp();
    grantDailyTicketIfNeeded();
    
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    
    let nextStageProgress = 100;
    let progressTip = "ğŸŒŸ ä½ å·²é”åˆ°æœ€çµ‚ä¿®ç‚ºï¼";

    if (nextInfo) {
        progressTip = `â¬†ï¸ è·é›¢ã€Œ${nextInfo.next_stage}ã€é‚„å·® ${nextInfo.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfo.train_needed} æ¬¡`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            nextStageProgress = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    
    let html = `
        <h1>ğŸ¯ é‹æ°£è¨“ç·´å·¥å…·</h1>
        <h2>V9-0ï¼ˆä¿®ä»™ç¶²é ç‰ˆï¼‰</h2>
        <p style="text-align:center;">è«‹é¸æ“‡è¨“ç·´é›£åº¦ï¼ˆ1 æœ€ç°¡å–®ï½10 æœ€å›°é›£ï¼‰</p>
    `;

    for (let i = 1; i <= 10; i++) {
        const score = maxScores[i] || 0;
        html += `<button data-action="start-training" data-level="${i}">é›£åº¦ ${i}ï¼ˆæœ€é«˜åˆ†ï¼š${score}ï¼‰ å‹ç‡ï¼šç´„ ${DIFFICULTY_WIN_RATE[i]}%</button>`;
    }

    html += `
        <div class="info-section">
            <p style="font-size: 1.2em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}</p>
            <p style="font-size: 1.2em; color: var(--gold-color);">ğŸ–ï¸ ç›®å‰ä»™é–€ä½éšï¼š${gameState.current_title}</p>
            <p style="font-size: 0.9em; color: var(--secondary-color);">${progressTip}</p>
            <progress value="${nextStageProgress}" max="100"></progress>
            <p>ğŸ‹ï¸ ç´¯ç©è¨“ç·´æ¬¡æ•¸ï¼š${gameState.total} | âš”ï¸ ä¿®ç…‰ç¶“é©—ï¼š${gameState.exp} | â­ æœ€é«˜åˆ†ï¼š${highestScore}</p>
            <p>ğŸŸï¸ æ¸¬è©¦æ©Ÿæœƒï¼š${gameState.luck_tickets} æ¬¡ (ç´¯ç©ç²å¾—ï¼š${gameState.luck_tickets_total})</p>
            <p>ğŸ’ éˆçŸ³ï¼š${gameState.stones}</p>
        </div>
        <button data-action="show-stage-list">ğŸ“œ æŸ¥çœ‹ä¿®ä»™ç­‰ç´šä¸€è¦½</button>
        <button data-action="show-game-rules">ğŸ“– éŠæˆ²è¦å‰‡èªªæ˜</button>
        <button data-action="show-rank-list">ğŸ‘‘ æŸ¥çœ‹ä»™é–€ä½éšå°è™Ÿ</button>
        <button data-action="show-backpack">ğŸ’ èƒŒåŒ…</button>
        <button data-action="show-shop">ğŸ›’ å•†åº—</button>
        <button data-action="render-test-luck-menu">ğŸ” æ¸¬è©¦é‹æ°£</button>
        <button data-action="test-sfx">ğŸ”Š æ¸¬è©¦éŸ³æ•ˆ</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="1">ğŸª™ å…Œæ› 1 éˆçŸ³ (-${STONE_EXCHANGE_COST} EXP)</button>
        <hr>
        <button class="btn-warning" data-action="reset-stats">æ­¸é›¶è¨“ç·´/ç¶“é©—çµ±è¨ˆ</button>
        <button class="btn-danger" data-action="clear-scores">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ€é«˜åˆ†ç´€éŒ„</button>
    `;
    
    app.innerHTML = html;
    showTemporaryMessages();
    // ä¿®è£œè¡Œå‹•è£ç½®ç®­é ­åœ–ç¤ºï¼ˆç”¨ SVG æ›¿æ›ï¼‰
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

// ===================== è¨“ç·´æµç¨‹ =====================

function startTraining(level) {
    trainingState = {
        difficulty: level,
        round: 0,
        success: 0,
        fail: 0,
        totalRounds: 20,
        hasAnswered: false,
        correctAnswers: [],
        gameGridButtons: [],
        // Per-round state
        hasUsedSingleUseItem: false,
        allowedChoices: 1,
        selectedChoices: [],
    };
    trainingNext();
}

function trainingNext() {
    if (trainingState.round >= trainingState.totalRounds) {
        timers.nextRound = setTimeout(showTrainingResult, 400);
        return;
    }
    trainingState.round++;
    
    // é‡ç½®æ¯é¡Œç‹€æ…‹
    trainingState.hasAnswered = false;
    trainingState.hasUsedSingleUseItem = false;
    trainingState.allowedChoices = 1;
    trainingState.selectedChoices = [];
    // æœ¬é¡Œé¡å¤–æ™‚é–“é‡ç½®
    trainingState.roundExtraTime = 0;
    // é‡ç½®å€’æ•¸ç”¨çš„å‰©é¤˜æ™‚é–“ (é¿å…å»¶çºŒåˆ°ä¸‹ä¸€é¡Œ)
    trainingState.countdownRemaining = null;

    const gameDef = ALL_GAMES[Math.floor(Math.random() * ALL_GAMES.length)];
    const gameFunc = window[gameDef.func];
    gameFunc(); // This function will call renderTrainingScreen
}

function updateGameInfo() {
    const infoLabel = document.getElementById('game-info-label');
    if (infoLabel) {
        infoLabel.innerHTML = `ç¬¬ ${trainingState.round}/${trainingState.totalRounds} é¡Œ | âœ… æ­£ç¢º: ${trainingState.success} âŒ éŒ¯èª¤: ${trainingState.fail} | å¯é¸æ¬¡æ•¸: ${trainingState.allowedChoices - trainingState.selectedChoices.length}`;
    }
}

function renderTrainingScreen(title, items, correctAnswers, columns=5, btnSize=60) {
    clearApp();
    trainingState.correctAnswers = correctAnswers;
    
    let gridTemplateColumns = `repeat(${columns}, 1fr)`;

    let buttonsHTML = '';
    items.forEach((item) => {
        // Use data-choice to avoid issues with special characters in IDs
        buttonsHTML += `<button class="grid-btn" data-action="grid-btn" data-choice="${item}" style="height:${btnSize}px;">${item}</button>`;
    });

    app.innerHTML = `
        <p id="difficulty-info-label" style="text-align:center;"></p>
        <p id="game-info-label" style="text-align:center;"></p>
        <h3 style="text-align:center;">${title} (${correctAnswers.length} å€‹)</h3>
        <p id="feedback-label" class="feedback"></p>
        <p id="countdown-label" style="text-align:center; color:grey;"></p>
        <div class="game-grid" style="grid-template-columns: ${gridTemplateColumns};">
            ${buttonsHTML}
        </div>
        <div id="action-buttons">
            <button data-action="show-use-item-dialog">ğŸ’ ä½¿ç”¨é“å…·</button>
        </div>
    `;

    updateGameInfo();
    trainingState.gameGridButtons = Array.from(document.querySelectorAll('.grid-btn'));
    startAnswerCountdown(10);

    // æ›´æ–°é›£åº¦èˆ‡ä¸‹ä¸€éšæ®µé–€æª»è³‡è¨Š
    const diffLabel = document.getElementById('difficulty-info-label');
    if (diffLabel) {
        const difficulty = trainingState.difficulty || 1;
        const nextInfoStage = getNextCultivationInfo(gameState.exp);
        if (nextInfoStage) {
            diffLabel.innerHTML = `é›£åº¦ ${difficulty}ï½œä¸‹ä¸€éšæ®µã€Œ${nextInfoStage.next_stage}ã€é–€æª»ï¼šé‚„å·® ${nextInfoStage.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfoStage.train_needed} æ¬¡`;
        } else {
            diffLabel.innerHTML = `é›£åº¦ ${difficulty}ï½œå·²é”æœ€é«˜éšæ®µ`;
        }
    }
}

function onGridButtonClick(button) {
    if (trainingState.hasAnswered) return;

    if (trainingState.allowedChoices > 1) {
        const choice = button.dataset.choice;
        button.classList.toggle('checked');
        if (button.classList.contains('checked')) {
            if (trainingState.selectedChoices.length < trainingState.allowedChoices) {
                trainingState.selectedChoices.push(choice);
            } else {
                button.classList.remove('checked'); // Exceeded choices
            }
        } else {
            trainingState.selectedChoices = trainingState.selectedChoices.filter(c => c !== choice);
        }
        updateGameInfo();
        // ä¸å†ç”¨ã€Œé¸æ»¿å°±è‡ªå‹•çµæŸã€ï¼Œæ”¹ç”±æŒ‰ä¸‹ç¢ºèªæˆ–å€’æ•¸çµæŸå¾Œä½œç­”
    } else {
        checkAnswerSingle(button.dataset.choice);
    }
}

function startAnswerCountdown(seconds) {
    // æœ¬é¡Œå€’æ•¸æ™‚é–“ï¼šåŸºç¤ç§’æ•¸ + roundExtraTimeï¼ˆä¸Šä¸€é¡ŒåŠ æ™‚å·²åœ¨ trainingNext() é‡ç½®ï¼‰
    let remaining = seconds + (trainingState.roundExtraTime || 0);
    // ä½¿ç”¨ state å„²å­˜å‰©é¤˜ç§’æ•¸ï¼Œæ–¹ä¾¿åœ¨ä½¿ç”¨é™£æ³•æ™‚å³æ™‚å¢åŠ 
    trainingState.countdownRemaining = remaining;
    const countdownLabel = document.getElementById('countdown-label');
    
    if (timers.answer) clearTimeout(timers.answer);

    const update = () => {
        // è‹¥ UI è¢«åˆ‡æ›å°±åœæ­¢è¨ˆæ™‚
        if (!document.getElementById('countdown-label')) return;
        // è‹¥å·²å›ç­”å‰‡åœè¡¨
        if (trainingState.hasAnswered) {
            countdownLabel.textContent = "ä½œç­”çµæŸ";
            return;
        }
        // ä»¥ state ä¸­çš„å‰©é¤˜ç§’æ•¸ç‚ºæº–ï¼ˆå¯èƒ½è¢«é™£æ³•ä¸­é€”åŠ æ™‚ä¿®æ”¹ï¼‰
        remaining = trainingState.countdownRemaining || 0;
        if (remaining >= 0) {
            countdownLabel.textContent = `ä½œç­”å€’æ•¸ï¼š${remaining} ç§’`;
            trainingState.countdownRemaining = remaining - 1;
            timers.answer = setTimeout(update, 1000);
        } else {
            countdownLabel.textContent = "æ™‚é–“åˆ°ï¼";
            if (trainingState.allowedChoices > 1) {
                checkAnswerMulti();
            } else {
                checkAnswerSingle(null); // null means timeout
            }
        }
    };
    update();
}

function checkAnswerSingle(choice) {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    const feedbackLabel = document.getElementById('feedback-label');
    let correct = false;

    if (choice === null) { // Timeout
        trainingState.fail++;
        feedbackLabel.innerHTML = `âŒ æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆï¼š${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
    } else {
        correct = trainingState.correctAnswers.includes(choice);
        if (correct) {
            trainingState.success++;
            feedbackLabel.innerHTML = `âœ… æ­å–œä½ é¸å°äº†ï¼ä½ é¸çš„æ˜¯ï¼š${choice}`;
            feedbackLabel.className = "feedback success";
        } else {
            trainingState.fail++;
            feedbackLabel.innerHTML = `âŒ éŒ¯äº†ï¼Œä½ é¸çš„æ˜¯ï¼š${choice} æ­£ç¢ºç­”æ¡ˆï¼š${trainingState.correctAnswers.join(', ')}`;
            feedbackLabel.className = "feedback error";
        }
        // Query selector needs to handle special characters in data attributes
        document.querySelector(`.grid-btn[data-choice="${choice}"]`).classList.add('selected');
    }
    
    finalizeRound();
}

function checkAnswerMulti() {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    document.getElementById('confirm-btn')?.remove();

    const feedbackLabel = document.getElementById('feedback-label');
    const isCorrect = trainingState.selectedChoices.some(c => trainingState.correctAnswers.includes(c));

    if (isCorrect) {
        trainingState.success++;
        feedbackLabel.innerHTML = `âœ… ç­”å°äº†ï¼ä½ çš„é¸æ“‡ä¸­åŒ…å«äº†æ­£ç¢ºç­”æ¡ˆã€‚`;
        feedbackLabel.className = "feedback success";
    } else {
        trainingState.fail++;
        feedbackLabel.innerHTML = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
    }
    finalizeRound();
}

function finalizeRound() {
    updateGameInfo();
    // çµç®—å›åˆå¾Œæ¸…é™¤æœ¬é¡ŒåŠ æ™‚ï¼Œé¿å…å»¶çºŒåˆ°ä¸‹ä¸€é¡Œï¼ˆé›™é‡ä¿éšœï¼‰
    trainingState.roundExtraTime = 0;
    // æ¸…é™¤å€’æ•¸å‰©é¤˜æ™‚é–“ç‹€æ…‹
    trainingState.countdownRemaining = null;
    if (timers.nextRound) clearTimeout(timers.nextRound);
    timers.nextRound = setTimeout(trainingNext, 2000);
}

function enterMultiChoiceMode() {
    if (trainingState.allowedChoices <= 1) return;
    if (document.getElementById('confirm-btn')) return;

    const confirmBtn = document.createElement('button');
    confirmBtn.id = 'confirm-btn';
    confirmBtn.textContent = 'ç¢ºèªé¸æ“‡';
    confirmBtn.dataset.action = "check-answer-multi";
    document.getElementById('action-buttons').appendChild(confirmBtn);
}


function showTrainingResult() {
    clearApp();
    const score = Math.floor((trainingState.success / trainingState.totalRounds) * 100);
    const prevTotalTrainCount = gameState.total;
    gameState.total++;

    if (score > (maxScores[trainingState.difficulty] || 0)) {
        maxScores[trainingState.difficulty] = score;
    }
    
    const required = DIFFICULTY_WIN_RATE[trainingState.difficulty] || 0;
    const [bonusExp, bonusMsg] = getCultivationBonusExp(score, required);
    const prevExp = gameState.exp;
    const baseExp = 1;
    const totalGain = baseExp + Math.max(0, bonusExp);
    gameState.exp += totalGain;
    if (bonusExp > 0) gameState.bonus = (gameState.bonus || 0) + bonusExp;

    // === æ–°å¢è™•ç½°æ©Ÿåˆ¶ ===
    // è‹¥å¾—åˆ†ä½æ–¼è©²é›£åº¦çš„å‹ç‡é–€æª»ï¼Œä¾å·®è·æ‰£æ¸›ä¿®ç…‰å€¼
    let penaltyMsg = "";
    if (score < required) {
        const diffLow = required - score;
        if (diffLow >= 5) {
            const steps = Math.floor(diffLow / 5);
            const penaltyPercent = Math.pow(2, steps - 1);
            let penaltyExp = Math.floor(gameState.exp * penaltyPercent / 100);
            if (penaltyExp > 0) {
                gameState.exp = Math.max(0, gameState.exp - penaltyExp);
                penaltyMsg = `âŒ åˆ†æ•¸ä½æ–¼é–€æª» ${diffLow} åˆ†ï¼Œæ‰£é™¤ ${penaltyExp} ä¿®ç…‰å€¼ (${penaltyPercent}%)`;
            }
        }
    }

    // åœ¨æ‰£é™¤è™•ç½°å¾Œé€²è¡Œå‡ç´šåˆ¤å®š
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    
    let resultHTML = `
        <h2>ğŸ è¨“ç·´å®Œæˆ</h2>
        <div class="feedback success">å¾—åˆ†ï¼š${score} / 100</div>
        <p style="text-align:center;">ğŸ’¡ åŸºæœ¬ä¿®ç…‰ç¶“é©— +${baseExp}</p>
    `;
    if (bonusMsg) resultHTML += `<p style="text-align:center; color:green;">ğŸ‰ ${bonusMsg}</p>`;
    if (penaltyMsg) resultHTML += `<p style="text-align:center; color:red;">${penaltyMsg}</p>`;
    if (levelupMsg) resultHTML += `<p class="message msg-levelup">${levelupMsg}</p>`;

    let rewardsHTML = '';
    
    // é€±æœŸçå‹µ
    if (gameState.total > 0 && gameState.total % 5 === 0) {
        const [rewardsList] = grantRandomRewards(1);
        rewardsHTML += `<div class="message msg-reward">ğŸ‰ ç´¯ç©è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé€±æœŸçå‹µï¼<br>${rewardsList.join('<br>')}</div>`;
    }
    
    // é‡Œç¨‹ç¢‘çå‹µ
    if (TRAINING_MILESTONES[gameState.total]) {
        const milestone = TRAINING_MILESTONES[gameState.total];
        gameState.current_title = milestone.title;
        const [rewardsList] = grantRandomRewards(milestone.rewards);
        rewardsHTML += `<div class="message msg-reward">ğŸ† æ­å–œï¼è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé‡Œç¨‹ç¢‘ï¼<br>ç²å¾—æ–°ä½éšï¼šã€${milestone.title}ã€‘<br>ç²å¾—çå‹µï¼š<br>${rewardsList.join('<br>')}</div>`;
    }

    // ç‰¹å®šæ¬¡æ•¸çå‹µ
    const countRewards = checkTrainingCountRewards(prevTotalTrainCount, gameState.total);
    if (countRewards) rewardsHTML += `<div class="message msg-reward">${countRewards}</div>`;

    // éˆçŸ³çå‹µ
    let stonesAward = 0;
    if (score >= 90) stonesAward = 3;
    else if (score >= 70) stonesAward = 2;
    else if (score >= 50) stonesAward = 1;
    if (score === 100) stonesAward += 3;
    const randomDrop = Math.random() < 0.10 ? 1 : 0;
    const totalStonesGain = stonesAward + randomDrop;
    if (totalStonesGain > 0) {
        gameState.stones += totalStonesGain;
        let parts = [];
        if (stonesAward > 0) parts.push(`æ ¹æ“šè¡¨ç¾ç²å¾— ${stonesAward} éˆçŸ³`);
        if (randomDrop > 0) parts.push("å¶é‡é©šå–œï¼š+1 éˆçŸ³");
        rewardsHTML += `<p style="text-align:center; color:darkorchid">ğŸ’ ${parts.join('ï¼›')}</p>`;
    }

    saveGameState();
    // æ›´æ–°ä¸»ç•«é¢è³‡è¨Šï¼Œä»¥åæ˜ è™•ç½°èˆ‡çå‹µ
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch (e) {}
    }
    
    const comment = commentForScore(score, required);

    resultHTML += rewardsHTML;
    resultHTML += `<p style="text-align:center; color:purple; font-style:italic;">"${comment}"</p>`;
    resultHTML += `<button data-action="render-main-menu">ğŸ” å›ä¸»é¸å–®</button>`;
    app.innerHTML = resultHTML;
}

function checkTrainingCountRewards(prev, current) {
    let msg = [];
    const addItem = (itemName) => {
        gameState.inventory[itemName] = (gameState.inventory[itemName] || 0) + 1;
        if (!gameState.inventory_order.includes(itemName)) {
            gameState.inventory_order.push(itemName);
            gameState.inventory_order.sort((a, b) => {
                const keyA = getItemSortKey(a);
                const keyB = getItemSortKey(b);
                if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
                if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
                return a.localeCompare(b, 'zh-Hant');
            });
        }
    };

    if (prev < 100 && current >= 100) {
        const item = Math.random() < 0.5 ? "å…¥å“ä¸‰æ‰èšéˆé™£" : "å…¥å“å››é–€é™·æ•µé™£";
        addItem(item);
        msg.push(`ğŸ ç™¾ç…‰æˆé‹¼ï¼è¨“ç·´é” 100 æ¬¡ï¼Œé ˜æ‚Ÿé™£æ³•ï¼šã€${item}ã€‘`);
    }
    if (prev < 200 && current >= 200) {
        const item = Math.random() < 0.5 ? "å…¥å“ç¯‰åŸºåç´è¨£" : "å…¥å“æ¾é¹¤é•·é’åŠŸ";
        addItem(item);
        msg.push(`ğŸ é“å¿ƒç©©å›ºï¼è¨“ç·´é” 200 æ¬¡ï¼Œç¿’å¾—åŠŸæ³•ï¼šã€${item}ã€‘`);
    }
    if (prev < 500 && current >= 500) {
        const item = ["å…¥å“é’ç«¹åŠ", "å…¥å“éŠ…èƒŒåˆ€", "å…¥å“ç¢é›²æ§"][Math.floor(Math.random() * 3)];
        addItem(item);
        msg.push(`ğŸ é‹’èŠ’åˆéœ²ï¼è¨“ç·´é” 500 æ¬¡ï¼Œç²å¾—å…µå™¨ï¼šã€${item}ã€‘`);
    }
    return msg.join('<br>');
}

function commentForScore(score, expected) {
    const diff = score - expected;
    const feedbacks = {
        95:"é‹æ°£è¶…ç¥ï¼Œç„¡äººèƒ½æ•µï¼", 90:"é‹æ°£ç¥åŒ–ï¼Œç„¡äººèƒ½æ•µï¼", 85:"é‹æ°£çˆ†æ£šï¼Œç¾¨ç…çœ¾äººï¼", 80:"å¤©é¸ä¹‹äººï¼Œéä½ è«å±¬ï¼", 75:"çµ•å°çš„é‹æ°£æŒæ¡è€…ï¼", 70:"é‹å‹¢å¦‚è™¹ï¼Œç„¡äººèƒ½æ“‹ã€‚", 65:"å¼·é‹ä¾†è¥²ï¼Œå‹¢ä¸å¯æ“‹ã€‚", 60:"ä½ çš„é‹å‹¢å¦‚æ—¥ä¸­å¤©ã€‚", 55:"å¹¸é‹æ˜Ÿé«˜ç…§ï¼Œå‰é€”ä¼¼éŒ¦ã€‚", 50:"å¥½é‹é€£é€£ï¼Œå‹¢é ­æ­£æ—ºã€‚", 45:"ç•¥å‹ä¸€ç±Œï¼Œå‰æ™¯å¯æœŸã€‚", 40:"å¯¦åŠ›èˆ‡é‹æ°£å…¼å…·ã€‚", 35:"ç©©ç´®ç©©æ‰“ï¼Œé€æ­¥æ™‰å‡ã€‚", 30:"é‹æ°£å°šä½³ï¼Œå¯å†æ¥å†å²ã€‚", 25:"ç•¥é«˜ä¸€ç·šï¼Œå°šæœ‰é€²æ­¥ç©ºé–“ã€‚", 20:"å‹‰å¼·è¶…æ¨™ï¼Œç¹¼çºŒåŠªåŠ›ã€‚", 15:"ç¨ç¨é ˜å…ˆï¼Œé‚„éœ€æ‹¼æã€‚", 10:"å‰›å‰›å¥½éç·šï¼Œåˆ¥é¬†æ‡ˆã€‚", 5:"éšªä¸­æ±‚å‹ï¼Œé©šéšªéé—œã€‚", 0:"ä¸­è¦ä¸­çŸ©ï¼Œå‰›å¥½ç¬¦åˆé æœŸã€‚",
        [-5]:"äº›å¾®è½å¾Œï¼Œèª¿æ•´å¿ƒæ…‹ã€‚",[-10]:"å·®å¼·äººæ„ï¼Œé‚„éœ€åŠªåŠ›ã€‚",[-15]:"å°æœ‰å¤±åˆ©ï¼Œç©©ä½é™£è…³ã€‚", [-20]:"ç•¥ä½æ–¼å¹³å‡ï¼Œå†æ¥å†å²ã€‚",[-25]:"é‹å‹¢åå¼±ï¼Œç¹¼çºŒæŒ‘æˆ°ã€‚",[-30]:"è¡¨ç¾å¹³å¹³ï¼Œéœ€è¦åŠ å¼·ã€‚", [-35]:"ç¨å«Œéœè‰²ï¼Œä¸å¦‚é æœŸã€‚",[-40]:"æœ‰é»èƒŒé‹ï¼ŒæŒ¯ä½œèµ·ä¾†ã€‚",[-45]:"é‹æ°£ä¸æ¿Ÿï¼Œå†æˆ°ä¸€å ´ã€‚", [-50]:"æ˜é¡¯è½å¾Œï¼Œé‡æ•´æ——é¼“ã€‚",[-55]:"å¯¦åŠ›æœªå±•ï¼Œä¸‹æ¬¡å†ä¾†ã€‚",[-60]:"ç‹€æ³ä¸ä½³ï¼Œéœ€è¦åæ€ã€‚", [-65]:"é‹æ°£ä½è¿·ï¼Œæ³¨æ„è½‰é‹ã€‚",[-70]:"å¤§å¹…å¤±åˆ©ï¼Œå†æ¥å†å²ã€‚",[-75]:"ä»Šæ—¥ä¸å®œå‡ºé–€â€¦", [-80]:"è«¸äº‹ä¸é †ï¼Œå¿è€ç‚ºä¸Šã€‚",[-85]:"èƒŒé‹çºèº«ï¼Œè«‹å°å¿ƒè¡Œäº‹ã€‚",[-90]:"æ¥µåº¦èƒŒé‹ï¼Œå¿«å»æ±‚ç¥å•åœã€‚"
    };
    const closest = Object.keys(feedbacks).reduce((prev, curr) => Math.abs(curr - diff) < Math.abs(prev - diff) ? curr : prev);
    return feedbacks[closest] || "é‹å‹¢æœªçŸ¥ï¼Œä¿æŒå¹³å¸¸å¿ƒã€‚";
}


// ===================== éŠæˆ²é¡Œåº«ç”Ÿæˆ =====================
// â–¼â–¼â–¼ MAJOR FIX: Corrected the logic to ensure answer positions are truly random. â–¼â–¼â–¼
function game_template(title, pool, total, columns=5, btnSize=60) {
    // 1. å¾é¡Œåº«ä¸­éš¨æ©Ÿé¸å‡ºæœ¬æ¬¡è¦é¡¯ç¤ºçš„æ‰€æœ‰é¸é …
    const itemsForDisplay = [...pool].sort(() => 0.5 - Math.random()).slice(0, total);

    // 2. æ±ºå®šæ­£ç¢ºç­”æ¡ˆçš„æ•¸é‡
    const correctCount = generateCorrectChoices(total);

    // 3. å¾å‰›å‰›é¸å‡ºçš„é¸é …ä¸­ï¼Œ**å†æ¬¡éš¨æ©ŸæŒ‘é¸**å‡ºæ­£ç¢ºç­”æ¡ˆ
    //    é€™æ˜¯ä¿®æ­£çš„æ ¸å¿ƒï¼Œç¢ºä¿æ­£ç¢ºç­”æ¡ˆä¸æ˜¯å›ºå®šåœ¨å‰å¹¾å€‹
    const correctAnswers = [...itemsForDisplay].sort(() => 0.5 - Math.random()).slice(0, correctCount);

    // 4. å°‡éš¨æ©Ÿæ’åˆ—çš„é¸é …å’Œéš¨æ©Ÿé¸å®šçš„ç­”æ¡ˆå‚³éçµ¦æ¸²æŸ“å‡½å¼
    renderTrainingScreen(title, itemsForDisplay, correctAnswers, columns, btnSize);
}

function generateCorrectChoices(total) {
    const ratio = 1 - (trainingState.difficulty / 10);
    let correctCount = Math.max(1, Math.floor(total * ratio));
    if (trainingState.difficulty === 1 && correctCount === total) {
        correctCount--;
    }
    return correctCount;
}

// Assign game functions to the window object so they can be called by string name
window.game_guess_hidden = () => { const n = 10; game_template("å¾ 1ï½10 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_20 = () => { const n = 20; game_template("å¾ 1ï½20 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_30 = () => { const n = 30; game_template("å¾ 1ï½30 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 6); }
window.game_treasure_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("å¯¶ç®±è¨“ç·´", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_gift_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("ç¦®ç‰©è¨“ç·´", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_emoji_pick = () => { game_template("é¸å‡ºå¥½é‹è¡¨æƒ…ç¬¦è™Ÿ", EMOJIS, EMOJIS.length, 5); }
window.game_animals = () => { game_template("é¸å‡ºå¹¸é‹å‹•ç‰©", ANIMALS, ANIMALS.length, 5); }
window.game_foods = () => { game_template("é¸å‡ºå¹¸é‹é£Ÿç‰©", FOODS, FOODS.length, 5); }
window.game_places = () => { game_template("é¸å‡ºå¹¸é‹åœ°é»", PLACES, PLACES.length, 5); }
window.game_shape_select = () => { game_template("é¸å‡ºå¹¸é‹åœ–å½¢", SHAPES, SHAPES.length, 5); }
window.game_color_select = () => { game_template("æ‰¾å‡ºå¹¸é‹é¡è‰²", COLORS, COLORS.length, 5); }
window.game_flags = () => { game_template("é¸å‡ºå¹¸é‹åœ‹æ——", FLAGS, FLAGS.length, 5); }
window.game_nature = () => { game_template("é¸å‡ºå¹¸é‹è‡ªç„¶ç¾è±¡", NATURE, NATURE.length, 5); }
window.game_cards = () => { game_template("é¸å‡ºå¹¸é‹æ’²å…‹ç‰Œ", CARDS, CARDS.length, 10, 48); }
window.game_mahjong = () => { game_template("é¸å‡ºå¹¸é‹éº»å°‡", MAHJONG, MAHJONG.length, 7); }
window.game_vehicles = () => { game_template("é¸å‡ºå¹¸é‹äº¤é€šå·¥å…·", VEHICLES, VEHICLES.length, 6); }
window.game_zodiacs = () => { game_template("é¸å‡ºå¹¸é‹æ˜Ÿåº§", ZODIACS, ZODIACS.length, 6); }
window.game_lucky_period = () => { game_template("æŒ‘é¸å¹¸é‹æ™‚æ®µ", CLOCKS, CLOCKS.length, 6, 48); }
window.game_professions = () => { game_template("é¸å‡ºå¹¸é‹è·æ¥­", PROFESSIONS, PROFESSIONS.length, 7, 56); }
window.game_sports = () => { game_template("æŒ‘é¸é‹å‹•èˆ‡çé …", SPORTS, SPORTS.length, 6, 48); }
window.game_office = () => { game_template("æŒ‘é¸è¾¦å…¬æ–‡å…·", OFFICE, OFFICE.length, 6, 48); }
window.game_tools = () => { game_template("æŒ‘é¸å·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–", TOOLS, TOOLS.length, 6, 48); }

// æ–°å¢ä¸‰ç¨®åœ–ç¤ºè¨“ç·´å‡½å¼
// è‡ªå‹•æ‹†åˆ†å¾Œçš„å››å€‹é¡Œåº«å‡½å¼
window.game_office_a = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·A", OFFICE_A, OFFICE_A.length, 6, 48); };
window.game_office_b = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·B", OFFICE_B, OFFICE_B.length, 6, 48); };
window.game_tools_a = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–A", TOOLS_A, TOOLS_A.length, 6, 48); };
window.game_tools_b = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–B", TOOLS_B, TOOLS_B.length, 6, 48); };

window.game_sports_awards = () => { game_template("é¸å‡ºé«”è‚²èˆ‡çé …", SPORTS, SPORTS.length, 6, 48); };
window.game_office_supplies = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·", OFFICE, OFFICE.length, 6, 48); };
window.game_tools_others = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–", TOOLS, TOOLS.length, 6, 48); };


// ===================== æ¸¬è©¦é‹æ°£ç³»çµ± =====================

function renderTestLuckMenu() {
    clearApp();
    grantDailyTicketIfNeeded();
    const tickets = gameState.luck_tickets;
    app.innerHTML = `
        <h2>ğŸ§ª æ¸¬è©¦ä½ çš„é‹æ°£</h2>
        <div class="info-section" style="padding:10px;">
            <p>æŠ½å¡æ¨¡å¼å°‡éš¨æ©Ÿç²å¾—ä¿®ç…‰ç¶“é©—ã€éˆçŸ³ã€ç¥¨åˆ¸æˆ–é“å…·ã€‚</p>
            <p>ğŸŸï¸ ç›®å‰æ¸¬è©¦æ©Ÿæœƒï¼š${tickets} æ¬¡</p>
            <p>ğŸ“… ä»Šæ—¥é‹å‹¢ä¸æ¶ˆè€—ç¥¨ã€‚</p>
        </div>
        <button data-action="run-luck-draw" data-draws="1" data-mode="å¹¸é‹æŠ½å¡å–®æŠ½" ${tickets < 1 ? 'disabled' : ''}>ğŸƒ å–®æŠ½ (æ¶ˆè€— 1 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="3" data-mode="å¹¸é‹æŠ½å¡ä¸‰æŠ½" ${tickets < 3 ? 'disabled' : ''}>ğŸƒ ä¸‰æŠ½ (æ¶ˆè€— 3 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="10" data-mode="å¹¸é‹æŠ½å¡10é€£æŠ½" ${tickets < 10 ? 'disabled' : ''}>ğŸƒ åé€£æŠ½ (æ¶ˆè€— 10 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="100" data-mode="å¹¸é‹æŠ½å¡100é€£æŠ½" ${tickets < 100 ? 'disabled' : ''}>ğŸƒ ç™¾é€£æŠ½ (æ¶ˆè€— 100 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="1000" data-mode="å¹¸é‹æŠ½å¡1000é€£æŠ½" ${tickets < 1000 ? 'disabled' : ''}>ğŸƒ åƒé€£æŠ½ (æ¶ˆè€— 1000 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="${tickets}" data-mode="å¹¸é‹æŠ½å¡å…¨éƒ¨æŠ½" ${tickets < 1 ? 'disabled' : ''}>ğŸƒ å…¨éƒ¨æŠ½ (æ¶ˆè€— ${tickets} ç¥¨)</button>
        <button data-action="run-today-luck">ğŸ“… ä»Šæ—¥é‹å‹¢ (æ¯æ—¥ä¸€æ¬¡ï½œå…è²»)</button>
        <hr>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1" data-cost="${REDEEM_1_COST}">ğŸ« å…Œæ› 1 å¼µ (-${REDEEM_1_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="5" data-cost="${REDEEM_5_COST}">ğŸ« å…Œæ› 5 å¼µ (-${REDEEM_5_COST} EXP)</button>
        <hr>
        <button data-action="show-luck-history">ğŸ“ˆ æŸ¥çœ‹æ­·å²èˆ‡çµ±è¨ˆ</button>
        <button data-action="render-main-menu">ğŸ”™ è¿”å›ä¸»é¸å–®</button>
    `;
    showTemporaryMessages();
    // å°è¡Œå‹•è£ç½®ä¿®è£œç®­é ­åœ–ç¤º
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

function redeemTickets(pieces, cost) {
    if (gameState.exp < cost) {
        addTemporaryMessage(`âš ï¸ EXP ä¸è¶³ (éœ€è¦ ${cost}ï¼Œç›®å‰ ${gameState.exp})`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.luck_tickets += pieces;
        gameState.luck_tickets_total += pieces;
        addTemporaryMessage(`âœ… å…Œæ›æˆåŠŸï¼š-${cost} EXP â†’ +${pieces} ç¥¨`, 'msg-shop');
        saveGameState();
    }
    renderTestLuckMenu();
}

function runLuckDraw(draws, mode) {
    if (gameState.luck_tickets < draws || draws <= 0) {
        addTemporaryMessage(`âš ï¸ æ¸¬è©¦æ©Ÿæœƒä¸è¶³ï¼`, 'msg-shop-fail');
        renderTestLuckMenu();
        return;
    }
    gameState.luck_tickets -= draws;
    
    const [details, totals] = grantRandomRewards(draws);
    
    let summaryParts = [];
    if (totals.exp > 0) summaryParts.push(`+${totals.exp} EXP`);
    if (totals.stones > 0) summaryParts.push(`+${totals.stones} éˆçŸ³`);
    if (totals.tickets > 0) summaryParts.push(`+${totals.tickets} ç¥¨åˆ¸`);
    if (Object.keys(totals.items).length > 0) {
        const totalItems = Object.values(totals.items).reduce((a, b) => a + b, 0);
        summaryParts.push(`+${totalItems} ä»¶é“å…·`);
    }

    const summaryMsg = summaryParts.length > 0 ? summaryParts.join('ã€') : "ä»€éº¼éƒ½æ²’æœ‰...";
    addLuckHistory(mode, 0, "", totals.exp, summaryMsg);
    
    renderDrawResult(summaryMsg, details, mode, draws);
}

function addLuckHistory(mode, value, category, expGain, rewardMsg) {
    gameState.luck_tests_total++;
    gameState.luck_history.push({
        time: new Date().toLocaleString('sv-SE'), // YYYY-MM-DD HH:MM:SS
        mode, value, category, exp: expGain, reward_msg: rewardMsg
    });
    if (gameState.luck_history.length > 200) {
        gameState.luck_history.shift();
    }
    saveGameState();
}

function grantRandomRewards(count) {
    let rewardsList = [], totals = { exp: 0, stones: 0, tickets: 0, items: {} };
    
    const itemPool = Object.keys(ITEM_STONE_PRICES);
    const weights = itemPool.map(item => {
        const price = ITEM_STONE_PRICES[item] || 1;
        const grade = GRADE_NAMES.findIndex(g => item.startsWith(g)) + 1 || 1;
        return 1000 / (price * grade + 1);
    });

    const getScaledRandomAmount = (min, max) => {
        const bias_factor = Math.pow(gameState.stage_idx / CULTIVATION_STAGES.length, 2);
        const mode = min + (max - min) * bias_factor;
        const u = Math.random();
        // triangular distribution formula
        return Math.ceil(u < (mode - min) / (max - min) ? min + Math.sqrt(u * (max - min) * (mode - min)) : max - Math.sqrt((1 - u) * (max - min) * (max - mode)));
    };

    for (let i = 0; i < count; i++) {
        const rand = Math.random() * 100;
        let rewardType;
        if (rand < 40) rewardType = "exp";
        else if (rand < 70) rewardType = "stones";
        else if (rand < 85) rewardType = "tickets";
        else rewardType = "item";

        if (rewardType === 'exp') {
            const amount = getScaledRandomAmount(1, 1000);
            totals.exp += amount;
            rewardsList.push(`ç²å¾— ä¿®ç…‰ç¶“é©— +${amount}`);
        } else if (rewardType === 'stones') {
            const amount = getScaledRandomAmount(1, 100);
            totals.stones += amount;
            rewardsList.push(`ç²å¾— éˆçŸ³ +${amount}`);
        } else if (rewardType === 'tickets') {
            const amount = getScaledRandomAmount(1, 5);
            totals.tickets += amount;
            rewardsList.push(`ç²å¾— ç¥¨åˆ¸ +${amount}`);
        } else if (rewardType === 'item') {
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let randWeight = Math.random() * totalWeight;
            let itemName = itemPool[itemPool.length - 1];
            for(let j=0; j<weights.length; j++){
                if(randWeight < weights[j]){
                    itemName = itemPool[j];
                    break;
                }
                randWeight -= weights[j];
            }
            const amount = getScaledRandomAmount(1, 10);
            totals.items[itemName] = (totals.items[itemName] || 0) + amount;
            rewardsList.push(`ç²å¾— é“å…· [${itemName}] Ã—${amount}`);
        }
    }

    const prevExp = gameState.exp;
    gameState.exp += totals.exp;
    gameState.stones += totals.stones;
    gameState.luck_tickets += totals.tickets;
    Object.entries(totals.items).forEach(([name, qty]) => {
        gameState.inventory[name] = (gameState.inventory[name] || 0) + qty;
         if (!gameState.inventory_order.includes(name)) gameState.inventory_order.push(name);
    });
    if(Object.keys(totals.items).length > 0){
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }

    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    if (levelupMsg) rewardsList.push(`<span class="msg-levelup">${levelupMsg}</span>`);
    
    saveGameState();
    return [rewardsList, totals];
}

function runTodayLuck() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_luck_date === today) {
        showTodayLuckResult(true);
        return;
    }

    const [rewardsList, totals] = grantRandomRewards(1);
    const rewardMsg = rewardsList[0] || "ä»Šæ—¥å¹³æ·¡ç„¡å¥‡...";

    gameState.last_luck_date = today;
    gameState.last_luck_reward_msg = rewardMsg;

    addLuckHistory("ä»Šæ—¥é‹å‹¢", 0, "å‹•æ…‹çå‹µ", totals.exp, rewardMsg);
    showTodayLuckResult(false);
}

function renderDrawResult(summary, details, mode, draws) {
    clearApp();
    const currentStage = getCultivationStage(gameState.exp);
    
    app.innerHTML = `
        <h2>ğŸƒ ${mode} çµæœ</h2>
        <div class="feedback info">ğŸ ç¸½è¨ˆï¼š${summary}</div>
        <div style="height: 150px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px; margin-bottom:15px;">
            ${details.join('<br>')}
        </div>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}</p>
            <p>ç´¯ç© EXPï¼š${gameState.exp}</p>
        </div>
        <button data-action="run-luck-draw" data-draws="${draws}" data-mode="${mode}" ${gameState.luck_tickets < draws ? 'disabled' : ''}>ğŸ” å†ä¾†ä¸€æ¬¡ (${draws} ç¥¨)</button>
        <button data-action="show-luck-history">ğŸ“ˆ æŸ¥çœ‹æ­·å²èˆ‡çµ±è¨ˆ</button>
        <button data-action="render-test-luck-menu">ğŸ”™ è¿”å›æ¸¬è©¦é¸å–®</button>
        <button data-action="render-main-menu">ğŸ  å›ä¸»é¸å–®</button>
    `;
}

function showTodayLuckResult(isRepeat) {
    clearApp();
    const luckySuggestion = () => {
        const seed = parseInt(new Date().toISOString().slice(0, 10).replace(/-/g, ''), 10);
        const rng = (s) => () => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
        const rand = rng(seed);
        const lucky_num = Math.floor(rand() * 39) + 1;
        const lucky_color = COLORS[Math.floor(rand() * COLORS.length)];
        const lucky_emoji = EMOJIS[Math.floor(rand() * EMOJIS.length)];
        const lucky_dir = ["ä¸Š", "ä¸‹", "å·¦", "å³", "å·¦ä¸Š", "å³ä¸Š", "å³ä¸‹", "å·¦ä¸‹"][Math.floor(rand() * 8)];
        return `å¹¸é‹è™Ÿç¢¼ï¼š${lucky_num} | å¹¸é‹è‰²ï¼š${lucky_color} | å¹¸é‹è¡¨æƒ…ï¼š${lucky_emoji} | å¹¸é‹æ–¹ä½ï¼š${lucky_dir}`;
    };

    app.innerHTML = `
        <h2>ğŸ“… ä»Šæ—¥é‹å‹¢</h2>
        <div class="feedback" style="color:darkorange">${isRepeat ? '(ä»Šæ—¥å·²æ¸¬) ' : ''}${gameState.last_luck_reward_msg}</div>
        <p style="text-align:center;">${luckySuggestion()}</p>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${getCultivationStage(gameState.exp)}</p>
        </div>
        <button data-action="render-test-luck-menu">ğŸ”™ è¿”å›æ¸¬è©¦é¸å–®</button>
        <button data-action="render-main-menu">ğŸ  å›ä¸»é¸å–®</button>
    `;
}

// ===================== é›œé …åŠŸèƒ½ & é‡ç½® =====================
function exchangeStones(count) {
    const cost = STONE_EXCHANGE_COST * count;
    if (gameState.exp < cost) {
        addTemporaryMessage(`âš ï¸ EXP ä¸è¶³ï¼Œç„¡æ³•å…Œæ›`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.stones += count;
        handleLevelUp(gameState.exp + cost, gameState.exp); // Recalculate level
        addTemporaryMessage(`âœ… å…Œæ›æˆåŠŸï¼š-${cost} EXP â†’ +${count} éˆçŸ³`, 'msg-shop');
        saveGameState();
    }
    renderMainMenu();
}

function resetTrainingStats() {
    if (confirm("ç¢ºå®šè¦æ­¸é›¶æ‰€æœ‰è¨“ç·´çµ±è¨ˆã€ç¶“é©—ã€é“å…·å’Œç­‰ç´šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        gameState = JSON.parse(JSON.stringify(defaultStats));
        saveGameState();
        renderMainMenu();
    }
}

function clearMaxScores() {
    if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é›£åº¦çš„æœ€é«˜åˆ†ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        maxScores = {};
        saveGameState();
        renderMainMenu();
    }
}


// ===================== Modal (å½ˆå‡ºè¦–çª—) ç³»çµ± =====================
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalFooter = document.getElementById('modal-footer');
const modalCloseBtn = document.getElementById('modal-close-btn');

modalCloseBtn.onclick = () => modal.style.display = "none";
window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function showModal(title, bodyHTML, footerHTML = '') {
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHTML;
    modalFooter.innerHTML = footerHTML;
    modal.style.display = "flex";
}

function showStageList() {
    // åˆ—å‡ºå„å±¤ç´šæ‰€éœ€çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸é–€æª»
    const content = CULTIVATION_STAGES.map(([exp,, name]) => {
        const requiredTrain = getRequiredTrainingsForExp(exp);
        return `<li><b>${name}</b>ï¼šéœ€ä¿®ç…‰ç¶“é©— ${exp}ï¼Œè¨“ç·´æ¬¡æ•¸é–€æª» ${requiredTrain}</li>`;
    }).join('');
    showModal("ä¿®ä»™ç­‰ç´šä¸€è¦½è¡¨", `<ul style="padding-left: 20px;">${content}</ul>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

function showRankList() {
    let content = 'ä»™é–€ä½éšæ˜¯æ ¹æ“šæ‚¨çš„ç¸½è¨“ç·´æ¬¡æ•¸æˆäºˆçš„æ¦®è­½ç¨±è™Ÿï¼š<br><br><ul style="padding-left: 20px;">';
    content += Object.entries(TRAINING_MILESTONES).map(([count, data]) => `<li>è¨“ç·´ <b>${count}</b> æ¬¡ï¼šæˆäºˆä½éšã€${data.title}ã€‘</li>`).join('');
    showModal("ä»™é–€ä½éšå°è™Ÿä¸€è¦½è¡¨", `${content}</ul>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

function showLuckHistory() {
    let content = '';
    if (!gameState.luck_history || gameState.luck_history.length === 0) {
      content = "å°šç„¡æ­·å²ç´€éŒ„ã€‚";
    } else {
      const totalExp = gameState.luck_history.reduce((s, h) => s + (h.exp || 0), 0);
      content += `<p><b>ç´¯ç©ç¶“é©— +${totalExp}</b></p><hr>`;
      content += '<ul style="padding-left: 20px; word-break: break-all;">';
      gameState.luck_history.slice().reverse().slice(0, 50).forEach(h => {
        content += `<li>[${h.time}] <b>${h.mode}</b> â†’ ${h.reward_msg || `${h.value} (${h.category})`} (EXP +${h.exp})</li>`;
      });
      content += '</ul>';
    }
    showModal("æ¸¬è©¦é‹æ°£æ­·å²", content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// éŠæˆ²è¦å‰‡èªªæ˜ï¼šè©³ç´°èªªæ˜å‡ç´šçå‹µã€é—œå¡ã€é“å…·åŠŸèƒ½ä»¥åŠè™•ç½°æ©Ÿåˆ¶ã€‚
// # æ–°å¢éŠæˆ²è¦å‰‡èªªæ˜æŒ‰éˆ•å°æ‡‰çš„å‡½å¼
function showGameRules() {
    /* # éŠæˆ²è¦å‰‡ï¼š
       1. å‡ç´šçå‹µèªªæ˜ï¼šç•¶ä½ çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸åŒæ™‚é”åˆ°ä¸‹ä¸€å±¤é–€æª»ï¼Œ
          ä¿®ç‚ºæœƒè‡ªå‹•çªç ´ã€‚æ¯çªç ´ä¸€å±¤ï¼Œå°‡ç²å¾—ä¸€å®šæ•¸é‡çš„æ¸¬è©¦æ©Ÿæœƒèˆ‡éˆçŸ³çå‹µã€‚
       2. éŠæˆ²é—œå¡èªªæ˜ï¼šè¨“ç·´å…±æœ‰ 10 ç¨®é›£åº¦ï¼Œæ¯å›åˆåŒ…å« 20 é¡Œåœ–ç¤ºï¼Œè«‹åœ¨å€’æ•¸æ™‚é–“å…§é¸å‡ºç›®æ¨™ã€‚ç­”å°å¯ç´¯ç©ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸ï¼Œé”åˆ°è©²é›£åº¦è¦æ±‚çš„å‹ç‡å¯ç²å¾—é¡å¤–ç¶“é©—åŠ æˆã€‚
       3. é“å…·å‡ç´šåŠåŠŸèƒ½èªªæ˜ï¼šé“å…·åˆ†ç‚ºå…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ã€ä»™ä¸¹ç­‰é¡ï¼š
          - å…µå™¨ï¼šå¢åŠ å¯é¸ç­”æ¡ˆæ•¸ï¼Œå¯åœ¨å¤šé¸é¡Œä¸­ä½¿ç”¨ï¼›
          - åŠŸæ³•ï¼šæ’é™¤éƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆï¼›
          - é™£æ³•ï¼šå¢åŠ ç•¶é¡Œä½œç­”æ™‚é–“ï¼›
          - éˆå™¨ï¼šé¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆï¼›
          - éˆç¬¦ï¼šé¡¯ç¤ºéƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆï¼›
          - ä»™ä¸¹ï¼šç«‹å³å¢åŠ ä¿®ç…‰ç¶“é©—ã€‚
          é“å…·å¯ä»¥åœ¨å•†åº—è³¼è²·ï¼Œæˆ–é€éæ¶ˆè€—éˆçŸ³å‡ç´šç‚ºæ›´é«˜å“éšï¼Œæ•ˆæœå°‡æ›´å¼·ã€‚å‡ç´šæ¶ˆè€—çš„éˆçŸ³æœƒå³æ™‚æ‰£é™¤ä¸¦æ›´æ–°é¡¯ç¤ºã€‚
       4. è™•ç½°æ©Ÿåˆ¶ï¼šè‹¥è¨“ç·´çµæŸæ™‚å¾—åˆ†ä½æ–¼è©²é›£åº¦è¦æ±‚çš„å‹ç‡é–€æª»ï¼Œå°‡æ‰£æ¸›ä¿®ç…‰ç¶“é©—ã€‚å·®è·æ¯å¢åŠ  5 åˆ†ï¼Œè™•ç½°ç‡ç¿»å€ï¼šå·® 5 åˆ†æ‰£ 1%ï¼Œå·® 10 åˆ†æ‰£ 2%ï¼Œå·® 15 åˆ†æ‰£ 4%ï¼Œå·® 20 åˆ†æ‰£ 8%ï¼Œå·® 25 åˆ†æ‰£ 16%ï¼Œå·® 30 åˆ†æ‰£ 32%ï¼Œä»¥æ­¤é¡æ¨ã€‚ç•¶ä¿®ç…‰ç¶“é©—ç‚º 0 æ™‚ä¸å†æ‰£æ¸›ã€‚*/
    const content = `
        <div style="text-align:left;">
            <h3>1. å‡ç´šçå‹µèªªæ˜</h3>
            <p>ç•¶ä½ çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸åŒæ™‚é”åˆ°ä¸‹ä¸€å±¤é–€æª»æ™‚ï¼Œä¿®ç‚ºæœƒè‡ªå‹•çªç ´ã€‚æ¯çªç ´ä¸€å±¤ï¼Œä¾æ“šçªç ´å±¤ç´šå·®è·ç²å¾—ç›¸æ‡‰æ•¸é‡çš„æ¸¬è©¦æ©Ÿæœƒèˆ‡éˆçŸ³ã€‚</p>
            <h3>2. éŠæˆ²é—œå¡èªªæ˜</h3>
            <p>è¨“ç·´å…±æœ‰ 10 å€‹é›£åº¦ï¼Œæ¯å›åˆåŒ…å« 20 é¡Œåœ–ç¤ºï¼Œè«‹åœ¨å€’æ•¸æ™‚é–“å…§é¸å‡ºç›®æ¨™ã€‚ç­”å°èƒ½ç´¯ç©ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸ï¼›é”åˆ°è©²é›£åº¦è¦æ±‚çš„å‹ç‡ï¼Œå¯é¡å¤–ç²å¾—ä¿®ç…‰ç¶“é©—çå‹µã€‚</p>
            <h3>3. é“å…·å‡ç´šåŠåŠŸèƒ½èªªæ˜</h3>
            <p>é“å…·åˆ†ç‚ºå…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ã€ä»™ä¸¹ç­‰é¡ï¼Œæ¯ç¨®é“å…·åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
            <ul>
                <li><b>å…µå™¨</b>ï¼šå¢åŠ å¯é¸ç­”æ¡ˆæ•¸ï¼Œå¯ç”¨æ–¼å¤šé¸é¡Œã€‚</li>
                <li><b>åŠŸæ³•</b>ï¼šæ’é™¤éƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆã€‚</li>
                <li><b>é™£æ³•</b>ï¼šå¢åŠ ä½œç­”æ™‚é–“ï¼Œåƒ…å°ç•¶é¡Œæœ‰æ•ˆã€‚</li>
                <li><b>éˆå™¨</b>ï¼šé¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆã€‚</li>
                <li><b>éˆç¬¦</b>ï¼šé¡¯ç¤ºéƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆã€‚</li>
                <li><b>ä»™ä¸¹</b>ï¼šç«‹å³å¢åŠ ä¿®ç…‰ç¶“é©—ã€‚</li>
            </ul>
            <p>é“å…·å¯åœ¨å•†åº—è³¼è²·ï¼Œæˆ–ä½¿ç”¨éˆçŸ³é€²è¡Œå‡ç´šä»¥æå‡æ•ˆæœã€‚å‡ç´šæ™‚æ¶ˆè€—çš„éˆçŸ³æœƒå³åˆ»å¾ä½ çš„å¸³æˆ¶æ‰£é™¤ä¸¦åˆ·æ–°ä¸»ç•«é¢ã€‚</p>
            <h3>4. è™•ç½°æ©Ÿåˆ¶</h3>
            <p>è‹¥è¨“ç·´çµç®—å¾—åˆ†ä½æ–¼è©²é›£åº¦è¦æ±‚çš„å‹ç‡é–€æª»ï¼Œä½ çš„ä¿®ç…‰ç¶“é©—å°‡è¢«æ‰£æ¸›ã€‚èˆ‡é–€æª»å·®è·æ¯å¢åŠ  5 åˆ†ï¼Œè™•ç½°ç‡ç¿»å€ï¼šå·® 5 åˆ†æ‰£ 1%ï¼Œå·® 10 åˆ†æ‰£ 2%ï¼Œå·® 15 åˆ†æ‰£ 4%ï¼Œå·® 20 åˆ†æ‰£ 8%ï¼Œå·® 25 åˆ†æ‰£ 16%ï¼Œå·® 30 åˆ†æ‰£ 32%ï¼Œä¾æ­¤é¡æ¨ã€‚ç•¶ä¿®ç…‰ç¶“é©—ç‚º 0 æ™‚ä¸å†æ‰£æ¸›ã€‚</p>
        </div>
    `;
    showModal("ğŸ“œ éŠæˆ²è¦å‰‡èªªæ˜", content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// æ›´æ–°ä¸»é¸å–®è³‡æ–™ï¼Œä¾‹å¦‚ä¿®ç…‰ç¶“é©—ã€éˆçŸ³èˆ‡è¨“ç·´æ¬¡æ•¸ç­‰ã€‚
// # ç•¶æ¶ˆè€—æˆ–å¢åŠ ä¿®ç…‰ç¶“é©—/éˆçŸ³å¾Œï¼Œå¯èª¿ç”¨æ­¤å‡½å¼å³æ™‚æ›´æ–°ä¸»é¸å–®é¡¯ç¤ºã€‚
function updateMainMenuInfo() {
    const info = document.querySelector('.info-section');
    if (!info) return;
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    const ps = info.querySelectorAll('p');
    if (ps[0]) ps[0].innerHTML = `ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}`;
    if (ps[1]) ps[1].innerHTML = `ğŸ–ï¸ ç›®å‰ä»™é–€ä½éšï¼š${gameState.current_title}`;
    let tip = "ğŸŒŸ ä½ å·²é”åˆ°æœ€çµ‚ä¿®ç‚ºï¼";
    let progressVal = 100;
    if (nextInfo) {
        tip = `â¬†ï¸ è·é›¢ã€Œ${nextInfo.next_stage}ã€é‚„å·® ${nextInfo.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfo.train_needed} æ¬¡`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            progressVal = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    if (ps[2]) ps[2].innerHTML = tip;
    const progressEl = info.querySelector('progress');
    if (progressEl) progressEl.value = progressVal;
    if (ps[3]) ps[3].innerHTML = `ğŸ‹ï¸ ç´¯ç©è¨“ç·´æ¬¡æ•¸ï¼š${gameState.total} | âš”ï¸ ä¿®ç…‰ç¶“é©—ï¼š${gameState.exp} | â­ æœ€é«˜åˆ†ï¼š${highestScore}`;
    if (ps[4]) ps[4].innerHTML = `ğŸŸï¸ æ¸¬è©¦æ©Ÿæœƒï¼š${gameState.luck_tickets} æ¬¡ (ç´¯ç©ç²å¾—ï¼š${gameState.luck_tickets_total})`;
    if (ps[5]) ps[5].innerHTML = `ğŸ’ éˆçŸ³ï¼š${gameState.stones}`;
}

function showBackpack() {
    const sortedInventory = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      // ä½¿ç”¨ compareItemNames ç¢ºä¿ä¾é¡å‹èˆ‡å“éšæ’åº
      .sort(([a], [b]) => compareItemNames(a, b));
    let content = '';
    if (sortedInventory.length === 0) {
      content = "<p>èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p>";
    } else {
      content = '<ul style="padding-left: 20px;">' +
        sortedInventory.map(([name, qty]) => `<li>${name} Ã—${qty}</li>`).join('') +
        '</ul>';
    }
    const footer = `
      <button data-action="use-exp-items">ğŸµ ä½¿ç”¨ä»™ä¸¹</button>
      <button class="btn-danger" data-action="delete-items">ğŸ—‘ï¸ åˆªé™¤é“å…·</button>`;
    showModal("ğŸ’ èƒŒåŒ…", content, footer);
}

// === ä½¿ç”¨ä»™ä¸¹ï¼ˆEXP é¡ï¼‰===
function showUseExpDialog() {
  const expItems = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp'))
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (expItems.length === 0) {
    content = "<p>æ²’æœ‰å¯ç”¨çš„ä»™ä¸¹é¡é“å…·</p>";
  } else {
    content = expItems.map(([name, qty]) => {
      const eff = ITEM_EFFECTS[name] || {};
      const addExp = eff.n || 0;
      return `
        <div class="modal-item-row">
          <label for="useexp-${name}">${name}ï¼ˆæŒæœ‰ ${qty}ï¼‰â†’ æ¯é¡† +${addExp} EXP</label>
          <input type="number" id="useexp-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
  }
  const footer = `
    <button data-action="fill-all-exp">å…¨éƒ¨å¡«æ»¿</button>
    <button data-action="confirm-use-exp">ç¢ºèªä½¿ç”¨</button>
    <button data-action="confirm-use-exp-all" class="btn-warning">å…¨éƒ¨ä½¿ç”¨</button>`;
  showModal("ğŸµ ä½¿ç”¨ä»™ä¸¹", content, footer);
}

function confirmUseExp() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  let totalGain = 0;
  const inv = gameState.inventory;
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('useexp-', '');
    const eff = ITEM_EFFECTS[name] || {};
    const add = (eff.n || 0) * qty;
    const cur = inv[name] || 0;
    inv[name] = Math.max(0, cur - qty);
    totalGain += add;
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("ğŸµ ä½¿ç”¨çµæœ",
      `<p>å…±ç²å¾— +${totalGain} EXP</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">é—œé–‰</button>`);
  } else {
    showModal("ğŸµ ä½¿ç”¨çµæœ", "<p>æœªé¸æ“‡ä»»ä½•ä»™ä¸¹ã€‚</p>", `<button data-action="close-modal">é—œé–‰</button>`);
  }
}

// === æ‰¹é‡å¡«æ»¿èˆ‡å…¨éƒ¨ä½¿ç”¨ EXP é¡ä»™ä¸¹ ===
function fillAllExpInputs() {
  const inputs = modalBody.querySelectorAll('input[id^="useexp-"]');
  inputs.forEach(input => {
    const max = parseInt(input.getAttribute('max') || '0', 10);
    if (max > 0) input.value = String(max);
  });
}

function confirmUseExpAll() {
  const inv = gameState.inventory;
  let totalGain = 0;
  Object.entries(inv).forEach(([name, qty]) => {
    if (qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp')) {
      const eff = ITEM_EFFECTS[name];
      const add = (eff.n || 0) * qty;
      inv[name] = 0;
      totalGain += add;
    }
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("ğŸµ ä½¿ç”¨çµæœ",
      `<p>å…±ç²å¾— +${totalGain} EXPï¼ˆå…¨éƒ¨ä½¿ç”¨ï¼‰</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">é—œé–‰</button>`);
  } else {
    showModal("ğŸµ ä½¿ç”¨çµæœ", "<p>æ²’æœ‰å¯ç”¨çš„ä»™ä¸¹ã€‚</p>", `<button data-action="close-modal">é—œé–‰</button>`);
  }
}

// === åˆªé™¤é“å…· ===
function showDeleteItemsDialog() {
  const deletables = Object.entries(gameState.inventory)
    .filter(([, qty]) => qty > 0)
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (deletables.length === 0) {
    content = "<p>èƒŒåŒ…æ²’æœ‰å¯ä»¥åˆªé™¤çš„é“å…·</p>";
  } else {
    content = deletables.map(([name, qty]) => `
      <div class="modal-item-row">
        <label for="del-${name}">${name}ï¼ˆæŒæœ‰ ${qty}ï¼‰</label>
        <input type="number" id="del-${name}" min="0" max="${qty}" value="0" />
      </div>`).join('');
  }
  const footer = `<button data-action="confirm-delete-items">ç¢ºèªåˆªé™¤</button>`;
  showModal("ğŸ—‘ï¸ åˆªé™¤é“å…·", content, footer);
}

function confirmDeleteItems() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  const inv = gameState.inventory;
  let removedList = [];
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('del-', '');
    const cur = inv[name] || 0;
    const rm = Math.min(qty, cur);
    if (rm > 0) {
      inv[name] = cur - rm;
      removedList.push(`${name} Ã—${rm}`);
    }
  });
  saveGameState();
  showModal("ğŸ—‘ï¸ åˆªé™¤çµæœ",
    removedList.length ? `<p>å·²åˆªé™¤ï¼š${removedList.join('ã€')}</p>` : "<p>æœªåˆªé™¤ä»»ä½•é“å…·</p>",
    `<button data-action="close-modal">é—œé–‰</button>`);
}

function showShop() {
    const sortedItems = Object.entries(ITEM_STONE_PRICES).sort(([a], [b]) => {
        const keyA = getItemSortKey(a);
        const keyB = getItemSortKey(b);
        if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
        if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
        return a.localeCompare(b, 'zh-Hant');
    });

    let content = `<p style="text-align:center;"><b>ç•¶å‰éˆçŸ³ï¼š${gameState.stones}</b></p>`;
    content += sortedItems.map(([item, cost]) => {
        const desc = ITEM_EFFECTS[item]?.desc || '';
        return `<div class="modal-item-row">
            <label for="shop-${item}">${item} - ${cost} éˆçŸ³ (${desc})</label>
            <input type="number" id="shop-${item}" min="0" value="0" placeholder="0">
        </div>`;
    }).join('');

    let footer = `<button data-action="bulk-buy-items">è³¼è²·é¸æ“‡</button>
                  <button class="btn-warning" data-action="show-sell-dialog">è²©è³£é“å…·</button>
                  <button class="btn-secondary" data-action="show-upgrade-dialog">å“éšå‡ç´š</button>`;
    
    showModal("ğŸ›’ å•†åº—", content, footer);
}

function bulkBuyItems() {
    const inputs = modalBody.querySelectorAll('input[type="number"]');
    let totalCost = 0;
    const purchase = {};

    inputs.forEach(input => {
        const qty = parseInt(input.value, 10);
        if (qty > 0) {
            const itemName = input.id.replace('shop-', '');
            const price = ITEM_STONE_PRICES[itemName] || 0;
            totalCost += price * qty;
            purchase[itemName] = qty;
        }
    });

    if (totalCost > gameState.stones) {
        alert(`éˆçŸ³ä¸è¶³ï¼éœ€è¦ ${totalCost}ï¼Œæ‚¨åªæœ‰ ${gameState.stones}ã€‚`);
        return;
    }

    if (Object.keys(purchase).length > 0) {
        gameState.stones -= totalCost;
        Object.entries(purchase).forEach(([item, qty]) => {
            gameState.inventory[item] = (gameState.inventory[item] || 0) + qty;
            if (!gameState.inventory_order.includes(item)) {
                gameState.inventory_order.push(item);
                 gameState.inventory_order.sort((a, b) => compareItemNames(a, b));
            }
        });
        saveGameState();
        addTemporaryMessage(`âœ… è³¼è²·æˆåŠŸï¼ŒèŠ±è²» ${totalCost} éˆçŸ³ï¼`, 'msg-shop');
    }
    modal.style.display = "none";
    renderMainMenu();
}

function showUpgradeDialog() {
    const upgradable = Object.keys(UPGRADE_PATHS)
        .filter(item => (gameState.inventory[item] || 0) > 0 && !(gameState.inventory[UPGRADE_PATHS[item]] > 0))
        // ä¾é¡å‹èˆ‡å“éšæ’åº
        .sort((a,b) => compareItemNames(a, b));

    let content = `<p style="text-align:center;"><b>ç•¶å‰éˆçŸ³ï¼š${gameState.stones}</b></p>`;
    if (upgradable.length === 0) {
        content += `<p>æ²’æœ‰å¯å‡ç´šçš„é“å…·ã€‚</p>`;
    } else {
        content += upgradable.map(item => {
            const nextItem = UPGRADE_PATHS[item];
            const cost = ITEM_EFFECTS[item].upgrade_cost || 0;
            return `<div class="modal-item-row">
                <span>å‡ç´š ${item} â†’ ${nextItem}</span>
                <button data-action="upgrade-item" data-current="${item}" data-next="${nextItem}" data-cost="${cost}" ${gameState.stones < cost ? 'disabled' : ''}>${cost} éˆçŸ³</button>
            </div>`;
        }).join('');
    }
    showModal("âœ¨ å“éšå‡ç´š", content, `<button data-action="show-shop">è¿”å›å•†åº—</button>`);
}

function upgradeItem(currentItem, nextItem, cost) {
    if (gameState.stones < cost) {
        alert("éˆçŸ³ä¸è¶³ï¼");
        return;
    }
    gameState.stones -= cost;
    gameState.inventory[nextItem] = (gameState.inventory[nextItem] || 0) + 1;
    // Don't remove old item
    if (!gameState.inventory_order.includes(nextItem)) {
        gameState.inventory_order.push(nextItem);
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }
    saveGameState();
    // æ‰£éˆçŸ³å¾Œç«‹å³æ›´æ–°ä¸»ç•«é¢è³‡è¨Šï¼ˆå°¤å…¶æ˜¯éˆçŸ³é¡¯ç¤ºï¼‰
    if (typeof updateMainMenuInfo === 'function') {
        updateMainMenuInfo();
    }
    alert(`å‡ç´šæˆåŠŸï¼ç²å¾— ${nextItem}`);
    showUpgradeDialog(); // Refresh modal
}

// ===================== éŠæˆ²ä¸­é“å…·ä½¿ç”¨ =====================

function showUseItemDialog() {
    const usableItems = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      .map(([name]) => name)
      .filter(name => {
        const type = ITEM_EFFECTS[name]?.type;
        return ["correct", "wrong", "multi_choice", "reveal_wrong", "add_time"].includes(type);
      })
      // ä¾é¡å‹èˆ‡å“éšæ’åº
      .sort((a, b) => compareItemNames(a, b));
    let content = '';
    if (usableItems.length === 0) {
      content = '<p>æ²’æœ‰å¯ç”¨çš„æˆ°é¬¥é“å…·</p>';
    } else {
      content = usableItems.map(item => {
        const eff = ITEM_EFFECTS[item];
        const cost = eff.exp_cost || 0;
        let disabled = '';
        let tooltip = '';
        if (gameState.exp < cost) {
          disabled = 'disabled';
          tooltip = ` (ä¿®ç…‰ç¶“é©—ä¸è¶³: ${cost})`;
        }
        if (['correct', 'wrong', 'multi_choice'].includes(eff.type) && trainingState.hasUsedSingleUseItem) {
          disabled = 'disabled';
          tooltip = ' (æœ¬é¡Œå·²ç”¨éæ­¤é¡é“å…·)';
        }
        if (['correct', 'wrong'].includes(eff.type)) {
          const allowedGrade = getGradeByDifficulty(trainingState.difficulty);
          if (!item.startsWith(allowedGrade)) {
            disabled = 'disabled';
            tooltip = ` (æ­¤é›£åº¦éœ€ç”¨ ${allowedGrade} é“å…·)`;
          }
        }
        return `<button data-action="use-item" data-item-name="${item}" ${disabled}>
          ${item} Ã—${gameState.inventory[item]}
          <br><small>${eff.desc || ''}${cost > 0 ? ` (æ¶ˆè€—${cost} EXP)` : ''}${tooltip}</small>
        </button>`;
      }).join('');
    }
    showModal('ğŸ’ ä½¿ç”¨é“å…·', content);
}

function useItem(itemName) {
    const eff  = ITEM_EFFECTS[itemName];
    if (!eff) return;
    const cost = eff.exp_cost || 0;
    if (gameState.exp < cost) return;
    if (['correct', 'wrong', 'multi_choice'].includes(eff.type)) {
      if (trainingState.hasUsedSingleUseItem) return;
      trainingState.hasUsedSingleUseItem = true;
    }
    gameState.exp -= cost;
    if (['correct', 'wrong'].includes(eff.type)) {
      gameState.inventory[itemName] = Math.max(0, (gameState.inventory[itemName] || 0) - 1);
    }
    saveGameState();
    const fb = document.getElementById('feedback-label');
    let msg = '';
    if (eff.type === 'multi_choice') {
      trainingState.allowedChoices += (eff.n || 1);
      enterMultiChoiceMode();
      msg = `âš”ï¸ å…µå™¨æ•ˆæœï¼šæœ¬é¡Œå¯é¸ç­”æ¡ˆæ•¸å¢åŠ  ${eff.n}ï¼ˆç¸½å…± ${trainingState.allowedChoices} æ¬¡ï¼‰`;
    } else if (eff.type === 'reveal_wrong') {
      const buttons = trainingState.gameGridButtons || [];
      let remain = eff.n || 1;
      for (const b of buttons) {
        if (remain <= 0) break;
        const choice = b.dataset.choice;
        if (!trainingState.correctAnswers.includes(choice) && !b.classList.contains('hint-wrong')) {
          b.classList.add('hint-wrong');
          remain--;
        }
      }
      msg = `ğŸ“œ åŠŸæ³•æ•ˆæœï¼šå·²æ¨™ç¤º ${eff.n} å€‹éŒ¯èª¤ç­”æ¡ˆ`;
    } else if (eff.type === 'add_time') {
      // é™£æ³•å¢åŠ ä½œç­”æ™‚é–“åƒ…é™æœ¬é¡Œæœ‰æ•ˆï¼šä¸­é€”å¯ä»¥ç–ŠåŠ ä¸¦å³æ™‚ç”Ÿæ•ˆ
      const inc = eff.n || 0;
      trainingState.roundExtraTime = (trainingState.roundExtraTime || 0) + inc;
      // è‹¥å€’æ•¸æ­£åœ¨è·‘ï¼Œç«‹å³å¢åŠ å‰©é¤˜ç§’æ•¸
      if (typeof trainingState.countdownRemaining === 'number') {
        trainingState.countdownRemaining += inc;
        const label = document.getElementById('countdown-label');
        if (label && trainingState.countdownRemaining >= 0) {
          label.textContent = `ä½œç­”å€’æ•¸ï¼š${trainingState.countdownRemaining} ç§’`;
        }
      }
      msg = `â›©ï¸ é™£æ³•æ•ˆæœï¼šä½œç­”æ™‚é–“å¢åŠ  ${inc} ç§’ï¼ˆåƒ…æœ¬é¡Œï¼‰`;
    } else if (eff.type === 'correct') {
// éˆå™¨ï¼šé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆã€‚n <= 0 è¦–ç‚ºå…¨éƒ¨ï¼Œå¦å‰‡é¡¯ç¤º n å€‹
const buttons = trainingState.gameGridButtons || [];
// æ‰¾å‡ºæ‰€æœ‰å°šæœªæ¨™ç¤ºçš„æ­£ç¢ºæŒ‰éˆ•
const correctButtons = buttons.filter(b =>
  trainingState.correctAnswers.includes(b.dataset.choice) && !b.classList.contains('hint-correct')
);
let toReveal;
if (eff.n <= 0) {
  // n <= 0 è¡¨ç¤ºå…¨éƒ¨äº®é¡¯
  toReveal = correctButtons;
} else {
  // å¦å‰‡åªé¡¯ç¤ºå‰ n å€‹
  toReveal = correctButtons.slice(0, eff.n);
}
// å°‡é¸ä¸­çš„æŒ‰éˆ•æ¨™è¨˜ç‚ºæ­£ç¢º
toReveal.forEach(b => b.classList.add('hint-correct'));
msg = `ğŸª¬ éˆå™¨æ•ˆæœï¼šå·²æ¨™ç¤º ${eff.n <= 0 ? 'å…¨éƒ¨' : toReveal.length} å€‹æ­£ç¢ºç­”æ¡ˆ`;
    } else if (eff.type === 'wrong') {
      const buttons = trainingState.gameGridButtons || [];
      let remain = eff.n || 1;
      for (const b of buttons) {
        if (remain <= 0) break;
        const choice = b.dataset.choice;
        if (!trainingState.correctAnswers.includes(choice) && !b.classList.contains('hint-wrong')) {
          b.classList.add('hint-wrong');
          remain--;
        }
      }
      msg = `ğŸ§¿ éˆç¬¦æ•ˆæœï¼šå·²æ’é™¤ ${eff.n} å€‹éŒ¯èª¤ç­”æ¡ˆ`;
    }
    if (fb) { fb.textContent = msg; fb.className = "feedback info"; }
    modal.style.display = 'none';
}

// Stubs for unimplemented modal functions
function useExpItems() { showUseExpDialog(); }
function deleteItems() { showDeleteItemsDialog(); }
function showSellDialog() {
  const sellable = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && ITEM_STONE_PRICES[name] !== undefined)
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (sellable.length === 0) {
    content = '<p>èƒŒåŒ…ä¸­æ²’æœ‰å¯è²©è³£çš„é“å…·ã€‚</p>';
  } else {
    content = sellable.map(([name, qty]) => {
      const sellPriceSingle = Math.floor((ITEM_STONE_PRICES[name] || 0) / 2);
      return `
        <div class="modal-item-row">
          <label for="sell-${name}">${name}ï¼ˆæŒæœ‰ ${qty}ï¼‰ - è³£åƒ¹: ${sellPriceSingle} éˆçŸ³/å€‹</label>
          <input type="number" id="sell-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
    content += `<p id="sell-total" style="margin-top:10px;text-align:center;">é è¨ˆå¯ç²å¾—ï¼š0 éˆçŸ³</p>`;
  }
  const footer = `<button data-action="confirm-sell-items">ç¢ºèªè²©è³£</button>`;
  showModal("ğŸ’° è²©è³£é“å…·", content, footer);
  // attach update for predicted sell value
  setTimeout(() => {
    const totalLabel = document.getElementById('sell-total');
    function updateTotal() {
      let totalBuyValue = 0;
      sellable.forEach(([name]) => {
        const input = modalBody.querySelector(`#sell-${name}`);
        if (input) {
          const count = parseInt(input.value || '0', 10);
          if (count > 0) {
            const price = ITEM_STONE_PRICES[name] || 0;
            totalBuyValue += price * count;
          }
        }
      });
      const sellValue = Math.floor(totalBuyValue / 2);
      if (totalLabel) {
        totalLabel.textContent = `é è¨ˆå¯ç²å¾—ï¼š${sellValue} éˆçŸ³`;
      }
    }
    sellable.forEach(([name]) => {
      const input = modalBody.querySelector(`#sell-${name}`);
      if (input) {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
      }
    });
    updateTotal();
  }, 0);
}

function confirmSellItems() {
  const toSell = [];
  let totalBuyValue = 0;
  Object.entries(gameState.inventory).forEach(([name, qty]) => {
    const input = modalBody.querySelector(`#sell-${name}`);
    if (input) {
      const count = Math.max(0, parseInt(input.value || '0', 10));
      if (count > 0) {
        toSell.push({name: name, qty: count});
        totalBuyValue += (ITEM_STONE_PRICES[name] || 0) * count;
      }
    }
  });
  if (toSell.length === 0) {
    showModal("ğŸ’° è²©è³£çµæœ", "<p>æœªè²©è³£ä»»ä½•é“å…·</p>", `<button data-action="close-modal">é—œé–‰</button>`);
    return;
  }
  const sellValue = Math.floor(totalBuyValue / 2);
  toSell.forEach(item => {
    gameState.inventory[item.name] = Math.max(0, (gameState.inventory[item.name] || 0) - item.qty);
  });
  gameState.stones += sellValue;
  saveGameState();
  const soldItemsDesc = toSell.map(item => `${item.name} Ã—${item.qty}`);
  showModal("ğŸ’° è²©è³£çµæœ", `<p>å·²è²©è³£ï¼š${soldItemsDesc.join('ã€')}</p><p>ç²å¾— ${sellValue} éˆçŸ³</p>`, `<button data-action="close-modal">é—œé–‰</button>`);
}


// ===================== å…¨åŸŸäº‹ä»¶è™•ç† =====================
document.body.addEventListener('click', (event) => {
    let target = event.target;
    // If the target itself doesn't have the action, check its parent
    if (!target.dataset.action) {
        target = target.closest('[data-action]');
    }
    if (!target) return;

    const action = target.dataset.action;
    
    const simpleActions = {
        'render-main-menu': renderMainMenu, 'render-test-luck-menu': renderTestLuckMenu,
        'show-stage-list': showStageList, 'show-rank-list': showRankList,
        'show-backpack': showBackpack, 'show-shop': showShop,
        'reset-stats': resetTrainingStats, 'clear-scores': clearMaxScores,
        'run-today-luck': runTodayLuck, 'show-luck-history': showLuckHistory,
        'show-upgrade-dialog': showUpgradeDialog, 'check-answer-multi': checkAnswerMulti,
        'show-use-item-dialog': showUseItemDialog, 'close-modal': () => modal.style.display = "none",
        'bulk-buy-items': bulkBuyItems,
        'use-exp-items': showUseExpDialog,
        'delete-items': showDeleteItemsDialog,
        'confirm-use-exp': confirmUseExp,
        'confirm-delete-items': confirmDeleteItems,
        'fill-all-exp': fillAllExpInputs,
        'confirm-use-exp-all': confirmUseExpAll,
        'confirm-sell-items': confirmSellItems,
        'show-sell-dialog': showSellDialog,
        'show-game-rules': showGameRules,
        'test-sfx': () => {
            try {
                if (typeof ensureAudio === 'function' && typeof playBeep === 'function') {
                    ensureAudio();
                    playBeep({ freq: 880 });
                }
            } catch (e) {}
        },
    };

    if (simpleActions[action]) {
        simpleActions[action]();
        return;
    }

    // Actions with parameters
    switch(action) {
        case 'start-training':
            startTraining(parseInt(target.dataset.level, 10));
            break;
        case 'exchange-stones':
            exchangeStones(parseInt(target.dataset.count, 10));
            break;
        case 'redeem-tickets':
            redeemTickets(parseInt(target.dataset.pieces, 10), parseInt(target.dataset.cost, 10));
            break;
        case 'run-luck-draw':
            runLuckDraw(parseInt(target.dataset.draws, 10), target.dataset.mode);
            break;
        case 'upgrade-item':
            upgradeItem(target.dataset.current, target.dataset.next, parseInt(target.dataset.cost, 10));
            break;
        case 'use-item':
            useItem(target.dataset.itemName);
            break;
        case 'grid-btn': 
            onGridButtonClick(target);
            break;
    }
});


// ===================== å•Ÿå‹•éŠæˆ² =====================
loadGameState();
renderMainMenu();

}); // â–²â–²â–² End of DOMContentLoaded listener â–²â–²â–²
</script>

<!-- éŸ³æ•ˆèˆ‡ç®­é ­å¾Œæ´ç¨‹å¼ï¼šåœ¨è¡Œå‹•è£ç½®ä¸Šé¡¯ç¤ºç®­é ­ï¼Œä¸¦ç”ŸæˆéŸ³æ•ˆï¼ˆç„¡éœ€å¤–éƒ¨éŸ³æª”ï¼‰ -->
<script>
// ==== è¡Œå‹•è£ç½®ç®­é ­ SVG å¾Œæ´ ====
function svgArrow(dir, size = 18) {
    const pathMap = {
        up:   'M9 2 L16 14 H2 Z',
        right:'M2 2 L14 9 L2 16 Z',
        down: 'M2 2 L16 2 L9 16 Z',
        left: 'M2 9 L14 2 L14 16 Z'
    };
    const key = pathMap[dir] ? dir : 'up';
    const svg = `<svg viewBox="0 0 18 18" width="${size}" height="${size}" aria-hidden="true" style="display:inline-block;vertical-align:middle"><path d="${pathMap[key]}" fill="currentColor"/></svg>`;
    const el = document.createElement('span');
    el.className = 'luck-arrow-svg';
    el.innerHTML = svg;
    return el;
}

// å°‡å«æœ‰ç®­é ­å­—å…ƒæˆ–æŒ‡å®š data å±¬æ€§çš„ç¯€é»æ›¿æ›ç‚º SVG
function patchLuckArrows() {
    const selector = '.luck-arrow, [data-luck-arrow], [data-dir]';
    document.querySelectorAll(selector).forEach(node => {
        // å·²ç¶“æœ‰ SVG å°±ä¸é‡è¤‡æ›¿æ›
        if (node.querySelector('svg')) return;
        // åˆ¤æ–·æ–¹å‘
        let dir = node.dataset.luckArrow || node.dataset.dir || '';
        // è‹¥æœªæŒ‡å®šï¼Œæ ¹æ“šå…§å®¹åˆ¤æ–·
        if (!dir) {
            const text = node.textContent.trim();
            const map = {'â†‘': 'up', 'â†’': 'right', 'â†“': 'down', 'â†': 'left'};
            dir = map[text] || 'up';
        }
        // æ¸…ç©ºæ–‡å­—ä¸¦æ’å…¥ SVG
        node.textContent = '';
        node.appendChild(svgArrow(dir));
    });
}

// ==== WebAudio éŸ³æ•ˆå·¥å…· ====
let __audioCtx = null;
function ensureAudio() {
    if (!__audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        __audioCtx = new Ctx();
    }
    return __audioCtx;
}

function playBeep(opts) {
    const cfg = Object.assign({ freq: 880, dur: 0.12, type: 'sine', gain: 0.06 }, opts);
    const ctx = ensureAudio();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    osc.type = cfg.type;
    osc.frequency.value = cfg.freq;
    gainNode.gain.value = cfg.gain;
    osc.connect(gainNode).connect(ctx.destination);
    const t = ctx.currentTime;
    osc.start(t);
    osc.stop(t + cfg.dur);
}

function playLevelUp() {
    const ctx = ensureAudio();
    if (!ctx) return;
    const now = ctx.currentTime;
    // ä¸Šè¡Œå°å’Œå¼¦ï¼šC-E-G ä¾åºéŸ¿èµ·
    [[523.25, 0], [659.25, 0.08], [783.99, 0.16]].forEach(([freq, offset]) => {
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gainNode.gain.value = 0.05;
        osc.connect(gainNode).connect(ctx.destination);
        osc.start(now + offset);
        osc.stop(now + offset + 0.18);
    });
}

// ==== åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ====
window.addEventListener('DOMContentLoaded', () => {
    try {
        patchLuckArrows();
    } catch (e) {}
});
</script>

</body>
</html>
