<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹æ°£è¨“ç·´å·¥å…· V2-22ï¼ˆä¿®ä»™ç¶²é é›¢ç·šç‰ˆï¼‰</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #545b62;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gold-color: #DAA520;
            --teal-color: #20c997;
            --purple-color: #6f42c1;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #app-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            text-align: center;
            margin-top: 0;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: var(--primary-color);
            color: white;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤è¡Œå‹•è£ç½®é»æ“Šé«˜äº® */
        }
        button:hover {
            background-color: var(--primary-hover);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #b22a38; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }

        /*
         * è‡ªå®šç¾©åŠŸèƒ½æŒ‰éˆ•é¡è‰²å€éš”
         * æ™®é€šè¨“ç·´ä½¿ç”¨ä¸»è‰²ç³»ï¼ˆprimaryï¼‰ï¼Œç§˜å¢ƒè©¦ç…‰ä½¿ç”¨ç´«è‰²ç³»ï¼Œå…¶é¤˜åŠŸèƒ½ä½¿ç”¨é’è‰²ç³»ã€‚
         * å°æ‡‰ hover ç‹€æ…‹ä¹Ÿé¡å¤–è¨­ç½®ï¼Œé¿å…è¢«é€šç”¨ button:hover è¦†è“‹ã€‚
         */
        .btn-training {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-training:hover {
            background-color: var(--primary-hover);
        }
        .btn-trial {
            background-color: var(--purple-color);
            color: white;
        }
        .btn-trial:hover {
            /* ç¨å¾®åŠ æ·±ç´«è‰²ä½œç‚º hover æ•ˆæœ */
            background-color: #5a379a;
        }
        .btn-other {
            background-color: var(--teal-color);
            color: white;
        }
        .btn-other:hover {
            /* ç¨å¾®åŠ æ·±é’è‰²ä½œç‚º hover æ•ˆæœ */
            background-color: #1aa179;
        }

        /*
         * é“å…·é¡åˆ¥åº•è‰²å€éš”
         * å…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€ä»™ä¸¹ã€éˆå™¨ã€éˆç¬¦åˆ†åˆ¥å°æ‡‰ä¸åŒèƒŒæ™¯è‰²ï¼Œä»¥åˆ©è¦–è¦ºå€åˆ†ã€‚
         */
        .cat-weapon { background-color: #e9e6ff; }
        /*
         * åŠŸæ³•èˆ‡é™£æ³•åº•è‰²èª¿æ•´ï¼šæå‡å€åˆ†åº¦
         * åŠŸæ³•æ¡ç”¨æ·¡ç¶ è‰²ï¼Œé™£æ³•æ¡ç”¨æ·¡æ©™è‰²ã€‚
         */
        /* åŠŸæ³•ï¼ˆtechniqueï¼‰ï¼šæ¡ç”¨æ›´ç‚ºæ˜é¡¯çš„æ·¡ç¶ è‰²ï¼Œé¿å…èˆ‡å…¶ä»–é¡åˆ¥æ··æ·† */
        .cat-technique { background-color: #d5f7d8; }
        /* é™£æ³•ï¼ˆformationï¼‰ï¼šæ¡ç”¨æ›´ç‚ºæ˜é¡¯çš„æ·¡æ©™è‰²ï¼Œä»¥ä¾¿èˆ‡åŠŸæ³•å€åˆ† */
        .cat-formation { background-color: #ffe9cc; }
        .cat-elixir { background-color: #fff8e1; }
        .cat-artifact { background-color: #e0f7fa; }
        .cat-charm { background-color: #fce4ec; }

        /*
         * é“å…·å“éšå­—é«”é¡è‰²å€éš”
         * å°æ‡‰å„å“éšè¨­å®šä¸åŒé¡è‰²ï¼Œå¾å…¥å“è‡³å¤©å“ä¾æ¬¡éå¢ã€‚
         */
        .grade-in { color: #8a4b00; }
        .grade-low { color: #006400; }
        .grade-mid { color: #0000ff; }
        .grade-high { color: #800080; }
        .grade-excellent { color: #ff4500; }
        .grade-ultra { color: #C71585; }
        .grade-ultimate { color: #DAA520; }
        .grade-treasure { color: #B8860B; }
        .grade-earth { color: #2E8B57; }
        .grade-heaven { color: #8B0000; }

        /*
         * è¨“ç·´çµæœé¡¯ç¤ºé¡è‰²å€åˆ†
         * è¨“ç·´æ¬¡æ•¸å¢åŠ  (+1) ä½¿ç”¨æˆåŠŸè‰²ï¼Œæœªå¢åŠ  (+0) ä½¿ç”¨å±éšªè‰²ã€‚
         */
        .train-add {
            color: var(--success-color);
            font-weight: bold;
        }
        .train-none {
            color: var(--danger-color);
            font-weight: bold;
        }

        /*
         * ç§˜å¢ƒè©¦ç…‰æ¨¡å¼èƒŒæ™¯è‰²
         * è®“ç§˜å¢ƒè©¦ç…‰ç•«é¢åº•è‰²èˆ‡ä¸»é¸å–®ç§˜å¢ƒè©¦ç…‰æŒ‰éˆ•é¡è‰²ç›¸å‘¼æ‡‰ï¼Œæ¡ç”¨æ·¡ç´«è‰²ä»¥ä¿ç•™é–±è®€æ€§ã€‚
         */
        .trial-mode {
            background-color: #f3e8fd;
        }

        /*
         * å›é ‚éƒ¨æŒ‰éˆ•å›ºå®šä½ç½®è¨­å®š
         * åœ¨ä¸»é¸å–®æ™‚é¡¯ç¤ºï¼Œå…¶ä»–ä»‹é¢éš±è—ï¼Œç”± JS æ§åˆ¶ display å±¬æ€§ã€‚
         */
        #back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            width: auto;
            padding: 10px 16px;
        }

        /*
         * å›é ‚éƒ¨æŒ‰éˆ•å°ˆç”¨æ¨£å¼ï¼šä½¿ç”¨ç¨ç«‹é¡è‰²å€éš”æ–¼å…¶ä»–åŠŸèƒ½æŒ‰éˆ•ã€‚
         * æ¡ç”¨ info è‰²ç³»ä½œç‚ºèƒŒæ™¯ï¼Œä¸¦æ–¼ hover æ™‚ç¨å¾®åŠ æ·±ã€‚
         */
        .btn-back-top {
            /* ä½¿ç”¨æ·±è‰²é…è‰²ï¼Œèˆ‡å…¶ä»–æŒ‰éˆ•å€éš”é–‹ä¾† */
            background-color: #343a40;
            color: #fff;
        }
        .btn-back-top:hover {
            background-color: #23272b;
        }

        /*
         * æˆ°é¬¥é“å…·åˆ†é¡éæ¿¾æŒ‰éˆ•æ¨£å¼
         * åœ¨ä½¿ç”¨é“å…·å°è©±æ¡†ä¸­é¡¯ç¤ºçš„åˆ†é¡åˆ‡æ›æŒ‰éˆ•ï¼Œæ¡ç”¨æ¬¡è¦è‰²ç³»ï¼Œç•¶å‰é¸ä¸­æ™‚ä½¿ç”¨ä¸»è‰²ç³»ã€‚
         */
        .btn-filter {
            display: inline-block;
            margin: 4px;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
        }
        .btn-filter.active {
            background-color: var(--primary-color);
        }
        .btn-filter:disabled {
            background-color: var(--secondary-color);
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-filter:not(:disabled):hover {
            background-color: var(--secondary-hover);
        }

        /*
         * ç°½åˆ°æ—¥æ›†è¡¨æ ¼æ¨£å¼
         * ä½¿ç”¨ç°¡æ˜“è¡¨æ ¼é¡¯ç¤ºç•¶æœˆæ—¥æœŸï¼Œå·²ç°½åˆ°æ—¥æœŸä½¿ç”¨æˆåŠŸè‰²æ¨™ç¤ºï¼Œä»Šå¤©ä½¿ç”¨ä¸»è¦è‰²æ¡†ç·šã€‚
         */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .calendar-table th, .calendar-table td {
            border: 1px solid #dee2e6;
            padding: 4px;
            text-align: center;
        }
        .calendar-cell-signed {
            background-color: var(--success-color);
            color: #fff;
        }
        .calendar-cell-today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }


        .info-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .info-section p {
            margin: 6px 0;
        }

        progress {
            width: 100%;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            border: none;
        }
        progress::-webkit-progress-bar {
            background-color: #e9ecef;
        }
        progress::-webkit-progress-value {
            background-color: var(--success-color);
            transition: width 0.5s ease-in-out;
        }
        progress::-moz-progress-bar {
            background-color: var(--success-color);
        }

        .game-grid {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .grid-btn {
            width: 100%;
            height: 60px;
            font-size: 24px;
            padding: 0;
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid #ccc;
        }
        .grid-btn:hover {
            background-color: #e2e6ea;
        }
        .grid-btn.selected {
            border-color: var(--primary-color);
            background-color: #e0f7fa;
            box-shadow: 0 0 5px var(--primary-color);
        }
        .grid-btn.hint-correct {
            border: 2px solid var(--gold-color);
            background-color: #fff7d6;
        }
        .grid-btn.hint-wrong {
            border: 2px solid var(--danger-color);
            background-color: #ffe6e6;
        }
        .grid-btn.checked {
            background-color: #d1ecf1;
            border-color: var(--info-color);
        }

        /*
         * åœ¨ç§˜å¢ƒè©¦ç…‰æ¨¡å¼ä¸‹ï¼Œå°‡é¡Œç›®æŒ‰éˆ•ï¼ˆgrid-btnï¼‰åº•è‰²æ”¹ç‚ºç´«è‰²ç³»ï¼Œä»¥èˆ‡ç§˜å¢ƒè©¦ç…‰æŒ‰éˆ•ä¸€è‡´ã€‚
         * å› ç‚ºç§˜å¢ƒè©¦ç…‰æœƒåœ¨å®¹å™¨å…ƒç´ ä¸Šå¥—ç”¨ trial-mode classï¼Œæ•…åœ¨æ­¤ä½¿ç”¨è©² class åšçˆ¶å±¤é¸æ“‡ã€‚
         */
        /* ç§˜å¢ƒè©¦ç…‰çš„é¡Œç›®æŒ‰éˆ•é¡è‰²å›å¾©èˆ‡ä¸€èˆ¬è¨“ç·´ä¸€è‡´ï¼Œè®“é“å…·æç¤ºèˆ‡æ­£ç¢º/éŒ¯èª¤é«˜äº®é¡¯ç¤ºæ­£å¸¸ã€‚æ•…ä¸å†è¦†å¯« .grid-btn æ¨£å¼ã€‚ */


        .feedback {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .feedback.success { color: var(--success-color); }
        .feedback.error { color: var(--danger-color); }
        .feedback.info { color: var(--info-color); }
        
        .message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .msg-daily { color: #004085; background-color: #cce5ff; border: 1px solid #b8daff; }
        .msg-shop { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .msg-shop-fail { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .msg-levelup { color: var(--purple-color); font-weight: bold; }
        .msg-reward { color: var(--gold-color); font-weight: bold; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-item-row label { flex-grow: 1; }
        .modal-item-row input[type="number"] {
            width: 70px;
            padding: 5px;
            text-align: right;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .modal-footer {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: #000; }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="app"></div>
    </div>

    <!-- Modal Template -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="close-btn" id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>

    <!-- å›ºå®šæ–¼å³ä¸‹è§’çš„å›é ‚éƒ¨æŒ‰éˆ•ï¼Œåœ¨ä¸»é¸å–®æ™‚é¡¯ç¤ºï¼Œå…¶é¤˜æ™‚éš±è— -->
    <button id="back-to-top" class="btn-back-top">â¬†ï¸ å›é ‚éƒ¨</button>

<script>
// =================================================================================
// é‹æ°£è¨“ç·´å·¥å…· V9-0 - JavaScript é›¢ç·šç¶²é ç‰ˆ
// ä½œè€…ï¼šGemini (ç§»æ¤è‡ªä½¿ç”¨è€…æä¾›çš„ Python è…³æœ¬)
// ç‰ˆæœ¬ï¼š1.2 - ä¿®æ­£è¨“ç·´æ¨¡å¼ä¸­ç­”æ¡ˆä½ç½®è¦å¾‹æ’åˆ—çš„å•é¡Œï¼Œå¯¦ç¾çœŸæ­£éš¨æ©Ÿã€‚
// =================================================================================

document.addEventListener('DOMContentLoaded', () => {

// ===================== éŠæˆ²æ ¸å¿ƒè¨­å®šèˆ‡æ•¸æ“š (ä¾†è‡ª Python) =====================
const SCORE_FILE = "max_scores"; // localStorage key
const STATS_FILE = "training_stats"; // localStorage key
// # ç§˜å¢ƒè©¦ç…‰æœ€é«˜åˆ†è³‡æ–™å„²å­˜éµï¼Œç”¨æ–¼è¨˜éŒ„ç©å®¶åœ¨å„é›£åº¦ç§˜å¢ƒè©¦ç…‰ä¸­çš„æœ€ä½³æˆç¸¾ã€‚
const TRIAL_SCORE_FILE = "max_trial_scores";

// # ç§˜å¢ƒè©¦ç…‰æœ€é«˜ç´€éŒ„è¼‰å…¥å¾Œå­˜æ”¾æ–¼æ­¤ç‰©ä»¶ï¼Œæ ¼å¼é¡ä¼¼æ–¼ maxScores: { difficulty: bestScore }
let maxTrialScores = {};

const DIFFICULTY_WIN_RATE = {1:90, 2:80, 3:65, 4:50, 5:35, 6:25, 7:15, 8:10, 9:7, 10:5};

// ç§˜å¢ƒè©¦ç…‰å„é›£åº¦ç²å¾—è¨“ç·´æ¬¡æ•¸çš„æœ€ä½ç­”å°é¡Œæ•¸é–€æª»
// é›£åº¦ 1ï¼šè‡³å°‘ç­”å° 17 é¡Œï¼›é›£åº¦ 2ï¼š15 é¡Œï¼›é›£åº¦ 3ï¼š12 é¡Œï¼›é›£åº¦ 4ï¼š9 é¡Œï¼›
// é›£åº¦ 5ï¼š6 é¡Œï¼›é›£åº¦ 6ï¼š4 é¡Œï¼›é›£åº¦ 7ï¼š2 é¡Œï¼›é›£åº¦ 8ï¼š1 é¡Œï¼›
// é›£åº¦ 9ï¼š1 é¡Œï¼›é›£åº¦ 10ï¼š0 é¡Œï¼ˆç­”éŒ¯ä¹Ÿå¯ç²å¾—è¨“ç·´æ¬¡æ•¸ï¼‰ã€‚
const TRIAL_TRAINING_REQUIREMENTS = {1: 17, 2: 15, 3: 12, 4: 9, 5: 6, 6: 4, 7: 2, 8: 1, 9: 1, 10: 0};

// æ¯æ—¥ä»»å‹™æ¨¡æ¿ï¼šéš¨æ©Ÿç”Ÿæˆæ¯æ—¥ä»»å‹™çš„å€™é¸æ¸…å–®
// ä»»å‹™é¡å‹åˆ†ç‚ºæ™®é€šè¨“ç·´(training)èˆ‡ç§˜å¢ƒè©¦ç…‰(secretTrial)ï¼ŒåŒ…å«æŒ‡å®šé›£åº¦èˆ‡å®Œæˆæ¬¡æ•¸ç›®æ¨™ã€‚
// å®Œæˆæ™®é€šè¨“ç·´ä»»å‹™æ™‚éœ€è¦åˆ†æ•¸ >= é›£åº¦å‹ç‡é–€æª»ï¼›å®Œæˆç§˜å¢ƒä»»å‹™éœ€è‡³å°‘ç­”å°å°æ‡‰é¡Œæ•¸ã€‚
const DAILY_TASK_TEMPLATES = [
    { type: 'training', difficulty: 1, target: 10 },
    { type: 'training', difficulty: 2, target: 9 },
    { type: 'training', difficulty: 3, target: 8 },
    { type: 'training', difficulty: 4, target: 7 },
    { type: 'training', difficulty: 5, target: 6 },
    { type: 'training', difficulty: 6, target: 5 },
    { type: 'training', difficulty: 7, target: 4 },
    { type: 'training', difficulty: 8, target: 3 },
    { type: 'training', difficulty: 9, target: 2 },
    { type: 'training', difficulty: 10, target: 1 },    
    { type: 'secretTrial', difficulty: 1, target: 5 },
    { type: 'secretTrial', difficulty: 2, target: 5 },
    { type: 'secretTrial', difficulty: 3, target: 4 },
    { type: 'secretTrial', difficulty: 4, target: 4 },
    { type: 'secretTrial', difficulty: 5, target: 3 },
    { type: 'secretTrial', difficulty: 6, target: 3 },
    { type: 'secretTrial', difficulty: 7, target: 2 },
    { type: 'secretTrial', difficulty: 8, target: 2 },
    { type: 'secretTrial', difficulty: 9, target: 1 },
    { type: 'secretTrial', difficulty: 10, target: 1 }
];
const REDEEM_1_COST = 50;
const REDEEM_10_COST = 500;
const REDEEM_100_COST = 5000;
const REDEEM_1000_COST = 50000;
const REDEEM_1000000_COST = 50000000;
const STONE_EXCHANGE_COST = 100;
const STONE_100_EXCHANGE_COST = 10000;
const STONE_1000_EXCHANGE_COST = 100000;

const TRAINING_MILESTONES = {
    5: {"rewards": 1, "title": "1.å®—é–€çš„åŸºçŸ³"}, 10: {"rewards": 1, "title": "2.è¦‹ç¿’å¼Ÿå­"}, 25: {"rewards": 2, "title": "3.å¤–é–€é›œå½¹"}, 50: {"rewards": 2, "title": "4.å¤–é–€å¼Ÿå­"}, 75: {"rewards": 3, "title": "5.å¤–é–€å¸«å…„"}, 100: {"rewards": 5, "title": "6.å¤–é–€èè‹±"}, 150: {"rewards": 3, "title": "7.å…§é–€å€™è£œ"}, 200: {"rewards": 4, "title": "8.å…§é–€å¼Ÿå­"}, 300: {"rewards": 5, "title": "9.å…§é–€å¸«å…„"}, 400: {"rewards": 5, "title": "10.å…§é–€èè‹±"}, 500: {"rewards": 10, "title": "11.å®—é–€åŸ·äº‹"}, 600: {"rewards": 5, "title": "12.ä»»å‹™å ‚å¼Ÿå­"}, 700: {"rewards": 5, "title": "13.å‚³æ³•å ‚å¼Ÿå­"}, 800: {"rewards": 5, "title": "14.ç…‰ä¸¹é–£å¼Ÿå­"}, 900: {"rewards": 5, "title": "15.ç…‰å™¨åŠå¼Ÿå­"}, 1000: {"rewards": 15, "title": "16.è¦ªå‚³å¼Ÿå­"}, 1200: {"rewards": 6, "title": "17.æˆ’å¾‹å ‚åŸ·äº‹"}, 1400: {"rewards": 6, "title": "18.è—ç¶“é–£åŸ·äº‹"}, 1600: {"rewards": 6, "title": "19.ç™¾è‰åœ’ç®¡äº‹"}, 1800: {"rewards": 6, "title": "20.è¬ç¸å±±ç®¡äº‹"}, 2000: {"rewards": 20, "title": "21.é¦–å¸­å¤§å¼Ÿå­"}, 2500: {"rewards": 10, "title": "22.ä»»å‹™å ‚é•·è€"}, 3000: {"rewards": 10, "title": "23.å‚³æ³•å ‚é•·è€"}, 3500: {"rewards": 10, "title": "24.ç…‰ä¸¹é–£é•·è€"}, 4000: {"rewards": 10, "title": "25.ç…‰å™¨åŠé•·è€"}, 5000: {"rewards": 25, "title": "26.å®—é–€é•·è€"}, 6000: {"rewards": 12, "title": "27.åˆ‘æ³•é•·è€"}, 7000: {"rewards": 12, "title": "28.å‚³åŠŸé•·è€"}, 8000: {"rewards": 12, "title": "29.å®¢å¿é•·è€"}, 9000: {"rewards": 12, "title": "30.å·¡å±±é•·è€"}, 10000: {"rewards": 30, "title": "31.å®—é–€è­·æ³•"}, 12500: {"rewards": 15, "title": "32.ä¸¹é“å³°ä¸»"}, 15000: {"rewards": 15, "title": "33.å™¨é“å³°ä¸»"}, 17500: {"rewards": 15, "title": "34.åŠé“å³°ä¸»"}, 20000: {"rewards": 40, "title": "35.å¤ªä¸Šé•·è€"}, 25000: {"rewards": 20, "title": "36.å®—é–€è–å­"}, 30000: {"rewards": 20, "title": "37.å®—é–€è–å¥³"}, 35000: {"rewards": 20, "title": "38.è¡Œèµ°çš„å‚³èªª"}, 40000: {"rewards": 20, "title": "39.è­·é“äºº"}, 50000: {"rewards": 50, "title": "40.ä»£å®—ä¸»"}, 60000: {"rewards": 25, "title": "41.é®æ´¾è€ç¥–"}, 70000: {"rewards": 25, "title": "42.é–‹æ´¾ç¥–å¸«"}, 80000: {"rewards": 25, "title": "43.æ¸¡åŠ«çœŸä»™"}, 90000: {"rewards": 25, "title": "44.é£›å‡ä¹‹äºº"}, 100000: {"rewards": 100, "title": "45.äººé–“ä¹‹ç¥"}, 120000: {"rewards": 50, "title": "46.å¤©ç•Œè¡Œè€…"}, 140000: {"rewards": 50, "title": "47.æ˜Ÿç•ŒéŠç¥"}, 160000: {"rewards": 50, "title": "48.ä½é¢ä¹‹ä¸»"}, 180000: {"rewards": 50, "title": "49.æ™‚ç©ºæ—…è€…"}, 200000: {"rewards": 100, "title": "50.è¬å¤å‚³èªª"}, 250000: {"rewards": 100, "title": "51.å› æœä¹‹æ‰‹"}, 300000: {"rewards": 100, "title": "52.å‘½é‹ç·¨ç¹”è€…"}, 400000: {"rewards": 100, "title": "53è¦å‰‡åˆ¶å®šè€…"}, 500000: {"rewards": 100, "title": "54.å¤§é“ä¹‹æº"}, 1000000: {"rewards": 500, "title": "55.çµ‚æ¥µé€ ç‰©ä¸»"},
};

const CULTIVATION_STAGES = (() => {
    let stages = [[0, 0, "å‡¡äººåˆå…¥é“"]];
    const LEVELS_PER_STAGE = 10;
    const score_cycle = Object.values(DIFFICULTY_WIN_RATE);
    let base_need_exp = 0;
    let need_step = 10;
    const stage_names = ["1.å‡¡äºº", "2.ç·´æ°£", "3.ç¯‰åŸº", "4.çµä¸¹", "5.å…ƒå¬°", "6.åŒ–ç¥", "7.ç…‰è™›", "8.åˆé«”", "9.å¤§ä¹˜", "10.æ¸¡åŠ«", "11.çœŸä»™", "12.é‡‘ä»™", "13.å¤ªä¹™é‡‘ä»™", "14.å¤§ç¾…é‡‘ä»™", "15.æ··å…ƒå¤§ç¾…", "16.ä»™ç‹", "17.ä»™å¸", "18.å¤©å°Š", "19.ç¥–ä»™", "20.ç„¡ä¸Š", "21.è¶…è„«è¼ªè¿´", "22.ç„¡ä¸Šæ¥µå¢ƒ", "23.æ··æ²Œç„¡æ¥µ", "24.å¤§é“æ­¸ä¸€", "25.å®‡å®™ä¹‹ä¸»", "26.å‰µä¸–çœŸç¥", "27.ç•Œå¤–å¤©å°Š", "28.æ··å…ƒé“å°Š", "29.å§‹æºå¸å°Š", "30.å¤ªåˆè–çš‡", "31.æ°¸æ†ä¹‹ç¥", "32.æ··æ²Œä¸»å®°", "33.è¬é“æ­¸å®—", "34.çµ‚æ¥µé€ ç‰©ä¸»", "35.ç„¡é™æ°¸å­˜è€…", "36.è¶…ç¶­è§€å¯Ÿè€…", "37.è¶…è¶Šè€…", "38.çœŸç†åŒ–èº«", "39.è™›ç„¡ä¹‹ç¥", "40.ç•Œä¸Šç•Œä¸»", "41.å”¯ä¸€çœŸç¥","42.å¤ªä¸Šé“ç¥–","43.æ°¸åŠ«ä¸æœ½","44.ç„¡æ¥µæœ¬æº","45.å¤šå…ƒå½¼å²¸ä¸»","46.åŸåˆæ„å¿—", "47.è¬ç•Œå§‹ç¥–","48.çµ‚ç„‰å‰µä¸–è€…","49.çµ•å°çœŸç†","50.è¶…è¶Šå”¯ä¸€","51.æ°¸æ†ç‹åº§"];
    stage_names.forEach(stage => {
        for (let sub = 1; sub <= LEVELS_PER_STAGE; sub++) {
            base_need_exp += need_step;
            const need_score = score_cycle[stages.length % score_cycle.length];
            stages.push([base_need_exp, need_score, `${stage}${sub}å±¤`]);
        }
        need_step = Math.max(need_step + 1, Math.floor(need_step * 1.5));
    });
    return stages;
})();

const GRADE_NAMES = ["å…¥å“", "ä¸‹å“", "ä¸­å“", "ä¸Šå“", "æ¥µå“", "è¶…å“", "çµ•å“", "å¯¶å“", "åœ°å“", "å¤©å“"];
const ITEM_TYPE_ORDER = ['å…µå™¨', 'åŠŸæ³•', 'é™£æ³•', 'ä»™ä¸¹', 'éˆå™¨', 'éˆç¬¦'];

const WEAPONS = {
    "å…¥å“é’ç«¹åŠ": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"}, "å…¥å“éŠ…èƒŒåˆ€": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"}, "å…¥å“ç¢é›²æ§": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "å¢åŠ 1æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸‹å“å¯’é‹’åŠ": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸‹å“è£‚çŸ³åˆ€": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸‹å“æ¸¸é¾æ§": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "å¢åŠ 2æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸­å“é’éœœåŠ": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸­å“èµ¤ç„°åˆ€": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸­å“éœ†ç½¡æ§": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "å¢åŠ 3æ¬¡ä½œç­”æ¬¡æ•¸"},
    "ä¸Šå“æµå…‰åŠ": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸Šå“è’¼é¯¨åˆ€": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"}, "ä¸Šå“ç ´è»æ§": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "å¢åŠ 4æ¬¡ä½œç­”æ¬¡æ•¸"},
    "æ¥µå“é›¢ç«é£›åŠ": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"}, "æ¥µå“ç„å†¥é¬¼åˆ€": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"}, "æ¥µå“ç´«é›»ç¥æ§": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "å¢åŠ 5æ¬¡ä½œç­”æ¬¡æ•¸"},
    "è¶…å“å¤ªè™›åŠèƒš": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"}, "è¶…å“ç„¡ç›¸åˆ€èƒ": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"}, "è¶…å“å¤©ç½¡æ§é­‚": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "å¢åŠ 6æ¬¡ä½œç­”æ¬¡æ•¸"},
    "çµ•å“å¤ªç™½æ˜ŸåŠ": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"}, "çµ•å“ç„æ­¦é®æµ·åˆ€": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"}, "çµ•å“é’é¾é©šé›·æ§": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "å¢åŠ 7æ¬¡ä½œç­”æ¬¡æ•¸"},
    "å¯¶å“æ‡¸å¤©é£›ä»™åŠ": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¯¶å“ç ´ç•Œéé‡‘æ§": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "å¢åŠ 8æ¬¡ä½œç­”æ¬¡æ•¸"},
    "åœ°å“å´‘å´™æ–¬é‚ªåŠ": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"}, "åœ°å“åšåœŸé®å²³åˆ€": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"}, "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "å¢åŠ 9æ¬¡ä½œç­”æ¬¡æ•¸"},
    "å¤©å“å¤ªæ¸…èª…ä»™åŠ": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¤©å“å¤©é“å¯©åˆ‘åˆ€": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"}, "å¤©å“ä¹¾å¤å®šæµ·æ§": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "å¢åŠ 10æ¬¡ä½œç­”æ¬¡æ•¸"},
};
const TECHNIQUES = {
    "å…¥å“ç¯‰åŸºåç´è¨£": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "é¡¯ç¾1å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å…¥å“æ¾é¹¤é•·é’åŠŸ": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "é¡¯ç¾1å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸‹å“å°å‘¨å¤©è¡Œæ°£": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "é¡¯ç¾2å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "é¡¯ç¾2å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸­å“ç„æ¯æ­¸ä¸€è¨£": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "é¡¯ç¾3å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "é¡¯ç¾3å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "é¡¯ç¾4å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸Šå“ç´«åºœé‚„çœŸç¶“": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "é¡¯ç¾4å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "æ¥µå“å¤ªé™°ç…‰æœˆç¶“": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "é¡¯ç¾5å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "æ¥µå“é›¢ç«å†¥é›·ç¶“": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "é¡¯ç¾5å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "é¡¯ç¾6å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "è¶…å“ç„¡ç›¸ç„åŠŸ": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "é¡¯ç¾6å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "çµ•å“ä¹è½‰é‡‘èº«è¨£": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "é¡¯ç¾7å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "çµ•å“äº”é›·æ­£æ³•": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "é¡¯ç¾7å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å¯¶å“æ´å¤©é€ åŒ–ç¶“": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "é¡¯ç¾8å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "é¡¯ç¾8å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "åœ°å“åœ°è—å†¥å¿ƒç¶“": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "é¡¯ç¾9å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "åœ°å“åšåœŸç„¡ç–†è¨£": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "é¡¯ç¾9å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å¤©å“å¤§é“æ··å…ƒè—": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "é¡¯ç¾10å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¤©å“ç„¡æ¥µæœ¬æºç¶“": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "é¡¯ç¾10å€‹éŒ¯èª¤ç­”æ¡ˆ"},
};
const FORMATIONS = {
    "å…¥å“ä¸‰æ‰èšéˆé™£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "å¢åŠ 1ç§’ä½œç­”æ™‚é–“"}, "å…¥å“å››é–€é™·æ•µé™£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "å¢åŠ 1ç§’ä½œç­”æ™‚é–“"},
    "ä¸‹å“äº”è¡Œè­·å±±é™£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "å¢åŠ 2ç§’ä½œç­”æ™‚é–“"}, "ä¸‹å“å…­ç”²è¿·è¸ªé™£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "å¢åŠ 2ç§’ä½œç­”æ™‚é–“"},
    "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "å¢åŠ 3ç§’ä½œç­”æ™‚é–“"}, "ä¸­å“å…«é–€é‡‘é–é™£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "å¢åŠ 3ç§’ä½œç­”æ™‚é–“"},
    "ä¸Šå“ä¹å®®å¹»å¤©é™£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "å¢åŠ 4ç§’ä½œç­”æ™‚é–“"}, "ä¸Šå“åäºŒå¤©ç½¡é™£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "å¢åŠ 4ç§’ä½œç­”æ™‚é–“"},
    "æ¥µå“ç„æ­¦é®æµ·é™£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "å¢åŠ 5ç§’ä½œç­”æ™‚é–“"}, "æ¥µå“ç™½è™è£‚å¤©é™£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "å¢åŠ 5ç§’ä½œç­”æ™‚é–“"},
    "è¶…å“é’é¾é¨°é›²é™£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "å¢åŠ 6ç§’ä½œç­”æ™‚é–“"}, "è¶…å“æœ±é›€ç„šå¤©é™£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "å¢åŠ 6ç§’ä½œç­”æ™‚é–“"},
    "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "å¢åŠ 7ç§’ä½œç­”æ™‚é–“"}, "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "å¢åŠ 7ç§’ä½œç­”æ™‚é–“"},
    "å¯¶å“è¬éˆæ­¸æºé™£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "å¢åŠ 8ç§’ä½œç­”æ™‚é–“"}, "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "å¢åŠ 8ç§’ä½œç­”æ™‚é–“"},
    "åœ°å“ä¹åœ°é®é­”å¤§é™£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "å¢åŠ 9ç§’ä½œç­”æ™‚é–“"}, "åœ°å“åšåœŸæ­¸å¢Ÿé™£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "å¢åŠ 9ç§’ä½œç­”æ™‚é–“"},
    "å¤©å“å…ˆå¤©ä¸€ç‚åŒ–åŠ«å¤§é™£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "å¢åŠ 10ç§’ä½œç­”æ™‚é–“"}, "å¤©å“ç„¡æ¥µä¹¾å¤ç•ŒåŸŸé™£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "å¢åŠ 10ç§’ä½œç­”æ™‚é–“"},
};

const UPGRADE_PATHS = {
    "å…¥å“é’ç«¹åŠ": "ä¸‹å“å¯’é‹’åŠ", "ä¸‹å“å¯’é‹’åŠ": "ä¸­å“é’éœœåŠ", "ä¸­å“é’éœœåŠ": "ä¸Šå“æµå…‰åŠ", "ä¸Šå“æµå…‰åŠ": "æ¥µå“é›¢ç«é£›åŠ", "æ¥µå“é›¢ç«é£›åŠ": "è¶…å“å¤ªè™›åŠèƒš", "è¶…å“å¤ªè™›åŠèƒš": "çµ•å“å¤ªç™½æ˜ŸåŠ", "çµ•å“å¤ªç™½æ˜ŸåŠ": "å¯¶å“æ‡¸å¤©é£›ä»™åŠ", "å¯¶å“æ‡¸å¤©é£›ä»™åŠ": "åœ°å“å´‘å´™æ–¬é‚ªåŠ", "åœ°å“å´‘å´™æ–¬é‚ªåŠ": "å¤©å“å¤ªæ¸…èª…ä»™åŠ",
    "å…¥å“éŠ…èƒŒåˆ€": "ä¸‹å“è£‚çŸ³åˆ€", "ä¸‹å“è£‚çŸ³åˆ€": "ä¸­å“èµ¤ç„°åˆ€", "ä¸­å“èµ¤ç„°åˆ€": "ä¸Šå“è’¼é¯¨åˆ€", "ä¸Šå“è’¼é¯¨åˆ€": "æ¥µå“ç„å†¥é¬¼åˆ€", "æ¥µå“ç„å†¥é¬¼åˆ€": "è¶…å“ç„¡ç›¸åˆ€èƒ", "è¶…å“ç„¡ç›¸åˆ€èƒ": "çµ•å“ç„æ­¦é®æµ·åˆ€", "çµ•å“ç„æ­¦é®æµ·åˆ€": "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€", "å¯¶å“æˆ®ç¥è¡€æœˆåˆ€": "åœ°å“åšåœŸé®å²³åˆ€", "åœ°å“åšåœŸé®å²³åˆ€": "å¤©å“å¤©é“å¯©åˆ‘åˆ€",
    "å…¥å“ç¢é›²æ§": "ä¸‹å“æ¸¸é¾æ§", "ä¸‹å“æ¸¸é¾æ§": "ä¸­å“éœ†ç½¡æ§", "ä¸­å“éœ†ç½¡æ§": "ä¸Šå“ç ´è»æ§", "ä¸Šå“ç ´è»æ§": "æ¥µå“ç´«é›»ç¥æ§", "æ¥µå“ç´«é›»ç¥æ§": "è¶…å“å¤©ç½¡æ§é­‚", "è¶…å“å¤©ç½¡æ§é­‚": "çµ•å“é’é¾é©šé›·æ§", "çµ•å“é’é¾é©šé›·æ§": "å¯¶å“ç ´ç•Œéé‡‘æ§", "å¯¶å“ç ´ç•Œéé‡‘æ§": "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§", "åœ°å“å¾ŒåœŸèª“ç›Ÿæ§": "å¤©å“ä¹¾å¤å®šæµ·æ§",
    "å…¥å“ç¯‰åŸºåç´è¨£": "ä¸‹å“å°å‘¨å¤©è¡Œæ°£", "ä¸‹å“å°å‘¨å¤©è¡Œæ°£": "ä¸­å“ç„æ¯æ­¸ä¸€è¨£", "ä¸­å“ç„æ¯æ­¸ä¸€è¨£": "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£", "ä¸Šå“ä¸‰èŠ±èšé ‚è¨£": "æ¥µå“å¤ªé™°ç…‰æœˆç¶“", "æ¥µå“å¤ªé™°ç…‰æœˆç¶“": "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“", "è¶…å“å¤ªä¹™æ­¸å…ƒç¶“": "çµ•å“ä¹è½‰é‡‘èº«è¨£", "çµ•å“ä¹è½‰é‡‘èº«è¨£": "å¯¶å“æ´å¤©é€ åŒ–ç¶“", "å¯¶å“æ´å¤©é€ åŒ–ç¶“": "åœ°å“åœ°è—å†¥å¿ƒç¶“", "åœ°å“åœ°è—å†¥å¿ƒç¶“": "å¤©å“å¤§é“æ··å…ƒè—",
    "å…¥å“æ¾é¹¤é•·é’åŠŸ": "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“", "ä¸‹å“é’æœ¨é¤Šå…ƒè¡“": "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡", "ä¸­å“èµ¤é™½ç…‰é«”ç¯‡": "ä¸Šå“ç´«åºœé‚„çœŸç¶“", "ä¸Šå“ç´«åºœé‚„çœŸç¶“": "æ¥µå“é›¢ç«å†¥é›·ç¶“", "æ¥µå“é›¢ç«å†¥é›·ç¶“": "è¶…å“ç„¡ç›¸ç„åŠŸ", "è¶…å“ç„¡ç›¸ç„åŠŸ": "çµ•å“äº”é›·æ­£æ³•", "çµ•å“äº”é›·æ­£æ³•": "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£", "å¯¶å“å…ˆå¤©ä¸€ç‚è¨£": "åœ°å“åšåœŸç„¡ç–†è¨£", "åœ°å“åšåœŸç„¡ç–†è¨£": "å¤©å“ç„¡æ¥µæœ¬æºç¶“",
    "å…¥å“ä¸‰æ‰èšéˆé™£": "ä¸‹å“äº”è¡Œè­·å±±é™£", "ä¸‹å“äº”è¡Œè­·å±±é™£": "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£", "ä¸­å“ä¸ƒæ›œæ˜Ÿé–€é™£": "ä¸Šå“ä¹å®®å¹»å¤©é™£", "ä¸Šå“ä¹å®®å¹»å¤©é™£": "æ¥µå“ç„æ­¦é®æµ·é™£", "æ¥µå“ç„æ­¦é®æµ·é™£": "è¶…å“é’é¾é¨°é›²é™£", "è¶…å“é’é¾é¨°é›²é™£": "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£", "çµ•å“å››è±¡åˆä¸€é®åŸŸé™£": "å¯¶å“è¬éˆæ­¸æºé™£", "å¯¶å“è¬éˆæ­¸æºé™£": "åœ°å“ä¹åœ°é®é­”å¤§é™£", "åœ°å“ä¹åœ°é®é­”å¤§é™£": "å¤©å“å…ˆå¤©ä¸€ç‚åŒ–åŠ«å¤§é™£",
    "å…¥å“å››é–€é™·æ•µé™£": "ä¸‹å“å…­ç”²è¿·è¸ªé™£", "ä¸‹å“å…­ç”²è¿·è¸ªé™£": "ä¸­å“å…«é–€é‡‘é–é™£", "ä¸­å“å…«é–€é‡‘é–é™£": "ä¸Šå“åäºŒå¤©ç½¡é™£", "ä¸Šå“åäºŒå¤©ç½¡é™£": "æ¥µå“ç™½è™è£‚å¤©é™£", "æ¥µå“ç™½è™è£‚å¤©é™£": "è¶…å“æœ±é›€ç„šå¤©é™£", "è¶…å“æœ±é›€ç„šå¤©é™£": "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£", "çµ•å“å¤ªä¹™æ··å…ƒå°å¤©é™£": "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£", "å¯¶å“å…ˆå¤©å…©å„€åæ¼”é™£": "åœ°å“åšåœŸæ­¸å¢Ÿé™£", "åœ°å“åšåœŸæ­¸å¢Ÿé™£": "å¤©å“ç„¡æ¥µä¹¾å¤ç•ŒåŸŸé™£",
};

const ITEM_EFFECTS = {
    "å…¥å“ä»™ä¸¹": {"type": "exp", "n": 10, "desc": "å¢åŠ  10 ä¿®ç…‰ç¶“é©—"}, "ä¸‹å“ä»™ä¸¹": {"type": "exp", "n": 30, "desc": "å¢åŠ  30 ä¿®ç…‰ç¶“é©—"}, "ä¸­å“ä»™ä¸¹": {"type": "exp", "n": 70, "desc": "å¢åŠ  70 ä¿®ç…‰ç¶“é©—"}, "ä¸Šå“ä»™ä¸¹": {"type": "exp", "n": 150, "desc": "å¢åŠ  150 ä¿®ç…‰ç¶“é©—"}, "æ¥µå“ä»™ä¸¹": {"type": "exp", "n": 310, "desc": "å¢åŠ  310 ä¿®ç…‰ç¶“é©—"}, "è¶…å“ä»™ä¸¹": {"type": "exp", "n": 630, "desc": "å¢åŠ  630 ä¿®ç…‰ç¶“é©—"}, "çµ•å“ä»™ä¸¹": {"type": "exp", "n": 1270, "desc": "å¢åŠ  1270 ä¿®ç…‰ç¶“é©—"}, "å¯¶å“ä»™ä¸¹": {"type": "exp", "n": 2550, "desc": "å¢åŠ  2550 ä¿®ç…‰ç¶“é©—"}, "åœ°å“ä»™ä¸¹": {"type": "exp", "n": 5110, "desc": "å¢åŠ  5110 ä¿®ç…‰ç¶“é©—"}, "å¤©å“ä»™ä¸¹": {"type": "exp", "n": 10230, "desc": "å¢åŠ  10230 ä¿®ç…‰ç¶“é©—"},
    "å…¥å“éˆç¬¦": {"type": "wrong", "n": 1, "desc": "æ’é™¤ 1 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸‹å“éˆç¬¦": {"type": "wrong", "n": 2, "desc": "æ’é™¤ 2 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸­å“éˆç¬¦": {"type": "wrong", "n": 3, "desc": "æ’é™¤ 3 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "ä¸Šå“éˆç¬¦": {"type": "wrong", "n": 4, "desc": "æ’é™¤ 4 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "æ¥µå“éˆç¬¦": {"type": "wrong", "n": 5, "desc": "æ’é™¤ 5 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "è¶…å“éˆç¬¦": {"type": "wrong", "n": 6, "desc": "æ’é™¤ 6 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "çµ•å“éˆç¬¦": {"type": "wrong", "n": 7, "desc": "æ’é™¤ 7 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¯¶å“éˆç¬¦": {"type": "wrong", "n": 8, "desc": "æ’é™¤ 8 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "åœ°å“éˆç¬¦": {"type": "wrong", "n": 9, "desc": "æ’é™¤ 9 å€‹éŒ¯èª¤ç­”æ¡ˆ"}, "å¤©å“éˆç¬¦": {"type": "wrong", "n": 10, "desc": "æ’é™¤ 10 å€‹éŒ¯èª¤ç­”æ¡ˆ"},
    "å…¥å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸‹å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸­å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "ä¸Šå“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "æ¥µå“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "è¶…å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "çµ•å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "å¯¶å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "åœ°å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"}, "å¤©å“éˆå™¨": {"type": "correct", "n": 0, "desc": "é¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆ"},
    ...WEAPONS, ...TECHNIQUES, ...FORMATIONS
};

const ITEM_STONE_PRICES = {
    "å…¥å“ä»™ä¸¹": 3, "ä¸‹å“ä»™ä¸¹": 6, "ä¸­å“ä»™ä¸¹": 12, "ä¸Šå“ä»™ä¸¹": 24, "æ¥µå“ä»™ä¸¹": 48, "è¶…å“ä»™ä¸¹": 96, "çµ•å“ä»™ä¸¹": 192, "å¯¶å“ä»™ä¸¹": 384, "åœ°å“ä»™ä¸¹": 768, "å¤©å“ä»™ä¸¹": 1536,
    "å…¥å“éˆç¬¦": 1, "ä¸‹å“éˆç¬¦": 2, "ä¸­å“éˆç¬¦": 4, "ä¸Šå“éˆç¬¦": 8, "æ¥µå“éˆç¬¦": 16, "è¶…å“éˆç¬¦": 32, "çµ•å“éˆç¬¦": 64, "å¯¶å“éˆç¬¦": 128, "åœ°å“éˆç¬¦": 256, "å¤©å“éˆç¬¦": 512,
    "å…¥å“éˆå™¨": 5, "ä¸‹å“éˆå™¨": 10, "ä¸­å“éˆå™¨": 20, "ä¸Šå“éˆå™¨": 40, "æ¥µå“éˆå™¨": 80, "è¶…å“éˆå™¨": 160, "çµ•å“éˆå™¨": 320, "å¯¶å“éˆå™¨": 640, "åœ°å“éˆå™¨": 1280, "å¤©å“éˆå™¨": 2560,
};

const ITEM_RENAME_MAP = {
    "æ™®é€šä»™ä¸¹": "å…¥å“ä»™ä¸¹", "æ™®é€šéˆç¬¦": "å…¥å“éˆç¬¦", "æ™®é€šéˆå™¨": "å…¥å“éˆå™¨",
};

const EMOJIS = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜¡","ğŸ˜­","ğŸ˜","ğŸ˜±","ğŸ˜´","ğŸ˜‡","ğŸ¤–"];
const ANIMALS = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ¦„","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤"];
const FOODS = ["ğŸ","ğŸŠ","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ¥‘","ğŸ","ğŸ¥","ğŸ’","ğŸ”","ğŸŸ","ğŸ•","ğŸŒ­","ğŸ¥ª","ğŸ¥—","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸœ"];
const COLORS = ["ğŸ”´","ğŸŸ ","ğŸŸ¡","ğŸŸ¢","ğŸ”µ","ğŸŸ£","âš«","âšª","ğŸŸ¤","ğŸŸ¥","ğŸŸ§","ğŸŸ¨","ğŸŸ©","ğŸŸ¦","ğŸŸª","â¬›","â¬œ","ğŸŸ«","ğŸ”¶","ğŸ”·"];
const SHAPES = ["ğŸ”º","ğŸ”µ","â¬›","â­","ğŸŸ©","ğŸŸ§","ğŸŸ¥","â¬œ","ğŸ”¶","ğŸ”·","ğŸ”³","ğŸ”²","ğŸŸ«","ğŸ”¸","ğŸ”¹","â¬Ÿ","â¬¢","â¬£","âº","â¹"];
const PLACES = ["ğŸ ","ğŸ¢","ğŸ¬","ğŸ­","ğŸ°","ğŸ¯","ğŸï¸","ğŸ–ï¸","â›©ï¸","ğŸ¡","ğŸ¢","ğŸ ","ğŸ—½","ğŸ—¼","â›²","ğŸ•Œ","â›ª","ğŸ›•","ğŸ•ï¸"];
const FLAGS = ["ğŸ‡¹ğŸ‡¼","ğŸ‡¯ğŸ‡µ","ğŸ‡°ğŸ‡·","ğŸ‡¨ğŸ‡³","ğŸ‡ºğŸ‡¸","ğŸ‡¬ğŸ‡§","ğŸ‡«ğŸ‡·","ğŸ‡©ğŸ‡ª","ğŸ‡®ğŸ‡¹","ğŸ‡ªğŸ‡¸","ğŸ‡§ğŸ‡·","ğŸ‡¨ğŸ‡¦","ğŸ‡¦ğŸ‡º","ğŸ‡³ğŸ‡¿","ğŸ‡·ğŸ‡º","ğŸ‡¸ğŸ‡ª","ğŸ‡³ğŸ‡´","ğŸ‡®ğŸ‡³","ğŸ‡²ğŸ‡½","ğŸ‡¿ğŸ‡¦"];
const NATURE = ["ğŸŒ","ğŸŒ","ğŸŒ§ï¸","â›ˆï¸","ğŸŒªï¸","ğŸŒˆ","ğŸŒŠ","ğŸŒ‹","â„ï¸","ğŸƒ"];
const CARDS = ["ğŸ‚±","ğŸ‚²","ğŸ‚³","ğŸ‚´","ğŸ‚µ","ğŸ‚¶","ğŸ‚·","ğŸ‚¸","ğŸ‚¹","ğŸ‚º","ğŸ‚»","ğŸ‚¼","ğŸ‚½","ğŸ‚¾","ğŸ‚¡","ğŸ‚¢","ğŸ‚£","ğŸ‚¤","ğŸ‚¥","ğŸ‚¦","ğŸ‚§","ğŸ‚¨","ğŸ‚©","ğŸ‚ª","ğŸ‚«","ğŸ‚¬","ğŸ‚­","ğŸ‚®","ğŸƒ","ğŸƒ‚","ğŸƒƒ","ğŸƒ„","ğŸƒ…","ğŸƒ†","ğŸƒ‡","ğŸƒˆ","ğŸƒ‰","ğŸƒŠ","ğŸƒ‹","ğŸƒŒ","ğŸƒ","ğŸƒ","ğŸƒ‘","ğŸƒ’","ğŸƒ“","ğŸƒ”","ğŸƒ•","ğŸƒ–","ğŸƒ—","ğŸƒ˜","ğŸƒ™","ğŸƒš","ğŸƒ›","ğŸƒœ","ğŸƒ","ğŸƒ","ğŸ‚ ","ğŸƒ","ğŸƒŸ"];
const MAHJONG = ["ğŸ€‡","ğŸ€ˆ","ğŸ€‰","ğŸ€Š","ğŸ€‹","ğŸ€Œ","ğŸ€","ğŸ€","ğŸ€","ğŸ€™","ğŸ€š","ğŸ€›","ğŸ€œ","ğŸ€","ğŸ€","ğŸ€Ÿ","ğŸ€ ","ğŸ€¡","ğŸ€","ğŸ€‘","ğŸ€’","ğŸ€“","ğŸ€”","ğŸ€•","ğŸ€–","ğŸ€—","ğŸ€˜","ğŸ€€","ğŸ€","ğŸ€‚","ğŸ€ƒ","ğŸ€„","ğŸ€…","ğŸ€†"];
const VEHICLES = ["ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸï¸","ğŸš“","ğŸš‘","ğŸš’","ğŸš","ğŸšš","ğŸš›","ğŸšœ","ğŸ›»","ğŸ›º","ğŸš²","ğŸ›µ","ğŸï¸","ğŸš”","ğŸš","âœˆï¸","ğŸ›«","ğŸ›¬","ğŸ›©ï¸","ğŸš","ğŸ›¶","ğŸš¤","â›µ","ğŸ›³ï¸","ğŸš€"];
const ZODIACS = ["â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“"];
const CLOCKS = ["ğŸ•›","ğŸ•","ğŸ•‘","ğŸ•’","ğŸ•“","ğŸ•”","ğŸ••","ğŸ•–","ğŸ•—","ğŸ•˜","ğŸ•™","ğŸ•š"];
const PROFESSIONS = ["ğŸ§‘â€âš•ï¸","ğŸ§‘â€ğŸ«","ğŸ§‘â€ğŸ³","ğŸ§‘â€ğŸ’»","ğŸ§‘â€ğŸ”¬","ğŸ§‘â€ğŸ¨","ğŸ§‘â€ğŸš’","ğŸ§‘â€âœˆï¸","ğŸ§‘â€ğŸš€","ğŸ§‘â€ğŸ”§","ğŸ§‘â€ğŸŒ¾","ğŸ§‘â€ğŸ­","ğŸ§‘â€âš–ï¸","ğŸ§‘â€ğŸ¤","ğŸ§‘â€ğŸ“","ğŸ‘®â€â™‚ï¸","ğŸ‘·â€â™‚ï¸"];
const SPORTS = ["ğŸ–ï¸","ğŸ†","ğŸ…","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","âš¾","ğŸ¥","ğŸ€","ğŸ","ğŸˆ","ğŸ‰","ğŸ¾","ğŸ¥","ğŸ³","ğŸ","ğŸ‘","ğŸ’","ğŸ¥","ğŸ“","ğŸ¸","ğŸ¥Š","ğŸ¥‹","ğŸ¥…","â›³","â›¸ï¸","ğŸ£","ğŸ¤¿","ğŸ½","ğŸ¿","ğŸ›·","ğŸ¥Œ","ğŸ¯"];
const OFFICE = ["ğŸ“”","ğŸ“•","ğŸ“–","ğŸ“—","ğŸ“˜","ğŸ“™","ğŸ“š","ğŸ““","ğŸ“’","ğŸ“ƒ","ğŸ“œ","ğŸ“„","ğŸ“°","ğŸ—ï¸","ğŸ“‘","ğŸ”–","ğŸ·ï¸","âœ‰ï¸","ğŸ“§","ğŸ“¨","ğŸ“©","ğŸ“¤","ğŸ“¥","ğŸ“¦","ğŸ“«","ğŸ“ª","ğŸ“¬","ğŸ“­","ğŸ“®","ğŸ—³ï¸","âœï¸","âœ’ï¸","ğŸ–‹ï¸","ğŸ–Šï¸","ğŸ–Œï¸","ğŸ–ï¸","ğŸ“","ğŸ’¼","ğŸ“","ğŸ“‚","ğŸ—‚ï¸","ğŸ“…","ğŸ“†","ğŸ—’ï¸","ğŸ—“ï¸","ğŸ“‡","ğŸ“ˆ","ğŸ“‰","ğŸ“Š","ğŸ“‹","ğŸ“Œ","ğŸ“","ğŸ“","ğŸ–‡ï¸","ğŸ“","ğŸ“","âœ‚ï¸","ğŸ—ƒï¸","ğŸ—„ï¸","ğŸ—‘ï¸","ğŸªª"];
const TOOLS = ["ğŸ§³","ğŸŒ¡ï¸","ğŸ§¸","ğŸ§¶","ğŸª¢","ğŸ”","ğŸ”","ğŸ•¯ï¸","ğŸ’¡","ğŸ”¦","ğŸ”’","ğŸ”“","ğŸ”","ğŸ”","ğŸ”‘","ğŸ—ï¸","ğŸ”¨","ğŸª“","â›ï¸","âš’ï¸","ğŸ› ï¸","ğŸ—¡ï¸","âš”ï¸","ğŸ’£","ğŸªƒ","ğŸ¹","ğŸ›¡ï¸","ğŸªš","ğŸ”§","ğŸª›","ğŸ”©","âš™ï¸","ğŸ—œï¸","âš–ï¸","ğŸ”—","â›“ï¸","ğŸ’¥","ğŸª","ğŸ§°","ğŸ§²","ğŸªœ","ğŸª","âš—ï¸","ğŸ§ª","ğŸ§«","ğŸ”¬","ğŸ”­","ğŸ“¡","ğŸ’‰","ğŸ©¹","ğŸ©¼","ğŸ©º","ğŸ©»","ğŸšª","ğŸª","ğŸªŸ","ğŸ›ï¸","ğŸ›‹ï¸","ğŸª‘","ğŸš½","ğŸª ","ğŸš¿","ğŸ›","ğŸª¤","ğŸª’","ğŸ§´","ğŸ§·","ğŸ§¹","ğŸ§º","ğŸ§»","ğŸª£","ğŸ§¼","ğŸ«§","ğŸª¥","ğŸ§½","ğŸ§¯","ğŸ›’","ğŸš¬","âš°ï¸","ğŸª¦","âš±ï¸","ğŸª§"];
// è‡ªå‹•æ‹†åˆ†è¾¦å…¬æ–‡å…·èˆ‡å·¥å…·/å®¶å±…ç”¨å“ç‚ºå‰åŠ(A)èˆ‡å¾ŒåŠ(B)
const OFFICE_A = OFFICE.slice(0, Math.ceil(OFFICE.length / 2));
const OFFICE_B = OFFICE.slice(Math.ceil(OFFICE.length / 2));
const TOOLS_A = TOOLS.slice(0, Math.ceil(TOOLS.length / 2));
const TOOLS_B = TOOLS.slice(Math.ceil(TOOLS.length / 2));

// # === æ–°å¢ç¬¦è™Ÿèˆ‡å­—æ¯è¨“ç·´é¡Œåº« ===
// ç¾…é¦¬æ•¸å­—ï¼ˆå¤§å¯« 1â€“12ï¼‰
const ROMAN_NUMERALS_U = ["â… ","â…¡","â…¢","â…£","â…¤","â…¥","â…¦","â…§","â…¨","â…©","â…ª","â…«"];
// ç¾…é¦¬æ•¸å­—ï¼ˆå°å¯« 1â€“12ï¼‰
const ROMAN_NUMERALS_L = ["â…°","â…±","â…²","â…³","â…´","â…µ","â…¶","â…·","â…¸","â…¹","â…º","â…»"];
// æ•¸å­¸ç¬¦è™Ÿ
const MATH_SYMBOLS = ["+","âˆ’","Ã—","Ã·","Â±","=","â‰ ","â‰ˆ","â‰’","âˆ½","â‰¦","â‰§","â‰¤","â‰¥","âˆµ","âˆ´","ï¼‹","ï¼","ï¹¢","ï¹£","ï¼œ","ï¼","ï¹¤","ï¹¥","â‰®","â‰¯","^","âˆš","âˆ","âˆ"];
// # ç¾…é¦¬æ•¸å­—ï¼ˆå¤§å¯« 1-12ï¼‰
const ROMAN_U = ["â… ","â…¡","â…¢","â…£","â…¤","â…¥","â…¦","â…§","â…¨","â…©","â…ª","â…«"];
// # ç¾…é¦¬æ•¸å­—ï¼ˆå°å¯« 1-12ï¼‰
const ROMAN_L = ["â…°","â…±","â…²","â…³","â…´","â…µ","â…¶","â…·","â…¸","â…¹","â…º","â…»"];
// å–®ä½ç¬¦è™Ÿ
const UNIT_SYMBOLS = ["â„ƒ","â„‰","ã™","ãš","ã›","ãœ","ã","ã","ãŸ","ã ","ã¡","ã¢","ã£","ã¤","ã¥","ã¦","ã","ã•","ã","ã","ã","ã„"];
// æœˆä»½ç¬¦è™Ÿï¼ˆä½¿ç”¨ CJK åœˆå­—æœˆä»½ 1â€“12ï¼‰
const MONTH_SYMBOLS = ["ã‹€","ã‹","ã‹‚","ã‹ƒ","ã‹„","ã‹…","ã‹†","ã‹‡","ã‹ˆ","ã‹‰","ã‹Š","ã‹‹"];
// æ—¥æœŸç¬¦è™Ÿï¼ˆ1ï½31 èˆ‡ 0ï¼‰
const DATE_SYMBOLS = ["ã ","ã¡","ã¢","ã£","ã¤","ã¥","ã¦","ã§","ã¨","ã©","ãª","ã«","ã¬","ã­","ã®","ã¯","ã°","ã±","ã²","ã³","ã´","ãµ","ã¶","ã·","ã¸","ã¹","ãº","ã»","ã¼","ã½","ã¾"];
// æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯« Aâ€“Zï¼‰
const BOLD_SERIF_U = ["ğ€","ğ","ğ‚","ğƒ","ğ„","ğ…","ğ†","ğ‡","ğˆ","ğ‰","ğŠ","ğ‹","ğŒ","ğ","ğ","ğ","ğ","ğ‘","ğ’","ğ“","ğ”","ğ•","ğ–","ğ—","ğ˜","ğ™"];
// æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå°å¯« aâ€“zï¼‰
const BOLD_SERIF_L = ["ğš","ğ›","ğœ","ğ","ğ","ğŸ","ğ ","ğ¡","ğ¢","ğ£","ğ¤","ğ¥","ğ¦","ğ§","ğ¨","ğ©","ğª","ğ«","ğ¬","ğ­","ğ®","ğ¯","ğ°","ğ±","ğ²","ğ³"];
// è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰
const SCRIPT_U = ["ğ’œ","ğµ","ğ’","ğ’Ÿ","ğ¸","ğ¹","ğ’¢","ğ»","ğ¼","ğ’¥","ğ’¦","ğ¿","ğ‘€","ğ’©","ğ’ª","ğ’«","ğ’¬","ğ‘…","ğ’®","ğ’¯","ğ’°","ğ’±","ğ’²","ğ’³","ğ’´","ğ’µ"];
// è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰
const SCRIPT_L = ["ğ’¶","ğ’·","ğ’¸","ğ’¹","ğ‘’","ğ’»","ğ‘”","ğ’½","ğ’¾","ğ’¿","ğ“€","ğ“","ğ“‚","ğ“ƒ","ğ‘œ","ğ“…","ğ“†","ğ“‡","ğ“ˆ","ğ“‰","ğ“Š","ğ“‹","ğ“Œ","ğ“","ğ“","ğ“"];
// å¸Œè‡˜å­—æ¯ï¼ˆå¤§å¯«ï¼‰
const GREEK_U = ["Î‘","Î’","Î“","Î”","Î•","Î–","Î—","Î˜","Î™","Îš","Î›","Îœ","Î","Î","ÎŸ","Î ","Î¡","Î£","Î¤","Î¥","Î¦","Î§","Î¨","Î©"];
// å¸Œè‡˜å­—æ¯ï¼ˆå°å¯«ï¼‰
const GREEK_L = ["Î±","Î²","Î³","Î´","Îµ","Î¶","Î·","Î¸","Î¹","Îº","Î»","Î¼","Î½","Î¾","Î¿","Ï€","Ï","Ïƒ","Ï„","Ï…","Ï†","Ï‡","Ïˆ","Ï‰"];
// æ³¨éŸ³ç¬¦è™Ÿ
const BOPOMOFO = ["ã„…","ã„†","ã„‡","ã„ˆ","ã„‰","ã„Š","ã„‹","ã„Œ","ã„","ã„","ã„","ã„","ã„‘","ã„’","ã„“","ã„”","ã„•","ã„–","ã„—","ã„˜","ã„™","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦","ã„§","ã„¨","ã„©","Ë™","ËŠ","Ë‡","Ë‹"];
// æ—¥æ–‡å¹³å‡å
const HIRAGANA = ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“","ãŒ","ã","ã","ã’","ã”","ã•","ã—","ã™","ã›","ã","ã–","ã˜","ãš","ãœ","ã","ãŸ","ã¡","ã¤","ã¦","ã¨","ã ","ã¢","ã¥","ã§","ã©","ãª","ã«","ã¬","ã­","ã®","ã¯","ã²","ãµ","ã¸","ã»","ã°","ã³","ã¶","ã¹","ã¼","ã±","ã´","ã·","ãº","ã½","ã¾","ã¿","ã‚€","ã‚","ã‚‚","ã‚„","ã‚†","ã‚ˆ","ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚","ã‚","ã‚","ã‚‘","ã‚’","ã‚“"];
// æ—¥æ–‡ç‰‡å‡å
const KATAKANA = ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª","ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³","ã‚¬","ã‚®","ã‚°","ã‚²","ã‚´","ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½","ã‚¶","ã‚¸","ã‚º","ã‚¼","ã‚¾","ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ","ãƒ€","ãƒ‚","ãƒ…","ãƒ‡","ãƒ‰","ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ","ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›","ãƒ","ãƒ“","ãƒ–","ãƒ™","ãƒœ","ãƒ‘","ãƒ”","ãƒ—","ãƒš","ãƒ","ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢","ãƒ¤","ãƒ¦","ãƒ¨","ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­","ãƒ¯","ãƒ°","ãƒ±","ãƒ²","ãƒ³"];
// éŸ“æ–‡å…ƒéŸ³èˆ‡è¼”éŸ³ç¬¦è™Ÿï¼ˆå®Œæ•´ Jamo åˆ—è¡¨ï¼‰
const KOREAN_JAMO = ["ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¸","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…ƒ","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…","ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…¥","ã…¦","ã…§","ã…¨","ã…©","ã…ª","ã…«","ã…¬","ã…­","ã…®","ã…¯","ã…°","ã…±","ã…²","ã…³","ã…´","ã…µ","ã…¶","ã…·","ã…¸","ã…¹","ã…º","ã…»","ã…¼","ã…½","ã…¾","ã…¿","ã†€","ã†","ã†‚","ã†ƒ","ã†„","ã†…","ã††","ã†‡","ã†ˆ","ã†‰","ã†Š"];
// è²¨å¹£ç¬¦è™Ÿ
const CURRENCY_SYMBOLS = ["Â¤","Â¢","$","à¸¿","â‚«","à§³","â‚­","â‚¥","â‚±","â‚¹","â‚¨","â‚ª","â‚¸","â‚®","â‚©","Â¥","áŸ›","â‚ ","â‚¯","â‚¬","Æ’","â‚£","â‚´","â„³","â‚§","â‚°","Â£","â‚½","â‚³","â‚¡","â‚¢","â‚²","â‚µ","â‚¦"];
// éŸ³æ¨‚ç¬¦è™Ÿ
const MUSIC_SYMBOLS = ["â™ª","â™«","â™¬","â™­","â™¯","ğ„","ğ„¢","ğ„«","â™®","ğ„ª","ğ„­","ğ„®","ğ„¯","ğ„°ğ„±","ğ„²","ğ„³"];
// åœ‹éš›è±¡æ£‹ç¬¦è™Ÿ
const CHESS_SYMBOLS = ["â™”","â™•","â™–","â™—","â™˜","â™™","â™š","â™›","â™œ","â™","â™","â™Ÿ"];

// # æ–°å¢ï¼šç”Ÿè‚–ç¬¦è™Ÿï¼ˆåäºŒç”Ÿè‚–ï¼‰
const CHINESE_ZODIAC = ["ğŸ­","ğŸ®","ğŸ¯","ğŸ°","ğŸ²","ğŸ","ğŸ´","ğŸ‘","ğŸµ","ğŸ”","ğŸ¶","ğŸ·"];
// # æ–°å¢ï¼šé‡‘åº¸å°èªªåå››éƒ¨ï¼ˆé£›é›ªé€£å¤©å°„ç™½é¹¿ç¬‘æ›¸ç¥ä¿ å€šç¢§é´›ï¼‰
const JINYONG_BOOKS = ["é£›","é›ª","é€£","å¤©","å°„","ç™½","é¹¿","ç¬‘","æ›¸","ç¥","ä¿ ","å€š","ç¢§","é´›"];
// # æ–°å¢ï¼šä¸­æ–‡æ•¸å­—ï¼ˆå¤§å¯«ï¼‰
const CHINESE_BIG_NUMERALS = ["å£¹","è²³","åƒ","è‚†","ä¼","é™¸","æŸ’","æŒ","ç–","æ‹¾","ä½°","ä»Ÿ","è¬","å„„","å…†","åœ“","è§’","åˆ†","é›¶","æ•´"];

// # æ–°å¢ï¼šäºŒåå››ç¯€æ°£åˆ—è¡¨
// åŒ…å«æ˜¥å¤ç§‹å†¬å››å­£çš„äºŒåå››ç¯€æ°£ï¼Œç”¨æ–¼ç¯€æ°£è¨“ç·´éŠæˆ²ã€‚
const SOLAR_TERMS = [
    "ç«‹æ˜¥","é›¨æ°´","é©šèŸ„","æ˜¥åˆ†","æ¸…æ˜","ç©€é›¨",
    "ç«‹å¤","å°æ»¿","èŠ’ç¨®","å¤è‡³","å°æš‘","å¤§æš‘",
    "ç«‹ç§‹","è™•æš‘","ç™½éœ²","ç§‹åˆ†","å¯’éœ²","éœœé™",
    "ç«‹å†¬","å°é›ª","å¤§é›ª","å†¬è‡³","å°å¯’","å¤§å¯’"
];

// # æ–°å¢ï¼šå°‡æ—¥æ–‡å’ŒéŸ“æ–‡ç¬¦è™Ÿæ‹†åˆ†ç‚º Aã€B å…©éƒ¨åˆ†
const HIRAGANA_A = HIRAGANA.slice(0, Math.ceil(HIRAGANA.length / 2));
const HIRAGANA_B = HIRAGANA.slice(Math.ceil(HIRAGANA.length / 2));
const KATAKANA_A = KATAKANA.slice(0, Math.ceil(KATAKANA.length / 2));
const KATAKANA_B = KATAKANA.slice(Math.ceil(KATAKANA.length / 2));
const KOREAN_JAMO_A = KOREAN_JAMO.slice(0, Math.ceil(KOREAN_JAMO.length / 2));
const KOREAN_JAMO_B = KOREAN_JAMO.slice(Math.ceil(KOREAN_JAMO.length / 2));

// ===================== æ–°å¢åå¤©å¹²ã€åäºŒåœ°æ”¯åŠå…­åå¹²æ”¯çµ„åˆ =====================
// åå¤©å¹²åˆ—è¡¨
const TIANGAN = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
// åäºŒåœ°æ”¯åˆ—è¡¨
const DIZHI = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
// å…­åå¹²æ”¯çµ„åˆï¼šåå¤©å¹²èˆ‡åäºŒåœ°æ”¯ä¾åºå¾ªç’°çµ„æˆï¼Œå…± 60 çµ„
const GANZHI = (() => {
    const arr = [];
    for (let i = 0; i < 60; i++) {
        arr.push(TIANGAN[i % TIANGAN.length] + DIZHI[i % DIZHI.length]);
    }
    return arr;
})();


const ALL_GAMES = [
    { name: "å¾ 1ï½10 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_hidden" }, { name: "å¾ 1ï½20 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_20" }, { name: "å¾ 1ï½30 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", func: "game_guess_30" }, { name: "å¯¶ç®±è¨“ç·´ï¼šé¸å‡ºæ­£ç¢ºçš„", func: "game_treasure_box" }, { name: "é¸å‡ºå¥½é‹è¡¨æƒ…ç¬¦è™Ÿ", func: "game_emoji_pick" }, { name: "é¸å‡ºå¹¸é‹å‹•ç‰©", func: "game_animals" }, { name: "é¸å‡ºå¹¸é‹é£Ÿç‰©", func: "game_foods" }, { name: "é¸å‡ºå¹¸é‹åœ°é»", func: "game_places" }, { name: "é¸å‡ºå¹¸é‹åœ–å½¢", func: "game_shape_select" }, { name: "æ‰¾å‡ºå¹¸é‹é¡è‰²", func: "game_color_select" }, { name: "é¸å‡ºå¹¸é‹åœ‹æ——", func: "game_flags" }, { name: "é¸å‡ºå¹¸é‹è‡ªç„¶ç¾è±¡", func: "game_nature" }, { name: "é¸å‡ºå¹¸é‹æ’²å…‹ç‰Œç¬¦è™Ÿ", func: "game_cards" }, { name: "é¸å‡ºå¹¸é‹éº»å°‡åœ–æ¡ˆ", func: "game_mahjong" }, { name: "é¸å‡ºå¹¸é‹äº¤é€šå·¥å…·", func: "game_vehicles" }, { name: "é¸å‡ºå¹¸é‹æ˜Ÿåº§ç¬¦è™Ÿ", func: "game_zodiacs" }, { name: "ç¦®ç‰©è¨“ç·´ï¼šé¸å‡ºå¹¸é‹ç¦®ç‰©è™Ÿç¢¼", func: "game_gift_box" }, { name: "æŒ‘é¸ä»Šå¤©å¹¸é‹æ™‚æ®µ", func: "game_lucky_period" }, { name: "é¸å‡ºå¹¸é‹è·æ¥­", func: "game_professions" }, { name: "é¸å‡ºé«”è‚²èˆ‡çé …", func: "game_sports_awards" }, { name: "é¸å‡ºè¾¦å…¬æ–‡å…·A", func: "game_office_a" }, { name: "é¸å‡ºè¾¦å…¬æ–‡å…·B", func: "game_office_b" }, { name: "é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–A", func: "game_tools_a" }, { name: "é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–B", func: "game_tools_b" }, 
    { name: "ç¾…é¦¬æ•¸å­—ï¼ˆå¤§å¯«ï¼‰", func: "game_roman_u" }, { name: "ç¾…é¦¬æ•¸å­—ï¼ˆå°å¯«ï¼‰", func: "game_roman_l" }, { name: "æ•¸å­¸ç¬¦è™Ÿ", func: "game_math_symbols" }, { name: "å–®ä½ç¬¦è™Ÿ", func: "game_unit_symbols" }, { name: "æœˆä»½ç¬¦è™Ÿ", func: "game_month_symbols" }, { name: "æ—¥æœŸç¬¦è™Ÿ", func: "game_date_symbols" }, { name: "æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰", func: "game_bold_serif_u" }, { name: "æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰", func: "game_bold_serif_l" }, { name: "è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰", func: "game_script_u" }, { name: "è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰", func: "game_script_l" }, { name: "å¸Œè‡˜å­—æ¯ï¼ˆå¤§å¯«ï¼‰", func: "game_greek_u" }, { name: "å¸Œè‡˜å­—æ¯ï¼ˆå°å¯«ï¼‰", func: "game_greek_l" }, { name: "æ³¨éŸ³ç¬¦è™Ÿ", func: "game_bopomofo" }, { name: "æ—¥æ–‡å¹³å‡å", func: "game_hiragana" }, { name: "æ—¥æ–‡ç‰‡å‡å", func: "game_katakana" }, { name: "éŸ“æ–‡å…ƒéŸ³è¼”éŸ³", func: "game_korean_jamo" }, { name: "è²¨å¹£ç¬¦è™Ÿ", func: "game_currency_symbols" }, { name: "éŸ³æ¨‚ç¬¦è™Ÿ", func: "game_music_symbols" }, { name: "åœ‹éš›è±¡æ£‹ç¬¦è™Ÿ", func: "game_chess_symbols" } ];


// ===================== éŠæˆ²ç‹€æ…‹ç®¡ç† =====================
let gameState;
let maxScores;
let trainingState;
let timers = {
    answer: null,
    nextRound: null,
};

// é“å…·åˆ†é¡éæ¿¾å™¨ï¼šç”¨æ–¼æˆ°é¬¥é“å…·ä½¿ç”¨ä»‹é¢
// é è¨­ç‚º nullï¼Œç•¶é–‹å•Ÿä½¿ç”¨é“å…·å°è©±æ¡†æ™‚æœƒè‡ªå‹•è¨­å®š
let currentItemFilter = null;
// èƒŒåŒ…åˆ†é¡éæ¿¾å™¨ï¼šç”¨æ–¼èƒŒåŒ…æ¸…å–®çš„åˆ†é¡æŒ‰éˆ•
let currentBackpackFilter = null;

// é è¨­éŠæˆ²ç‹€æ…‹
const defaultStats = {
    total: 0, exp: 0, bonus: 0, luck_tests_total: 0,
    luck_history: [], luck_tickets: 0, luck_tickets_total: 0,
    stage_idx: 0, last_daily_ticket_date: "", inventory: {},
    inventory_order: [], stones: 0, current_title: "1.å®—é–€çš„åŸºçŸ³",
    last_luck_date: "", last_luck_reward_msg: ""
    , personalName: ""
    , gender: ""
    , createDate: ""
    , linggen: null
    // å¿«æ·é“å…·åˆ—è¡¨ï¼šç”¨æ–¼æˆ°é¬¥é“å…·ç¯©é¸
    , quickItems: []
    // æ¯æ—¥ç°½åˆ°ï¼šæœ€å¾Œç°½åˆ°æ—¥æœŸä»¥åŠé€£çºŒç°½åˆ°å¤©æ•¸
    , signInLastDate: ""
    , signInStreak: 0
    // æ¯æ—¥ä»»å‹™ï¼šå­˜æ”¾ä»Šæ—¥ä»»å‹™è³‡æ–™ï¼ˆæ—¥æœŸã€ä»»å‹™é¡å‹ã€é›£åº¦ã€ç›®æ¨™ã€é€²åº¦ã€æ˜¯å¦æ¥å—ã€æ˜¯å¦å®Œæˆã€æ˜¯å¦å·²é ˜å–ï¼‰
    , dailyTask: {}
    // ç°½åˆ°æ­·å²ï¼šè¨˜éŒ„ç°½åˆ°éçš„æ—¥æœŸåˆ—è¡¨ï¼Œç”¨æ–¼ç°½åˆ°æ—¥æ›†é¡¯ç¤º
    , signInHistory: []
    // å¤©å‘½æŒ‘æˆ°ï¼šæœ¬æ—¥ç”¢ç”Ÿçš„éš¨æ©Ÿä»»å‹™åˆ—è¡¨
    , heavenChallenges: []
    // å¤©å‘½æŒ‘æˆ°ç”¢ç”Ÿæ—¥æœŸï¼šç”¨æ–¼æ¯æ—¥åˆ·æ–°ä»»å‹™
    , heavenChallengeDate: ""
};

function saveToLocalStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save to localStorage", e);
    }
}

function loadFromLocalStorage(key, defaultValue = {}) {
    const data = localStorage.getItem(key);
    try {
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error("Failed to parse from localStorage", e);
        return defaultValue;
    }
}

function saveGameState() {
    saveToLocalStorage(STATS_FILE, gameState);
    saveToLocalStorage(SCORE_FILE, maxScores);
    // # åŒæ­¥ç§˜å¢ƒè©¦ç…‰æœ€é«˜ç´€éŒ„åˆ° localStorage
    saveToLocalStorage(TRIAL_SCORE_FILE, maxTrialScores);
}

function loadGameState() {
    gameState = loadFromLocalStorage(STATS_FILE, JSON.parse(JSON.stringify(defaultStats)));
    maxScores = loadFromLocalStorage(SCORE_FILE, {});
    // # è¼‰å…¥ç§˜å¢ƒè©¦ç…‰æœ€é«˜ç´€éŒ„ï¼Œå¦‚æœå°šç„¡å‰‡çµ¦ç©ºç‰©ä»¶
    maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, {});
    // å…¼å®¹èˆŠç‰ˆé“å…·åç¨±
    const newInv = {};
    for (const [key, value] of Object.entries(gameState.inventory)) {
        const newName = ITEM_RENAME_MAP[key] || key;
        newInv[newName] = (newInv[newName] || 0) + value;
    }
    gameState.inventory = newInv;
    gameState.stage_idx = getStageIndex(gameState.exp);

    // è‹¥ quickItems å°šæœªå®šç¾©ï¼Œåˆå§‹åŒ–ç‚ºç©ºé™£åˆ—ï¼ˆå…¼å®¹èˆŠç‰ˆå­˜æª”ï¼‰
    if (!Array.isArray(gameState.quickItems)) {
        gameState.quickItems = [];
    }

    // è‹¥æ¯æ—¥ç°½åˆ°ç›¸é—œæ¬„ä½ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç‚ºé è¨­å€¼ï¼ˆå…¼å®¹èˆŠç‰ˆå­˜æª”ï¼‰
    if (typeof gameState.signInLastDate !== 'string') {
        gameState.signInLastDate = "";
    }
    if (typeof gameState.signInStreak !== 'number') {
        gameState.signInStreak = 0;
    }
    // è‹¥æ¯æ—¥ä»»å‹™ä¸å­˜åœ¨æˆ–éç‰©ä»¶ï¼Œåˆå§‹åŒ–ç‚ºç©ºç‰©ä»¶
    if (!gameState.dailyTask || typeof gameState.dailyTask !== 'object') {
        gameState.dailyTask = {};
    }
    // è‹¥ç°½åˆ°æ­·å²ä¸å­˜åœ¨æˆ–ä¸æ˜¯é™£åˆ—ï¼Œåˆå§‹åŒ–ç‚ºç©ºé™£åˆ—ï¼ˆå…¼å®¹èˆŠç‰ˆå­˜æª”ï¼‰
    if (!Array.isArray(gameState.signInHistory)) {
        gameState.signInHistory = [];
    }

    // è‹¥å¤©å‘½æŒ‘æˆ°è³‡æ–™ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç‚ºç©ºé™£åˆ—èˆ‡ç©ºæ—¥æœŸï¼ˆå…¼å®¹èˆŠç‰ˆå­˜æª”ï¼‰
    if (!Array.isArray(gameState.heavenChallenges)) {
        gameState.heavenChallenges = [];
    }
    if (typeof gameState.heavenChallengeDate !== 'string') {
        gameState.heavenChallengeDate = "";
    }
}


// ===================== æ ¸å¿ƒé‚è¼¯å‡½å¼ (ç§»æ¤è‡ª Python) =====================
// ä¾æ“šæ‰€éœ€ä¿®ç…‰ç¶“é©—è¨ˆç®—è¨“ç·´æ¬¡æ•¸é–€æª»ï¼ˆååˆ†ä¹‹ä¸€ï¼Œå‘ä¸Šå–æ•´ï¼Œè‡³å°‘ç‚º 1ï¼‰ã€‚
// ä¾‹å¦‚éœ€è¦ 10 EXP çš„å±¤ç´šï¼Œéœ€è¦ 1 æ¬¡è¨“ç·´ï¼›éœ€è¦ 25 EXP çš„å±¤ç´šï¼Œéœ€è¦ 3 æ¬¡è¨“ç·´ã€‚
function getRequiredTrainingsForExp(needExp) {
    // needExp å¯èƒ½ç‚º undefined æˆ– 0ï¼Œçš†è¿”å› 1
    if (!needExp || needExp <= 0) return 1;
    return Math.max(1, Math.ceil(needExp / 10));
}

function getStageIndex(exp) {
    // æ ¹æ“šç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸é–€æª»åˆ¤æ–·ç©å®¶ç•¶å‰ä¿®ç‚ºå±¤ç´šã€‚
    // å¿…é ˆåŒæ™‚æ»¿è¶³ç¶“é©—å€¼èˆ‡è¨“ç·´æ¬¡æ•¸æ¢ä»¶æ‰å¯é€²å…¥ä¸‹ä¸€å±¤ã€‚
    let idx = 0;
    for (let i = 0; i < CULTIVATION_STAGES.length; i++) {
        const [need_exp] = CULTIVATION_STAGES[i];
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp >= need_exp && gameState.total >= requiredTrain) {
            idx = i;
        } else {
            break;
        }
    }
    return idx;
}

function getCultivationStage(exp) {
    return CULTIVATION_STAGES[getStageIndex(exp)][2];
}

function getNextCultivationInfo(exp) {
    // æ ¹æ“šç¶“é©—å€¼èˆ‡ç¸½è¨“ç·´æ¬¡æ•¸ï¼Œè¨ˆç®—è·é›¢ä¸‹ä¸€å±¤æ‰€éœ€çš„ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸
    for (const [need_exp,, name] of CULTIVATION_STAGES) {
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp < need_exp || gameState.total < requiredTrain) {
            return {
                next_stage: name,
                exp_needed: Math.max(0, need_exp - exp),
                train_needed: Math.max(0, requiredTrain - gameState.total)
            };
        }
    }
    return null;
}

function getCultivationBonusExp(score, requiredScore) {
    const diff = score - requiredScore;
    if (diff < 5) return [0, ""];
    const capped = Math.min(diff, 95);
    const n = Math.floor(capped / 5);
    const exp = Math.pow(2, n - 1);
    return [Math.floor(exp), `åˆ†æ•¸è¶…éé–€æª» ${capped} åˆ†ï¼Œç²å¾—é¡å¤– +${Math.floor(exp)} ä¿®ç…‰ç¶“é©—ï¼`];
}

function getItemSortKey(itemName) {
    let itemType = 'æœªçŸ¥', itemGrade = 'æœªçŸ¥';
    for (const t of ITEM_TYPE_ORDER) {
        if (t === 'å…µå™¨') {
            if (itemName.includes('åŠ') || itemName.includes('åˆ€') || itemName.includes('æ§')) {
                itemType = t; break;
            }
        } else if (itemName.includes(t)) {
            itemType = t; break;
        }
    }
    for (const g of GRADE_NAMES) {
        if (itemName.includes(g)) {
            itemGrade = g; break;
        }
    }
    const typeIndex = ITEM_TYPE_ORDER.includes(itemType) ? ITEM_TYPE_ORDER.indexOf(itemType) : ITEM_TYPE_ORDER.length;
    const gradeIndex = GRADE_NAMES.includes(itemGrade) ? GRADE_NAMES.indexOf(itemGrade) : GRADE_NAMES.length;
    return [typeIndex, gradeIndex, itemName];
}

// === é“å…·åˆ†é¡åŠå“éšè¼”åŠ©å‡½å¼ ===
// å°‡ä¸­æ–‡å“éšæ˜ å°„ç‚ºè‹±æ–‡ class åç¨±ï¼Œä¾¿æ–¼ CSS æŒ‡å®šæ¨£å¼
const GRADE_CLASS_MAP = {
    'å…¥å“': 'in',
    'ä¸‹å“': 'low',
    'ä¸­å“': 'mid',
    'ä¸Šå“': 'high',
    'æ¥µå“': 'excellent',
    'è¶…å“': 'ultra',
    'çµ•å“': 'ultimate',
    'å¯¶å“': 'treasure',
    'åœ°å“': 'earth',
    'å¤©å“': 'heaven',
};

// æ ¹æ“šé“å…·åç¨±åˆ¤æ–·å…¶é¡åˆ¥ï¼Œå›å‚³å°æ‡‰çš„ class å­—ä¸²ã€‚
function getItemCategoryClass(itemName) {
    let itemType = 'æœªçŸ¥';
    // é¡å‹åˆ¤æ–·é‚è¼¯èˆ‡ getItemSortKey ç›¸åŒ
    // ä¾é¡å‹é—œéµå­—åˆ¤æ–·é“å…·é¡åˆ¥ã€‚
    // å…µå™¨ï¼šåç¨±åŒ…å«åŠã€åˆ€ã€æ§ã€‚
    // åŠŸæ³•ï¼šåç¨±åŒ…å«ã€ŒåŠŸæ³•ã€æˆ–å¸¸è¦‹çš„åŠŸæ³•çµå°¾å­—ã€Œè¨£ã€ã€ã€Œç¶“ã€ã€‚
    // é™£æ³•ï¼šåç¨±åŒ…å«ã€Œé™£æ³•ã€æˆ–ã€Œé™£ã€ã€‚
    // å…¶ä»–é¡å‹ç›´æ¥åŒ…å«å°æ‡‰çš„é—œéµå­—ï¼ˆä¾‹å¦‚ ä»™ä¸¹ã€éˆå™¨ã€éˆç¬¦ï¼‰ã€‚
    for (const t of ITEM_TYPE_ORDER) {
        if (t === 'å…µå™¨') {
            if (itemName.includes('åŠ') || itemName.includes('åˆ€') || itemName.includes('æ§')) {
                itemType = t;
                break;
            }
        } else if (t === 'åŠŸæ³•') {
            // åŠŸæ³•é¡ï¼šåŒ…å«ã€ŒåŠŸæ³•ã€æˆ–å¸¸è¦‹åŠŸæ³•çµå°¾å­—ã€Œè¨£ã€ã€Œç¶“ã€ã€Œè—ã€ï¼Œ
            // ä»¥åŠä¿®ç…‰æ–¹æ³•å¸¸ç”¨è©ã€Œè¡Œæ°£ã€ã€Œåç´ã€ã€Œç…‰ã€ã€‚
            if (itemName.includes('åŠŸæ³•') || itemName.includes('è¨£') || itemName.includes('ç¶“') || itemName.includes('è—')
                || itemName.includes('è¡Œæ°£') || itemName.includes('åç´') || itemName.includes('ç…‰')) {
                itemType = t;
                break;
            }
        } else if (t === 'é™£æ³•') {
            if (itemName.includes('é™£æ³•') || itemName.includes('é™£')) {
                itemType = t;
                break;
            }
        } else if (itemName.includes(t)) {
            itemType = t;
            break;
        }
    }
    switch (itemType) {
        case 'å…µå™¨': return 'weapon';
        case 'åŠŸæ³•': return 'technique';
        case 'é™£æ³•': return 'formation';
        case 'ä»™ä¸¹': return 'elixir';
        case 'éˆå™¨': return 'artifact';
        case 'éˆç¬¦': return 'charm';
        default: return 'unknown';
    }
}

// æ ¹æ“šé“å…·åç¨±åˆ¤æ–·å“éšï¼Œå›å‚³å°æ‡‰çš„ class å­—ä¸²ã€‚
function getItemGradeClass(itemName) {
    for (const [cn, cls] of Object.entries(GRADE_CLASS_MAP)) {
        if (itemName.includes(cn)) {
            return cls;
        }
    }
    return '';
}
// æ¯”è¼ƒé“å…·åç¨±çš„å‡½å¼ï¼šä¾ç…§é¡å‹ç´¢å¼•ã€å“éšç´¢å¼•ã€æœ€å¾Œä»¥åç¨±ï¼ˆå­—å…¸åºï¼‰æ’åºã€‚
// èˆ‡ 8-8 ç‰ˆ Python get_item_sort_key é…åˆï¼Œé¿å…ä½¿ç”¨ join æ¯”å°é€ æˆæ’åºéŒ¯äº‚ã€‚
function compareItemNames(nameA, nameB) {
    const keyA = getItemSortKey(nameA);
    const keyB = getItemSortKey(nameB);
    // å…ˆæ¯”é¡å‹
    if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
    // å†æ¯”å“éš
    if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
    // æœ€å¾Œæ¯”åç¨±
    return nameA.localeCompare(nameB, 'zh-Hant');
}

function getGradeByDifficulty(difficulty) {
    const idx = Math.max(0, Math.min(GRADE_NAMES.length - 1, difficulty - 1));
    return GRADE_NAMES[idx];
}


// ===================== éŠæˆ²æµç¨‹æ§åˆ¶ =====================
const app = document.getElementById('app');
let temporaryMessages = []; // ç”¨æ–¼é¡¯ç¤ºè‡¨æ™‚è¨Šæ¯ï¼Œä¾‹å¦‚æ¯æ—¥çå‹µ

function clearApp() {
    app.innerHTML = '';
    Object.values(timers).forEach(timer => clearTimeout(timer));

    // åœ¨é€²å…¥æ–°ç•«é¢æ™‚éš±è—å›é ‚éƒ¨æŒ‰éˆ•
    try {
        const backBtn = document.getElementById('back-to-top');
        if (backBtn) backBtn.style.display = 'none';
    } catch (e) { /* ignore */ }
}

function addTemporaryMessage(html, type) {
    temporaryMessages.push({ html, type });
}

function showTemporaryMessages() {
    temporaryMessages.forEach(({html, type}) => {
        const p = document.createElement('p');
        p.className = `message ${type}`;
        p.innerHTML = html;
        app.appendChild(p);
    });
    temporaryMessages = [];
}

function handleLevelUp(prevExp, newExp) {
    const prevIdx = getStageIndex(prevExp);
    const newIdx = getStageIndex(newExp);
    if (newIdx <= prevIdx) {
        gameState.stage_idx = newIdx;
        saveGameState();
        return "";
    }
    
    let ticketsGain = 0;
    for (let k = prevIdx + 1; k <= newIdx; k++) {
        const prevName = CULTIVATION_STAGES[k - 1][2];
        const match = prevName.match(/(\d+)å±¤$/);
        ticketsGain += match ? parseInt(match[1], 10) : 1;
    }
    
    const stonesGain = newIdx - prevIdx;
    
    gameState.stage_idx = newIdx;
    gameState.luck_tickets += ticketsGain;
    gameState.luck_tickets_total += ticketsGain;
    gameState.stones += stonesGain;
    saveGameState();

    // æ’­æ”¾å‡ç´šéŸ³æ•ˆ
    try {
        if (typeof playLevelUp === 'function') {
            playLevelUp();
        }
    } catch (e) {}
    
    let parts = [];
    if (ticketsGain > 0) parts.push(`+${ticketsGain} ç¥¨`);
    if (stonesGain > 0) parts.push(`+${stonesGain} éˆçŸ³`);

    return `ğŸŸï¸ å‡å±¤çå‹µï¼š${parts.join('ã€')}ï¼ˆç›®å‰ç¥¨ ${gameState.luck_tickets}ï¼ŒéˆçŸ³ ${gameState.stones}ï¼‰`;
}

function grantDailyTicketIfNeeded() {
    // ä½¿ç”¨æœ¬åœ°æ™‚é–“
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_daily_ticket_date !== today) {
        gameState.luck_tickets += 1;
        gameState.luck_tickets_total += 1;
        gameState.stones += 1;
        gameState.last_daily_ticket_date = today;
        saveGameState();
        addTemporaryMessage(`ğŸ ä»Šæ—¥ç™»å…¥è´ˆé€ +1 æ¸¬è©¦æ©ŸæœƒåŠ +1 éˆçŸ³ï¼ˆç›®å‰ç¥¨ ${gameState.luck_tickets}ï¼ŒéˆçŸ³ ${gameState.stones}ï¼‰`, 'msg-daily');
    }
}

// ===================== ä¸»é¸å–®æ¸²æŸ“ =====================
// ===================== éˆæ ¹æ¸¬è©¦èˆ‡å€‹äººè³‡æ–™ =====================
// # æä¾›åˆå§‹è¨­å®šä»‹é¢ï¼Œæ”¶é›†å§“åèˆ‡æ€§åˆ¥ä¸¦å•Ÿå‹•éˆæ ¹æ¸¬è©¦
function showInitialSetup() {
    clearApp();
    let html = `<h1>ğŸŒ± éˆæ ¹æ¸¬è©¦</h1>`;
    html += `<p style="text-align:center;">æ­¡è¿æ–°ä¿®å£«ï¼è«‹å¡«å¯«ä½ çš„å§“åèˆ‡æ€§åˆ¥ï¼Œå†é–‹å§‹éˆæ ¹æ¸¬è©¦ã€‚</p>`;
    html += `<p style="text-align:center;"><label>å§“åï¼š<input type="text" id="initial-name" placeholder="è«‹è¼¸å…¥å§“å" /></label></p>`;
    html += `<p style="text-align:center;"><label>æ€§åˆ¥ï¼š<select id="initial-gender"><option value="">æœªçŸ¥</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select></label></p>`;
    html += `<button data-action="start-linggen-test">ğŸŒ± é–‹å§‹éˆæ ¹æ¸¬è©¦</button>`;
    app.innerHTML = html;
}

// # é–‹å§‹éˆæ ¹æ¸¬è©¦ï¼šä¿å­˜åŸºæœ¬è³‡æ–™ä¸¦å¾é›£åº¦ 1 æ¸¬è©¦èµ·
function startLinggenTest() {
    try {
        const nameInput = document.getElementById('initial-name');
        const genderSelect = document.getElementById('initial-gender');
        const nameVal = nameInput ? nameInput.value.trim() : '';
        const genderVal = genderSelect ? genderSelect.value : '';
        gameState.personalName = nameVal || 'ç„¡åä¿®å£«';
        gameState.gender = genderVal || '';
        const todayStr = new Date().toISOString().slice(0,10);
        gameState.createDate = todayStr;
        gameState.linggen = null;
        saveGameState();
        if (typeof updateUserProfile === 'function') {
            try { updateUserProfile({ personalName: gameState.personalName, gender: gameState.gender, createDate: gameState.createDate }); } catch (e) {}
        }
    } catch (e) {}
    try {
        startTraining(1);
        if (trainingState) {
            trainingState.isLinggenTest = true;
            trainingState.linggenLevel = 1;
            trainingState.totalRounds = 1;
        }
    } catch (e) { console.warn('éˆæ ¹æ¸¬è©¦å•Ÿå‹•å¤±æ•—', e); }
}

// # å°é›²ç«¯ä½¿ç”¨è€…æª”æ¡ˆé€²è¡Œåˆä½µæ›´æ–°
async function updateUserProfile(fields) {
    if (!FIREBASE_ONLINE_ENABLED || !db) return;
    try {
        await ensureSignedIn();
        const u = auth && auth.currentUser;
        if (!u) return;
        await db.collection('users').doc(u.uid).set(fields, { merge: true });
    } catch (e) {
        console.warn('æ›´æ–°ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', e);
    }
}
function renderMainMenu() {
    clearApp();
    // è¿”å›ä¸»é¸å–®æ™‚ç§»é™¤ç§˜å¢ƒè©¦ç…‰èƒŒæ™¯æ¨£å¼ï¼Œä¸¦é¡¯ç¤ºå›é ‚éƒ¨æŒ‰éˆ•
    try {
        const containerEl = document.getElementById('app-container');
        if (containerEl) containerEl.classList.remove('trial-mode');
        const backBtn = document.getElementById('back-to-top');
        if (backBtn) backBtn.style.display = 'inline-block';
    } catch (e) { /* ignore */ }
    grantDailyTicketIfNeeded();
    // åˆå§‹åŒ–æ¯æ—¥ä»»å‹™ï¼šè‹¥ç•¶æ—¥ä»»å‹™ä¸å­˜åœ¨æˆ–å·²éæœŸå‰‡ç”Ÿæˆæ–°ä»»å‹™
    try { initDailyTask(); } catch (e) {}

    // åˆå§‹åŒ–å¤©å‘½æŒ‘æˆ°ï¼šè‹¥ç•¶æ—¥ä»»å‹™ä¸å­˜åœ¨æˆ–å·²éæœŸå‰‡ç”Ÿæˆæ–°ä»»å‹™
    try { initHeavenChallenges(); } catch (e) {}
    // # è‹¥å°šæœªè¨­å®šå§“åæˆ–å°šæœªæ¸¬è©¦éˆæ ¹ï¼Œé€²å…¥åˆå§‹åŒ–æµç¨‹
    if (!gameState.personalName || gameState.personalName === "" || gameState.linggen === null || gameState.linggen === undefined) {
        if (typeof showInitialSetup === 'function') {
            showInitialSetup();
            return;
        }
    }
    
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    
    let nextStageProgress = 100;
    let progressTip = "ğŸŒŸ ä½ å·²é”åˆ°æœ€çµ‚ä¿®ç‚ºï¼";

    if (nextInfo) {
        progressTip = `â¬†ï¸ è·é›¢ã€Œ${nextInfo.next_stage}ã€é‚„å·® ${nextInfo.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfo.train_needed} æ¬¡`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            nextStageProgress = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    
    let html = `
        <h1>ğŸ¯ é‹æ°£è¨“ç·´å·¥å…·</h1>
        <h2>V2-22ï¼ˆä¿®ä»™ç¶²é é›¢ç·šç‰ˆï¼‰</h2>
        <p style="text-align:center;">è«‹é¸æ“‡è¨“ç·´é›£åº¦ï¼ˆ1 æœ€ç°¡å–®ï½10 æœ€å›°é›£ï¼‰</p>
    `;

    for (let i = 1; i <= 10; i++) {
        const score = maxScores[i] || 0;
        // ä½¿ç”¨ btn-training åˆ†é¡æŒ‰éˆ•é¡è‰²å€éš”
        html += `<button class="btn-training" data-action="start-training" data-level="${i}">é›£åº¦ ${i}ï¼ˆæœ€é«˜åˆ†ï¼š${score}ï¼‰ å‹ç‡ï¼šç´„ ${DIFFICULTY_WIN_RATE[i]}%</button>`;
    }

    // # æ–°å¢ç§˜å¢ƒè©¦ç…‰é¸é …èˆ‡æ’è¡Œæ¦œï¼šæ”¾ç½®æ–¼é›£åº¦ 1~10 æŒ‰éˆ•ä¹‹å¾Œ
    html += `<button class="btn-trial" data-action="render-secret-trial-menu">ğŸŒŒ ç§˜å¢ƒè©¦ç…‰</button>`;
    html += `<button class="btn-trial" data-action="show-trial-leaderboard">ğŸ† ç§˜å¢ƒæ’è¡Œæ¦œ</button>`;
    // æ–°å¢ä¿®ä»™æ’è¡Œæ¦œï¼šä¾ä¿®ç‚ºé«˜ä½æ’åï¼ˆé›¢ç·šé¡¯ç¤ºå€‹äººä¿®ç‚ºï¼‰
    html += `<button class="btn-other" data-action="show-cultivation-leaderboard">ğŸŒ„ ä¿®ä»™æ’è¡Œæ¦œ</button>`;


    html += `
        <div class="info-section">
            <p style="font-size: 1.2em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}</p>
            <p style="font-size: 1.2em; color: var(--gold-color);">ğŸ–ï¸ ç›®å‰ä»™é–€ä½éšï¼š${gameState.current_title}</p>
            <p style="font-size: 0.9em; color: var(--secondary-color);">${progressTip}</p>
            <progress value="${nextStageProgress}" max="100"></progress>
            <p>ğŸ‹ï¸ ç´¯ç©è¨“ç·´æ¬¡æ•¸ï¼š${gameState.total} | âš”ï¸ ä¿®ç…‰ç¶“é©—ï¼š${gameState.exp} | â­ æœ€é«˜åˆ†ï¼š${highestScore}</p>
            <p>ğŸŸï¸ æ¸¬è©¦æ©Ÿæœƒï¼š${gameState.luck_tickets} æ¬¡ (ç´¯ç©ç²å¾—ï¼š${gameState.luck_tickets_total})</p>
            <p>ğŸ’ éˆçŸ³ï¼š${gameState.stones}</p>
            <p>ğŸ‘¤ å§“åï¼š${gameState.personalName || 'æœªè¨­å®š'} | æ€§åˆ¥ï¼š${gameState.gender || 'æœªè¨­å®š'} | ğŸŒ± éˆæ ¹ï¼š${(gameState.linggen === undefined || gameState.linggen === null) ? 'æœªæ¸¬' : ((gameState.linggen <= 0) ? 'ç„¡éˆæ ¹' : gameState.linggen + ' éˆæ ¹')}</p>
        </div>
        <button class="btn-other" data-action="show-stage-list">ğŸ“œ æŸ¥çœ‹ä¿®ä»™ç­‰ç´šä¸€è¦½</button>
        <button class="btn-other" data-action="show-game-rules">ğŸ“– éŠæˆ²è¦å‰‡èªªæ˜</button>
        <button class="btn-other" data-action="show-rank-list">ğŸ‘‘ æŸ¥çœ‹ä»™é–€ä½éšå°è™Ÿ</button>
        <button class="btn-other" data-action="show-backpack">ğŸ’ èƒŒåŒ…</button>
        <button class="btn-other" data-action="show-shop">ğŸ›’ å•†åº—</button>
        <button class="btn-other" data-action="render-test-luck-menu">ğŸ” æ¸¬è©¦é‹æ°£</button>
        <button class="btn-other" data-action="handle-daily-signin">ğŸ“… æ¯æ—¥ç°½åˆ°</button>
        <!-- æ–°å¢ç°½åˆ°æ—¥æ›†æŒ‰éˆ•ï¼šä¾›ç©å®¶æŸ¥çœ‹æœ¬æœˆç°½åˆ°æƒ…æ³ -->
        <button class="btn-other" data-action="show-signin-calendar">ğŸ“† ç°½åˆ°æ—¥æ›†</button>
        <button class="btn-other" data-action="show-daily-task">ğŸ—’ï¸ æ¯æ—¥ä»»å‹™</button>
        <!-- æ–°å¢å¤©å‘½æŒ‘æˆ°æŒ‰éˆ•ï¼šå¯æŸ¥çœ‹ä¸¦æ¥å—éš¨æ©Ÿä»»å‹™ -->
        <button class="btn-other" data-action="show-heaven-challenges">ğŸŒ  å¤©å‘½æŒ‘æˆ°</button>
        <button class="btn-other" data-action="test-sfx">ğŸ”Š æ¸¬è©¦éŸ³æ•ˆ</button>
        <button class="btn-other" data-action="show-login-menu">ğŸ‘¤ å¸³è™Ÿ</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="1">ğŸª™ å…Œæ› 1 éˆçŸ³ (-${STONE_EXCHANGE_COST} EXP)</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="100">ğŸª™ å…Œæ› 100 éˆçŸ³ (-${STONE_100_EXCHANGE_COST} EXP)</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="1000">ğŸª™ å…Œæ› 1000 éˆçŸ³ (-${STONE_1000_EXCHANGE_COST} EXP)</button>
        <!-- # æ–°å¢å…¨éƒ¨å…Œæ›éˆçŸ³ï¼šä¾ç…§ç•¶å‰ EXP è¨ˆç®—å¯å…Œæ›æ•¸é‡ä¸¦é¡¯ç¤ºæ‰€éœ€ EXP -->
        ${(() => {
            const maxStones = Math.floor(gameState.exp / STONE_EXCHANGE_COST);
            const costAll = maxStones * STONE_EXCHANGE_COST;
            const disabled = maxStones < 1 ? 'disabled' : '';
            return `<button class="btn-secondary" data-action="exchange-stones" data-count="${maxStones}" ${disabled}>ğŸª™ å…¨éƒ¨å…Œæ› (-${costAll} EXP)</button>`;
        })()}
        <hr>
        <button class="btn-warning" data-action="reset-stats">æ­¸é›¶è¨“ç·´/ç¶“é©—çµ±è¨ˆ</button>
        <button class="btn-danger" data-action="clear-scores">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ€é«˜åˆ†ç´€éŒ„</button>
    `;
    
    app.innerHTML = html;
    showTemporaryMessages();
    // ä¿®è£œè¡Œå‹•è£ç½®ç®­é ­åœ–ç¤ºï¼ˆç”¨ SVG æ›¿æ›ï¼‰
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

// ===================== è¨“ç·´æµç¨‹ =====================

function startTraining(level) {
    trainingState = {
        difficulty: level,
        round: 0,
        success: 0,
        fail: 0,
        totalRounds: 20,
        hasAnswered: false,
        correctAnswers: [],
        gameGridButtons: [],
        // Per-round state
        hasUsedSingleUseItem: false,
        allowedChoices: 1,
        selectedChoices: [],
    };
    // # ç·šä¸Šç‰ˆæ–°å¢ï¼šç´€éŒ„é–‹å§‹æ™‚é–“èˆ‡æœ¬å±€ä½¿ç”¨é“å…·æ¸…å–®ï¼ˆä¸å½±éŸ¿èˆŠç‰ˆé‚è¼¯ï¼‰
    try {
        trainingState.startedAt = Date.now();       // # æœ¬å±€é–‹å§‹æ™‚é–“
        trainingState.usedItems = [];               // # æœ¬å±€ä½¿ç”¨éçš„é“å…·ï¼ˆå…µå™¨/åŠŸæ³•/é™£æ³•ï¼‰
    } catch (e) { /* # ignore */ }

    trainingNext();
}

function trainingNext() {
    if (trainingState.round >= trainingState.totalRounds) {
        timers.nextRound = setTimeout(showTrainingResult, 400);
        return;
    }
    trainingState.round++;
    
    // é‡ç½®æ¯é¡Œç‹€æ…‹
    trainingState.hasAnswered = false;
    trainingState.hasUsedSingleUseItem = false;
    trainingState.allowedChoices = 1;
    trainingState.selectedChoices = [];
    // æœ¬é¡Œé¡å¤–æ™‚é–“é‡ç½®
    trainingState.roundExtraTime = 0;
    // é‡ç½®å€’æ•¸ç”¨çš„å‰©é¤˜æ™‚é–“ (é¿å…å»¶çºŒåˆ°ä¸‹ä¸€é¡Œ)
    trainingState.countdownRemaining = null;

    const gameDef = ALL_GAMES[Math.floor(Math.random() * ALL_GAMES.length)];
    const gameFunc = window[gameDef.func];
    gameFunc(); // This function will call renderTrainingScreen
}

function updateGameInfo() {
    const infoLabel = document.getElementById('game-info-label');
    if (infoLabel) {
        // # è‹¥ç‚ºç§˜å¢ƒè©¦ç…‰æ¨¡å¼ï¼Œé¡¯ç¤ºç•¶å‰é¡Œè™Ÿã€ä¸é¡¯ç¤ºç¸½é¡Œæ•¸ï¼Œä¸¦é¡å¤–é¡¯ç¤ºè©²é›£åº¦æœ€é«˜ç­”å°é¡Œæ•¸
        if (trainingState.mode === 'secretTrial') {
            const best = (maxTrialScores && maxTrialScores[trainingState.difficulty]) ? maxTrialScores[trainingState.difficulty] : 0;
            infoLabel.innerHTML = `ç¬¬ ${trainingState.round} é¡Œ | âœ… æ­£ç¢º: ${trainingState.success} âŒ éŒ¯èª¤: ${trainingState.fail} | å¯é¸æ¬¡æ•¸: ${trainingState.allowedChoices - trainingState.selectedChoices.length} | ğŸ¯ æœ€é«˜ï¼š${best} é¡Œ`;
        } else if (trainingState.totalRounds === Infinity) {
            // # å…¶ä»–ç„¡é™å›åˆæ¨¡å¼ï¼ˆç†è«–ä¸Šä¸æœƒç”¨åˆ°ï¼‰ï¼Œä¸é¡¯ç¤ºç¸½é¡Œæ•¸
            infoLabel.innerHTML = `ç¬¬ ${trainingState.round} é¡Œ | âœ… æ­£ç¢º: ${trainingState.success} âŒ éŒ¯èª¤: ${trainingState.fail} | å¯é¸æ¬¡æ•¸: ${trainingState.allowedChoices - trainingState.selectedChoices.length}`;
        } else {
            infoLabel.innerHTML = `ç¬¬ ${trainingState.round}/${trainingState.totalRounds} é¡Œ | âœ… æ­£ç¢º: ${trainingState.success} âŒ éŒ¯èª¤: ${trainingState.fail} | å¯é¸æ¬¡æ•¸: ${trainingState.allowedChoices - trainingState.selectedChoices.length}`;
        }
    }
}

function renderTrainingScreen(title, items, correctAnswers, columns=5, btnSize=60) {
    clearApp();
    trainingState.correctAnswers = correctAnswers;
    
    let gridTemplateColumns = `repeat(${columns}, 1fr)`;

    let buttonsHTML = '';
    items.forEach((item) => {
        // Use data-choice to avoid issues with special characters in IDs
        buttonsHTML += `<button class="grid-btn" data-action="grid-btn" data-choice="${item}" style="height:${btnSize}px;">${item}</button>`;
    });

    app.innerHTML = `
        <p id="difficulty-info-label" style="text-align:center;"></p>
        <p id="game-info-label" style="text-align:center;"></p>
        <h3 style="text-align:center;">${title} (${correctAnswers.length} å€‹)</h3>
        <p id="feedback-label" class="feedback"></p>
        <p id="countdown-label" style="text-align:center; color:grey;"></p>
        <div class="game-grid" style="grid-template-columns: ${gridTemplateColumns};">
            ${buttonsHTML}
        </div>
        <div id="action-buttons">
            <button data-action="show-use-item-dialog">ğŸ’ ä½¿ç”¨é“å…·</button>
        </div>
    `;

    updateGameInfo();
    trainingState.gameGridButtons = Array.from(document.querySelectorAll('.grid-btn'));
    startAnswerCountdown(10);

    // æ›´æ–°é›£åº¦èˆ‡ä¸‹ä¸€éšæ®µé–€æª»è³‡è¨Š
    const diffLabel = document.getElementById('difficulty-info-label');
    if (diffLabel) {
        const difficulty = trainingState.difficulty || 1;
        const nextInfoStage = getNextCultivationInfo(gameState.exp);
        if (nextInfoStage) {
            diffLabel.innerHTML = `é›£åº¦ ${difficulty}ï½œä¸‹ä¸€éšæ®µã€Œ${nextInfoStage.next_stage}ã€é–€æª»ï¼šé‚„å·® ${nextInfoStage.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfoStage.train_needed} æ¬¡`;
        } else {
            diffLabel.innerHTML = `é›£åº¦ ${difficulty}ï½œå·²é”æœ€é«˜éšæ®µ`;
        }
    }
}

function onGridButtonClick(button) {
    if (trainingState.hasAnswered) return;

    if (trainingState.allowedChoices > 1) {
        const choice = button.dataset.choice;
        button.classList.toggle('checked');
        if (button.classList.contains('checked')) {
            if (trainingState.selectedChoices.length < trainingState.allowedChoices) {
                trainingState.selectedChoices.push(choice);
            } else {
                button.classList.remove('checked'); // Exceeded choices
            }
        } else {
            trainingState.selectedChoices = trainingState.selectedChoices.filter(c => c !== choice);
        }
        updateGameInfo();
        // ä¸å†ç”¨ã€Œé¸æ»¿å°±è‡ªå‹•çµæŸã€ï¼Œæ”¹ç”±æŒ‰ä¸‹ç¢ºèªæˆ–å€’æ•¸çµæŸå¾Œä½œç­”
    } else {
        checkAnswerSingle(button.dataset.choice);
    }
}

function startAnswerCountdown(seconds) {
    // æœ¬é¡Œå€’æ•¸æ™‚é–“ï¼šåŸºç¤ç§’æ•¸ + roundExtraTimeï¼ˆä¸Šä¸€é¡ŒåŠ æ™‚å·²åœ¨ trainingNext() é‡ç½®ï¼‰
    let remaining = seconds + (trainingState.roundExtraTime || 0);
    // ä½¿ç”¨ state å„²å­˜å‰©é¤˜ç§’æ•¸ï¼Œæ–¹ä¾¿åœ¨ä½¿ç”¨é™£æ³•æ™‚å³æ™‚å¢åŠ 
    trainingState.countdownRemaining = remaining;
    const countdownLabel = document.getElementById('countdown-label');
    
    if (timers.answer) clearTimeout(timers.answer);

    const update = () => {
        // è‹¥ UI è¢«åˆ‡æ›å°±åœæ­¢è¨ˆæ™‚
        if (!document.getElementById('countdown-label')) return;
        // è‹¥å·²å›ç­”å‰‡åœè¡¨
        if (trainingState.hasAnswered) {
            countdownLabel.textContent = "ä½œç­”çµæŸ";
            return;
        }
        // ä»¥ state ä¸­çš„å‰©é¤˜ç§’æ•¸ç‚ºæº–ï¼ˆå¯èƒ½è¢«é™£æ³•ä¸­é€”åŠ æ™‚ä¿®æ”¹ï¼‰
        remaining = trainingState.countdownRemaining || 0;
        if (remaining >= 0) {
            countdownLabel.textContent = `ä½œç­”å€’æ•¸ï¼š${remaining} ç§’`;
            trainingState.countdownRemaining = remaining - 1;
            timers.answer = setTimeout(update, 1000);
        } else {
            countdownLabel.textContent = "æ™‚é–“åˆ°ï¼";
            if (trainingState.allowedChoices > 1) {
                checkAnswerMulti();
            } else {
                checkAnswerSingle(null); // null means timeout
            }
        }
    };
    update();
}

function checkAnswerSingle(choice) {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    const feedbackLabel = document.getElementById('feedback-label');
    let correct = false;

    if (choice === null) { // Timeout
        trainingState.fail++;
        feedbackLabel.innerHTML = `âŒ æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆï¼š${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
        // # åœ¨å–®é¡ŒçµæŸå¾Œæ¨™è¨˜é€™é¡Œç‚ºéŒ¯èª¤ï¼Œç”¨æ–¼ç§˜å¢ƒè©¦ç…‰åˆ¤æ–·
        trainingState._lastCorrect = false;
    } else {
        correct = trainingState.correctAnswers.includes(choice);
        if (correct) {
            trainingState.success++;
            feedbackLabel.innerHTML = `âœ… æ­å–œä½ é¸å°äº†ï¼ä½ é¸çš„æ˜¯ï¼š${choice}`;
            feedbackLabel.className = "feedback success";
        } else {
            trainingState.fail++;
            feedbackLabel.innerHTML = `âŒ éŒ¯äº†ï¼Œä½ é¸çš„æ˜¯ï¼š${choice} æ­£ç¢ºç­”æ¡ˆï¼š${trainingState.correctAnswers.join(', ')}`;
            feedbackLabel.className = "feedback error";
        }
        // Query selector needs to handle special characters in data attributes
        document.querySelector(`.grid-btn[data-choice="${choice}"]`).classList.add('selected');
        // # åœ¨å–®é¡ŒçµæŸå¾Œæ¨™è¨˜é€™é¡Œçš„å°éŒ¯
        trainingState._lastCorrect = correct;
    }
    
    finalizeRound();
}

function checkAnswerMulti() {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    document.getElementById('confirm-btn')?.remove();

    const feedbackLabel = document.getElementById('feedback-label');
    const isCorrect = trainingState.selectedChoices.some(c => trainingState.correctAnswers.includes(c));
    // # åœ¨çµæŸå¾Œæ¨™è¨˜æ­¤é¡Œçš„å°éŒ¯ï¼Œä¾›ç§˜å¢ƒè©¦ç…‰æ¨¡å¼åˆ¤æ–·
    trainingState._lastCorrect = isCorrect;

    if (isCorrect) {
        trainingState.success++;
        feedbackLabel.innerHTML = `âœ… ç­”å°äº†ï¼ä½ çš„é¸æ“‡ä¸­åŒ…å«äº†æ­£ç¢ºç­”æ¡ˆã€‚`;
        feedbackLabel.className = "feedback success";
    } else {
        trainingState.fail++;
        feedbackLabel.innerHTML = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
    }
    finalizeRound();
}

function finalizeRound() {
    updateGameInfo();

    // # é¡Œç›®çµç®—å¾Œï¼Œç„¡è«–ç­”å°èˆ‡å¦ï¼Œéƒ½å°‡æ­£ç¢ºç­”æ¡ˆèˆ‡éŒ¯èª¤ç­”æ¡ˆé«˜äº®é¡¯ç¤ºã€‚
    // # éæ­·æ‰€æœ‰æŒ‰éˆ•ï¼Œå°‡ç­”æ¡ˆå±¬æ–¼æ­£ç¢ºåˆ—è¡¨è€…åŠ ä¸Š hint-correctï¼Œå…¶ä»–å‰‡åŠ ä¸Š hint-wrong
    try {
        const buttons = trainingState.gameGridButtons || [];
        if (Array.isArray(buttons)) {
            buttons.forEach(b => {
                const choice = b.dataset.choice;
                if (trainingState.correctAnswers && trainingState.correctAnswers.includes(choice)) {
                    // # ç‚ºæ­£ç¢ºç­”æ¡ˆæ·»åŠ æ¨™è¨˜
                    if (!b.classList.contains('hint-correct')) {
                        b.classList.add('hint-correct');
                    }
                } else {
                    // # ç‚ºéŒ¯èª¤ç­”æ¡ˆæ·»åŠ æ¨™è¨˜
                    if (!b.classList.contains('hint-wrong')) {
                        b.classList.add('hint-wrong');
                    }
                }
            });
        }
    } catch (e) { /* # ignore */ }
    // çµç®—å›åˆå¾Œæ¸…é™¤æœ¬é¡ŒåŠ æ™‚ï¼Œé¿å…å»¶çºŒåˆ°ä¸‹ä¸€é¡Œï¼ˆé›™é‡ä¿éšœï¼‰
    trainingState.roundExtraTime = 0;
    // æ¸…é™¤å€’æ•¸å‰©é¤˜æ™‚é–“ç‹€æ…‹
    trainingState.countdownRemaining = null;
    if (timers.nextRound) clearTimeout(timers.nextRound);
    // # ç§˜å¢ƒè©¦ç…‰æ¨¡å¼ä¸‹ï¼Œè‹¥ç­”éŒ¯å‰‡çµæŸä¸¦é¡¯ç¤ºè©¦ç…‰çµæœï¼›è‹¥ç­”å°å‰‡ç¹¼çºŒä¸‹ä¸€é¡Œ
    if (trainingState.mode === 'secretTrial' || trainingState.totalRounds === Infinity) {
        if (trainingState._lastCorrect) {
            timers.nextRound = setTimeout(trialNext, 2000);
        } else {
            timers.nextRound = setTimeout(showTrialResult, 2000);
        }
    } else {
        timers.nextRound = setTimeout(trainingNext, 2000);
    }
}

function enterMultiChoiceMode() {
    if (trainingState.allowedChoices <= 1) return;
    if (document.getElementById('confirm-btn')) return;

    const confirmBtn = document.createElement('button');
    confirmBtn.id = 'confirm-btn';
    confirmBtn.textContent = 'ç¢ºèªé¸æ“‡';
    confirmBtn.dataset.action = "check-answer-multi";
    document.getElementById('action-buttons').appendChild(confirmBtn);
}


function showTrainingResult() {
    // # è‹¥æ­£åœ¨é€²è¡Œéˆæ ¹æ¸¬è©¦ï¼Œä¸è¨ˆç®—ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸ï¼Œç›´æ¥æ ¹æ“šç­”é¡Œçµæœåˆ¤æ–·ä¸‹ä¸€æ­¥
    if (trainingState && trainingState.isLinggenTest) {
        const wasCorrect = (trainingState.success >= trainingState.totalRounds);
        const currLv = trainingState.linggenLevel || trainingState.difficulty || 1;
        if (wasCorrect && currLv < 10) {
            // å‰å¾€ä¸‹ä¸€é›£åº¦æ¸¬è©¦
            startTraining(currLv + 1);
            if (trainingState) {
                trainingState.isLinggenTest = true;
                trainingState.linggenLevel = currLv + 1;
                trainingState.totalRounds = 1;
            }
        } else {
            // æ¸¬è©¦çµæŸï¼Œè¨ˆç®—éˆæ ¹
            let rootVal = wasCorrect ? currLv : (currLv - 1);
            if (rootVal < 0) rootVal = 0;
            gameState.linggen = rootVal;
            // è‹¥å°šæœªè¨˜éŒ„åˆå§‹æ—¥æœŸï¼Œè£œéŒ„
            if (!gameState.createDate) {
                gameState.createDate = new Date().toISOString().slice(0,10);
            }
            saveGameState();
            try {
                if (typeof updateUserProfile === 'function') {
                    updateUserProfile({ linggen: gameState.linggen, createDate: gameState.createDate, personalName: gameState.personalName, gender: gameState.gender });
                }
            } catch (e) {}
            const msg = (rootVal <= 0) ? 'ç„¡éˆæ ¹' : (rootVal + ' éˆæ ¹');
            showModal('ğŸŒ± éˆæ ¹æ¸¬è©¦çµæœ', `<p>ä½ çš„éˆæ ¹ç‚ºï¼š${msg}</p>`, `<button data-action="render-main-menu">ç¢ºèª</button>`);
        }
        return;
    }
    clearApp();
    const score = Math.floor((trainingState.success / trainingState.totalRounds) * 100);
    const prevTotalTrainCount = gameState.total;
    gameState.total++;

    if (score > (maxScores[trainingState.difficulty] || 0)) {
        maxScores[trainingState.difficulty] = score;
    }
    
    const required = DIFFICULTY_WIN_RATE[trainingState.difficulty] || 0;
    // æ›´æ–°æ¯æ—¥ä»»å‹™é€²åº¦ï¼šæ™®é€šè¨“ç·´éœ€è¦é”åˆ°è©²é›£åº¦å‹ç‡é–€æª»æ‰è¨ˆå…¥
    try {
        const isPass = (score >= required);
        updateDailyTaskProgressTraining(isPass, trainingState.difficulty);
    } catch (e) { /* ignore */ }
    // å…ˆè¨ˆç®—ç¶“é©—ç²å–ï¼Œå†æ ¹æ“šå¢é‡æ›´æ–°ä»»å‹™é€²åº¦
    const [bonusExp, bonusMsg] = getCultivationBonusExp(score, required);
    const baseExp = 1;
    const totalGain = baseExp + Math.max(0, bonusExp);
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    if (bonusExp > 0) gameState.bonus = (gameState.bonus || 0) + bonusExp;
    // == å¤©å‘½æŒ‘æˆ°é€²åº¦æ›´æ–° ==
    // åœ¨è¨“ç·´çµæŸå¾Œï¼Œæ ¹æ“šç­”å°é¡Œæ•¸ã€ç¸½é¡Œæ•¸ã€å‹ç‡èˆ‡ç²å¾—ç¶“é©—æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦
    try {
        const diffLevel = trainingState.difficulty || 1;
        const correctCount = trainingState.success || 0;
        const totalRounds = trainingState.totalRounds || 20;
        const winRate = score; // 0-100
        const expGainForTraining = totalGain;
        if (typeof updateHeavenChallengeProgressTraining === 'function') {
            updateHeavenChallengeProgressTraining(diffLevel, correctCount, totalRounds, winRate, expGainForTraining);
        }
        // ç´¯ç©ç¶“é©—é¡ä»»å‹™ï¼šä¹Ÿå°‡ä¿®ç…‰ç¶“é©—å¢é‡å‚³é
        if (typeof updateHeavenChallengeProgressExp === 'function') {
            updateHeavenChallengeProgressExp(expGainForTraining);
        }
    } catch (e) { /* ignore */ }

    // === æ–°å¢è™•ç½°æ©Ÿåˆ¶ ===
    // è‹¥å¾—åˆ†ä½æ–¼è©²é›£åº¦çš„å‹ç‡é–€æª»ï¼Œä¾å·®è·æ‰£æ¸›ä¿®ç…‰å€¼
    let penaltyMsg = "";
    if (score < required) {
        const diffLow = required - score;
        if (diffLow >= 5) {
            const steps = Math.floor(diffLow / 5);
            const penaltyPercent = Math.pow(2, steps - 1);
            let penaltyExp = Math.floor(gameState.exp * penaltyPercent / 100);
            if (penaltyExp > 0) {
                gameState.exp = Math.max(0, gameState.exp - penaltyExp);
                penaltyMsg = `âŒ åˆ†æ•¸ä½æ–¼é–€æª» ${diffLow} åˆ†ï¼Œæ‰£é™¤ ${penaltyExp} ä¿®ç…‰å€¼ (${penaltyPercent}%)`;
            }
        }
    }

    // åœ¨æ‰£é™¤è™•ç½°å¾Œé€²è¡Œå‡ç´šåˆ¤å®š
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    
    // è¨ˆç®—æœ¬æ¬¡è¨“ç·´æ¬¡æ•¸å¢é‡ï¼Œç”¨æ–¼é¡¯ç¤ºï¼‹1 æˆ– ï¼‹0 æ–‡å­—
    const trainingAdded = gameState.total - prevTotalTrainCount;
    let resultHTML = `
        <h2>ğŸ è¨“ç·´å®Œæˆ</h2>
        <div class="feedback success">å¾—åˆ†ï¼š${score} / 100</div>
        <p style="text-align:center;">ğŸ’¡ åŸºæœ¬ä¿®ç…‰ç¶“é©— +${baseExp}</p>
        <p class="${trainingAdded > 0 ? 'train-add' : 'train-none'}" style="text-align:center;">è¨“ç·´æ¬¡æ•¸+${trainingAdded > 0 ? trainingAdded : 0}</p>
    `;
    if (bonusMsg) resultHTML += `<p style="text-align:center; color:green;">ğŸ‰ ${bonusMsg}</p>`;
    if (penaltyMsg) resultHTML += `<p style="text-align:center; color:red;">${penaltyMsg}</p>`;
    if (levelupMsg) resultHTML += `<p class="message msg-levelup">${levelupMsg}</p>`;

    let rewardsHTML = '';
    
    // é€±æœŸçå‹µ
    if (gameState.total > 0 && gameState.total % 5 === 0) {
        const [rewardsList] = grantRandomRewards(1);
        rewardsHTML += `<div class="message msg-reward">ğŸ‰ ç´¯ç©è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé€±æœŸçå‹µï¼<br>${rewardsList.join('<br>')}</div>`;
    }
    
    // é‡Œç¨‹ç¢‘çå‹µ
    if (TRAINING_MILESTONES[gameState.total]) {
        const milestone = TRAINING_MILESTONES[gameState.total];
        gameState.current_title = milestone.title;
        const [rewardsList] = grantRandomRewards(milestone.rewards);
        rewardsHTML += `<div class="message msg-reward">ğŸ† æ­å–œï¼è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé‡Œç¨‹ç¢‘ï¼<br>ç²å¾—æ–°ä½éšï¼šã€${milestone.title}ã€‘<br>ç²å¾—çå‹µï¼š<br>${rewardsList.join('<br>')}</div>`;
    }

    // ç‰¹å®šæ¬¡æ•¸çå‹µ
    const countRewards = checkTrainingCountRewards(prevTotalTrainCount, gameState.total);
    if (countRewards) rewardsHTML += `<div class="message msg-reward">${countRewards}</div>`;

    // éˆçŸ³çå‹µ
    let stonesAward = 0;
    if (score >= 90) stonesAward = 3;
    else if (score >= 70) stonesAward = 2;
    else if (score >= 50) stonesAward = 1;
    if (score === 100) stonesAward += 3;
    const randomDrop = Math.random() < 0.10 ? 1 : 0;
    const totalStonesGain = stonesAward + randomDrop;
    if (totalStonesGain > 0) {
        gameState.stones += totalStonesGain;
        let parts = [];
        if (stonesAward > 0) parts.push(`æ ¹æ“šè¡¨ç¾ç²å¾— ${stonesAward} éˆçŸ³`);
        if (randomDrop > 0) parts.push("å¶é‡é©šå–œï¼š+1 éˆçŸ³");
        rewardsHTML += `<p style="text-align:center; color:darkorchid">ğŸ’ ${parts.join('ï¼›')}</p>`;
    }

    // # å¦‚æœå¾—åˆ†æ˜¯ 100 åˆ†ï¼Œä¾ç…§æŒ‘æˆ°é›£åº¦çµ¦äºˆé¡å¤–çå‹µï¼ˆé›£åº¦è¶Šé«˜çå‹µè¶Šå¤šï¼‰
    if (score === 100) {
        try {
            const diffLvl = trainingState.difficulty || 1;
            const [perfRewards] = grantRandomRewards(diffLvl);
            rewardsHTML += `<div class="message msg-reward">ğŸŒŸ å®Œç¾æ¼”å‡ºï¼é›£åº¦ ${diffLvl} å®Œç¾ç­”é¡Œï¼Œç²å¾— ${diffLvl} ä»½é¡å¤–çå‹µï¼š<br>${perfRewards.join('<br>')}</div>`;
            // # æ»¿åˆ†é”æˆæ™‚æ’­æ”¾ç‰¹æ®Šçå‹µéŸ³æ•ˆï¼ˆèˆ‡æ¨‚é€å°çä¸­çç›¸ä¼¼ï¼‰
            try { if (typeof playRewardSound === 'function') playRewardSound(); } catch (_) {}
        } catch (e) { console.warn('æ»¿åˆ†çå‹µè¨ˆç®—éŒ¯èª¤', e); }
    }

    saveGameState();
    // # ç·šä¸Šç‰ˆæ–°å¢ï¼šè¨“ç·´çµæŸæ™‚ï¼Œä¸Šå‚³é›²ç«¯ç´€éŒ„ï¼ˆFirebase Firestoreï¼‰
    try {
        if (typeof onGameFinished === 'function') {
            const _durationSec = Math.max(0, Math.floor((Date.now() - (trainingState.startedAt || Date.now())) / 1000));  // # æœ¬å±€è€—æ™‚ï¼ˆç§’ï¼‰
            const _result = (score >= (DIFFICULTY_WIN_RATE[trainingState.difficulty] || 0)) ? 'pass' : 'fail';             // # æ˜¯å¦é”æ¨™
            const _usedItems = Array.isArray(trainingState.usedItems) ? trainingState.usedItems.slice(0) : [];            // # ä½¿ç”¨é“å…·æ¸…å–®ï¼ˆæœ¬å±€ï¼‰
            onGameFinished({
                level: trainingState.difficulty,
                score: score,
                mode: 'æ··åˆè¨“ç·´',                 // # ç›®å‰é¡Œç›®æ··åˆï¼ˆæœªç´°åˆ†å„éŠæˆ²ï¼‰ï¼Œå¾ŒçºŒå¯å‚³æ›´ç²¾ç´°çš„æ¨¡å¼åç¨±
                usedItems: _usedItems,
                durationSec: _durationSec,
                result: _result,
                publishToLeaderboard: false     // # é è¨­ä¸å…¬é–‹åˆ°æ’è¡Œæ¦œï¼›å¯åœ¨ UI å¢åŠ é–‹é—œå†æ”¹ç‚º true
            });
        }
    } catch (e) { console.warn('ä¸Šå‚³é›²ç«¯å¤±æ•—', e); }

    // æ›´æ–°ä¸»ç•«é¢è³‡è¨Šï¼Œä»¥åæ˜ è™•ç½°èˆ‡çå‹µ
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch (e) {}
    }
    
    const comment = commentForScore(score, required);

    resultHTML += rewardsHTML;
    resultHTML += `<p style="text-align:center; color:purple; font-style:italic;">"${comment}"</p>`;
    // # æ–°å¢å†æ¬¡æŒ‘æˆ°æŒ‰éˆ•ï¼šå¯ç›´æ¥é‡è¤‡ç›®å‰é›£åº¦ä¹‹è¨“ç·´
    resultHTML += `<button data-action="retry-training">ğŸ”„ å†æ¬¡æŒ‘æˆ°</button>`;
    resultHTML += `<button data-action="render-main-menu">ğŸ” å›ä¸»é¸å–®</button>`;
    app.innerHTML = resultHTML;
}

function checkTrainingCountRewards(prev, current) {
    let msg = [];
    const addItem = (itemName) => {
        gameState.inventory[itemName] = (gameState.inventory[itemName] || 0) + 1;
        if (!gameState.inventory_order.includes(itemName)) {
            gameState.inventory_order.push(itemName);
            gameState.inventory_order.sort((a, b) => {
                const keyA = getItemSortKey(a);
                const keyB = getItemSortKey(b);
                if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
                if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
                return a.localeCompare(b, 'zh-Hant');
            });
        }
    };

    if (prev < 100 && current >= 100) {
        const item = Math.random() < 0.5 ? "å…¥å“ä¸‰æ‰èšéˆé™£" : "å…¥å“å››é–€é™·æ•µé™£";
        addItem(item);
        msg.push(`ğŸ ç™¾ç…‰æˆé‹¼ï¼è¨“ç·´é” 100 æ¬¡ï¼Œé ˜æ‚Ÿé™£æ³•ï¼šã€${item}ã€‘`);
    }
    if (prev < 200 && current >= 200) {
        const item = Math.random() < 0.5 ? "å…¥å“ç¯‰åŸºåç´è¨£" : "å…¥å“æ¾é¹¤é•·é’åŠŸ";
        addItem(item);
        msg.push(`ğŸ é“å¿ƒç©©å›ºï¼è¨“ç·´é” 200 æ¬¡ï¼Œç¿’å¾—åŠŸæ³•ï¼šã€${item}ã€‘`);
    }
    if (prev < 500 && current >= 500) {
        const item = ["å…¥å“é’ç«¹åŠ", "å…¥å“éŠ…èƒŒåˆ€", "å…¥å“ç¢é›²æ§"][Math.floor(Math.random() * 3)];
        addItem(item);
        msg.push(`ğŸ é‹’èŠ’åˆéœ²ï¼è¨“ç·´é” 500 æ¬¡ï¼Œç²å¾—å…µå™¨ï¼šã€${item}ã€‘`);
    }
    return msg.join('<br>');
}

function commentForScore(score, expected) {
    const diff = score - expected;
    const feedbacks = {
        95:"é‹æ°£è¶…ç¥ï¼Œç„¡äººèƒ½æ•µï¼", 90:"é‹æ°£ç¥åŒ–ï¼Œç„¡äººèƒ½æ•µï¼", 85:"é‹æ°£çˆ†æ£šï¼Œç¾¨ç…çœ¾äººï¼", 80:"å¤©é¸ä¹‹äººï¼Œéä½ è«å±¬ï¼", 75:"çµ•å°çš„é‹æ°£æŒæ¡è€…ï¼", 70:"é‹å‹¢å¦‚è™¹ï¼Œç„¡äººèƒ½æ“‹ã€‚", 65:"å¼·é‹ä¾†è¥²ï¼Œå‹¢ä¸å¯æ“‹ã€‚", 60:"ä½ çš„é‹å‹¢å¦‚æ—¥ä¸­å¤©ã€‚", 55:"å¹¸é‹æ˜Ÿé«˜ç…§ï¼Œå‰é€”ä¼¼éŒ¦ã€‚", 50:"å¥½é‹é€£é€£ï¼Œå‹¢é ­æ­£æ—ºã€‚", 45:"ç•¥å‹ä¸€ç±Œï¼Œå‰æ™¯å¯æœŸã€‚", 40:"å¯¦åŠ›èˆ‡é‹æ°£å…¼å…·ã€‚", 35:"ç©©ç´®ç©©æ‰“ï¼Œé€æ­¥æ™‰å‡ã€‚", 30:"é‹æ°£å°šä½³ï¼Œå¯å†æ¥å†å²ã€‚", 25:"ç•¥é«˜ä¸€ç·šï¼Œå°šæœ‰é€²æ­¥ç©ºé–“ã€‚", 20:"å‹‰å¼·è¶…æ¨™ï¼Œç¹¼çºŒåŠªåŠ›ã€‚", 15:"ç¨ç¨é ˜å…ˆï¼Œé‚„éœ€æ‹¼æã€‚", 10:"å‰›å‰›å¥½éç·šï¼Œåˆ¥é¬†æ‡ˆã€‚", 5:"éšªä¸­æ±‚å‹ï¼Œé©šéšªéé—œã€‚", 0:"ä¸­è¦ä¸­çŸ©ï¼Œå‰›å¥½ç¬¦åˆé æœŸã€‚",
        [-5]:"äº›å¾®è½å¾Œï¼Œèª¿æ•´å¿ƒæ…‹ã€‚",[-10]:"å·®å¼·äººæ„ï¼Œé‚„éœ€åŠªåŠ›ã€‚",[-15]:"å°æœ‰å¤±åˆ©ï¼Œç©©ä½é™£è…³ã€‚", [-20]:"ç•¥ä½æ–¼å¹³å‡ï¼Œå†æ¥å†å²ã€‚",[-25]:"é‹å‹¢åå¼±ï¼Œç¹¼çºŒæŒ‘æˆ°ã€‚",[-30]:"è¡¨ç¾å¹³å¹³ï¼Œéœ€è¦åŠ å¼·ã€‚", [-35]:"ç¨å«Œéœè‰²ï¼Œä¸å¦‚é æœŸã€‚",[-40]:"æœ‰é»èƒŒé‹ï¼ŒæŒ¯ä½œèµ·ä¾†ã€‚",[-45]:"é‹æ°£ä¸æ¿Ÿï¼Œå†æˆ°ä¸€å ´ã€‚", [-50]:"æ˜é¡¯è½å¾Œï¼Œé‡æ•´æ——é¼“ã€‚",[-55]:"å¯¦åŠ›æœªå±•ï¼Œä¸‹æ¬¡å†ä¾†ã€‚",[-60]:"ç‹€æ³ä¸ä½³ï¼Œéœ€è¦åæ€ã€‚", [-65]:"é‹æ°£ä½è¿·ï¼Œæ³¨æ„è½‰é‹ã€‚",[-70]:"å¤§å¹…å¤±åˆ©ï¼Œå†æ¥å†å²ã€‚",[-75]:"ä»Šæ—¥ä¸å®œå‡ºé–€â€¦", [-80]:"è«¸äº‹ä¸é †ï¼Œå¿è€ç‚ºä¸Šã€‚",[-85]:"èƒŒé‹çºèº«ï¼Œè«‹å°å¿ƒè¡Œäº‹ã€‚",[-90]:"æ¥µåº¦èƒŒé‹ï¼Œå¿«å»æ±‚ç¥å•åœã€‚"
    };
    const closest = Object.keys(feedbacks).reduce((prev, curr) => Math.abs(curr - diff) < Math.abs(prev - diff) ? curr : prev);
    return feedbacks[closest] || "é‹å‹¢æœªçŸ¥ï¼Œä¿æŒå¹³å¸¸å¿ƒã€‚";
}


// ===================== éŠæˆ²é¡Œåº«ç”Ÿæˆ =====================
// â–¼â–¼â–¼ MAJOR FIX: Corrected the logic to ensure answer positions are truly random. â–¼â–¼â–¼
function game_template(title, pool, total, columns=5, btnSize=60) {
    // 1. å¾é¡Œåº«ä¸­éš¨æ©Ÿé¸å‡ºæœ¬æ¬¡è¦é¡¯ç¤ºçš„æ‰€æœ‰é¸é …
    const itemsForDisplay = [...pool].sort(() => 0.5 - Math.random()).slice(0, total);

    // 2. æ±ºå®šæ­£ç¢ºç­”æ¡ˆçš„æ•¸é‡
    const correctCount = generateCorrectChoices(total);

    // 3. å¾å‰›å‰›é¸å‡ºçš„é¸é …ä¸­ï¼Œ**å†æ¬¡éš¨æ©ŸæŒ‘é¸**å‡ºæ­£ç¢ºç­”æ¡ˆ
    //    é€™æ˜¯ä¿®æ­£çš„æ ¸å¿ƒï¼Œç¢ºä¿æ­£ç¢ºç­”æ¡ˆä¸æ˜¯å›ºå®šåœ¨å‰å¹¾å€‹
    const correctAnswers = [...itemsForDisplay].sort(() => 0.5 - Math.random()).slice(0, correctCount);

    // 4. å°‡éš¨æ©Ÿæ’åˆ—çš„é¸é …å’Œéš¨æ©Ÿé¸å®šçš„ç­”æ¡ˆå‚³éçµ¦æ¸²æŸ“å‡½å¼
    renderTrainingScreen(title, itemsForDisplay, correctAnswers, columns, btnSize);
}

function generateCorrectChoices(total) {
    const ratio = 1 - (trainingState.difficulty / 10);
    let correctCount = Math.max(1, Math.floor(total * ratio));
    if (trainingState.difficulty === 1 && correctCount === total) {
        correctCount--;
    }
    return correctCount;
}

// Assign game functions to the window object so they can be called by string name
window.game_guess_hidden = () => { const n = 10; game_template("å¾ 1ï½10 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_20 = () => { const n = 20; game_template("å¾ 1ï½20 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_30 = () => { const n = 30; game_template("å¾ 1ï½30 é¸å‡ºæ­£ç¢ºè™Ÿç¢¼", Array.from({length: n}, (_, i) => String(i + 1)), n, 6); }
window.game_treasure_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("å¯¶ç®±è¨“ç·´", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_gift_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("ç¦®ç‰©è¨“ç·´", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_emoji_pick = () => { game_template("é¸å‡ºå¥½é‹è¡¨æƒ…ç¬¦è™Ÿ", EMOJIS, EMOJIS.length, 5); }
window.game_animals = () => { game_template("é¸å‡ºå¹¸é‹å‹•ç‰©", ANIMALS, ANIMALS.length, 5); }
window.game_foods = () => { game_template("é¸å‡ºå¹¸é‹é£Ÿç‰©", FOODS, FOODS.length, 5); }
window.game_places = () => { game_template("é¸å‡ºå¹¸é‹åœ°é»", PLACES, PLACES.length, 5); }
window.game_shape_select = () => { game_template("é¸å‡ºå¹¸é‹åœ–å½¢", SHAPES, SHAPES.length, 5); }
window.game_color_select = () => { game_template("æ‰¾å‡ºå¹¸é‹é¡è‰²", COLORS, COLORS.length, 5); }
window.game_flags = () => { game_template("é¸å‡ºå¹¸é‹åœ‹æ——", FLAGS, FLAGS.length, 5); }
window.game_nature = () => { game_template("é¸å‡ºå¹¸é‹è‡ªç„¶ç¾è±¡", NATURE, NATURE.length, 5); }
window.game_cards = () => { game_template("é¸å‡ºå¹¸é‹æ’²å…‹ç‰Œ", CARDS, CARDS.length, 10, 48); }
window.game_mahjong = () => { game_template("é¸å‡ºå¹¸é‹éº»å°‡", MAHJONG, MAHJONG.length, 7); }
window.game_vehicles = () => { game_template("é¸å‡ºå¹¸é‹äº¤é€šå·¥å…·", VEHICLES, VEHICLES.length, 6); }
window.game_zodiacs = () => { game_template("é¸å‡ºå¹¸é‹æ˜Ÿåº§", ZODIACS, ZODIACS.length, 6); }
window.game_lucky_period = () => { game_template("æŒ‘é¸å¹¸é‹æ™‚æ®µ", CLOCKS, CLOCKS.length, 6, 48); }
window.game_professions = () => { game_template("é¸å‡ºå¹¸é‹è·æ¥­", PROFESSIONS, PROFESSIONS.length, 7, 56); }
window.game_sports = () => { game_template("æŒ‘é¸é‹å‹•èˆ‡çé …", SPORTS, SPORTS.length, 6, 48); }
window.game_office = () => { game_template("æŒ‘é¸è¾¦å…¬æ–‡å…·", OFFICE, OFFICE.length, 6, 48); }
window.game_tools = () => { game_template("æŒ‘é¸å·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–", TOOLS, TOOLS.length, 6, 48); }

// æ–°å¢ä¸‰ç¨®åœ–ç¤ºè¨“ç·´å‡½å¼
// è‡ªå‹•æ‹†åˆ†å¾Œçš„å››å€‹é¡Œåº«å‡½å¼
window.game_office_a = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·A", OFFICE_A, OFFICE_A.length, 6, 48); };
window.game_office_b = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·B", OFFICE_B, OFFICE_B.length, 6, 48); };
window.game_tools_a = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–A", TOOLS_A, TOOLS_A.length, 6, 48); };
window.game_tools_b = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–B", TOOLS_B, TOOLS_B.length, 6, 48); };

window.game_sports_awards = () => { game_template("é¸å‡ºé«”è‚²èˆ‡çé …", SPORTS, SPORTS.length, 6, 48); };
window.game_office_supplies = () => { game_template("é¸å‡ºè¾¦å…¬æ–‡å…·", OFFICE, OFFICE.length, 6, 48); };
window.game_tools_others = () => { game_template("é¸å‡ºå·¥å…·ã€å®¶å±…ç”¨å“åŠå…¶ä»–", TOOLS, TOOLS.length, 6, 48); };

// # æ–°å¢ç¬¦è™Ÿé¡è¨“ç·´éŠæˆ²å‡½å¼
// # ç¾…é¦¬æ•¸å­—ï¼ˆå¤§å¯«ï¼‰
window.game_roman_u = () => { game_template("ç¾…é¦¬æ•¸å­—ï¼ˆå¤§å¯«ï¼‰", ROMAN_U, ROMAN_U.length, 6); };
// # ç¾…é¦¬æ•¸å­—ï¼ˆå°å¯«ï¼‰
window.game_roman_l = () => { game_template("ç¾…é¦¬æ•¸å­—ï¼ˆå°å¯«ï¼‰", ROMAN_L, ROMAN_L.length, 6); };
// # æ•¸å­¸ç¬¦è™Ÿ
window.game_math_symbols = () => { game_template("æ•¸å­¸ç¬¦è™Ÿ", MATH_SYMBOLS, MATH_SYMBOLS.length, 6); };
// # å–®ä½ç¬¦è™Ÿ
window.game_unit_symbols = () => { game_template("å–®ä½ç¬¦è™Ÿ", UNIT_SYMBOLS, UNIT_SYMBOLS.length, 6); };
// # æœˆä»½ç¬¦è™Ÿ
window.game_month_symbols = () => { game_template("æœˆä»½ç¬¦è™Ÿ", MONTH_SYMBOLS, MONTH_SYMBOLS.length, 6); };
// # æ—¥æœŸç¬¦è™Ÿ
window.game_date_symbols = () => { game_template("æ—¥æœŸç¬¦è™Ÿ", DATE_SYMBOLS, DATE_SYMBOLS.length, 6); };
// # æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰
window.game_bold_serif_u = () => { game_template("æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰", BOLD_SERIF_U, BOLD_SERIF_U.length, 6); };
// # æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰
window.game_bold_serif_l = () => { game_template("æœ‰è¥¯ç·šç²—é«”è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰", BOLD_SERIF_L, BOLD_SERIF_L.length, 6); };
// # è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰
window.game_script_u = () => { game_template("è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå¤§å¯«ï¼‰", SCRIPT_U, SCRIPT_U.length, 6); };
// # è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰
window.game_script_l = () => { game_template("è‰æ›¸è‹±æ–‡å­—æ¯ï¼ˆå°å¯«ï¼‰", SCRIPT_L, SCRIPT_L.length, 6); };
// # å¸Œè‡˜å­—æ¯ï¼ˆå¤§å¯«ï¼‰
window.game_greek_u = () => { game_template("å¸Œè‡˜å­—æ¯ï¼ˆå¤§å¯«ï¼‰", GREEK_U, GREEK_U.length, 6); };
// # å¸Œè‡˜å­—æ¯ï¼ˆå°å¯«ï¼‰
window.game_greek_l = () => { game_template("å¸Œè‡˜å­—æ¯ï¼ˆå°å¯«ï¼‰", GREEK_L, GREEK_L.length, 6); };
// # æ³¨éŸ³ç¬¦è™Ÿ
window.game_bopomofo = () => { game_template("æ³¨éŸ³ç¬¦è™Ÿ", BOPOMOFO, BOPOMOFO.length, 7, 48); };
// # æ—¥æ–‡å¹³å‡å
window.game_hiragana = () => { game_template("æ—¥æ–‡å¹³å‡å", HIRAGANA, HIRAGANA.length, 8, 48); };
// # æ—¥æ–‡ç‰‡å‡å
window.game_katakana = () => { game_template("æ—¥æ–‡ç‰‡å‡å", KATAKANA, KATAKANA.length, 8, 48); };
// # éŸ“æ–‡å…ƒéŸ³è¼”éŸ³
window.game_korean_jamo = () => { game_template("éŸ“æ–‡å…ƒéŸ³è¼”éŸ³", KOREAN_JAMO, KOREAN_JAMO.length, 9, 48); };
// # è²¨å¹£ç¬¦è™Ÿ
window.game_currency_symbols = () => { game_template("è²¨å¹£ç¬¦è™Ÿ", CURRENCY_SYMBOLS, CURRENCY_SYMBOLS.length, 6); };
// # éŸ³æ¨‚ç¬¦è™Ÿ
window.game_music_symbols = () => { game_template("éŸ³æ¨‚ç¬¦è™Ÿ", MUSIC_SYMBOLS, MUSIC_SYMBOLS.length, 5); };
// # åœ‹éš›è±¡æ£‹ç¬¦è™Ÿ
window.game_chess_symbols = () => { game_template("åœ‹éš›è±¡æ£‹ç¬¦è™Ÿ", CHESS_SYMBOLS, CHESS_SYMBOLS.length, 6); };

// # æ–°å¢ï¼šç”Ÿè‚–ç¬¦è™ŸéŠæˆ²
window.game_chinese_zodiacs = () => { game_template("ç”Ÿè‚–ç¬¦è™Ÿ", CHINESE_ZODIAC, CHINESE_ZODIAC.length, 4, 48); };
// # æ–°å¢ï¼šé‡‘åº¸å°èªªåå››éƒ¨éŠæˆ²
window.game_jinyong = () => { game_template("é‡‘åº¸å°èªª14éƒ¨", JINYONG_BOOKS, JINYONG_BOOKS.length, 7, 48); };
// # æ–°å¢ï¼šä¸­æ–‡æ•¸å­—ï¼ˆå¤§å¯«ï¼‰éŠæˆ²
window.game_chinese_big_digits = () => { game_template("ä¸­æ–‡æ•¸å­—ï¼ˆå¤§å¯«ï¼‰", CHINESE_BIG_NUMERALS, CHINESE_BIG_NUMERALS.length, 6, 48); };
// # æ–°å¢ï¼šæ—¥æ–‡ã€éŸ“æ–‡ç¬¦è™Ÿæ‹†åˆ†å¾Œçš„éŠæˆ²å®šç¾©
window.game_hiragana_a = () => { game_template("æ—¥æ–‡å¹³å‡åA", HIRAGANA_A, HIRAGANA_A.length, 8, 48); };
window.game_hiragana_b = () => { game_template("æ—¥æ–‡å¹³å‡åB", HIRAGANA_B, HIRAGANA_B.length, 8, 48); };
window.game_katakana_a = () => { game_template("æ—¥æ–‡ç‰‡å‡åA", KATAKANA_A, KATAKANA_A.length, 8, 48); };
window.game_katakana_b = () => { game_template("æ—¥æ–‡ç‰‡å‡åB", KATAKANA_B, KATAKANA_B.length, 8, 48); };
window.game_korean_jamo_a = () => { game_template("éŸ“æ–‡å­—ç¬¦è™ŸA", KOREAN_JAMO_A, KOREAN_JAMO_A.length, 9, 48); };
window.game_korean_jamo_b = () => { game_template("éŸ“æ–‡å­—ç¬¦è™ŸB", KOREAN_JAMO_B, KOREAN_JAMO_B.length, 9, 48); };

// # æ–°å¢ï¼šåå¤©å¹²ã€åäºŒåœ°æ”¯ä»¥åŠå…­åå¹²æ”¯çµ„åˆéŠæˆ²å‡½å¼
// # åå¤©å¹²ï¼š10 å€‹å¹²ï¼Œ5 åˆ—é¡¯ç¤º
window.game_tiangan = () => { game_template("åå¤©å¹²", TIANGAN, TIANGAN.length, 5); };
// # åäºŒåœ°æ”¯ï¼š12 å€‹æ”¯ï¼Œ6 åˆ—é¡¯ç¤º
window.game_dizhi = () => { game_template("åäºŒåœ°æ”¯", DIZHI, DIZHI.length, 6); };
// # å…­åå¹²æ”¯çµ„åˆï¼š60 å€‹å¹²æ”¯ï¼Œ6 åˆ—é¡¯ç¤ºï¼Œè¼ƒå°æŒ‰éˆ•å°ºå¯¸æ–¹ä¾¿é¡¯ç¤º
// # å…­åå¹²æ”¯è¨“ç·´ï¼šç”±æ–¼æ¯å€‹é¸é …å«å…©å€‹å­—å…ƒï¼Œåœ¨æ‰‹æ©Ÿç€è¦½æ™‚å®¹æ˜“è¢«è£åˆ‡ï¼Œå› æ­¤å°‡æŒ‰éˆ•é«˜åº¦æé«˜è‡³ 60px
window.game_ganzhi = () => { game_template("å…­åå¹²æ”¯çµ„åˆ", GANZHI, GANZHI.length, 6, 72); };

// # æ–°å¢ï¼šäºŒåå››ç¯€æ°£éŠæˆ²å‡½å¼
// 24 ç¯€æ°£å…±æœ‰äºŒåå››å€‹ç¯€æ°£ï¼Œæ¡ç”¨ 6 åˆ—é¡¯ç¤ºï¼Œæ¯è¡Œ 4 æ¬„ï¼Œç”± game_template è™•ç†é¡¯ç¤ºã€‚
window.game_solar_terms = () => {
    game_template("äºŒåå››ç¯€æ°£", SOLAR_TERMS, SOLAR_TERMS.length, 6, 72);
};

// # èª¿æ•´éŠæˆ²åˆ—è¡¨ï¼šåˆªé™¤åŸæœ¬çš„æ—¥æ–‡å¹³å‡åã€ç‰‡å‡åã€éŸ“æ–‡å…ƒéŸ³è¼”éŸ³é …ç›®ï¼Œä¸¦åŠ å…¥æ‹†åˆ†ç‰ˆèˆ‡æ–°å¢çš„ç¬¦è™ŸéŠæˆ²
(function() {
    try {
        if (Array.isArray(ALL_GAMES)) {
            const filtered = ALL_GAMES.filter(it => !['æ—¥æ–‡å¹³å‡å', 'æ—¥æ–‡ç‰‡å‡å', 'éŸ“æ–‡å…ƒéŸ³è¼”éŸ³'].includes(it.name));
            filtered.push(
                { name: 'æ—¥æ–‡å¹³å‡åA', func: 'game_hiragana_a' },
                { name: 'æ—¥æ–‡å¹³å‡åB', func: 'game_hiragana_b' },
                { name: 'æ—¥æ–‡ç‰‡å‡åA', func: 'game_katakana_a' },
                { name: 'æ—¥æ–‡ç‰‡å‡åB', func: 'game_katakana_b' },
                { name: 'éŸ“æ–‡å­—ç¬¦è™ŸA', func: 'game_korean_jamo_a' },
                { name: 'éŸ“æ–‡å­—ç¬¦è™ŸB', func: 'game_korean_jamo_b' },
                { name: 'ç”Ÿè‚–ç¬¦è™Ÿ', func: 'game_chinese_zodiacs' },
                { name: 'é‡‘åº¸å°èªª14éƒ¨', func: 'game_jinyong' },
                { name: 'ä¸­æ–‡æ•¸å­—ï¼ˆå¤§å¯«ï¼‰', func: 'game_chinese_big_digits' }
            );
            ALL_GAMES.length = 0;
            filtered.forEach(it => ALL_GAMES.push(it));
        }
    } catch (e) {
        console.warn('ALL_GAMES modify failed', e);
    }
})();


// ===================== æ¸¬è©¦é‹æ°£ç³»çµ± =====================

function renderTestLuckMenu() {
    clearApp();
    grantDailyTicketIfNeeded();
    const tickets = gameState.luck_tickets;
    app.innerHTML = `
        <h2>ğŸ§ª æ¸¬è©¦ä½ çš„é‹æ°£</h2>
        <div class="info-section" style="padding:10px;">
            <p>æŠ½å¡æ¨¡å¼å°‡éš¨æ©Ÿç²å¾—ä¿®ç…‰ç¶“é©—ã€éˆçŸ³ã€ç¥¨åˆ¸æˆ–é“å…·ã€‚</p>
            <p>ğŸŸï¸ ç›®å‰æ¸¬è©¦æ©Ÿæœƒï¼š${tickets} æ¬¡</p>
            <p>ğŸ“… ä»Šæ—¥é‹å‹¢ä¸æ¶ˆè€—ç¥¨ã€‚</p>
        </div>
        <button data-action="run-luck-draw" data-draws="1" data-mode="å¹¸é‹æŠ½å¡å–®æŠ½" ${tickets < 1 ? 'disabled' : ''}>ğŸƒ å–®æŠ½ (æ¶ˆè€— 1 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="3" data-mode="å¹¸é‹æŠ½å¡ä¸‰æŠ½" ${tickets < 3 ? 'disabled' : ''}>ğŸƒ ä¸‰æŠ½ (æ¶ˆè€— 3 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="10" data-mode="å¹¸é‹æŠ½å¡10é€£æŠ½" ${tickets < 10 ? 'disabled' : ''}>ğŸƒ åé€£æŠ½ (æ¶ˆè€— 10 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="100" data-mode="å¹¸é‹æŠ½å¡100é€£æŠ½" ${tickets < 100 ? 'disabled' : ''}>ğŸƒ ç™¾é€£æŠ½ (æ¶ˆè€— 100 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="1000" data-mode="å¹¸é‹æŠ½å¡1000é€£æŠ½" ${tickets < 1000 ? 'disabled' : ''}>ğŸƒ åƒé€£æŠ½ (æ¶ˆè€— 1000 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="100000" data-mode="å¹¸é‹æŠ½å¡100000é€£æŠ½" ${tickets < 100000 ? 'disabled' : ''}>ğŸƒ åè¬é€£æŠ½ (æ¶ˆè€— 100000 ç¥¨)</button>
        <button data-action="run-luck-draw" data-draws="${tickets}" data-mode="å¹¸é‹æŠ½å¡å…¨éƒ¨æŠ½" ${tickets < 1 ? 'disabled' : ''}>ğŸƒ å…¨éƒ¨æŠ½ (æ¶ˆè€— ${tickets} ç¥¨)</button>
        <button data-action="run-today-luck">ğŸ“… ä»Šæ—¥é‹å‹¢ (æ¯æ—¥ä¸€æ¬¡ï½œå…è²»)</button>
        <hr>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1" data-cost="${REDEEM_1_COST}">ğŸ« å…Œæ› 1 å¼µ (-${REDEEM_1_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="10" data-cost="${REDEEM_10_COST}">ğŸ« å…Œæ› 10 å¼µ (-${REDEEM_10_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="100" data-cost="${REDEEM_100_COST}">ğŸ« å…Œæ› 100 å¼µ (-${REDEEM_100_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1000" data-cost="${REDEEM_1000_COST}">ğŸ« å…Œæ› 1000 å¼µ (-${REDEEM_1000_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1000000" data-cost="${REDEEM_1000000_COST}">ğŸ« å…Œæ› 1000000 å¼µ (-${REDEEM_1000000_COST} EXP)</button>
        <!-- # æ–°å¢å…¨éƒ¨å…Œæ›ç¥¨åˆ¸ï¼šä¾ç…§ç•¶å‰ EXP è¨ˆç®—å¯å…Œæ›çš„ç¥¨åˆ¸æ•¸é‡ä¸¦é¡¯ç¤ºæ‰€éœ€ EXP -->
        ${(() => {
            const maxTickets = Math.floor(gameState.exp / REDEEM_1_COST);
            const costAll = maxTickets * REDEEM_1_COST;
            const disabled = maxTickets < 1 ? 'disabled' : '';
            return `<button class="btn-secondary" data-action="redeem-tickets" data-pieces="${maxTickets}" data-cost="${costAll}" ${disabled}>ğŸ« å…¨éƒ¨å…Œæ› (-${costAll} EXP)</button>`;
        })()}
        <hr>
        <button data-action="show-luck-history">ğŸ“ˆ æŸ¥çœ‹æ­·å²èˆ‡çµ±è¨ˆ</button>
        <button data-action="render-main-menu">ğŸ”™ è¿”å›ä¸»é¸å–®</button>
    `;
    showTemporaryMessages();
    // å°è¡Œå‹•è£ç½®ä¿®è£œç®­é ­åœ–ç¤º
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

function redeemTickets(pieces, cost) {
    if (gameState.exp < cost) {
        addTemporaryMessage(`âš ï¸ EXP ä¸è¶³ (éœ€è¦ ${cost}ï¼Œç›®å‰ ${gameState.exp})`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.luck_tickets += pieces;
        gameState.luck_tickets_total += pieces;
        addTemporaryMessage(`âœ… å…Œæ›æˆåŠŸï¼š-${cost} EXP â†’ +${pieces} ç¥¨`, 'msg-shop');
        saveGameState();
    }
    renderTestLuckMenu();
}

function runLuckDraw(draws, mode) {
    if (gameState.luck_tickets < draws || draws <= 0) {
        addTemporaryMessage(`âš ï¸ æ¸¬è©¦æ©Ÿæœƒä¸è¶³ï¼`, 'msg-shop-fail');
        renderTestLuckMenu();
        return;
    }
    gameState.luck_tickets -= draws;
    
    const [details, totals] = grantRandomRewards(draws);
    
    let summaryParts = [];
    if (totals.exp > 0) summaryParts.push(`+${totals.exp} EXP`);
    if (totals.stones > 0) summaryParts.push(`+${totals.stones} éˆçŸ³`);
    if (totals.tickets > 0) summaryParts.push(`+${totals.tickets} ç¥¨åˆ¸`);
    if (Object.keys(totals.items).length > 0) {
        const totalItems = Object.values(totals.items).reduce((a, b) => a + b, 0);
        summaryParts.push(`+${totalItems} ä»¶é“å…·`);
    }

    const summaryMsg = summaryParts.length > 0 ? summaryParts.join('ã€') : "ä»€éº¼éƒ½æ²’æœ‰...";
    addLuckHistory(mode, 0, "", totals.exp, summaryMsg);
    
    renderDrawResult(summaryMsg, details, mode, draws);
}

function addLuckHistory(mode, value, category, expGain, rewardMsg) {
    gameState.luck_tests_total++;
    gameState.luck_history.push({
        time: new Date().toLocaleString('sv-SE'), // YYYY-MM-DD HH:MM:SS
        mode, value, category, exp: expGain, reward_msg: rewardMsg
    });
    if (gameState.luck_history.length > 200) {
        gameState.luck_history.shift();
    }
    saveGameState();
}

function grantRandomRewards(count) {
    let rewardsList = [], totals = { exp: 0, stones: 0, tickets: 0, items: {} };
    
    const itemPool = Object.keys(ITEM_STONE_PRICES);
    const weights = itemPool.map(item => {
        const price = ITEM_STONE_PRICES[item] || 1;
        const grade = GRADE_NAMES.findIndex(g => item.startsWith(g)) + 1 || 1;
        return 1000 / (price * grade + 1);
    });

    const getScaledRandomAmount = (min, max) => {
        const bias_factor = Math.pow(gameState.stage_idx / CULTIVATION_STAGES.length, 2);
        const mode = min + (max - min) * bias_factor;
        const u = Math.random();
        // triangular distribution formula
        return Math.ceil(u < (mode - min) / (max - min) ? min + Math.sqrt(u * (max - min) * (mode - min)) : max - Math.sqrt((1 - u) * (max - min) * (max - mode)));
    };

    for (let i = 0; i < count; i++) {
        const rand = Math.random() * 100;
        let rewardType;
        if (rand < 40) rewardType = "exp";
        else if (rand < 70) rewardType = "stones";
        else if (rand < 85) rewardType = "tickets";
        else rewardType = "item";

        if (rewardType === 'exp') {
            const amount = getScaledRandomAmount(0, 200);
            totals.exp += amount;
            rewardsList.push(`ç²å¾— ä¿®ç…‰ç¶“é©— +${amount}`);
        } else if (rewardType === 'stones') {
            const amount = getScaledRandomAmount(0, 20);
            totals.stones += amount;
            rewardsList.push(`ç²å¾— éˆçŸ³ +${amount}`);
        } else if (rewardType === 'tickets') {
            const amount = getScaledRandomAmount(0, 5);
            totals.tickets += amount;
            rewardsList.push(`ç²å¾— ç¥¨åˆ¸ +${amount}`);
        } else if (rewardType === 'item') {
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let randWeight = Math.random() * totalWeight;
            let itemName = itemPool[itemPool.length - 1];
            for(let j=0; j<weights.length; j++){
                if(randWeight < weights[j]){
                    itemName = itemPool[j];
                    break;
                }
                randWeight -= weights[j];
            }
            const amount = getScaledRandomAmount(0, 5);
            totals.items[itemName] = (totals.items[itemName] || 0) + amount;
            rewardsList.push(`ç²å¾— é“å…· [${itemName}] Ã—${amount}`);
        }
    }

    const prevExp = gameState.exp;
    gameState.exp += totals.exp;
    gameState.stones += totals.stones;
    gameState.luck_tickets += totals.tickets;
    Object.entries(totals.items).forEach(([name, qty]) => {
        gameState.inventory[name] = (gameState.inventory[name] || 0) + qty;
         if (!gameState.inventory_order.includes(name)) gameState.inventory_order.push(name);
    });
    if(Object.keys(totals.items).length > 0){
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }

    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    if (levelupMsg) rewardsList.push(`<span class="msg-levelup">${levelupMsg}</span>`);
    
    saveGameState();
    return [rewardsList, totals];
}

function runTodayLuck() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_luck_date === today) {
        showTodayLuckResult(true);
        return;
    }

    const [rewardsList, totals] = grantRandomRewards(1);
    const rewardMsg = rewardsList[0] || "ä»Šæ—¥å¹³æ·¡ç„¡å¥‡...";

    gameState.last_luck_date = today;
    gameState.last_luck_reward_msg = rewardMsg;

    addLuckHistory("ä»Šæ—¥é‹å‹¢", 0, "å‹•æ…‹çå‹µ", totals.exp, rewardMsg);
    showTodayLuckResult(false);
}

function renderDrawResult(summary, details, mode, draws) {
    clearApp();
    const currentStage = getCultivationStage(gameState.exp);
    
    app.innerHTML = `
        <h2>ğŸƒ ${mode} çµæœ</h2>
        <div class="feedback info">ğŸ ç¸½è¨ˆï¼š${summary}</div>
        <div style="height: 150px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px; margin-bottom:15px;">
            ${details.join('<br>')}
        </div>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}</p>
            <p>ç´¯ç© EXPï¼š${gameState.exp}</p>
        </div>
        <button data-action="run-luck-draw" data-draws="${draws}" data-mode="${mode}" ${gameState.luck_tickets < draws ? 'disabled' : ''}>ğŸ” å†ä¾†ä¸€æ¬¡ (${draws} ç¥¨)</button>
        <button data-action="show-luck-history">ğŸ“ˆ æŸ¥çœ‹æ­·å²èˆ‡çµ±è¨ˆ</button>
        <button data-action="render-test-luck-menu">ğŸ”™ è¿”å›æ¸¬è©¦é¸å–®</button>
        <button data-action="render-main-menu">ğŸ  å›ä¸»é¸å–®</button>
    `;
}

function showTodayLuckResult(isRepeat) {
    clearApp();
    const luckySuggestion = () => {
        const seed = parseInt(new Date().toISOString().slice(0, 10).replace(/-/g, ''), 10);
        const rng = (s) => () => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
        const rand = rng(seed);
        const lucky_num = Math.floor(rand() * 39) + 1;
        const lucky_color = COLORS[Math.floor(rand() * COLORS.length)];
        const lucky_emoji = EMOJIS[Math.floor(rand() * EMOJIS.length)];
        const lucky_dir = ["ä¸Š", "ä¸‹", "å·¦", "å³", "å·¦ä¸Š", "å³ä¸Š", "å³ä¸‹", "å·¦ä¸‹"][Math.floor(rand() * 8)];
        return `å¹¸é‹è™Ÿç¢¼ï¼š${lucky_num} | å¹¸é‹è‰²ï¼š${lucky_color} | å¹¸é‹è¡¨æƒ…ï¼š${lucky_emoji} | å¹¸é‹æ–¹ä½ï¼š${lucky_dir}`;
    };

    app.innerHTML = `
        <h2>ğŸ“… ä»Šæ—¥é‹å‹¢</h2>
        <div class="feedback" style="color:darkorange">${isRepeat ? '(ä»Šæ—¥å·²æ¸¬) ' : ''}${gameState.last_luck_reward_msg}</div>
        <p style="text-align:center;">${luckySuggestion()}</p>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${getCultivationStage(gameState.exp)}</p>
        </div>
        <button data-action="render-test-luck-menu">ğŸ”™ è¿”å›æ¸¬è©¦é¸å–®</button>
        <button data-action="render-main-menu">ğŸ  å›ä¸»é¸å–®</button>
    `;
}

// ===================== é›œé …åŠŸèƒ½ & é‡ç½® =====================
function exchangeStones(count) {
    const cost = STONE_EXCHANGE_COST * count;
    if (gameState.exp < cost) {
        addTemporaryMessage(`âš ï¸ EXP ä¸è¶³ï¼Œç„¡æ³•å…Œæ›`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.stones += count;
        handleLevelUp(gameState.exp + cost, gameState.exp); // Recalculate level
        addTemporaryMessage(`âœ… å…Œæ›æˆåŠŸï¼š-${cost} EXP â†’ +${count} éˆçŸ³`, 'msg-shop');
        saveGameState();
    }
    renderMainMenu();
}

function resetTrainingStats() {
    if (confirm("ç¢ºå®šè¦æ­¸é›¶æ‰€æœ‰è¨“ç·´çµ±è¨ˆã€ç¶“é©—ã€é“å…·å’Œç­‰ç´šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        gameState = JSON.parse(JSON.stringify(defaultStats));
        saveGameState();
        renderMainMenu();
    }
}

function clearMaxScores() {
    if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é›£åº¦çš„æœ€é«˜åˆ†ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        maxScores = {};
        saveGameState();
        renderMainMenu();
    }
}


// ===================== Modal (å½ˆå‡ºè¦–çª—) ç³»çµ± =====================
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalFooter = document.getElementById('modal-footer');
const modalCloseBtn = document.getElementById('modal-close-btn');

modalCloseBtn.onclick = () => modal.style.display = "none";
window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function showModal(title, bodyHTML, footerHTML = '') {
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHTML;
    modalFooter.innerHTML = footerHTML;
    modal.style.display = "flex";
}

function showStageList() {
    // åˆ—å‡ºå„å±¤ç´šæ‰€éœ€çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸é–€æª»
    const content = CULTIVATION_STAGES.map(([exp,, name]) => {
        const requiredTrain = getRequiredTrainingsForExp(exp);
        return `<li><b>${name}</b>ï¼šéœ€ä¿®ç…‰ç¶“é©— ${exp}ï¼Œè¨“ç·´æ¬¡æ•¸é–€æª» ${requiredTrain}</li>`;
    }).join('');
    showModal("ä¿®ä»™ç­‰ç´šä¸€è¦½è¡¨", `<ul style="padding-left: 20px;">${content}</ul>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

function showRankList() {
    let content = 'ä»™é–€ä½éšæ˜¯æ ¹æ“šæ‚¨çš„ç¸½è¨“ç·´æ¬¡æ•¸æˆäºˆçš„æ¦®è­½ç¨±è™Ÿï¼š<br><br><ul style="padding-left: 20px;">';
    content += Object.entries(TRAINING_MILESTONES).map(([count, data]) => `<li>è¨“ç·´ <b>${count}</b> æ¬¡ï¼šæˆäºˆä½éšã€${data.title}ã€‘</li>`).join('');
    showModal("ä»™é–€ä½éšå°è™Ÿä¸€è¦½è¡¨", `${content}</ul>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

function showLuckHistory() {
    let content = '';
    if (!gameState.luck_history || gameState.luck_history.length === 0) {
      content = "å°šç„¡æ­·å²ç´€éŒ„ã€‚";
    } else {
      const totalExp = gameState.luck_history.reduce((s, h) => s + (h.exp || 0), 0);
      content += `<p><b>ç´¯ç©ç¶“é©— +${totalExp}</b></p><hr>`;
      content += '<ul style="padding-left: 20px; word-break: break-all;">';
      gameState.luck_history.slice().reverse().slice(0, 50).forEach(h => {
        content += `<li>[${h.time}] <b>${h.mode}</b> â†’ ${h.reward_msg || `${h.value} (${h.category})`} (EXP +${h.exp})</li>`;
      });
      content += '</ul>';
    }
    showModal("æ¸¬è©¦é‹æ°£æ­·å²", content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// éŠæˆ²è¦å‰‡èªªæ˜ï¼šè©³ç´°èªªæ˜å‡ç´šçå‹µã€é—œå¡ã€é“å…·åŠŸèƒ½ä»¥åŠè™•ç½°æ©Ÿåˆ¶ã€‚
// # æ–°å¢éŠæˆ²è¦å‰‡èªªæ˜æŒ‰éˆ•å°æ‡‰çš„å‡½å¼
function showGameRules() {
    /* # éŠæˆ²è¦å‰‡ï¼š
       1. å‡ç´šçå‹µèªªæ˜ï¼šç•¶ä½ çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸åŒæ™‚é”åˆ°ä¸‹ä¸€å±¤é–€æª»ï¼Œ
          ä¿®ç‚ºæœƒè‡ªå‹•çªç ´ã€‚æ¯çªç ´ä¸€å±¤ï¼Œå°‡ç²å¾—ä¸€å®šæ•¸é‡çš„æ¸¬è©¦æ©Ÿæœƒèˆ‡éˆçŸ³çå‹µã€‚
       2. éŠæˆ²é—œå¡èªªæ˜ï¼šè¨“ç·´å…±æœ‰ 10 ç¨®é›£åº¦ï¼Œæ¯å›åˆåŒ…å« 20 é¡Œåœ–ç¤ºï¼Œè«‹åœ¨å€’æ•¸æ™‚é–“å…§é¸å‡ºç›®æ¨™ã€‚ç­”å°å¯ç´¯ç©ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸ï¼Œé”åˆ°è©²é›£åº¦è¦æ±‚çš„å‹ç‡å¯ç²å¾—é¡å¤–ç¶“é©—åŠ æˆã€‚
       3. é“å…·å‡ç´šåŠåŠŸèƒ½èªªæ˜ï¼šé“å…·åˆ†ç‚ºå…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ã€ä»™ä¸¹ç­‰é¡ï¼š
          - å…µå™¨ï¼šå¢åŠ å¯é¸ç­”æ¡ˆæ•¸ï¼Œå¯åœ¨å¤šé¸é¡Œä¸­ä½¿ç”¨ï¼›
          - åŠŸæ³•ï¼šæ’é™¤éƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆï¼›
          - é™£æ³•ï¼šå¢åŠ ç•¶é¡Œä½œç­”æ™‚é–“ï¼›
          - éˆå™¨ï¼šé¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆï¼›
          - éˆç¬¦ï¼šé¡¯ç¤ºéƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆï¼›
          - ä»™ä¸¹ï¼šç«‹å³å¢åŠ ä¿®ç…‰ç¶“é©—ã€‚
          é“å…·å¯ä»¥åœ¨å•†åº—è³¼è²·ï¼Œæˆ–é€éæ¶ˆè€—éˆçŸ³å‡ç´šç‚ºæ›´é«˜å“éšï¼Œæ•ˆæœå°‡æ›´å¼·ã€‚å‡ç´šæ¶ˆè€—çš„éˆçŸ³æœƒå³æ™‚æ‰£é™¤ä¸¦æ›´æ–°é¡¯ç¤ºã€‚
       4. è™•ç½°æ©Ÿåˆ¶ï¼šè‹¥è¨“ç·´çµæŸæ™‚å¾—åˆ†ä½æ–¼è©²é›£åº¦è¦æ±‚çš„å‹ç‡é–€æª»ï¼Œå°‡æ‰£æ¸›ä¿®ç…‰ç¶“é©—ã€‚å·®è·æ¯å¢åŠ  5 åˆ†ï¼Œè™•ç½°ç‡ç¿»å€ï¼šå·® 5 åˆ†æ‰£ 1%ï¼Œå·® 10 åˆ†æ‰£ 2%ï¼Œå·® 15 åˆ†æ‰£ 4%ï¼Œå·® 20 åˆ†æ‰£ 8%ï¼Œå·® 25 åˆ†æ‰£ 16%ï¼Œå·® 30 åˆ†æ‰£ 32%ï¼Œä»¥æ­¤é¡æ¨ã€‚ç•¶ä¿®ç…‰ç¶“é©—ç‚º 0 æ™‚ä¸å†æ‰£æ¸›ã€‚*/
    const content = `
        <div style="text-align:left;">
            <h3>1. å‡ç´šçå‹µèªªæ˜</h3>
            <p>ç•¶ä½ çš„ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸åŒæ™‚é”åˆ°ä¸‹ä¸€å±¤é–€æª»æ™‚ï¼Œä¿®ç‚ºæœƒè‡ªå‹•çªç ´ã€‚æ¯çªç ´ä¸€å±¤ï¼Œä¾æ“šçªç ´å±¤ç´šå·®è·ç²å¾—ç›¸æ‡‰æ•¸é‡çš„æ¸¬è©¦æ©Ÿæœƒèˆ‡éˆçŸ³ã€‚</p>
            <h3>2. éŠæˆ²é—œå¡èªªæ˜</h3>
            <p>è¨“ç·´å…±æœ‰ 10 å€‹é›£åº¦ï¼Œæ¯å›åˆåŒ…å« 20 é¡Œåœ–ç¤ºï¼Œè«‹åœ¨å€’æ•¸æ™‚é–“å…§é¸å‡ºç›®æ¨™ã€‚ç­”å°èƒ½ç´¯ç©ä¿®ç…‰ç¶“é©—èˆ‡è¨“ç·´æ¬¡æ•¸ï¼›é”åˆ°è©²é›£åº¦è¦æ±‚çš„å‹ç‡ï¼Œå¯é¡å¤–ç²å¾—ä¿®ç…‰ç¶“é©—çå‹µã€‚</p>
            <h3>3. é“å…·å‡ç´šåŠåŠŸèƒ½èªªæ˜</h3>
            <p>é“å…·åˆ†ç‚ºå…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ã€ä»™ä¸¹ç­‰é¡ï¼Œæ¯ç¨®é“å…·åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
            <ul>
                <li><b>å…µå™¨</b>ï¼šå¢åŠ å¯é¸ç­”æ¡ˆæ•¸ï¼Œå¯ç”¨æ–¼å¤šé¸é¡Œã€‚</li>
                <li><b>åŠŸæ³•</b>ï¼šæ’é™¤éƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆã€‚</li>
                <li><b>é™£æ³•</b>ï¼šå¢åŠ ä½œç­”æ™‚é–“ï¼Œåƒ…å°ç•¶é¡Œæœ‰æ•ˆã€‚</li>
                <li><b>éˆå™¨</b>ï¼šé¡¯ç¤ºå…¨éƒ¨æ­£ç¢ºç­”æ¡ˆã€‚</li>
                <li><b>éˆç¬¦</b>ï¼šé¡¯ç¤ºéƒ¨åˆ†éŒ¯èª¤ç­”æ¡ˆã€‚</li>
                <li><b>ä»™ä¸¹</b>ï¼šç«‹å³å¢åŠ ä¿®ç…‰ç¶“é©—ã€‚</li>
            </ul>
            <p>é“å…·å¯åœ¨å•†åº—è³¼è²·ï¼Œæˆ–ä½¿ç”¨éˆçŸ³é€²è¡Œå‡ç´šä»¥æå‡æ•ˆæœã€‚å‡ç´šæ™‚æ¶ˆè€—çš„éˆçŸ³æœƒå³åˆ»å¾ä½ çš„å¸³æˆ¶æ‰£é™¤ä¸¦åˆ·æ–°ä¸»ç•«é¢ã€‚</p>
            <h3>4. è™•ç½°æ©Ÿåˆ¶</h3>
            <p>è‹¥è¨“ç·´çµç®—å¾—åˆ†ä½æ–¼è©²é›£åº¦è¦æ±‚çš„å‹ç‡é–€æª»ï¼Œä½ çš„ä¿®ç…‰ç¶“é©—å°‡è¢«æ‰£æ¸›ã€‚èˆ‡é–€æª»å·®è·æ¯å¢åŠ  5 åˆ†ï¼Œè™•ç½°ç‡ç¿»å€ï¼šå·® 5 åˆ†æ‰£ 1%ï¼Œå·® 10 åˆ†æ‰£ 2%ï¼Œå·® 15 åˆ†æ‰£ 4%ï¼Œå·® 20 åˆ†æ‰£ 8%ï¼Œå·® 25 åˆ†æ‰£ 16%ï¼Œå·® 30 åˆ†æ‰£ 32%ï¼Œä¾æ­¤é¡æ¨ã€‚ç•¶ä¿®ç…‰ç¶“é©—ç‚º 0 æ™‚ä¸å†æ‰£æ¸›ã€‚</p>

            <h3>5. å®Œç¾èˆ‡ç§˜å¢ƒçå‹µ</h3>
            <p>åœ¨æ™®é€šè¨“ç·´ä¸­ï¼Œè‹¥åœ¨ 20 é¡Œä¸­å–å¾— 100 åˆ†æ»¿åˆ†ï¼Œå°‡æ ¹æ“šæŒ‘æˆ°é›£åº¦é¡å¤–ç²å¾—éš¨æ©Ÿçå‹µï¼šé›£åº¦ 1 æ™‚é¡å¤– 1 ä»½çå‹µï¼Œé›£åº¦ 2 æ™‚ 2 ä»½ï¼Œä»¥æ­¤é¡æ¨ã€‚</p>
            <p>åœ¨ç§˜å¢ƒè©¦ç…‰ä¸­ï¼Œè‹¥æœ¬æ¬¡é€£çºŒç­”å°é¡Œæ•¸è¶…è¶Šæ—¢å¾€æœ€é«˜ç´€éŒ„ï¼Œå°‡ç²å¾—é¡å¤–çå‹µï¼Œæ–°ç´€éŒ„è¶Šé«˜çå‹µè¶Šè±åšã€‚æ¯çªç ´ 100 é¡Œå°‡é¡å¤–å¢åŠ  2 ä»½çå‹µï¼Œè¶…è¶Š 500 é¡Œä»¥ä¸Šå¯ç²å¾—æ›´å¤šå€çå‹µã€‚</p>
            <p>é€²å…¥ç§˜å¢ƒè©¦ç…‰éœ€è¦æ¶ˆè€—éˆçŸ³ï¼šç§˜å¢ƒé›£åº¦ 1 æ¶ˆè€— 10 é¡†éˆçŸ³ï¼Œä¹‹å¾Œæ¯æé«˜ 1 ç´šæ‰€éœ€æ¶ˆè€—ç¿»å€ã€‚ä¾‹å¦‚é›£åº¦ 2 æ¶ˆè€— 20 é¡†ï¼Œé›£åº¦ 3 æ¶ˆè€— 40 é¡†ã€‚</p>
            <!-- # æ–°è¦å‰‡ï¼šç§˜å¢ƒè©¦ç…‰è¨“ç·´æ¬¡æ•¸åŠ æˆæ¢ä»¶èªªæ˜ -->
            <h3>6. ç§˜å¢ƒè©¦ç…‰è¨“ç·´æ¬¡æ•¸è¦å‰‡</h3>
            <p>ç§˜å¢ƒè©¦ç…‰ä¸åŒé›£åº¦ç²å¾—è¨“ç·´æ¬¡æ•¸çš„é–€æª»å¦‚ä¸‹ï¼š</p>
            <ul>
                <li>é›£åº¦ 1ï¼šè‡³å°‘ç­”å° 17 é¡Œ</li>
                <li>é›£åº¦ 2ï¼šè‡³å°‘ç­”å° 15 é¡Œ</li>
                <li>é›£åº¦ 3ï¼šè‡³å°‘ç­”å° 12 é¡Œ</li>
                <li>é›£åº¦ 4ï¼šè‡³å°‘ç­”å° 9 é¡Œ</li>
                <li>é›£åº¦ 5ï¼šè‡³å°‘ç­”å° 6 é¡Œ</li>
                <li>é›£åº¦ 6ï¼šè‡³å°‘ç­”å° 4 é¡Œ</li>
                <li>é›£åº¦ 7ï¼šè‡³å°‘ç­”å° 2 é¡Œ</li>
                <li>é›£åº¦ 8ï¼šè‡³å°‘ç­”å° 1 é¡Œ</li>
                <li>é›£åº¦ 9ï¼šè‡³å°‘ç­”å° 1 é¡Œ</li>
                <li>é›£åº¦ 10ï¼šä¸é™é¡Œæ•¸ï¼ˆç­”å° 0 é¡Œä¹Ÿå¯ï¼‰</li>
            </ul>
            <p>åªæœ‰é”åˆ°ä¸Šè¿°è¦æ±‚ï¼Œç§˜å¢ƒè©¦ç…‰çµæŸæ™‚æ‰æœƒå¢åŠ ä¸€æ¬¡è¨“ç·´æ¬¡æ•¸ã€‚</p>
            <h3>7. æ¯æ—¥ç°½åˆ°</h3>
            <p>æ¯å¤©å‡Œæ™¨ 00:00 æœƒåˆ·æ–°ç°½åˆ°ï¼Œç•¶æ—¥é¦–æ¬¡ç°½åˆ°å³å¯ä¾ç…§ç•¶å‰ä¿®ç‚ºéšå±¤ç²å¾—ä¿®ç…‰ç¶“é©—èˆ‡éˆçŸ³çå‹µã€‚é€£çºŒç°½åˆ°å¤©æ•¸è¶Šå¤šï¼Œçå‹µå€ç‡è¶Šé«˜ï¼›ä¸­æ–·ç°½åˆ°å¾Œï¼Œé€£çºŒå¤©æ•¸å°‡é‡æ–°è¨ˆç®—ã€‚</p>
            <h3>8. æ¯æ—¥éš¨æ©Ÿä»»å‹™</h3>
            <p>æ¯å¤©å°‡ç”Ÿæˆä¸€å€‹éš¨æ©Ÿä»»å‹™ï¼Œä¾‹å¦‚å®ŒæˆæŒ‡å®šé›£åº¦çš„æ™®é€šè¨“ç·´æˆ–ç§˜å¢ƒè©¦ç…‰å¤šæ¬¡ã€‚æ¥å—ä»»å‹™å¾Œï¼Œåœ¨è¨“ç·´æˆ–è©¦ç…‰çµç®—æ™‚è‹¥ç¬¦åˆæ¢ä»¶å‰‡æœƒç´¯è¨ˆé€²åº¦ï¼›é”åˆ°æŒ‡å®šæ¬¡æ•¸å³å¯å®Œæˆä»»å‹™ä¸¦é ˜å–çå‹µã€‚ä»»å‹™åƒ…ç•¶æ—¥æœ‰æ•ˆï¼Œæœªå®Œæˆæˆ–æœªæ¥å—çš„ä»»å‹™éš”æ—¥æœƒé‡æ–°ç”Ÿæˆã€‚</p>

            <h3>9. å¤©å‘½æŒ‘æˆ°ï¼ˆéš¨æ©Ÿä»»å‹™ç³»çµ±ï¼‰</h3>
            <p>å¤©å‘½æŒ‘æˆ°æ˜¯ä»¥æ—¥ç‚ºå–®ä½ç”¢ç”Ÿçš„éš¨æ©Ÿä»»å‹™ï¼Œæ¯ç¨®ä»»å‹™é¡å‹éƒ½æœƒæä¾› 10 å€‹é …ç›®å¯ä¾›é¸æ“‡ï¼Œä»»å‹™å…§å®¹æœƒæ ¹æ“šä½ çš„ä¿®ç‚ºèˆ‡æŒ‘æˆ°é›£åº¦è‡ªå‹•ç”Ÿæˆã€‚ä»»å‹™é¡å‹åŒ…å«ï¼š<b>æ™®é€šè¨“ç·´ä»»å‹™</b>ã€<b>ç§˜å¢ƒè©¦ç…‰ä»»å‹™</b>ã€<b>é“å…·ä½¿ç”¨ä»»å‹™</b>ã€<b>ä¿®ç‚ºï¼æˆå°±ä»»å‹™</b>ç­‰ã€‚ä¾‹å¦‚ï¼š</p>
            <ul>
                <li>å®ŒæˆæŒ‡å®šé›£åº¦çš„æ™®é€šè¨“ç·´å¤šæ¬¡ä¸¦é”åˆ°ç‰¹å®šå‹ç‡ï¼Œä¾‹å¦‚ã€Œå®Œæˆé›£åº¦ 3 æ™®é€šè¨“ç·´ 10 æ¬¡ä¸¦é”åˆ°å‹ç‡ 50% ä»¥ä¸Šã€ã€‚</li>
                <li>æ–¼æ™®é€šè¨“ç·´ç´¯ç©æ­£ç¢ºå›ç­”ä¸€å®šé¡Œæ•¸ï¼Œä¾‹å¦‚ã€Œæ–¼é›£åº¦ 2 è¨“ç·´ç´¯ç©æ­£ç¢ºå›ç­” 30 é¡Œã€ã€‚</li>
                <li>æŒ‘æˆ°ç§˜å¢ƒè©¦ç…‰å¤šæ¬¡ä¸¦æ¯æ¬¡é”åˆ°æœ€å°‘ç­”å°é¡Œæ•¸ï¼Œä¾‹å¦‚ã€ŒæŒ‘æˆ°ç§˜å¢ƒè©¦ç…‰é›£åº¦ 4 ä¸¦è‡³å°‘ç­”å° 12 é¡Œ 3 æ¬¡ã€ã€‚</li>
                <li>åœ¨ç§˜å¢ƒè©¦ç…‰ä¸­ä½¿ç”¨åŠŸæ³•å¤šæ¬¡ï¼Œä¾‹å¦‚ã€Œåœ¨ç§˜å¢ƒè©¦ç…‰ä¸­ä½¿ç”¨åŠŸæ³•æˆåŠŸæç¤º 15 æ¬¡ã€ã€‚</li>
                <li>æ–¼ä»»å‹™æœŸé–“å…§ä½¿ç”¨æŒ‡å®šé¡å‹é“å…·ï¼Œä¾‹å¦‚ã€Œåœ¨ä»»å‹™æœŸé–“å…§ä½¿ç”¨ 5 æ¬¡å…µå™¨é¡é“å…·ã€æˆ–ã€Œä½¿ç”¨éˆç¬¦æ’é™¤ 10 å€‹éŒ¯èª¤ç­”æ¡ˆã€ã€‚</li>
                <li>ç´¯ç©ç²å¾—ä¸€å®šä¿®ç…‰ç¶“é©—æˆ–é”æˆé€£çºŒæˆåŠŸè¨“ç·´æ¬¡æ•¸ï¼Œä¾‹å¦‚ã€Œç´¯ç©ç²å¾— 5000 ä¿®ç…‰ç¶“é©—ã€æˆ–ã€Œé€£çºŒæˆåŠŸå®Œæˆè¨“ç·´ 7 æ¬¡ã€ã€‚</li>
            </ul>
            <p>é€™äº›ä»»å‹™éœ€è¦å…ˆé»æ“Šã€Œæ¥å—ã€æ‰èƒ½é–‹å§‹ç´¯è¨ˆé€²åº¦ï¼›æ¥å—å¾Œå¯éš¨æ™‚å–æ¶ˆï¼Œå–æ¶ˆæœƒé‡ç½®é€²åº¦ã€‚æ¯äººåŒæ™‚æœ€å¤šæ¥å— 3 å€‹å¤©å‘½æŒ‘æˆ°ã€‚å®Œæˆä»»å‹™å¾Œå¯é ˜å–ç¨ç«‹çå‹µï¼ŒåŒ…æ‹¬ä¿®ç…‰ç¶“é©—ã€éˆçŸ³æˆ–ç¨€æœ‰é“å…·ï¼Œä»»å‹™è¶Šé›£çå‹µè¶Šè±åšï¼Œä¸”ä»»å‹™å¯è¨­å®šæœŸé™ï¼ˆç„¡æœŸé™ã€1 æ—¥ã€3 æ—¥ã€5 æ—¥ï¼‰ï¼ŒæœŸé™è¶Šé•·å‰‡çå‹µå€ç‡è¶Šé«˜ã€‚</p>
            <p>ä»»å‹™é€²åº¦æœƒåœ¨è¨“ç·´æˆ–ç§˜å¢ƒè©¦ç…‰çµç®—ï¼Œä»¥åŠä½¿ç”¨é“å…·æˆ–ç²å¾—ä¿®ç…‰ç¶“é©—æ™‚è‡ªå‹•æ›´æ–°ã€‚æ¯å€‹ä»»å‹™é …ç›®å¯ä»¥éš¨æ™‚æŒ‰ä¸‹ã€Œåˆ·æ–°ã€æŒ‰éˆ•é‡æ–°ç”Ÿæˆï¼Œä½†åˆ·æ–°å¾Œéœ€ç­‰å¾… 10 åˆ†é˜æ‰æœƒé¡¯ç¤ºæ–°çš„ä»»å‹™å…§å®¹ã€‚å®Œæˆä»»å‹™ä¸¦é ˜å–çå‹µå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å¡«è£œæ–°çš„ä»»å‹™ã€‚è‹¥å¤©å‘½æŒ‘æˆ°èˆ‡æ¯æ—¥ä»»å‹™ç›®æ¨™é‡ç–Šï¼Œé€²åº¦æœƒå…±äº«ï¼Œä½†çå‹µéœ€åˆ†åˆ¥é ˜å–ã€‚å¤©å‘½æŒ‘æˆ°æ¯æ—¥é‡æ–°æ•´ç†ï¼ŒéæœŸæˆ–å†·å»çµæŸæœƒè‡ªå‹•æ›¿æ›ç‚ºæ–°ä»»å‹™ã€‚</p>
        </div>
    `;
    showModal("ğŸ“œ éŠæˆ²è¦å‰‡èªªæ˜", content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// ===================== ç§˜å¢ƒè©¦ç…‰èˆ‡æ’è¡Œæ¦œ / ç™»å…¥ç³»çµ± =====================

// # ç§˜å¢ƒè©¦ç…‰ä¸»é¸å–®ï¼šè®“ç©å®¶æŒ‘é¸é›£åº¦å¾Œé–‹å§‹ç§˜å¢ƒè©¦ç…‰
function renderSecretTrialMenu() {
    clearApp();
    // åœ¨æ¸²æŸ“ç§˜å¢ƒé¸å–®å‰ï¼Œé‡æ–°è®€å–æœ¬åœ°ç§˜å¢ƒç´€éŒ„ï¼Œç¢ºä¿æŒ‰éˆ•ä¸Šé¡¯ç¤ºçš„æœ€é«˜ç­”é¡Œæ•¸æœ€æ–°
    try {
        maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, maxTrialScores || {});
    } catch (e) { /* ignore */ }
    let html = `<h1>ğŸŒŒ ç§˜å¢ƒè©¦ç…‰</h1>`;
    html += `<p style="text-align:center;">è«‹é¸æ“‡ç§˜å¢ƒé›£åº¦ï¼ˆ1 æœ€ç°¡å–®ï½10 æœ€å›°é›£ï¼‰</p>`;
    for (let i = 1; i <= 10; i++) {
        const best = maxTrialScores[i] || 0;
        // # æ¯å€‹ç§˜å¢ƒé›£åº¦çš„æ¶ˆè€—ï¼šé›£åº¦ 1 ç‚º 10 é¡†éˆçŸ³ï¼Œä¹‹å¾Œæ¯ä¸€ç´šç¿»å€
        const cost = 10 * Math.pow(2, i - 1);
        // # å°‡æ‰€éœ€éˆçŸ³èˆ‡æœ€é«˜ç­”å°é¡Œæ•¸æ¨™è¨»åœ¨æŒ‰éˆ•æ–‡å­—ä¸­
        html += `<button class="btn-trial" data-action="start-trial" data-level="${i}">ç§˜å¢ƒé›£åº¦ ${i}ï¼ˆ${cost}éˆçŸ³ï¼‰(æœ€é«˜ç­”å°ï¼š${best} é¡Œ)</button>`;
    }
    // ä½¿ç”¨ btn-trial é¢¨æ ¼è®“ç§˜å¢ƒè©¦ç…‰çš„è¿”å›æŒ‰éˆ•èˆ‡å…¶ä»–æŒ‰éˆ•åº•è‰²ä¸€è‡´
    html += `<button class="btn-trial" data-action="render-main-menu">ğŸ”™ è¿”å›ä¸»é¸å–®</button>`;
    app.innerHTML = html;
}

// # é–‹å§‹ç§˜å¢ƒè©¦ç…‰ï¼šé¡Œæ•¸ç„¡é™åˆ¶ï¼Œç›´åˆ°ç­”éŒ¯ç‚ºæ­¢
function startTrial(level) {
    // # é€²å…¥ç§˜å¢ƒè©¦ç…‰éœ€æ¶ˆè€—éˆçŸ³ï¼šé›£åº¦ 1 æ¶ˆè€— 10ï¼Œä¹‹å¾Œæ¯æé«˜ 1 ç´šéœ€æ±‚ç¿»å€
    try {
        var cost = 10 * Math.pow(2, (level - 1));
        // # è‹¥éˆçŸ³ä¸è¶³å‰‡æ‹’çµ•é€²å…¥è©¦ç…‰
        if (typeof gameState !== 'undefined' && gameState.stones < cost) {
            alert('ğŸ’ éˆçŸ³ä¸è¶³ï¼Œç„¡æ³•é€²å…¥ç§˜å¢ƒè©¦ç…‰ï¼');
            return;
        }
        if (typeof gameState !== 'undefined') {
            gameState.stones -= cost;
            try { saveGameState(); } catch (e) {}
            // # æ›´æ–°ä¸»ç•«é¢é¡¯ç¤ºéˆçŸ³æ•¸é‡ï¼ˆè‹¥å¯ç”¨ï¼‰
            if (typeof updateMainMenuInfo === 'function') {
                try { updateMainMenuInfo(); } catch (e) {}
            }
        }
    } catch (e) {}
    trainingState = {
        mode: 'secretTrial',
        difficulty: level,
        round: 0,
        success: 0,
        fail: 0,
        totalRounds: Infinity,
        hasAnswered: false,
        correctAnswers: [],
        gameGridButtons: [],
        hasUsedSingleUseItem: false,
        allowedChoices: 1,
        selectedChoices: [],
    };
    // # è¨˜éŒ„é–‹å§‹æ™‚é–“èˆ‡ä½¿ç”¨éçš„é“å…·
    try {
        trainingState.startedAt = Date.now();
        trainingState.usedItems = [];
    } catch (e) {}

    // é€²å…¥ç§˜å¢ƒè©¦ç…‰æ™‚ï¼Œå°‡ç•«é¢å®¹å™¨å¥—ç”¨ trial-mode ä»¥æ”¹è®ŠèƒŒæ™¯è‰²
    try {
        const containerEl = document.getElementById('app-container');
        if (containerEl) containerEl.classList.add('trial-mode');
    } catch (e) { /* ignore */ }
    trialNext();
}

// # ç§˜å¢ƒè©¦ç…‰ä¸‹ä¸€é¡Œï¼šé¡ä¼¼æ–¼ trainingNextï¼Œä½†æ²’æœ‰é¡Œæ•¸é™åˆ¶
function trialNext() {
    trainingState.round++;
    // é‡ç½®æ¯é¡Œç‹€æ…‹
    trainingState.hasAnswered = false;
    trainingState.hasUsedSingleUseItem = false;
    trainingState.allowedChoices = 1;
    trainingState.selectedChoices = [];
    trainingState.roundExtraTime = 0;
    trainingState.countdownRemaining = null;
    const gameDef = ALL_GAMES[Math.floor(Math.random() * ALL_GAMES.length)];
    const gameFunc = window[gameDef.func];
    gameFunc();
}

// # ç§˜å¢ƒè©¦ç…‰çµæŸèˆ‡çå‹µçµç®—
function showTrialResult() {
    clearApp();
    const correctCount = trainingState.success || 0;
    // è¨˜éŒ„æœ€é«˜ç´€éŒ„
    const diff = trainingState.difficulty;
    // æ›´æ–°æ¯æ—¥ä»»å‹™é€²åº¦ï¼šç§˜å¢ƒè©¦ç…‰é”åˆ°è¦æ±‚é¡Œæ•¸æ‰è¨ˆå…¥
    try {
        updateDailyTaskProgressTrial(correctCount, diff);
    } catch (e) { /* ignore */ }
    const prevBestTrial = maxTrialScores[diff] || 0;
    if (!maxTrialScores[diff] || correctCount > maxTrialScores[diff]) {
        maxTrialScores[diff] = correctCount;
        // # å„²å­˜åˆ° localStorage
        try { saveToLocalStorage(TRIAL_SCORE_FILE, maxTrialScores); } catch (e) {}
    }
    const prevTotalTrainCount = gameState.total;
    // # ç§˜å¢ƒè©¦ç…‰ï¼šæ ¹æ“šé›£åº¦è¨­å®šçš„ç­”å°é¡Œæ•¸é–€æª»ï¼Œæ±ºå®šæ˜¯å¦å¢åŠ  1 æ¬¡è¨“ç·´æ¬¡æ•¸
    try {
        const diff = trainingState.difficulty || 1;
        const threshold = (TRIAL_TRAINING_REQUIREMENTS && TRIAL_TRAINING_REQUIREMENTS[diff] !== undefined) ? TRIAL_TRAINING_REQUIREMENTS[diff] : 1;
        if (correctCount >= threshold) {
            gameState.total++;
        }
    } catch (e) {
        // è‹¥å‡ºç¾éŒ¯èª¤å›é€€è‡³åŸæœ¬é‚è¼¯ï¼ˆè‡³å°‘ç­”å° 1 é¡Œï¼‰
        if (correctCount >= 1) gameState.total++;
    }
    // åŸºç¤ç¶“é©—
    const baseExp = 1;
    // é¡å¤–ç¶“é©—ï¼šæ¯ 10 é¡Œ +1
    const bonusExp = Math.floor(correctCount / 10);
    const prevExp = gameState.exp;
    gameState.exp += baseExp + bonusExp;
    if (bonusExp > 0) gameState.bonus = (gameState.bonus || 0) + bonusExp;
    // ç™¼æ”¾éš¨æ©Ÿçå‹µï¼šæ¯ 20 é¡Œ 1 å€‹
    let rewardsHTML = '';
    const rewardCount = Math.floor(correctCount / 20);
    if (rewardCount > 0) {
        const rewardsList = grantRandomRewards(rewardCount)[0];
        rewardsHTML += `<div class="message msg-reward">ğŸ ç§˜å¢ƒè¡¨ç¾ç²å¾— ${rewardCount} å€‹éš¨æ©Ÿçå‹µï¼š<br>${rewardsList.join('<br>')}</div>`;
    }
    // ç•¶è¶…ééå¾€æœ€é«˜ç´€éŒ„æ™‚ï¼Œçµ¦äºˆé¡å¤–çå‹µï¼Œé›£åº¦è¶Šé«˜ã€ç­”å°è¶Šå¤šé¡Œï¼Œçå‹µè¶Šå¤š
    let recordRewardHTML = '';
    try {
        if (correctCount > prevBestTrial) {
            // # è¨­å®šè¶…è¶Šç´€éŒ„çš„çå‹µæ•¸é‡ï¼šåŸºæ–¼æ–°ç´€éŒ„çš„é¡Œæ•¸ï¼Œæ¯ 100 é¡Œå¢åŠ  2 ä»½çå‹µ
            const rewardCountRecord = 1 + Math.floor(correctCount / 100) * 2;
            const [recordRewards] = grantRandomRewards(rewardCountRecord);
            recordRewardHTML = `<div class="message msg-reward">ğŸ… è¶…è¶Šæ­·å²ç´€éŒ„ï¼ç²å¾— ${rewardCountRecord} å€‹é¡å¤–çå‹µï¼š<br>${recordRewards.join('<br>')}</div>`;
        }
    } catch (e) { console.warn('ç´€éŒ„çå‹µè¨ˆç®—éŒ¯èª¤', e); }

    // å¤©å‘½æŒ‘æˆ°é€²åº¦æ›´æ–°ï¼ˆç§˜å¢ƒè©¦ç…‰ï¼‰
    try {
        const diffLevelTrial = trainingState.difficulty || 1;
        const expGainTrial = baseExp + bonusExp;
        if (typeof updateHeavenChallengeProgressTrial === 'function') {
            updateHeavenChallengeProgressTrial(correctCount, diffLevelTrial, expGainTrial);
        }
        if (typeof updateHeavenChallengeProgressExp === 'function') {
            updateHeavenChallengeProgressExp(expGainTrial);
        }
    } catch (e) { /* ignore */ }

    // ç™¼æ”¾éˆçŸ³ï¼šæ¯ 30 é¡Œ 1 é¡†
    const stonesAward = Math.floor(correctCount / 30);
    if (stonesAward > 0) {
        gameState.stones += stonesAward;
        rewardsHTML += `<p style="text-align:center; color:darkorchid">ğŸ’ ç§˜å¢ƒè¡¨ç¾ç²å¾— ${stonesAward} éˆçŸ³</p>`;
    }

    // # è‹¥é€™æ¬¡ç­”é¡Œæ•¸è¶…éä»¥å¾€æœ€é«˜ç´€éŒ„ï¼Œå°‡ç´€éŒ„çå‹µåŠ å…¥é¡¯ç¤º
    if (recordRewardHTML) {
        rewardsHTML += recordRewardHTML;
        // # æ’­æ”¾ç‰¹æ®Šçå‹µéŸ³æ•ˆï¼ˆèˆ‡æ¨‚é€å°çä¸­çç›¸ä¼¼ï¼‰
        try { if (typeof playRewardSound === 'function') playRewardSound(); } catch (_) {}
    }

    // =============== è¨“ç·´æ¬¡æ•¸çå‹µèˆ‡ä»™é–€ä½éšæ›´æ–° ===============
    // # åœ¨ç§˜å¢ƒè©¦ç…‰ä¸­ä¹Ÿè¨ˆç®—é€±æœŸçå‹µã€é‡Œç¨‹ç¢‘çå‹µä»¥åŠç‰¹å®šæ¬¡æ•¸çå‹µï¼Œèˆ‡æ™®é€šè¨“ç·´ç›¸åŒ
    try {
        if (gameState.total > 0 && gameState.total % 5 === 0) {
            const [cycleRewards] = grantRandomRewards(1);
            rewardsHTML += `<div class="message msg-reward">ğŸ‰ ç´¯ç©è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé€±æœŸçå‹µï¼<br>${cycleRewards.join('<br>')}</div>`;
        }
        if (TRAINING_MILESTONES[gameState.total]) {
            const milestone = TRAINING_MILESTONES[gameState.total];
            gameState.current_title = milestone.title;
            const [milestoneRewards] = grantRandomRewards(milestone.rewards);
            rewardsHTML += `<div class="message msg-reward">ğŸ† æ­å–œï¼è¨“ç·´é” ${gameState.total} æ¬¡ï¼Œé”æˆé‡Œç¨‹ç¢‘ï¼<br>ç²å¾—æ–°ä½éšï¼šã€${milestone.title}ã€‘<br>ç²å¾—çå‹µï¼š<br>${milestoneRewards.join('<br>')}</div>`;
        }
        const countRewards = checkTrainingCountRewards(prevTotalTrainCount, gameState.total);
        if (countRewards) rewardsHTML += `<div class="message msg-reward">${countRewards}</div>`;
    } catch (e) { console.warn('ç§˜å¢ƒè¨“ç·´çå‹µéŒ¯èª¤', e); }

    // å‡ç´šåˆ¤å®š
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    // è¨ˆç®—æœ¬æ¬¡è¨“ç·´æ¬¡æ•¸å¢é‡ï¼Œç”¨æ–¼é¡¯ç¤ºï¼‹1 æˆ– ï¼‹0 æ–‡å­—
    const trainingAdded = gameState.total - prevTotalTrainCount;
    let resultHTML = `<h2>ğŸŒŒ ç§˜å¢ƒè©¦ç…‰å®Œæˆ</h2>`;
    resultHTML += `<div class="feedback success">é€£çºŒç­”å°é¡Œæ•¸ï¼š${correctCount}</div>`;
    resultHTML += `<p style="text-align:center;">ğŸ’¡ ä¿®ç…‰ç¶“é©— +${baseExp + bonusExp}</p>`;
    // é¡¯ç¤ºè¨“ç·´æ¬¡æ•¸åŠ æ¸›ï¼Œæ ¹æ“šæœ¬æ¬¡ç­”å°é¡Œæ•¸åˆ¤æ–·æ˜¯å¦å¢åŠ 
    resultHTML += `<p class="${trainingAdded > 0 ? 'train-add' : 'train-none'}" style="text-align:center;">è¨“ç·´æ¬¡æ•¸+${trainingAdded > 0 ? trainingAdded : 0}</p>`;
    if (levelupMsg) resultHTML += `<p class="message msg-levelup">${levelupMsg}</p>`;
    resultHTML += rewardsHTML;
    // é¡¯ç¤ºå›ä¸»é¸å–®æŒ‰éˆ•
    // # æ–°å¢å†æ¬¡æŒ‘æˆ°æŒ‰éˆ•ï¼šè‹¥éˆçŸ³è¶³å¤ ï¼Œå‰‡å¯å†æ¬¡æŒ‘æˆ°æœ¬é›£åº¦
    try {
        const diff = trainingState.difficulty || 1;
        const cost = 10 * Math.pow(2, diff - 1);
        const disabledAttr = (typeof gameState !== 'undefined' && gameState.stones < cost) ? 'disabled' : '';
        resultHTML += `<button class="btn-trial" data-action="retry-trial" data-level="${diff}" ${disabledAttr}>ğŸ”„ å†æ¬¡æŒ‘æˆ°</button>`;
    } catch (e) {
        // è‹¥å‡ºç¾éŒ¯èª¤ä»é¡¯ç¤ºå¯å†æ¬¡æŒ‘æˆ°
        resultHTML += `<button class="btn-trial" data-action="retry-trial">ğŸ”„ å†æ¬¡æŒ‘æˆ°</button>`;
    }
    resultHTML += `<button class="btn-trial" data-action="render-main-menu">ğŸ” å›ä¸»é¸å–®</button>`;
    app.innerHTML = resultHTML;
    saveGameState();
    // # ä¸Šå‚³ç§˜å¢ƒç´€éŒ„è‡³é›²ç«¯ (Firestore)
    try {
        if (typeof saveTrialRecord === 'function') {
            const _durationSec = Math.max(0, Math.floor((Date.now() - (trainingState.startedAt || Date.now())) / 1000));
            const _usedItems = Array.isArray(trainingState.usedItems) ? trainingState.usedItems.slice(0) : [];
            saveTrialRecord({
                level: trainingState.difficulty,
                score: correctCount,
                mode: 'ç§˜å¢ƒè©¦ç…‰',
                usedItems: _usedItems,
                durationSec: _durationSec,
                result: 'fail',
                publishToLeaderboard: true
            });
        }
    } catch (e) { console.warn('saveTrialRecord failed', e); }
    // æ›´æ–°ä¸»ç•«é¢è³‡è¨Š
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch(e) {}
    }
}

// # å°‡ç§˜å¢ƒè©¦ç…‰ç´€éŒ„å¯«å…¥é›²ç«¯ï¼š
async function saveTrialRecord(rec) {
    // rec: { level, score, mode, usedItems, durationSec, result, publishToLeaderboard }
    if (!FIREBASE_ONLINE_ENABLED || !db) return;
    var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
    if (!u) return;
    var uid = u.uid;
    var now = firebase.firestore.Timestamp.now();
    var runRef = db.collection('users').doc(uid).collection('trials').doc();
    var statRef = db.collection('user_trial_stats').doc(uid);
    return db.runTransaction(async function(tx) {
        tx.set(runRef, Object.assign({}, rec, {
            createdAt: now,
            clientAt: new Date().toISOString(),
            appVersion: 'web-1.0.0'
        }));
        var statSnap = await tx.get(statRef);
        var prev = statSnap.exists ? statSnap.data() : { totalTrials: 0, bestScore: -1 };
        var next = {
            totalTrials: (prev.totalTrials || 0) + 1,
            bestScore: Math.max(prev.bestScore || -1, rec.score || 0),
            lastPlayedAt: now
        };
        tx.set(statRef, next, { merge: true });
    }).then(async function() {
        // # æ›´æ–°å…¬é–‹æ’è¡Œæ¦œï¼šåŠ å…¥æˆ–æ›´æ–°å„é›£åº¦æœ€é«˜ç­”å°é¡Œæ•¸èˆ‡ç©å®¶åŸºæœ¬è³‡æ–™
        if (rec.publishToLeaderboard) {
            try {
                var prof = await getOrInitUserProfile();
                var leaderRef = db.collection('leaderboard_trial_public').doc(uid);
                await db.runTransaction(async function(tx2) {
                    var snap = await tx2.get(leaderRef);
                    var data = snap.exists ? snap.data() : {};
                    var bestScores = Object.assign({}, data.bestScores || {});
                    // # æ›´æ–°ç•¶å‰é›£åº¦æœ€é«˜åˆ†
                    var prevScore = bestScores[rec.level] || 0;
                    var newScore = Math.max(prevScore, rec.score || 0);
                    bestScores[rec.level] = newScore;
                    // # å…¨åŸŸæœ€é«˜åˆ†
                    var bestScoreOverall = data.bestScore || 0;
                    bestScoreOverall = Math.max(bestScoreOverall, rec.score || 0);
                    // # æ§‹å»ºæ›´æ–°è³‡æ–™
                    var updateData = {
                        bestScores: bestScores,
                        bestScore: bestScoreOverall,
                        displayName: (prof.personalName && prof.personalName !== '') ? prof.personalName : (prof.displayName || 'ç„¡åä¿®å£«'),
                        gender: prof.gender || '',
                        linggen: (typeof prof.linggen !== 'undefined' ? prof.linggen : ((typeof gameState !== 'undefined' && gameState.linggen !== undefined) ? gameState.linggen : null)),
                        createDate: prof.createDate || firebase.firestore.FieldValue.serverTimestamp(),
                        country: prof.country || 'TW',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    tx2.set(leaderRef, updateData, { merge: true });
                });
            } catch (e) {
                console.warn('æ›´æ–°æ’è¡Œæ¦œå¤±æ•—', e);
            }
        }
    }).catch(function(e){ console.warn('saveTrialRecord å¤±æ•—ï¼š', e); });
}

// # è®€å–ç§˜å¢ƒæ’è¡Œæ¦œ Top N
async function loadTrialLeaderboardTopN(n) {
    if (!FIREBASE_ONLINE_ENABLED || !db) return [];
    var qs = await db.collection('leaderboard_trial_public').orderBy('bestScore','desc').limit(n||100).get();
    return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

// # è®€å–ç§˜å¢ƒæ’è¡Œæ¦œï¼šå–å¾—å„é›£åº¦ Top 3 åï¼ˆå«ç©å®¶è³‡è¨Šï¼‰
async function loadTrialLeaderboardGrouped() {
    if (!FIREBASE_ONLINE_ENABLED || !db) return {};
    try {
        var qs = await db.collection('leaderboard_trial_public').get();
        var result = {};
        qs.docs.forEach(function(doc) {
            var d = doc.data() || {};
            var bestScores = d.bestScores || {};
            // # éæ­· 1~10 é›£åº¦
            for (var i = 1; i <= 10; i++) {
                var s = bestScores[i];
                if (typeof s === 'number' && s > 0) {
                    if (!result[i]) result[i] = [];
                    // # å°‡æ—¥æœŸæ ¼å¼åŒ–ï¼ˆæ¡ç”¨ createDate æˆ– updatedAtï¼‰
                    var dateStr = '';
                    var dt = d.updatedAt || d.createDate;
                    try {
                        if (dt && typeof dt.toDate === 'function') {
                            var dd = dt.toDate();
                            dateStr = dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
                        } else if (typeof dt === 'string') {
                            dateStr = dt.split('T')[0];
                        }
                    } catch (_) {}
                    result[i].push({
                        displayName: d.displayName || 'ç„¡åä¿®å£«',
                        gender: d.gender || '',
                        linggen: (typeof d.linggen !== 'undefined' && d.linggen !== null) ? d.linggen : '',
                        score: s,
                        date: dateStr
                    });
                }
            }
        });
        // # æ’åºä¸¦æˆªå–å‰ 3 å
        Object.keys(result).forEach(function(k) {
            result[k].sort(function(a,b) {
                // # æŒ‰åˆ†æ•¸é™åºï¼›è‹¥åˆ†æ•¸ç›¸åŒå‰‡æ—¥æœŸè¿‘è€…åœ¨å‰
                if (b.score !== a.score) return b.score - a.score;
                if (a.date && b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return 0;
            });
            result[k] = result[k].slice(0, 3);
        });
        return result;
    } catch (e) {
        console.warn('è®€å–æ’è¡Œæ¦œåˆ†çµ„å¤±æ•—', e);
        return {};
    }
}

// # é¡¯ç¤ºç§˜å¢ƒæ’è¡Œæ¦œï¼ˆå«é›¢ç·šè³‡è¨Šï¼‰
async function showTrialLeaderboard() {
    // å…ˆå˜—è©¦é‡æ–°è®€å–æœ¬åœ°ç§˜å¢ƒç´€éŒ„ï¼Œç¢ºä¿æ’è¡Œæ¦œè³‡æ–™æ˜¯æœ€æ–°çš„
    try {
        // è‹¥ localStorage å¯ç”¨ï¼Œå°‡æœ¬åœ°ç´€éŒ„è¼‰å…¥ maxTrialScoresï¼›å¤±æ•—æ™‚ä¿æŒåŸå€¼
        maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, maxTrialScores || {});
    } catch (e) { /* ignore */ }

    // å¦‚æœé›²ç«¯æœªå•Ÿç”¨å‰‡é¡¯ç¤ºé›¢ç·šç´€éŒ„
    if (!FIREBASE_ONLINE_ENABLED || !db) {
        let content = '';
        if (Object.keys(maxTrialScores || {}).length > 0) {
            content += '<p>æ‚¨çš„æœ¬åœ°ç§˜å¢ƒæœ€é«˜ç´€éŒ„ï¼š</p><ul style="padding-left:20px;">';
            for (let i = 1; i <= 10; i++) {
                const s = maxTrialScores[i] || 0;
                content += `<li>ç§˜å¢ƒé›£åº¦ ${i}ï¼š${s} é¡Œ</li>`;
            }
            content += '</ul>';
        } else {
            content = 'å°šç„¡æœ¬åœ°ç§˜å¢ƒç´€éŒ„ã€‚';
        }
        showModal('ç§˜å¢ƒæ’è¡Œæ¦œ (é›¢ç·š)', content, `<button data-action="close-modal">é—œé–‰</button>`);
        return;
    }
    let content = '';
    // # å¾é›²ç«¯è®€å–å„é›£åº¦å‰ä¸‰åè³‡æ–™
    let grouped = {};
    try {
        grouped = await loadTrialLeaderboardGrouped();
    } catch (e) { console.warn(e); grouped = {}; }
    if (!grouped || Object.keys(grouped).length === 0) {
        // # è‹¥é›²ç«¯ç„¡è³‡æ–™ï¼Œå˜—è©¦é¡¯ç¤ºæœ¬åœ°ç´€éŒ„
        if (maxTrialScores && Object.keys(maxTrialScores).length > 0) {
            content += '<p>æ‚¨çš„æœ¬åœ°ç§˜å¢ƒæœ€é«˜ç´€éŒ„ï¼š</p><ul style="padding-left:20px;">';
            for (let i = 1; i <= 10; i++) {
                const s = maxTrialScores[i] || 0;
                content += `<li>ç§˜å¢ƒé›£åº¦ ${i}ï¼š${s} é¡Œ</li>`;
            }
            content += '</ul>';
        } else {
            content = 'ç›®å‰æš«ç„¡æ’è¡Œæ¦œè³‡æ–™ã€‚';
        }
    } else {
        // # å»ºç«‹æ¯å€‹é›£åº¦çš„æ’è¡Œæ¦œè¡¨æ ¼
        for (let i = 1; i <= 10; i++) {
            const entries = grouped[i] || [];
            content += `<h3 style="text-align:left; margin-top:10px;">é›£åº¦ ${i}</h3>`;
            if (entries.length === 0) {
                content += '<p>æš«ç„¡è³‡æ–™ã€‚</p>';
                continue;
            }
            content += '<table style="width:100%; text-align:center; border-collapse:collapse; margin-bottom:10px;">';
            content += '<tr><th style="border-bottom:1px solid #ccc;">åæ¬¡</th><th style="border-bottom:1px solid #ccc;">å§“å</th><th style="border-bottom:1px solid #ccc;">æ€§åˆ¥</th><th style="border-bottom:1px solid #ccc;">éˆæ ¹</th><th style="border-bottom:1px solid #ccc;">æœ€é«˜ç­”å°é¡Œæ•¸</th><th style="border-bottom:1px solid #ccc;">ä¸Šæ¦œæ—¥æœŸ</th></tr>';
            entries.forEach(function(item, idx) {
                content += `<tr><td>${idx + 1}</td><td>${item.displayName || 'ç„¡åä¿®å£«'}</td><td>${item.gender || ''}</td><td>${(item.linggen === null || item.linggen === undefined || item.linggen === '') ? '' : item.linggen}</td><td>${item.score}</td><td>${item.date || ''}</td></tr>`;
            });
            content += '</table>';
        }
    }
    showModal('ç§˜å¢ƒæ’è¡Œæ¦œ', content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// === é¡¯ç¤ºä¿®ä»™æ’è¡Œæ¦œï¼ˆé›¢ç·šç‰ˆï¼‰===
// ä¾ç©å®¶ç•¶å‰ä¿®ç‚ºé¡¯ç¤ºå€‹äººä¿®ç‚ºæ’è¡Œæ¦œã€‚ç”±æ–¼é›¢ç·šæ¨¡å¼æ²’æœ‰å…¶ä»–ç©å®¶è³‡æ–™ï¼Œåƒ…é¡¯ç¤ºè‡ªå·±çš„ä¿®ç‚ºã€‚
function showCultivationLeaderboard() {
    try {
        const stageName = getCultivationStage(gameState.exp);
        const title = 'ä¿®ä»™æ’è¡Œæ¦œ (é›¢ç·š)';
        let content = '';
        if (!gameState.personalName || gameState.personalName === '') {
            // æœªè¨­å®šå§“åæ™‚åƒ…é¡¯ç¤ºä¿®ç‚ºç­‰ç´š
            content = `<p>æ‚¨çš„ä¿®ç‚ºï¼š${stageName}</p><p>ç›®å‰åƒ…æä¾›å€‹äººä¿®ç‚ºé¡¯ç¤ºã€‚</p>`;
        } else {
            content = `<p>ä¿®å£«ï¼š${gameState.personalName}</p><p>ä¿®ç‚ºï¼š${stageName}</p><p>ç›®å‰åƒ…æä¾›å€‹äººä¿®ç‚ºé¡¯ç¤ºã€‚</p>`;
        }
        showModal(title, content, `<button data-action="close-modal">é—œé–‰</button>`);
    } catch (e) {
        console.warn('é¡¯ç¤ºä¿®ä»™æ’è¡Œæ¦œå¤±æ•—', e);
        showModal('ä¿®ä»™æ’è¡Œæ¦œ (é›¢ç·š)', 'ç„¡æ³•é¡¯ç¤ºä¿®ä»™æ’è¡Œæ¦œã€‚', `<button data-action="close-modal">é—œé–‰</button>`);
    }
}

// # é¡¯ç¤ºç™»å…¥/å¸³è™Ÿç®¡ç†ä»‹é¢
function showLoginMenu() {
    // è‹¥é›²ç«¯æœªå•Ÿç”¨å‰‡é¡¯ç¤ºæç¤º
    if (!FIREBASE_ONLINE_ENABLED || !auth) {
        showModal('å¸³è™Ÿ', 'é›²ç«¯æœªå•Ÿç”¨ï¼Œç„¡æ³•ç™»å…¥ã€‚', `<button data-action="close-modal">é—œé–‰</button>`);
        return;
    }
    const u = auth.currentUser;
    let content = '';
    if (u && !u.isAnonymous) {
        // å·²ç™»å…¥
        const name = u.displayName || u.email || 'å·²ç™»å…¥';
        content += `<p>å·²ç™»å…¥ç‚ºï¼š${name}</p>`;
        content += `<button data-action="logout">ç™»å‡º</button>`;
    } else {
        // # å¦‚æœå°šæœªç™»å…¥æˆ–ç‚ºåŒ¿åä½¿ç”¨è€…ï¼Œæä¾›åŒ¿åç™»å…¥å’Œå…¶ä»–ç™»å…¥æ–¹å¼
        content += `<button data-action="login-anonymous">åŒ¿åç™»å…¥</button>`;
        content += `<button data-action="login-google">ä»¥ Google ç™»å…¥</button>`;
        content += `<button data-action="login-yahoo">ä»¥ Yahoo ç™»å…¥</button>`;
        content += `<button data-action="login-facebook">ä»¥ Facebook ç™»å…¥</button>`;
        content += `<button data-action="login-email">ä»¥ Email/å¯†ç¢¼è¨»å†Šç™»å…¥</button>`;
    }
    showModal('ç™»å…¥ / å¸³è™Ÿ', content, `<button data-action="close-modal">é—œé–‰</button>`);
}

// # Google ç™»å…¥
function loginGoogle() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    signInWithGoogleKeepData().then(function(){
        modal.style.display = 'none';
        // é‡æ–°æ¸²æŸ“ä¸»é¸å–®ä»¥æ›´æ–°ç™»å…¥ç‹€æ…‹é¡¯ç¤º
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Google ç™»å…¥å¤±æ•—', e);
        alert('Google ç™»å…¥å¤±æ•—');
    });
}

// # åŒ¿åç™»å…¥ï¼šæ‰‹å‹•å‘¼å« signInAnonymouslyï¼ˆé€šå¸¸è‡ªå‹•ï¼Œä½†æä¾›é¡¯å¼æ“ä½œï¼‰
function loginAnonymous() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    auth.signInAnonymously().then(function(res){
        // # é—œé–‰å½ˆçª—ä¸¦é‡æ–°æ¸²æŸ“ä¸»é¸å–®
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('åŒ¿åç™»å…¥å¤±æ•—', e);
        alert('åŒ¿åç™»å…¥å¤±æ•—');
    });
}
// # Email/å¯†ç¢¼ ç™»å…¥æˆ–è¨»å†Šï¼ˆç°¡æ˜“ promptï¼‰
function loginEmail() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    const email = prompt('è«‹è¼¸å…¥ Email');
    if (!email) return;
    const password = prompt('è«‹è¼¸å…¥å¯†ç¢¼ (è‡³å°‘ 6 å­—)');
    if (!password) return;
    upgradeToEmailPassword(email, password).then(function(){
        modal.style.display = 'none';
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Email ç™»å…¥æˆ–è¨»å†Šå¤±æ•—', e);
        alert('Email ç™»å…¥æˆ–è¨»å†Šå¤±æ•—');
    });
}

// # Yahoo ç™»å…¥
function loginYahoo() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    signInWithYahooKeepData().then(function(){
        // # ç™»å…¥æˆåŠŸé—œé–‰å½ˆçª—ä¸¦åˆ·æ–°ä¸»é¸å–®
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Yahoo ç™»å…¥å¤±æ•—', e);
        alert('Yahoo ç™»å…¥å¤±æ•—');
    });
}

// # Facebook ç™»å…¥
function loginFacebook() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    signInWithFacebookKeepData().then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Facebook ç™»å…¥å¤±æ•—', e);
        alert('Facebook ç™»å…¥å¤±æ•—');
    });
}

// # ç™»å‡º
function logout() {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return;
    signOutOnline().then(function(){
        modal.style.display = 'none';
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('ç™»å‡ºå¤±æ•—', e);
        alert('ç™»å‡ºå¤±æ•—');
    });
}

// æ›´æ–°ä¸»é¸å–®è³‡æ–™ï¼Œä¾‹å¦‚ä¿®ç…‰ç¶“é©—ã€éˆçŸ³èˆ‡è¨“ç·´æ¬¡æ•¸ç­‰ã€‚
// # ç•¶æ¶ˆè€—æˆ–å¢åŠ ä¿®ç…‰ç¶“é©—/éˆçŸ³å¾Œï¼Œå¯èª¿ç”¨æ­¤å‡½å¼å³æ™‚æ›´æ–°ä¸»é¸å–®é¡¯ç¤ºã€‚
function updateMainMenuInfo() {
    const info = document.querySelector('.info-section');
    if (!info) return;
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    const ps = info.querySelectorAll('p');
    if (ps[0]) ps[0].innerHTML = `ğŸ§˜â€â™‚ï¸ ç›®å‰ä¿®ç‚ºï¼š${currentStage}`;
    if (ps[1]) ps[1].innerHTML = `ğŸ–ï¸ ç›®å‰ä»™é–€ä½éšï¼š${gameState.current_title}`;
    let tip = "ğŸŒŸ ä½ å·²é”åˆ°æœ€çµ‚ä¿®ç‚ºï¼";
    let progressVal = 100;
    if (nextInfo) {
        tip = `â¬†ï¸ è·é›¢ã€Œ${nextInfo.next_stage}ã€é‚„å·® ${nextInfo.exp_needed} ä¿®ç…‰ç¶“é©—ã€è¨“ç·´ ${nextInfo.train_needed} æ¬¡`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            progressVal = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    if (ps[2]) ps[2].innerHTML = tip;
    const progressEl = info.querySelector('progress');
    if (progressEl) progressEl.value = progressVal;
    if (ps[3]) ps[3].innerHTML = `ğŸ‹ï¸ ç´¯ç©è¨“ç·´æ¬¡æ•¸ï¼š${gameState.total} | âš”ï¸ ä¿®ç…‰ç¶“é©—ï¼š${gameState.exp} | â­ æœ€é«˜åˆ†ï¼š${highestScore}`;
    if (ps[4]) ps[4].innerHTML = `ğŸŸï¸ æ¸¬è©¦æ©Ÿæœƒï¼š${gameState.luck_tickets} æ¬¡ (ç´¯ç©ç²å¾—ï¼š${gameState.luck_tickets_total})`;
    if (ps[5]) ps[5].innerHTML = `ğŸ’ éˆçŸ³ï¼š${gameState.stones}`;
    // # æ›´æ–°å€‹äººè³‡è¨Šèˆ‡éˆæ ¹
    if (ps[6]) {
        const nameVal = gameState.personalName || 'æœªè¨­å®š';
        const genderVal = gameState.gender || 'æœªè¨­å®š';
        let ling = '';
        if (gameState.linggen === undefined || gameState.linggen === null) {
            ling = 'æœªæ¸¬';
        } else if (gameState.linggen <= 0) {
            ling = 'ç„¡éˆæ ¹';
        } else {
            ling = gameState.linggen + ' éˆæ ¹';
        }
        ps[6].innerHTML = `ğŸ‘¤ å§“åï¼š${nameVal} | æ€§åˆ¥ï¼š${genderVal} | ğŸŒ± éˆæ ¹ï¼š${ling}`;
    }
}

function showBackpack() {
    // å°‡åº«å­˜ä¾åç¨±æ’åº
    const sortedInventory = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      .sort(([a], [b]) => compareItemNames(a, b));
    // åˆå§‹åŒ–èƒŒåŒ…ç¯©é¸å™¨ï¼šé è¨­ç‚ºå…µå™¨é¡
    if (!currentBackpackFilter) {
      currentBackpackFilter = 'weapon';
    }
    // å®šç¾©åˆ†é¡åˆ—è¡¨ï¼šä»™ä¸¹ã€å…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ã€å¿«æ·é“å…·
    const backpackFilterDefs = [
      { id: 'elixir', label: 'ä»™ä¸¹' },
      { id: 'weapon', label: 'å…µå™¨' },
      { id: 'technique', label: 'åŠŸæ³•' },
      { id: 'formation', label: 'é™£æ³•' },
      { id: 'artifact', label: 'éˆå™¨' },
      { id: 'charm', label: 'éˆç¬¦' },
      { id: 'quick', label: 'å¿«æ·é“å…·' }
    ];
    // å»ºç«‹åˆ†é¡æŒ‰éˆ•åˆ—
    const filterBar = backpackFilterDefs.map(f => {
      const isActive = (currentBackpackFilter === f.id);
      // å¿«æ·é“å…·è‹¥æ²’æœ‰å…§å®¹å‰‡ç¦ç”¨
      const isDisabled = (f.id === 'quick' && (!Array.isArray(gameState.quickItems) || gameState.quickItems.length === 0));
      const activeCls = isActive ? 'active' : '';
      const disableAttr = isDisabled ? 'disabled' : '';
      return `<button data-action="switch-backpack-filter" data-filter="${f.id}" class="btn-filter ${activeCls}" ${disableAttr}>${f.label}</button>`;
    }).join('');
    // æ ¹æ“šç•¶å‰ç¯©é¸é¡å‹ç¯©é¸é“å…·
    const filteredInventory = sortedInventory.filter(([name, qty]) => {
      const effType = ITEM_EFFECTS[name]?.type;
      switch (currentBackpackFilter) {
        case 'elixir':
          return effType === 'exp';
        case 'weapon':
          return effType === 'multi_choice';
        case 'technique':
          return effType === 'reveal_wrong';
        case 'formation':
          return effType === 'add_time';
        case 'artifact':
          return effType === 'correct';
        case 'charm':
          return effType === 'wrong';
        case 'quick':
          return Array.isArray(gameState.quickItems) &&
            gameState.quickItems.includes(name) &&
            effType !== 'exp';
        default:
          return true;
      }
    });
    let listHtml = '';
    if (filteredInventory.length === 0) {
      listHtml = "<p>è©²åˆ†é¡ä¸‹æ²’æœ‰é“å…·</p>";
    } else {
      listHtml = '<ul style="padding-left: 20px; list-style-position: inside;">' +
        filteredInventory.map(([name, qty]) => {
          const catCls = getItemCategoryClass(name);
          const gradeCls = getItemGradeClass(name);
          return `<li class="cat-${catCls}"><span class="grade-${gradeCls}">${name}</span> Ã—${qty}</li>`;
        }).join('') +
        '</ul>';
    }
    // çµ„åˆå…§å®¹ï¼šåˆ†é¡æŒ‰éˆ•åˆ— + é“å…·åˆ—è¡¨
    const content = `<div>${filterBar}</div>${listHtml}`;
    const footer = `
      <button data-action="use-exp-items">ğŸµ ä½¿ç”¨ä»™ä¸¹</button>
      <button class="btn-danger" data-action="delete-items">ğŸ—‘ï¸ åˆªé™¤é“å…·</button>
      <button data-action="manage-quick-items">âš¡ å¿«æ·é“å…·è¨­å®š</button>`;
    showModal("ğŸ’ èƒŒåŒ…", content, footer);
}

// === ä½¿ç”¨ä»™ä¸¹ï¼ˆEXP é¡ï¼‰===
function showUseExpDialog() {
  const expItems = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp'))
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (expItems.length === 0) {
    content = "<p>æ²’æœ‰å¯ç”¨çš„ä»™ä¸¹é¡é“å…·</p>";
  } else {
    content = expItems.map(([name, qty]) => {
      const eff = ITEM_EFFECTS[name] || {};
      const addExp = eff.n || 0;
      // åŠ å…¥åˆ†é¡èˆ‡å“éšæ¨£å¼
      const catCls = getItemCategoryClass(name);
      const gradeCls = getItemGradeClass(name);
      return `
        <div class="modal-item-row cat-${catCls}">
          <label for="useexp-${name}"><span class="grade-${gradeCls}">${name}</span>ï¼ˆæŒæœ‰ ${qty}ï¼‰â†’ æ¯é¡† +${addExp} EXP</label>
          <input type="number" id="useexp-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
  }
  const footer = `
    <button data-action="fill-all-exp">å…¨éƒ¨å¡«æ»¿</button>
    <button data-action="confirm-use-exp">ç¢ºèªä½¿ç”¨</button>
    <button data-action="confirm-use-exp-all" class="btn-warning">å…¨éƒ¨ä½¿ç”¨</button>`;
  showModal("ğŸµ ä½¿ç”¨ä»™ä¸¹", content, footer);
}

function confirmUseExp() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  let totalGain = 0;
  let totalUsed = 0;
  const inv = gameState.inventory;
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('useexp-', '');
    const eff = ITEM_EFFECTS[name] || {};
    const add = (eff.n || 0) * qty;
    const cur = inv[name] || 0;
    inv[name] = Math.max(0, cur - qty);
    totalGain += add;
    totalUsed += qty;
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("ğŸµ ä½¿ç”¨çµæœ",
      `<p>å…±ç²å¾— +${totalGain} EXP</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">é—œé–‰</button>`);
    // æ›´æ–°å¤©å‘½æŒ‘æˆ° - ä»™ä¸¹é¡é“å…·ä½¿ç”¨
    try {
      if (typeof updateHeavenChallengeProgressItemUse === 'function' && totalUsed > 0) {
        updateHeavenChallengeProgressItemUse('elixir', totalUsed);
      }
    } catch (e) { /* ignore */ }
  } else {
    showModal("ğŸµ ä½¿ç”¨çµæœ", "<p>æœªé¸æ“‡ä»»ä½•ä»™ä¸¹ã€‚</p>", `<button data-action="close-modal">é—œé–‰</button>`);
  }
}

// === æ‰¹é‡å¡«æ»¿èˆ‡å…¨éƒ¨ä½¿ç”¨ EXP é¡ä»™ä¸¹ ===
function fillAllExpInputs() {
  const inputs = modalBody.querySelectorAll('input[id^="useexp-"]');
  inputs.forEach(input => {
    const max = parseInt(input.getAttribute('max') || '0', 10);
    if (max > 0) input.value = String(max);
  });
}

function confirmUseExpAll() {
  const inv = gameState.inventory;
  let totalGain = 0;
  let totalUsed = 0;
  Object.entries(inv).forEach(([name, qty]) => {
    if (qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp')) {
      const eff = ITEM_EFFECTS[name];
      const add = (eff.n || 0) * qty;
      inv[name] = 0;
      totalGain += add;
      totalUsed += qty;
    }
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("ğŸµ ä½¿ç”¨çµæœ",
      `<p>å…±ç²å¾— +${totalGain} EXPï¼ˆå…¨éƒ¨ä½¿ç”¨ï¼‰</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">é—œé–‰</button>`);
    // æ›´æ–°å¤©å‘½æŒ‘æˆ° - ä»™ä¸¹é¡é“å…·ä½¿ç”¨
    try {
      if (typeof updateHeavenChallengeProgressItemUse === 'function' && totalUsed > 0) {
        updateHeavenChallengeProgressItemUse('elixir', totalUsed);
      }
    } catch (e) { /* ignore */ }
  } else {
    showModal("ğŸµ ä½¿ç”¨çµæœ", "<p>æ²’æœ‰å¯ç”¨çš„ä»™ä¸¹ã€‚</p>", `<button data-action="close-modal">é—œé–‰</button>`);
  }
}

// === åˆªé™¤é“å…· ===
function showDeleteItemsDialog() {
  const deletables = Object.entries(gameState.inventory)
    .filter(([, qty]) => qty > 0)
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (deletables.length === 0) {
    content = "<p>èƒŒåŒ…æ²’æœ‰å¯ä»¥åˆªé™¤çš„é“å…·</p>";
  } else {
    content = deletables.map(([name, qty]) => {
      // é“å…·åˆªé™¤åˆ—è¡¨ä¸­åŠ å…¥åˆ†é¡èˆ‡å“éšæ¨£å¼
      const catCls = getItemCategoryClass(name);
      const gradeCls = getItemGradeClass(name);
      return `
      <div class="modal-item-row cat-${catCls}">
        <label for="del-${name}"><span class="grade-${gradeCls}">${name}</span>ï¼ˆæŒæœ‰ ${qty}ï¼‰</label>
        <input type="number" id="del-${name}" min="0" max="${qty}" value="0" />
      </div>`;
    }).join('');
  }
  const footer = `<button data-action="confirm-delete-items">ç¢ºèªåˆªé™¤</button>`;
  showModal("ğŸ—‘ï¸ åˆªé™¤é“å…·", content, footer);
}

function confirmDeleteItems() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  const inv = gameState.inventory;
  let removedList = [];
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('del-', '');
    const cur = inv[name] || 0;
    const rm = Math.min(qty, cur);
    if (rm > 0) {
      inv[name] = cur - rm;
      removedList.push(`${name} Ã—${rm}`);
    }
  });
  saveGameState();
  showModal("ğŸ—‘ï¸ åˆªé™¤çµæœ",
    removedList.length ? `<p>å·²åˆªé™¤ï¼š${removedList.join('ã€')}</p>` : "<p>æœªåˆªé™¤ä»»ä½•é“å…·</p>",
    `<button data-action="close-modal">é—œé–‰</button>`);
}

function showShop() {
    const sortedItems = Object.entries(ITEM_STONE_PRICES).sort(([a], [b]) => {
        const keyA = getItemSortKey(a);
        const keyB = getItemSortKey(b);
        if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
        if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
        return a.localeCompare(b, 'zh-Hant');
    });

    let content = `<p style="text-align:center;"><b>ç•¶å‰éˆçŸ³ï¼š${gameState.stones}</b></p>`;
    content += sortedItems.map(([item, cost]) => {
        const desc = ITEM_EFFECTS[item]?.desc || '';
        // è¨ˆç®—åˆ†é¡èˆ‡å“éšçš„ class
        const catCls = getItemCategoryClass(item);
        const gradeCls = getItemGradeClass(item);
        const labelHtml = `<span class="grade-${gradeCls}">${item}</span> - ${cost} éˆçŸ³ (${desc})`;
        return `<div class="modal-item-row cat-${catCls}">
            <label for="shop-${item}">${labelHtml}</label>
            <input type="number" id="shop-${item}" min="0" value="0" placeholder="0">
        </div>`;
    }).join('');

    let footer = `<button data-action="bulk-buy-items">è³¼è²·é¸æ“‡</button>
                  <button class="btn-warning" data-action="show-sell-dialog">è²©è³£é“å…·</button>
                  <button class="btn-secondary" data-action="show-upgrade-dialog">å“éšå‡ç´š</button>`;
    
    showModal("ğŸ›’ å•†åº—", content, footer);
}

function bulkBuyItems() {
    const inputs = modalBody.querySelectorAll('input[type="number"]');
    let totalCost = 0;
    const purchase = {};

    inputs.forEach(input => {
        const qty = parseInt(input.value, 10);
        if (qty > 0) {
            const itemName = input.id.replace('shop-', '');
            const price = ITEM_STONE_PRICES[itemName] || 0;
            totalCost += price * qty;
            purchase[itemName] = qty;
        }
    });

    if (totalCost > gameState.stones) {
        alert(`éˆçŸ³ä¸è¶³ï¼éœ€è¦ ${totalCost}ï¼Œæ‚¨åªæœ‰ ${gameState.stones}ã€‚`);
        return;
    }

    if (Object.keys(purchase).length > 0) {
        gameState.stones -= totalCost;
        Object.entries(purchase).forEach(([item, qty]) => {
            gameState.inventory[item] = (gameState.inventory[item] || 0) + qty;
            if (!gameState.inventory_order.includes(item)) {
                gameState.inventory_order.push(item);
                 gameState.inventory_order.sort((a, b) => compareItemNames(a, b));
            }
        });
        saveGameState();
        addTemporaryMessage(`âœ… è³¼è²·æˆåŠŸï¼ŒèŠ±è²» ${totalCost} éˆçŸ³ï¼`, 'msg-shop');
    }
    modal.style.display = "none";
    renderMainMenu();
}

function showUpgradeDialog() {
    const upgradable = Object.keys(UPGRADE_PATHS)
        .filter(item => (gameState.inventory[item] || 0) > 0 && !(gameState.inventory[UPGRADE_PATHS[item]] > 0))
        // ä¾é¡å‹èˆ‡å“éšæ’åº
        .sort((a,b) => compareItemNames(a, b));

    let content = `<p style="text-align:center;"><b>ç•¶å‰éˆçŸ³ï¼š${gameState.stones}</b></p>`;
    if (upgradable.length === 0) {
        content += `<p>æ²’æœ‰å¯å‡ç´šçš„é“å…·ã€‚</p>`;
    } else {
        content += upgradable.map(item => {
            const nextItem = UPGRADE_PATHS[item];
            const cost = ITEM_EFFECTS[item].upgrade_cost || 0;
            // å‡ç´šå°è©±æ¡†ï¼šç‚ºç•¶å‰é“å…·åˆ—åŠ å…¥åˆ†é¡èˆ‡å“éšæ¨£å¼ï¼›åˆ†åˆ¥å°ç•¶å‰é“å…·èˆ‡ä¸‹ä¸€é“å…·åŠ ä¸Šå“éšé¡è‰²
            const catCls = getItemCategoryClass(item);
            const gradeClsCurrent = getItemGradeClass(item);
            const gradeClsNext = getItemGradeClass(nextItem);
            return `<div class="modal-item-row cat-${catCls}">
                <span>å‡ç´š <span class="grade-${gradeClsCurrent}">${item}</span> â†’ <span class="grade-${gradeClsNext}">${nextItem}</span></span>
                <button data-action="upgrade-item" data-current="${item}" data-next="${nextItem}" data-cost="${cost}" ${gameState.stones < cost ? 'disabled' : ''}>${cost} éˆçŸ³</button>
            </div>`;
        }).join('');
    }
    showModal("âœ¨ å“éšå‡ç´š", content, `<button data-action="show-shop">è¿”å›å•†åº—</button>`);
}

function upgradeItem(currentItem, nextItem, cost) {
    if (gameState.stones < cost) {
        alert("éˆçŸ³ä¸è¶³ï¼");
        return;
    }
    gameState.stones -= cost;
    gameState.inventory[nextItem] = (gameState.inventory[nextItem] || 0) + 1;
    // Don't remove old item
    if (!gameState.inventory_order.includes(nextItem)) {
        gameState.inventory_order.push(nextItem);
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }
    saveGameState();
    // æ‰£éˆçŸ³å¾Œç«‹å³æ›´æ–°ä¸»ç•«é¢è³‡è¨Šï¼ˆå°¤å…¶æ˜¯éˆçŸ³é¡¯ç¤ºï¼‰
    if (typeof updateMainMenuInfo === 'function') {
        updateMainMenuInfo();
    }
    alert(`å‡ç´šæˆåŠŸï¼ç²å¾— ${nextItem}`);
    showUpgradeDialog(); // Refresh modal
}

// ===================== éŠæˆ²ä¸­é“å…·ä½¿ç”¨ =====================

function showUseItemDialog() {
    // å–å¾—æ‰€æœ‰å¯ç”¨çš„æˆ°é¬¥é“å…·ï¼ˆå«å…µå™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ï¼‰ä¸¦ä¾é¡å‹èˆ‡å“éšæ’åº
    const allUsableItems = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      .map(([name]) => name)
      .filter(name => {
        const type = ITEM_EFFECTS[name]?.type;
        // åƒ…é™æ­£ç¢ºç­”æ¡ˆã€éŒ¯èª¤ç­”æ¡ˆã€å¤šé¸ã€æ¨™è¨˜éŒ¯èª¤ã€å¢åŠ æ™‚é–“é¡å‹
        return ["correct", "wrong", "multi_choice", "reveal_wrong", "add_time"].includes(type);
      })
      .sort((a, b) => compareItemNames(a, b));
    // å¦‚æœå°šæœªè¨­å®šéæ¿¾å™¨ï¼Œé è¨­ç‚ºå¿«æ·é“å…·ï¼ˆè‹¥æœ‰è¨­å®šï¼‰æˆ–å…µå™¨é¡
    if (!currentItemFilter) {
      if (Array.isArray(gameState.quickItems) && gameState.quickItems.length > 0) {
        currentItemFilter = 'quick';
      } else {
        currentItemFilter = 'weapon';
      }
    }
    // é“å…·åˆ†é¡åˆ—è¡¨
    const filterDefs = [
      { id: 'weapon', label: 'å…µå™¨' },
      { id: 'technique', label: 'åŠŸæ³•' },
      { id: 'formation', label: 'é™£æ³•' },
      { id: 'artifact', label: 'éˆå™¨' },
      { id: 'charm', label: 'éˆç¬¦' },
      { id: 'quick', label: 'å¿«æ·é“å…·' }
    ];
    // å»ºç«‹åˆ†é¡æŒ‰éˆ•åˆ—
    const filterBar = filterDefs.map(f => {
      const isActive = (currentItemFilter === f.id);
      // å¿«æ·é“å…·è‹¥æ²’æœ‰å…§å®¹å‰‡ç¦ç”¨
      const isDisabled = (f.id === 'quick' && (!Array.isArray(gameState.quickItems) || gameState.quickItems.length === 0));
      const activeCls = isActive ? 'active' : '';
      const disableAttr = isDisabled ? 'disabled' : '';
      return `<button data-action="switch-use-item-filter" data-filter="${f.id}" class="btn-filter ${activeCls}" ${disableAttr}>${f.label}</button>`;
    }).join('');
    // æ ¹æ“šç•¶å‰é¸æ“‡éæ¿¾é …ç›®
    let filteredItems;
    if (currentItemFilter === 'quick') {
      // å¿«æ·é“å…·ï¼šåƒ…é¡¯ç¤ºç©å®¶è¨­å®šçš„å¿«æ·é“å…·ä¸”å­˜åœ¨æ–¼èƒŒåŒ…ä¸­
      filteredItems = allUsableItems.filter(name => Array.isArray(gameState.quickItems) && gameState.quickItems.includes(name));
    } else {
      filteredItems = allUsableItems.filter(name => getItemCategoryClass(name) === currentItemFilter);
    }
    let content = '';
    if (!filteredItems || filteredItems.length === 0) {
      content = '<p>æ²’æœ‰å¯ç”¨çš„æˆ°é¬¥é“å…·</p>';
    } else {
      content = filteredItems.map(item => {
        const eff = ITEM_EFFECTS[item];
        const cost = eff.exp_cost || 0;
        let disabled = '';
        let tooltip = '';
        // æ ¹æ“šæ¶ˆè€— EXP åˆ¤æ–·æ˜¯å¦ç¦ç”¨
        if (gameState.exp < cost) {
          disabled = 'disabled';
          tooltip = ` (ä¿®ç…‰ç¶“é©—ä¸è¶³: ${cost})`;
        }
        // å–®æ¬¡é“å…·ä½¿ç”¨é™åˆ¶
        if (['correct', 'wrong', 'multi_choice'].includes(eff.type) && trainingState.hasUsedSingleUseItem) {
          disabled = 'disabled';
          tooltip = ' (æœ¬é¡Œå·²ç”¨éæ­¤é¡é“å…·)';
        }
        // é›£åº¦é™åˆ¶ï¼šæ­£ç¢ºèˆ‡éŒ¯èª¤é¡é“å…·éœ€ç¬¦åˆå“éš
        if (['correct', 'wrong'].includes(eff.type)) {
          const allowedGrade = getGradeByDifficulty(trainingState.difficulty);
          if (!item.startsWith(allowedGrade)) {
            disabled = 'disabled';
            tooltip = ` (æ­¤é›£åº¦éœ€ç”¨ ${allowedGrade} é“å…·)`;
          }
        }
        // åŠ å…¥é“å…·åˆ†é¡èˆ‡å“éšæ¨£å¼
        const catCls = getItemCategoryClass(item);
        const gradeCls = getItemGradeClass(item);
        return `<button data-action="use-item" data-item-name="${item}" class="cat-${catCls}" ${disabled}>
          <span class="grade-${gradeCls}">${item}</span> Ã—${gameState.inventory[item]}
          <br><small>${eff.desc || ''}${cost > 0 ? ` (æ¶ˆè€—${cost} EXP)` : ''}${tooltip}</small>
        </button>`;
      }).join('');
    }
    // çµ„åˆåˆ†é¡æŒ‰éˆ•åˆ—èˆ‡å…§å®¹
    const fullContent = `<div class="item-filter-bar" style="text-align:center; margin-bottom:8px;">${filterBar}</div>` + content;
    showModal('ğŸ’ ä½¿ç”¨é“å…·', fullContent);
}

function useItem(itemName) {
    const eff  = ITEM_EFFECTS[itemName];
    if (!eff) return;
    const cost = eff.exp_cost || 0;
    if (gameState.exp < cost) return;
    if (['correct', 'wrong', 'multi_choice'].includes(eff.type)) {
      if (trainingState.hasUsedSingleUseItem) return;
      trainingState.hasUsedSingleUseItem = true;
    }
    gameState.exp -= cost;
    if (['correct', 'wrong'].includes(eff.type)) {
      gameState.inventory[itemName] = Math.max(0, (gameState.inventory[itemName] || 0) - 1);
    }
    saveGameState();
    // # ç·šä¸Šç‰ˆæ–°å¢ï¼šè¨˜éŒ„æœ¬å±€ä½¿ç”¨éçš„é“å…·åç¨±ï¼ˆå»é‡ç”±å‰ç«¯/é›²ç«¯è‡ªè¡Œè™•ç†ï¼‰
    try {
        if (typeof trainingState !== 'undefined') {
            trainingState.usedItems = trainingState.usedItems || [];
            if (!trainingState.usedItems.includes(itemName)) {
                trainingState.usedItems.push(itemName);
            }
        }
    } catch (e) { /* # ignore */ }

    const fb = document.getElementById('feedback-label');
    let msg = '';
    if (eff.type === 'multi_choice') {
      trainingState.allowedChoices += (eff.n || 1);
      enterMultiChoiceMode();
      msg = `âš”ï¸ å…µå™¨æ•ˆæœï¼šæœ¬é¡Œå¯é¸ç­”æ¡ˆæ•¸å¢åŠ  ${eff.n}ï¼ˆç¸½å…± ${trainingState.allowedChoices} æ¬¡ï¼‰`;
    } else if (eff.type === 'reveal_wrong') {
      const buttons = trainingState.gameGridButtons || [];
      // å–å¾—æ‰€æœ‰å°šæœªæ¨™ç¤ºä¸”ç‚ºéŒ¯èª¤çš„æŒ‰éˆ•
      const wrongButtons = buttons.filter(b => !trainingState.correctAnswers.includes(b.dataset.choice) && !b.classList.contains('hint-wrong'));
      // éš¨æ©Ÿæ‰“äº‚é †åºï¼Œé¿å…å›ºå®šé †åºé¡¯ç¤ºéŒ¯èª¤é¸é …
      const shuffled = wrongButtons.sort(() => Math.random() - 0.5);
      const nReveal = eff.n || 1;
      const toReveal = shuffled.slice(0, nReveal);
      toReveal.forEach(b => b.classList.add('hint-wrong'));
      msg = `ğŸ“œ åŠŸæ³•æ•ˆæœï¼šå·²æ¨™ç¤º ${toReveal.length} å€‹éŒ¯èª¤ç­”æ¡ˆ`;
    } else if (eff.type === 'add_time') {
      // é™£æ³•å¢åŠ ä½œç­”æ™‚é–“åƒ…é™æœ¬é¡Œæœ‰æ•ˆï¼šä¸­é€”å¯ä»¥ç–ŠåŠ ä¸¦å³æ™‚ç”Ÿæ•ˆ
      const inc = eff.n || 0;
      trainingState.roundExtraTime = (trainingState.roundExtraTime || 0) + inc;
      // è‹¥å€’æ•¸æ­£åœ¨è·‘ï¼Œç«‹å³å¢åŠ å‰©é¤˜ç§’æ•¸
      if (typeof trainingState.countdownRemaining === 'number') {
        trainingState.countdownRemaining += inc;
        const label = document.getElementById('countdown-label');
        if (label && trainingState.countdownRemaining >= 0) {
          label.textContent = `ä½œç­”å€’æ•¸ï¼š${trainingState.countdownRemaining} ç§’`;
        }
      }
      msg = `â›©ï¸ é™£æ³•æ•ˆæœï¼šä½œç­”æ™‚é–“å¢åŠ  ${inc} ç§’ï¼ˆåƒ…æœ¬é¡Œï¼‰`;
    } else if (eff.type === 'correct') {
// éˆå™¨ï¼šé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆã€‚n <= 0 è¦–ç‚ºå…¨éƒ¨ï¼Œå¦å‰‡é¡¯ç¤º n å€‹
const buttons = trainingState.gameGridButtons || [];
// æ‰¾å‡ºæ‰€æœ‰å°šæœªæ¨™ç¤ºçš„æ­£ç¢ºæŒ‰éˆ•
const correctButtons = buttons.filter(b =>
  trainingState.correctAnswers.includes(b.dataset.choice) && !b.classList.contains('hint-correct')
);
let toReveal;
if (eff.n <= 0) {
  // n <= 0 è¡¨ç¤ºå…¨éƒ¨äº®é¡¯
  toReveal = correctButtons;
} else {
  // å¦å‰‡åªé¡¯ç¤ºå‰ n å€‹
  toReveal = correctButtons.slice(0, eff.n);
}
// å°‡é¸ä¸­çš„æŒ‰éˆ•æ¨™è¨˜ç‚ºæ­£ç¢º
toReveal.forEach(b => b.classList.add('hint-correct'));
msg = `ğŸª¬ éˆå™¨æ•ˆæœï¼šå·²æ¨™ç¤º ${eff.n <= 0 ? 'å…¨éƒ¨' : toReveal.length} å€‹æ­£ç¢ºç­”æ¡ˆ`;
    } else if (eff.type === 'wrong') {
      const buttons = trainingState.gameGridButtons || [];
      // å–å¾—æ‰€æœ‰å°šæœªæ¨™ç¤ºçš„éŒ¯èª¤æŒ‰éˆ•
      const wrongButtons = buttons.filter(b => !trainingState.correctAnswers.includes(b.dataset.choice) && !b.classList.contains('hint-wrong'));
      // éš¨æ©Ÿæ‰“äº‚é †åºï¼Œä»¥é¿å…å›ºå®šé †åºé¡¯ç¤ºéŒ¯èª¤é¸é …
      const shuffled = wrongButtons.sort(() => Math.random() - 0.5);
      const nReveal = eff.n || 1;
      const toReveal = shuffled.slice(0, nReveal);
      toReveal.forEach(b => b.classList.add('hint-wrong'));
      msg = `ğŸ§¿ éˆç¬¦æ•ˆæœï¼šå·²æ’é™¤ ${toReveal.length} å€‹éŒ¯èª¤ç­”æ¡ˆ`;
    }
    // === æ›´æ–°å¤©å‘½æŒ‘æˆ°çš„é“å…·ä½¿ç”¨é€²åº¦ ===
    try {
        if (typeof updateHeavenChallengeProgressItemUse === 'function') {
            let typeMapping = null;
            switch (eff.type) {
                case 'multi_choice':
                    typeMapping = 'weapon';
                    break;
                case 'reveal_wrong':
                    typeMapping = 'technique';
                    break;
                case 'add_time':
                    typeMapping = 'formation';
                    break;
                case 'correct':
                    typeMapping = 'artifact';
                    break;
                case 'wrong':
                    typeMapping = 'charm';
                    break;
                // EXP é¡ä»£è¡¨ä»™ä¸¹ï¼Œå°æ‡‰ elixir ä»»å‹™
                case 'exp':
                    typeMapping = 'elixir';
                    break;
                default:
                    typeMapping = null;
            }
            if (typeMapping) {
                updateHeavenChallengeProgressItemUse(typeMapping, 1);
            }
        }
    } catch (e) { /* ignore */ }
    if (fb) { fb.textContent = msg; fb.className = "feedback info"; }
    modal.style.display = 'none';
}

// Stubs for unimplemented modal functions
function useExpItems() { showUseExpDialog(); }
function deleteItems() { showDeleteItemsDialog(); }
function showSellDialog() {
  const sellable = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && ITEM_STONE_PRICES[name] !== undefined)
    // ä¾é¡å‹èˆ‡å“éšæ’åº
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (sellable.length === 0) {
    content = '<p>èƒŒåŒ…ä¸­æ²’æœ‰å¯è²©è³£çš„é“å…·ã€‚</p>';
  } else {
    content = sellable.map(([name, qty]) => {
      const sellPriceSingle = Math.floor((ITEM_STONE_PRICES[name] || 0) / 2);
      // åŠ å…¥åˆ†é¡åŠå“éšæ¨£å¼ï¼šåº•è‰²ä¾åˆ†é¡ã€æ–‡å­—é¡è‰²ä¾å“éš
      const catCls = getItemCategoryClass(name);
      const gradeCls = getItemGradeClass(name);
      return `
        <div class="modal-item-row cat-${catCls}">
          <label for="sell-${name}"><span class="grade-${gradeCls}">${name}</span>ï¼ˆæŒæœ‰ ${qty}ï¼‰ - è³£åƒ¹: ${sellPriceSingle} éˆçŸ³/å€‹</label>
          <input type="number" id="sell-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
    content += `<p id="sell-total" style="margin-top:10px;text-align:center;">é è¨ˆå¯ç²å¾—ï¼š0 éˆçŸ³</p>`;
  }
  const footer = `<button data-action="confirm-sell-items">ç¢ºèªè²©è³£</button>`;
  showModal("ğŸ’° è²©è³£é“å…·", content, footer);
  // attach update for predicted sell value
  setTimeout(() => {
    const totalLabel = document.getElementById('sell-total');
    function updateTotal() {
      let totalBuyValue = 0;
      sellable.forEach(([name]) => {
        const input = modalBody.querySelector(`#sell-${name}`);
        if (input) {
          const count = parseInt(input.value || '0', 10);
          if (count > 0) {
            const price = ITEM_STONE_PRICES[name] || 0;
            totalBuyValue += price * count;
          }
        }
      });
      const sellValue = Math.floor(totalBuyValue / 2);
      if (totalLabel) {
        totalLabel.textContent = `é è¨ˆå¯ç²å¾—ï¼š${sellValue} éˆçŸ³`;
      }
    }
    sellable.forEach(([name]) => {
      const input = modalBody.querySelector(`#sell-${name}`);
      if (input) {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
      }
    });
    updateTotal();
  }, 0);
}

function confirmSellItems() {
  const toSell = [];
  let totalBuyValue = 0;
  Object.entries(gameState.inventory).forEach(([name, qty]) => {
    const input = modalBody.querySelector(`#sell-${name}`);
    if (input) {
      const count = Math.max(0, parseInt(input.value || '0', 10));
      if (count > 0) {
        toSell.push({name: name, qty: count});
        totalBuyValue += (ITEM_STONE_PRICES[name] || 0) * count;
      }
    }
  });
  if (toSell.length === 0) {
    showModal("ğŸ’° è²©è³£çµæœ", "<p>æœªè²©è³£ä»»ä½•é“å…·</p>", `<button data-action="close-modal">é—œé–‰</button>`);
    return;
  }
  const sellValue = Math.floor(totalBuyValue / 2);
  toSell.forEach(item => {
    gameState.inventory[item.name] = Math.max(0, (gameState.inventory[item.name] || 0) - item.qty);
  });
  gameState.stones += sellValue;
  saveGameState();
  const soldItemsDesc = toSell.map(item => `${item.name} Ã—${item.qty}`);
  showModal("ğŸ’° è²©è³£çµæœ", `<p>å·²è²©è³£ï¼š${soldItemsDesc.join('ã€')}</p><p>ç²å¾— ${sellValue} éˆçŸ³</p>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

// === å¿«æ·é“å…·è¨­å®š ===
function showQuickItemsManager() {
  // å–å‡ºèƒŒåŒ…ä¸­å¯ç”¨æ–¼å¿«æ·æ¬„çš„é“å…·ï¼ˆæ­¦å™¨ã€åŠŸæ³•ã€é™£æ³•ã€éˆå™¨ã€éˆç¬¦ï¼‰ï¼ŒæŒ‰é¡å‹èˆ‡å“éšæ’åº
  const items = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0)
    .filter(([name]) => {
      const cat = getItemCategoryClass(name);
      return ['weapon','technique','formation','artifact','charm'].includes(cat);
    })
    .sort(([a],[b]) => compareItemNames(a,b));
  let content = '';
  if (items.length === 0) {
    content = '<p>æ²’æœ‰å¯åŠ å…¥å¿«æ·é“å…·çš„é …ç›®ã€‚</p>';
  } else {
    content = '<form id="quick-items-form">' + items.map(([name, qty]) => {
      const catCls = getItemCategoryClass(name);
      const gradeCls = getItemGradeClass(name);
      const checked = (Array.isArray(gameState.quickItems) && gameState.quickItems.includes(name)) ? 'checked' : '';
      return `<div class="modal-item-row cat-${catCls}">
        <label><input type="checkbox" name="quickitem" value="${name}" ${checked}/> <span class="grade-${gradeCls}">${name}</span>ï¼ˆæŒæœ‰ ${qty}ï¼‰</label>
      </div>`;
    }).join('') + '</form>';
  }
  const footer = `<button data-action="confirm-set-quick-items">ç¢ºèªè¨­å®š</button>`;
  showModal('âš¡ å¿«æ·é“å…·è¨­å®š', content, footer);
}

function confirmSetQuickItems() {
  // è®€å–è¡¨å–®ä¸­çš„å‹¾é¸é …ç›®ä¸¦æ›´æ–° gameState.quickItems
  const form = modalBody.querySelector('#quick-items-form');
  if (!form) {
    modal.style.display = 'none';
    return;
  }
  const selected = [];
  form.querySelectorAll('input[name="quickitem"]').forEach(cb => {
    if (cb.checked) selected.push(cb.value);
  });
  gameState.quickItems = selected;
  saveGameState();
  showModal('âš¡ å¿«æ·é“å…·è¨­å®š', `<p>å·²è¨­å®š ${selected.length} å€‹å¿«æ·é“å…·ã€‚</p>`, `<button data-action="close-modal">é—œé–‰</button>`);
}

// ===================== æ¯æ—¥ç°½åˆ°èˆ‡æ¯æ—¥ä»»å‹™ç³»çµ± =====================

// å–å¾—äºæ´²å°åŒ—æ™‚å€çš„ä»Šæ—¥æ—¥æœŸå­—ä¸²ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
function getTodayDateStr() {
    try {
        const now = new Date();
        const tzDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
        const y = tzDate.getFullYear();
        const m = String(tzDate.getMonth() + 1).padStart(2, '0');
        const d = String(tzDate.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    } catch (e) {
        // fallback: ä½¿ç”¨æœ¬åœ°æ™‚é–“
        return new Date().toISOString().slice(0, 10);
    }
}

// åˆå§‹åŒ–æ¯æ—¥ä»»å‹™ï¼šè‹¥ç•¶å¤©å°šæœªç”Ÿæˆä»»å‹™æˆ–ä»»å‹™æ—¥æœŸå·²éï¼Œå¾æ¨¡æ¿ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å€‹ä»»å‹™
function initDailyTask() {
    const todayStr = getTodayDateStr();
    if (!gameState.dailyTask || gameState.dailyTask.date !== todayStr) {
        // å¾ä»»å‹™æ¨¡æ¿ä¸­éš¨æ©Ÿé¸æ“‡ä¸€é …
        const tpl = DAILY_TASK_TEMPLATES[Math.floor(Math.random() * DAILY_TASK_TEMPLATES.length)];
        gameState.dailyTask = {
            date: todayStr,
            type: tpl.type,
            difficulty: tpl.difficulty,
            target: tpl.target,
            progress: 0,
            accepted: false,
            completed: false,
            claimed: false
        };
        // é‡ç½®é€£çºŒä»»å‹™æ¥å—ç‹€æ…‹
        saveGameState();
    }
}

// è™•ç†æ¯æ—¥ç°½åˆ°ï¼šæª¢æŸ¥æ˜¯å¦å·²ç°½åˆ°ï¼Œä¸¦ç™¼æ”¾çå‹µ
function handleDailySignIn() {
    const todayStr = getTodayDateStr();
    // è‹¥ä»Šæ—¥å·²ç°½åˆ°
    if (gameState.signInLastDate === todayStr) {
        showModal('ğŸ“… æ¯æ—¥ç°½åˆ°', '<p>ä½ ä»Šå¤©å·²ç¶“ç°½åˆ°ï¼Œæ˜å¤©å†ä¾†å§ï¼</p>', '<button data-action="close-modal">é—œé–‰</button>');
        return;
    }
    // è¨ˆç®—é€£çºŒç°½åˆ°å¤©æ•¸ï¼šè‹¥å‰ä¸€ç°½åˆ°æ—¥æœŸæ˜¯æ˜¨å¤©ï¼Œå‰‡é€£çºŒå¤©æ•¸+1ï¼›å¦å‰‡é‡ç½®ç‚º1
    const yesterday = new Date(new Date(todayStr).getTime() - 86400000);
    const yStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;
    let streak = 1;
    if (gameState.signInLastDate === yStr) {
        streak = (gameState.signInStreak || 0) + 1;
    }
    gameState.signInStreak = streak;
    gameState.signInLastDate = todayStr;
    // ç´€éŒ„ç°½åˆ°æ—¥æœŸåˆ°ç°½åˆ°æ­·å²ä¸­
    if (!Array.isArray(gameState.signInHistory)) {
        gameState.signInHistory = [];
    }
    if (!gameState.signInHistory.includes(todayStr)) {
        gameState.signInHistory.push(todayStr);
    }
    // æ ¹æ“šä¿®ç‚ºéšå±¤è¨ˆç®—åŸºç¤çå‹µï¼šéšå±¤è¶Šé«˜åŸºç¤å€¼è¶Šå¤§
    const stageIdx = getStageIndex(gameState.exp);
    let baseExp = 50 * (stageIdx + 1);
    // ç°½åˆ°é€£çºŒå¤©æ•¸è¶Šå¤šï¼Œçå‹µå€ç‡è¶Šé«˜
    const expReward = Math.floor(baseExp * (1 + 0.1 * streak) + Math.random() * baseExp * 0.5);
    const stonesReward = 2 + Math.floor(streak / 2);
    gameState.exp += expReward;
    gameState.stones += stonesReward;
    saveGameState();
    // è¨Šæ¯å…§å®¹
    const msg = `<p>âœ… ç°½åˆ°æˆåŠŸï¼å·²é€£çºŒç°½åˆ° ${streak} å¤©ã€‚</p><p>ç²å¾— ${expReward} ä¿®ç…‰ç¶“é©—èˆ‡ ${stonesReward} éˆçŸ³ï¼</p>`;
    showModal('ğŸ“… ç°½åˆ°çå‹µ', msg, '<button data-action="close-modal">é—œé–‰</button>');
    // æ›´æ–°ä¸»ç•«é¢è³‡è¨Š
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch (e) {}
    }
}

// é¡¯ç¤ºæ¯æ—¥ä»»å‹™å°è©±æ¡†
function showDailyTask() {
    initDailyTask();
    const task = gameState.dailyTask || {};
    // ä»»å‹™æè¿°
    let desc = '';
    if (task.type === 'training') {
        // éœ€è¦å‹ç‡é–€æª»é”æ¨™
        const reqRate = DIFFICULTY_WIN_RATE[task.difficulty] || 0;
        desc = `å®Œæˆæ™®é€šè¨“ç·´é›£åº¦ ${task.difficulty}ï¼ˆåˆ†æ•¸ â‰¥ ${reqRate}%ï¼‰${task.target} æ¬¡`;
    } else if (task.type === 'secretTrial') {
        const threshold = TRIAL_TRAINING_REQUIREMENTS[task.difficulty] || 1;
        desc = `å®Œæˆç§˜å¢ƒè©¦ç…‰é›£åº¦ ${task.difficulty}ï¼ˆè‡³å°‘ç­”å° ${threshold} é¡Œï¼‰${task.target} æ¬¡`;
    } else {
        desc = 'ä»Šæ—¥æ²’æœ‰ä»»å‹™ã€‚';
    }
    let body = `<p>ğŸ¯ ä»Šæ—¥ä»»å‹™ï¼š${desc}</p>`;
    // æ ¹æ“šä»»å‹™æ¥å—èˆ‡å®Œæˆç‹€æ…‹æ±ºå®šé¡¯ç¤ºå…§å®¹
    if (!task.accepted) {
        body += '<p>æ˜¯å¦æ¥å—é€™é …ä»»å‹™ï¼Ÿ</p>';
        const footer = `<button data-action="accept-daily-task">æ¥å—ä»»å‹™</button><button data-action="close-modal">é—œé–‰</button>`;
        showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', body, footer);
    } else {
        body += `<p>é€²åº¦ï¼š${task.progress || 0}/${task.target}</p>`;
        if (task.completed) {
            if (task.claimed) {
                body += '<p>ğŸ‰ ä»»å‹™å®Œæˆä¸”çå‹µå·²é ˜å–ï¼</p>';
                showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', body, '<button data-action="close-modal">é—œé–‰</button>');
            } else {
                body += '<p>ğŸ‰ ä»»å‹™å®Œæˆï¼è«‹é ˜å–çå‹µã€‚</p>';
                showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', body, '<button data-action="claim-daily-task">é ˜å–çå‹µ</button>');
            }
        } else {
            showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', body, '<button data-action="close-modal">é—œé–‰</button>');
        }
    }
}

// æ¥å—æ¯æ—¥ä»»å‹™
function acceptDailyTask() {
    initDailyTask();
    const task = gameState.dailyTask;
    if (!task) {
        showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', '<p>ä»Šæ—¥æ²’æœ‰ä»»å‹™å¯ä»¥æ¥å—ã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
        return;
    }
    if (task.accepted) {
        showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', '<p>ä½ å·²æ¥å—ä»Šæ—¥ä»»å‹™ï¼Œè«‹å®Œæˆå¾Œå†ä¾†ã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
        return;
    }
    task.accepted = true;
    task.progress = 0;
    task.completed = false;
    task.claimed = false;
    saveGameState();
    showModal('ğŸ—’ï¸ æ¯æ—¥ä»»å‹™', '<p>å·²æ¥å—ä»»å‹™ï¼ŒåŠ æ²¹ï¼</p>', '<button data-action="close-modal">é—œé–‰</button>');
}

// é ˜å–æ¯æ—¥ä»»å‹™çå‹µ
function claimDailyTaskReward() {
    initDailyTask();
    const task = gameState.dailyTask;
    if (!task || !task.completed) {
        showModal('ğŸ—’ï¸ ä»»å‹™çå‹µ', '<p>ä»»å‹™å°šæœªå®Œæˆï¼Œç„¡æ³•é ˜å–çå‹µã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
        return;
    }
    if (task.claimed) {
        showModal('ğŸ—’ï¸ ä»»å‹™çå‹µ', '<p>çå‹µå·²é ˜å–ã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
        return;
    }
    // æ ¹æ“šä»»å‹™é›£åº¦èˆ‡ç›®æ¨™çµ¦äºˆçå‹µï¼šé›£åº¦è¶Šé«˜èˆ‡ç›®æ¨™æ¬¡æ•¸è¶Šå¤šçå‹µè¶Šå¤§
    const baseExp = 200 * task.difficulty * task.target;
    const randExp = Math.floor(Math.random() * baseExp * 2);
    const expReward = baseExp + randExp;
    const stonesReward = 50 * task.difficulty;
    gameState.exp += expReward;
    gameState.stones += stonesReward;
    task.claimed = true;
    saveGameState();
    const msg = `<p>ğŸ ä»»å‹™å®Œæˆï¼ç²å¾— ${expReward} EXP èˆ‡ ${stonesReward} éˆçŸ³ã€‚</p>`;
    showModal('ğŸ—’ï¸ ä»»å‹™çå‹µ', msg, '<button data-action="close-modal">é—œé–‰</button>');
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch (e) {}
    }
}

// æ›´æ–°æ¯æ—¥ä»»å‹™é€²åº¦ï¼ˆæ™®é€šè¨“ç·´ï¼‰ï¼šisPass ç‚ºæ˜¯å¦é”åˆ°è©²é›£åº¦å‹ç‡é–€æª»
function updateDailyTaskProgressTraining(isPass, difficulty) {
    const task = gameState.dailyTask;
    if (!task || !task.accepted || task.completed) return;
    if (task.type !== 'training') return;
    if (task.difficulty !== difficulty) return;
    if (!isPass) return;
    task.progress = (task.progress || 0) + 1;
    if (task.progress >= task.target) {
        task.completed = true;
    }
    saveGameState();
}

// æ›´æ–°æ¯æ—¥ä»»å‹™é€²åº¦ï¼ˆç§˜å¢ƒè©¦ç…‰ï¼‰ï¼šæ ¹æ“šç­”å°é¡Œæ•¸åˆ¤æ–·æ˜¯å¦é”æ¨™
function updateDailyTaskProgressTrial(correctCount, difficulty) {
    const task = gameState.dailyTask;
    if (!task || !task.accepted || task.completed) return;
    if (task.type !== 'secretTrial') return;
    if (task.difficulty !== difficulty) return;
    const threshold = TRIAL_TRAINING_REQUIREMENTS[difficulty] !== undefined ? TRIAL_TRAINING_REQUIREMENTS[difficulty] : 1;
    if (correctCount < threshold) return;
    task.progress = (task.progress || 0) + 1;
    if (task.progress >= task.target) {
        task.completed = true;
    }
    saveGameState();
}

// é¡¯ç¤ºç°½åˆ°æ—¥æ›†ï¼šç”¢ç”Ÿç•¶æœˆæ—¥æ›†è¡¨ï¼Œæ¨™ç¤ºå·²ç°½åˆ°çš„æ—¥æœŸåŠä»Šå¤©
function showSignInCalendar() {
    try {
        // å–å¾—å°åŒ—æ™‚å€çš„å¹´ã€æœˆ
        const now = new Date();
        const tzDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
        const year = tzDate.getFullYear();
        const month = tzDate.getMonth(); // 0-based
        // ç•¶æœˆå¤©æ•¸
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        // é¦–æ—¥æ˜ŸæœŸå¹¾ï¼ˆ0=é€±æ—¥ï¼‰
        const firstDay = new Date(year, month, 1).getDay();
        // ä»Šæ—¥æ—¥æœŸå­—ä¸²
        const todayStr = getTodayDateStr();
        // ç”¢ç”Ÿè¡¨é ­
        let table = '<table class="calendar-table"><thead><tr>';
        const weekLabels = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        weekLabels.forEach(w => { table += '<th>' + w + '</th>'; });
        table += '</tr></thead><tbody>';
        let day = 1;
        // ç”¢ç”Ÿæœ€å¤š 6 è¡Œçš„æ—¥æ›†
        for (let i = 0; i < 6 && day <= daysInMonth; i++) {
            table += '<tr>';
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < firstDay || day > daysInMonth) {
                    table += '<td></td>';
                } else {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    let cls = '';
                    if (Array.isArray(gameState.signInHistory) && gameState.signInHistory.includes(dateStr)) {
                        cls += ' calendar-cell-signed';
                    }
                    if (dateStr === todayStr) {
                        cls += ' calendar-cell-today';
                    }
                    table += `<td class="${cls.trim()}">${day}</td>`;
                    day++;
                }
            }
            table += '</tr>';
        }
        table += '</tbody></table>';
        const content = `<p>ç•¶å‰æœˆä»½ï¼š${year}å¹´${month + 1}æœˆ</p>` + table;
        showModal('ğŸ“… ç°½åˆ°æ—¥æ›†', content, '<button data-action="close-modal">é—œé–‰</button>');
    } catch (e) {
        console.warn('é¡¯ç¤ºç°½åˆ°æ—¥æ›†å¤±æ•—', e);
        showModal('ğŸ“… ç°½åˆ°æ—¥æ›†', '<p>ç„¡æ³•é¡¯ç¤ºç°½åˆ°æ—¥æ›†ã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
    }
}

// ===================== å¤©å‘½æŒ‘æˆ°ç³»çµ± =====================
// éš¨æ©Ÿä»»å‹™åç¨±ï¼šå¤©å‘½æŒ‘æˆ°
// ç”¨æ–¼æ¯æ—¥ç”¢ç”Ÿæ•¸å€‹éš¨æ©ŸæŒ‘æˆ°ä»»å‹™ï¼Œç©å®¶å¯é¸æ“‡æ¥å—ï¼Œå®Œæˆå¾Œé ˜å–çå‹µã€‚

// åˆå§‹åŒ–å¤©å‘½æŒ‘æˆ°ï¼šè‹¥ç•¶æ—¥æœªç”Ÿæˆï¼Œå‰‡æ ¹æ“šè¦å‰‡ç”Ÿæˆæ–°çš„æŒ‘æˆ°ä»»å‹™
function initHeavenChallenges() {
    try {
        const today = getTodayDateStr();
        // è‹¥ä»Šæ—¥å°šæœªç”¢ç”Ÿä»»å‹™æˆ–æ—¥æœŸä¸åŒï¼Œé‡æ–°ç”Ÿæˆ
        if (!gameState.heavenChallengeDate || gameState.heavenChallengeDate !== today || !Array.isArray(gameState.heavenChallenges) || gameState.heavenChallenges.length === 0) {
            // æ¯æ—¥é‡æ–°ç”Ÿæˆä¸€æ‰¹ä»»å‹™
            gameState.heavenChallenges = generateRandomHeavenTasks();
            gameState.heavenChallengeDate = today;
            saveGameState();
        }
        // æ¯æ¬¡åˆå§‹åŒ–æ™‚é€²è¡Œæ¸…ç†ï¼Œè™•ç†å†·å»èˆ‡éæœŸä¸¦è£œå……ç¼ºå£
        cleanupHeavenChallenges();
    } catch (e) {
        console.warn('åˆå§‹åŒ–å¤©å‘½æŒ‘æˆ°å¤±æ•—', e);
    }
}

// ç”¢ç”Ÿéš¨æ©Ÿçš„å¤©å‘½æŒ‘æˆ°ä»»å‹™åˆ—è¡¨
// å–å¾—å¤©å‘½æŒ‘æˆ°çå‹µå€æ•¸ï¼šä¾æ“šä»»å‹™æœŸé™å¤©æ•¸ï¼Œå›å‚³å°æ‡‰å€ç‡ã€‚
function getHeavenRewardMultiplier(durationDays) {
    // æ¡ç”¨ç­‰æ¯”ç´šæ•¸ï¼šæœŸé™è¶Šé•·ï¼Œå€ç‡è¶Šé«˜ã€‚è‡ªè¨‚å¸¸æ•¸ï¼š0 å¤© = 100, 1 å¤© = 200, 3 å¤© = 400, 5 å¤© = 800
    switch (durationDays) {
        case 1: return 200;
        case 3: return 400;
        case 5: return 800;
        default: return 100;
    }
}

// éš¨æ©Ÿç”¢ç”Ÿå–®ä¸€å¤©å‘½æŒ‘æˆ°ä»»å‹™
function generateHeavenTask(type) {
    // è¼”åŠ©äº‚æ•¸å‡½å¼
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    // éš¨æ©ŸæœŸé™ï¼š0ã€1ã€3ã€5 å¤©
    const durations = [0, 1, 3, 5];
    const durationDays = durations[randInt(0, durations.length - 1)];
    const now = Date.now();
    const expireAt = durationDays > 0 ? now + durationDays * 24 * 60 * 60 * 1000 : null;
    const multiplier = getHeavenRewardMultiplier(durationDays);
    // æ ¹æ“šé¡å‹ç”¢ç”Ÿä¸åŒä»»å‹™
    if (type === 'training') {
        // å¯é¸å­é¡ï¼šsessionsã€correctã€streak
        const subTypes = ['sessions', 'correct', 'streak'];
        const subType = subTypes[randInt(0, subTypes.length - 1)];
        const difficulty = randInt(1, 5);
        if (subType === 'sessions') {
            const targetSessions = [5, 10, 15, 20][randInt(0, 3)];
            const winRate = [50, 60, 70][randInt(0, 2)];
            const baseExp = targetSessions * difficulty;
            const baseStones = Math.max(1, Math.floor(targetSessions / 5));
            return {
                id: 'training_sessions_' + Date.now() + '_' + Math.random(),
                type: 'training', subType: 'sessions', difficulty: difficulty,
                targetSessions: targetSessions, winRate: winRate,
                progress: { sessions: 0 }, accepted: false, completed: false, claimed: false,
                reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
                description: `å®Œæˆæ™®é€šè¨“ç·´é›£åº¦ ${difficulty} ${targetSessions} æ¬¡ä¸¦é”åˆ°å‹ç‡ ${winRate}% ä»¥ä¸Š`,
                durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
            };
        } else if (subType === 'correct') {
            const targetCorrect = [20, 30, 40, 50][randInt(0, 3)];
            const baseExp = targetCorrect; // æ¯é¡Œå°æ‡‰ 1 ç¶“é©—
            const baseStones = Math.max(1, Math.floor(targetCorrect / 10));
            return {
                id: 'training_correct_' + Date.now() + '_' + Math.random(),
                type: 'training', subType: 'correct', difficulty: difficulty,
                targetCorrect: targetCorrect,
                progress: { correct: 0 }, accepted: false, completed: false, claimed: false,
                reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
                description: `æ–¼æ™®é€šè¨“ç·´é›£åº¦ ${difficulty} ç´¯ç©æ­£ç¢ºå›ç­” ${targetCorrect} é¡Œ`,
                durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
            };
        } else {
            // streak ä»»å‹™
            const targetStreak = [5, 7, 10][randInt(0, 2)];
            const winRate = [50, 60, 70][randInt(0, 2)];
            const baseExp = targetStreak * difficulty * 2;
            const baseStones = Math.max(1, Math.floor(targetStreak / 2));
            return {
                id: 'training_streak_' + Date.now() + '_' + Math.random(),
                type: 'training', subType: 'streak', difficulty: difficulty,
                targetStreak: targetStreak, winRate: winRate,
                progress: { streak: 0 }, accepted: false, completed: false, claimed: false,
                reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
                description: `é€£çºŒæˆåŠŸå®Œæˆé›£åº¦ ${difficulty} è¨“ç·´ ${targetStreak} æ¬¡ä¸¦é”åˆ°å‹ç‡ ${winRate}% ä»¥ä¸Š`,
                durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
            };
        }
    } else if (type === 'trial') {
        const difficulty = randInt(1, 5);
        const targetSessions = [2, 3, 4, 5][randInt(0, 3)];
        // ä½¿ç”¨å…¨å±€ç§˜å¢ƒè¨“ç·´é–¾å€¼è¡¨ä»¥æ±ºå®šæ¯æ¬¡è‡³å°‘ç­”å°å¹¾é¡Œ
        const threshold = (TRIAL_TRAINING_REQUIREMENTS && TRIAL_TRAINING_REQUIREMENTS[difficulty] !== undefined) ? TRIAL_TRAINING_REQUIREMENTS[difficulty] : 1;
        const baseExp = targetSessions * (difficulty + 1);
        const baseStones = Math.max(1, targetSessions);
        return {
            id: 'trial_sessions_' + Date.now() + '_' + Math.random(),
            type: 'trial', subType: 'sessions', difficulty: difficulty,
            targetSessions: targetSessions, correctThreshold: threshold,
            progress: { sessions: 0 }, accepted: false, completed: false, claimed: false,
            reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
            description: `æŒ‘æˆ°ç§˜å¢ƒè©¦ç…‰é›£åº¦ ${difficulty} ä¸¦è‡³å°‘ç­”å° ${threshold} é¡Œ ${targetSessions} æ¬¡`,
            durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
        };
    } else if (type === 'item') {
        // å¯ä½¿ç”¨çš„é“å…·é¡å‹åˆ—è¡¨
        const itemTypes = ['weapon', 'charm', 'technique', 'formation', 'artifact', 'elixir'];
        const itemType = itemTypes[randInt(0, itemTypes.length - 1)];
        const labelMap = {
            weapon: 'å…µå™¨é¡é“å…·', charm: 'éˆç¬¦é¡é“å…·',
            technique: 'åŠŸæ³•é¡é“å…·', formation: 'é™£æ³•é¡é“å…·',
            artifact: 'éˆå™¨é¡é“å…·', elixir: 'ä»™ä¸¹é¡é“å…·'
        };
        const targetUses = [3, 5, 8, 10, 15][randInt(0, 4)];
        const baseExp = targetUses * 2;
        const baseStones = Math.max(1, Math.floor(targetUses / 2));
        return {
            id: 'item_usage_' + itemType + '_' + Date.now() + '_' + Math.random(),
            type: 'item', itemType: itemType,
            targetItemUse: targetUses,
            progress: { uses: 0 }, accepted: false, completed: false, claimed: false,
            reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
            description: `åœ¨ä»»å‹™æœŸé–“å…§ä½¿ç”¨ ${labelMap[itemType]} ${targetUses} æ¬¡`,
            durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
        };
    } else if (type === 'achievement') {
        // å¯é¸å­é¡ï¼šexp æˆ– streak
        const subTypes = ['exp', 'streak'];
        const subType = subTypes[randInt(0, subTypes.length - 1)];
        if (subType === 'exp') {
            const targetExp = [3000, 5000, 7000, 10000][randInt(0, 3)];
            const baseStones = Math.max(1, Math.floor(targetExp / 1000));
            return {
                id: 'achievement_exp_' + Date.now() + '_' + Math.random(),
                type: 'achievement', subType: 'exp',
                targetExp: targetExp,
                progress: { exp: 0 }, accepted: false, completed: false, claimed: false,
                reward: { exp: 0, stones: Math.floor(baseStones * multiplier) },
                description: `ç´¯ç©ç²å¾— ${targetExp} ä¿®ç…‰ç¶“é©—`,
                durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
            };
        } else {
            // achievement streak ä»»å‹™
            const difficulty = randInt(1, 5);
            const targetStreak = [5, 7, 10][randInt(0, 2)];
            const winRate = [50, 60, 70][randInt(0, 2)];
            const baseExp = targetStreak * difficulty * 2;
            const baseStones = Math.max(1, Math.floor(targetStreak / 2));
            return {
                id: 'achievement_streak_' + Date.now() + '_' + Math.random(),
                type: 'achievement', subType: 'streak', difficulty: difficulty,
                targetStreak: targetStreak, winRate: winRate,
                progress: { streak: 0 }, accepted: false, completed: false, claimed: false,
                reward: { exp: Math.floor(baseExp * multiplier), stones: Math.floor(baseStones * multiplier) },
                description: `é€£çºŒæˆåŠŸå®Œæˆé›£åº¦ ${difficulty} è¨“ç·´ ${targetStreak} æ¬¡ä¸¦é”åˆ°å‹ç‡ ${winRate}% ä»¥ä¸Š`,
                durationDays: durationDays, expireAt: expireAt, cooldownUntil: null
            };
        }
    }
    // é è¨­å‚³å›ç©ºä»»å‹™ï¼ˆä¸æ‡‰ç™¼ç”Ÿï¼‰
    return {
        id: 'invalid_' + Date.now() + '_' + Math.random(), type: type, subType: '',
        progress: {}, accepted: false, completed: false, claimed: false,
        reward: { exp: 0, stones: 0 }, description: 'ç„¡æ•ˆä»»å‹™', durationDays: 0, expireAt: null, cooldownUntil: null
    };
}

// ç”¢ç”Ÿéš¨æ©Ÿçš„å¤©å‘½æŒ‘æˆ°ä»»å‹™åˆ—è¡¨ï¼ˆæ¯ç¨®é¡å‹å„ 10 é …ï¼‰
function generateRandomHeavenTasks() {
    const tasks = [];
    const types = ['training', 'trial', 'item', 'achievement'];
    types.forEach((t) => {
        for (let i = 0; i < 10; i++) {
            tasks.push(generateHeavenTask(t));
        }
    });
    return tasks;
}

// æ¸…ç†å¤©å‘½æŒ‘æˆ°ä»»å‹™ï¼š
// - ç§»é™¤æˆ–æ›¿æ›å·²éæœŸä»»å‹™
// - è™•ç†å†·å»ä»»å‹™ï¼šè‹¥å†·å»æ™‚é–“å·²åˆ°ï¼Œç”¢ç”Ÿæ–°çš„ä»»å‹™
// - ç¢ºä¿æ¯ç¨®é¡å‹å‡ç¶­æŒ 10 å€‹ä»»å‹™
function cleanupHeavenChallenges() {
    try {
        const now = Date.now();
        if (!Array.isArray(gameState.heavenChallenges)) {
            gameState.heavenChallenges = [];
        }
        // è™•ç†æ¯å€‹ä»»å‹™
        for (let i = 0; i < gameState.heavenChallenges.length; i++) {
            const task = gameState.heavenChallenges[i];
            // å†·å»çµæŸï¼šæ›¿æ›ç‚ºæ–°ä»»å‹™ï¼ˆä¿æŒåŸé¡å‹ï¼‰
            if (task && task.cooldownUntil && now >= task.cooldownUntil) {
                gameState.heavenChallenges[i] = generateHeavenTask(task.type);
            }
            // éæœŸä»»å‹™ï¼šè‹¥è¨­æœ‰æœŸé™ä¸”å·²éæœŸï¼Œä¸”å°šæœªé ˜çï¼Œå‰‡ç›´æ¥æ›¿æ›ç‚ºæ–°ä»»å‹™
            const expired = task && task.expireAt && now >= task.expireAt;
            if (task && expired) {
                gameState.heavenChallenges[i] = generateHeavenTask(task.type);
            }
        }
        // ç¢ºä¿æ¯é¡å‹ä»»å‹™è‡³å°‘ 10 å€‹
        const counts = { training: 0, trial: 0, item: 0, achievement: 0 };
        gameState.heavenChallenges.forEach((t) => {
            if (t && t.type && counts.hasOwnProperty(t.type)) counts[t.type]++;
        });
        ['training','trial','item','achievement'].forEach((tp) => {
            while (counts[tp] < 10) {
                gameState.heavenChallenges.push(generateHeavenTask(tp));
                counts[tp]++;
            }
        });
        // è‹¥æœ‰å¤šé¤˜ä»»å‹™ï¼Œä¹Ÿä¸åšç§»é™¤ï¼Œåªç¶­æŒç”Ÿæˆã€‚å¯ä¾éœ€è¦è£å‰ªã€‚
        saveGameState();
    } catch (e) {
        console.warn('æ¸…ç†å¤©å‘½æŒ‘æˆ°ä»»å‹™å¤±æ•—', e);
    }
}

// æ›¿æ›å–®ä¸€å¤©å‘½æŒ‘æˆ°ä»»å‹™ç‚ºæ–°ä»»å‹™ï¼ˆä¿æŒåŸé¡å‹ï¼‰
function replaceHeavenTask(index) {
    try {
        const tasks = gameState.heavenChallenges || [];
        if (index < 0 || index >= tasks.length) return;
        const oldTask = tasks[index];
        const type = (oldTask && oldTask.type) || 'training';
        tasks[index] = generateHeavenTask(type);
        saveGameState();
    } catch (e) {
        console.warn('æ›¿æ›å¤©å‘½æŒ‘æˆ°ä»»å‹™å¤±æ•—', e);
    }
}

// åˆ·æ–°å¤©å‘½æŒ‘æˆ°ä»»å‹™ï¼šå°‡è©²ä»»å‹™è¨­ç½®ç‚ºå†·å»ç‹€æ…‹ä¸¦é‡ç½®é€²åº¦ï¼Œå¾…æ™‚é–“åˆ°è‡ªå‹•æ›´æ–°
function refreshHeavenChallenge(index) {
    try {
        initHeavenChallenges();
        const tasks = gameState.heavenChallenges || [];
        if (index < 0 || index >= tasks.length) return;
        const task = tasks[index];
        // è¨­å®šå†·å» 10 åˆ†é˜
        const cooldownMs = 10 * 60 * 1000;
        const now = Date.now();
        // é‡ç½®ä»»å‹™ç‹€æ…‹ï¼ˆå–æ¶ˆæ¥å—ã€æœªå®Œæˆã€æœªé ˜çï¼‰
        task.accepted = false;
        task.completed = false;
        task.claimed = false;
        task.cooldownUntil = now + cooldownMs;
        // æ¸…ç©ºé€²åº¦
        if (task.subType === 'sessions') {
            task.progress.sessions = 0;
        } else if (task.subType === 'correct') {
            task.progress.correct = 0;
        } else if (task.subType === 'streak') {
            task.progress.streak = 0;
        } else if (task.type === 'item') {
            task.progress.uses = 0;
        } else if (task.type === 'achievement') {
            if (task.subType === 'exp') task.progress.exp = 0;
            if (task.subType === 'streak') task.progress.streak = 0;
        }
        saveGameState();
        showHeavenChallenges();
    } catch (e) {
        console.warn('åˆ·æ–°å¤©å‘½æŒ‘æˆ°å¤±æ•—', e);
    }
}

// é¡¯ç¤ºå¤©å‘½æŒ‘æˆ°ä»»å‹™åˆ—è¡¨
function showHeavenChallenges() {
    try {
        // åˆå§‹åŒ–ä¸¦æ¸…ç†ä»»å‹™ï¼Œå†å±•ç¤ºæ¸…å–®
        initHeavenChallenges();
        cleanupHeavenChallenges();
        const tasks = gameState.heavenChallenges || [];
        let html = '';
        if (!tasks || tasks.length === 0) {
            html = '<p>ç›®å‰æ²’æœ‰ä»»ä½•å¤©å‘½æŒ‘æˆ°ä»»å‹™ã€‚</p>';
        } else {
            html = '<ul style="list-style:none; padding-left:0;">';
            const now = Date.now();
            // å°‡å·²æ¥å—ä¸”æœªé ˜ççš„ä»»å‹™ç½®é ‚é¡¯ç¤º
            const displayTasks = tasks.map((t,i) => ({task: t, index: i})).sort((a,b) => {
                const aAccepted = a.task && a.task.accepted && !a.task.claimed;
                const bAccepted = b.task && b.task.accepted && !b.task.claimed;
                if (aAccepted && !bAccepted) return -1;
                if (!aAccepted && bAccepted) return 1;
                return 0;
            });
            displayTasks.forEach(({task, index}) => {
                // å†·å»ä¸­ï¼šé¡¯ç¤ºå‰©é¤˜æ™‚é–“
                if (task.cooldownUntil && now < task.cooldownUntil) {
                    const remainMs = task.cooldownUntil - now;
                    const remainMin = Math.floor(remainMs / 60000);
                    const remainSec = Math.floor((remainMs % 60000) / 1000);
                    html += '<li style="margin-bottom: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background:#f8f9fa;">';
                    html += `<p>ä»»å‹™åˆ·æ–°ä¸­ï¼Œè«‹ç¨å€™ (${remainMin} åˆ† ${remainSec} ç§’)</p>`;
                    html += '</li>';
                    return;
                }
                // è¨ˆç®—é€²åº¦æè¿°
                let progressText = '';
                if (task.type === 'training') {
                    if (task.subType === 'sessions') {
                        const current = (task.progress && task.progress.sessions) || 0;
                        progressText = `${current} / ${task.targetSessions} æ¬¡`;
                    } else if (task.subType === 'correct') {
                        const current = (task.progress && task.progress.correct) || 0;
                        progressText = `${current} / ${task.targetCorrect} é¡Œ`;
                    } else if (task.subType === 'streak') {
                        const current = (task.progress && task.progress.streak) || 0;
                        progressText = `${current} / ${task.targetStreak} é€£å‹`;
                    }
                } else if (task.type === 'trial') {
                    const current = (task.progress && task.progress.sessions) || 0;
                    progressText = `${current} / ${task.targetSessions} æ¬¡`;
                } else if (task.type === 'item') {
                    const current = (task.progress && task.progress.uses) || 0;
                    progressText = `${current} / ${task.targetItemUse} æ¬¡`;
                } else if (task.type === 'achievement') {
                    if (task.subType === 'exp') {
                        const current = (task.progress && task.progress.exp) || 0;
                        progressText = `${current} / ${task.targetExp} EXP`;
                    } else if (task.subType === 'streak') {
                        const current = (task.progress && task.progress.streak) || 0;
                        progressText = `${current} / ${task.targetStreak} é€£å‹`;
                    }
                }
                // è¨ˆç®—æœŸé™
                let expireLabel = 'ç„¡æœŸé™';
                let remainingLabel = '';
                if (task.durationDays && task.durationDays > 0) {
                    expireLabel = `${task.durationDays} æ—¥`;
                    if (task.expireAt) {
                        const diffMs = task.expireAt - now;
                        if (diffMs > 0) {
                            const diffDays = Math.floor(diffMs / (24 * 3600 * 1000));
                            const diffHours = Math.floor((diffMs % (24 * 3600 * 1000)) / (3600 * 1000));
                            const diffMins = Math.floor((diffMs % (3600 * 1000)) / (60 * 1000));
                            remainingLabel = `å‰©é¤˜ ${diffDays} å¤© ${diffHours} æ™‚ ${diffMins} åˆ†`;
                        } else {
                            remainingLabel = 'ä»»å‹™å·²éæœŸ';
                        }
                    }
                }
                // å¥–åŠ±æè¿°
                const rewardParts = [];
                if (task.reward && task.reward.exp) rewardParts.push(`${task.reward.exp} EXP`);
                if (task.reward && task.reward.stones) rewardParts.push(`${task.reward.stones} éˆçŸ³`);
                // æ§‹å»ºå…ƒç´ 
                html += '<li style="margin-bottom: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;">';
                html += `<p>${task.description}</p>`;
                html += `<p>é€²åº¦ï¼š${progressText}</p>`;
                html += `<p>æœŸé™ï¼š${expireLabel}` + (remainingLabel ? `ï¼ˆ${remainingLabel}ï¼‰` : '') + '</p>';
                if (rewardParts.length > 0) {
                    html += `<p>çå‹µï¼š${rewardParts.join('ã€')}</p>`;
                }
                // é¡¯ç¤ºåˆ·æ–°æŒ‰éˆ•
                html += `<button data-action="refresh-heaven-challenge" data-index="${index}">ğŸ”„ åˆ·æ–°</button>`;
                // æŒ‰éˆ•ï¼šæœªæ¥å— -> æ¥å—ï¼›æ¥å—æœªå®Œæˆ -> æ”¾æ£„ï¼›å®Œæˆæœªé ˜ç -> é ˜å–ï¼›å·²é ˜ç -> å·²å®Œæˆ
                if (!task.accepted) {
                    html += `<button data-action="accept-heaven-challenge" data-index="${index}">âœ… æ¥å—</button>`;
                } else if (task.accepted && !task.completed) {
                    html += `<button data-action="cancel-heaven-challenge" data-index="${index}">âŒ æ”¾æ£„</button>`;
                } else if (task.accepted && task.completed && !task.claimed) {
                    html += `<button data-action="claim-heaven-challenge" data-index="${index}">ğŸ é ˜å–çå‹µ</button>`;
                } else {
                    html += `<span style="color: var(--success-color); font-weight: bold;">å·²å®Œæˆ</span>`;
                }
                html += '</li>';
            });
            html += '</ul>';
        }
        showModal('ğŸŒ  å¤©å‘½æŒ‘æˆ°', html, '<button data-action="close-modal">é—œé–‰</button>');
    } catch (e) {
        console.warn('é¡¯ç¤ºå¤©å‘½æŒ‘æˆ°å¤±æ•—', e);
        showModal('ğŸŒ  å¤©å‘½æŒ‘æˆ°', '<p>ç„¡æ³•é¡¯ç¤ºå¤©å‘½æŒ‘æˆ°ã€‚</p>', '<button data-action="close-modal">é—œé–‰</button>');
    }
}

// æ¥å—å¤©å‘½æŒ‘æˆ°ä»»å‹™
function acceptHeavenChallenge(index) {
    try {
        initHeavenChallenges();
        const tasks = gameState.heavenChallenges || [];
        if (index < 0 || index >= tasks.length) return;
        const task = tasks[index];
        // ä¸å¯åœ¨å†·å»æˆ–éæœŸæ™‚æ¥å—
        const nowTime = Date.now();
        if (task.cooldownUntil && nowTime < task.cooldownUntil) return;
        if (task.expireAt && nowTime > task.expireAt) return;
        if (task.accepted) return;
        // æª¢æŸ¥å·²æ¥å—ä»»å‹™æ•¸é‡ï¼šåŸºç¤ä¸Šé™ç‚º 3ï¼Œæ¯ç´¯ç© 5000 æ¬¡æ™®é€šè¨“ç·´å¯é¡å¤–å¤šæ¥å— 1 å€‹
        const acceptedCount = tasks.filter(t => t.accepted && !t.claimed).length;
        const baseLimit = 3;
        // è‹¥ gameState.total å°šæœªå®šç¾©å‰‡è¦–ç‚º 0
        const totalTrainings = gameState.total || 0;
        const extra = Math.floor(totalTrainings / 5000);
        const acceptedLimit = baseLimit + extra;
        if (acceptedCount >= acceptedLimit) {
            showModal('ğŸŒ  å¤©å‘½æŒ‘æˆ°', `<p>ä½ å·²æ¥å— ${acceptedLimit} å€‹å¤©å‘½æŒ‘æˆ°ï¼Œå®Œæˆå¾Œæ‰èƒ½æ¥å—æ–°çš„ä»»å‹™ã€‚</p>`, '<button data-action="close-modal">é—œé–‰</button>');
            return;
        }
        task.accepted = true;
        task.progress = task.progress || {};
        // é‡ç½®é€²åº¦
        if (task.subType === 'sessions') {
            task.progress.sessions = 0;
        } else if (task.subType === 'correct') {
            task.progress.correct = 0;
        } else if (task.subType === 'streak') {
            task.progress.streak = 0;
        } else if (task.type === 'item') {
            task.progress.uses = 0;
        } else if (task.type === 'achievement' && task.subType === 'exp') {
            task.progress.exp = 0;
        }
        saveGameState();
        showHeavenChallenges();
    } catch (e) {
        console.warn('æ¥å—å¤©å‘½æŒ‘æˆ°å¤±æ•—', e);
    }
}

// æ”¾æ£„å¤©å‘½æŒ‘æˆ°ä»»å‹™
function cancelHeavenChallenge(index) {
    try {
        initHeavenChallenges();
        const tasks = gameState.heavenChallenges || [];
        if (index < 0 || index >= tasks.length) return;
        const task = tasks[index];
        if (!task.accepted || task.claimed) return;
        // æ”¾æ£„å¾Œé‡ç½®ä»»å‹™ç‹€æ…‹åŠé€²åº¦
        task.accepted = false;
        task.completed = false;
        task.claimed = false;
        if (task.subType === 'sessions') {
            task.progress.sessions = 0;
        } else if (task.subType === 'correct') {
            task.progress.correct = 0;
        } else if (task.subType === 'streak') {
            task.progress.streak = 0;
        } else if (task.type === 'item') {
            task.progress.uses = 0;
        } else if (task.type === 'achievement' && task.subType === 'exp') {
            task.progress.exp = 0;
        }
        saveGameState();
        showHeavenChallenges();
    } catch (e) {
        console.warn('æ”¾æ£„å¤©å‘½æŒ‘æˆ°å¤±æ•—', e);
    }
}

// é ˜å–å¤©å‘½æŒ‘æˆ°çå‹µ
function claimHeavenChallengeReward(index) {
    try {
        initHeavenChallenges();
        const tasks = gameState.heavenChallenges || [];
        if (index < 0 || index >= tasks.length) return;
        const task = tasks[index];
        if (!task.accepted || !task.completed || task.claimed) return;
        // ç™¼æ”¾çå‹µ
        const rExp = (task.reward && task.reward.exp) || 0;
        const rStones = (task.reward && task.reward.stones) || 0;
        if (rExp > 0) gameState.exp += rExp;
        if (rStones > 0) gameState.stones += rStones;
        task.claimed = true;
        saveGameState();
        // çµ¦äºˆæç¤º
        let rewardMsgParts = [];
        if (rExp > 0) rewardMsgParts.push(`${rExp} ä¿®ç…‰ç¶“é©—`);
        if (rStones > 0) rewardMsgParts.push(`${rStones} éˆçŸ³`);
        const msg = rewardMsgParts.length > 0 ? rewardMsgParts.join('ã€') : 'å®Œæˆä»»å‹™ï¼Œçå‹µå·²ç™¼æ”¾';
        showModal('ğŸ å¤©å‘½æŒ‘æˆ°å®Œæˆ', `<p>${msg}</p>`, '<button data-action="close-modal">é—œé–‰</button>');
        // ä»»å‹™é ˜å–å¾Œï¼Œè‡ªå‹•ç”¢ç”Ÿæ–°ä»»å‹™ï¼ˆä¿æŒåŒé¡å‹ï¼‰
        replaceHeavenTask(index);
        showHeavenChallenges();
    } catch (e) {
        console.warn('é ˜å–å¤©å‘½æŒ‘æˆ°çå‹µå¤±æ•—', e);
    }
}

// æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆæ™®é€šè¨“ç·´ï¼‰ï¼šæ ¹æ“šç­”å°é¡Œæ•¸åŠå‹ç‡æ›´æ–°
function updateHeavenChallengeProgressTraining(difficulty, correctCount, totalRounds, winRate, expGain) {
    // ç¢ºä¿ä»»å‹™ç”Ÿæˆ
    initHeavenChallenges();
    const tasks = gameState.heavenChallenges || [];
    let changed = false;
    tasks.forEach((task) => {
        // ä»»å‹™å¿…é ˆå·²æ¥å—ä¸”æœªå®Œæˆï¼›ä¸”æœªéæœŸæˆ–å†·å»
        if (!task.accepted || task.completed) return;
        const nowTime = Date.now();
        if ((task.cooldownUntil && nowTime < task.cooldownUntil) || (task.expireAt && nowTime > task.expireAt)) {
            return;
        }
        try {
            if (task.type === 'training') {
                if (task.difficulty === difficulty) {
                    if (task.subType === 'sessions') {
                        // éœ€è¦é”åˆ°æŒ‡å®šå‹ç‡
                        if (winRate >= task.winRate) {
                            task.progress.sessions = (task.progress.sessions || 0) + 1;
                            if (task.progress.sessions >= task.targetSessions) {
                                task.completed = true;
                            }
                            changed = true;
                        }
                    } else if (task.subType === 'correct') {
                        task.progress.correct = (task.progress.correct || 0) + correctCount;
                        if (task.progress.correct >= task.targetCorrect) {
                            task.completed = true;
                        }
                        changed = true;
                    } else if (task.subType === 'streak') {
                        // streak ä»»å‹™ï¼šè‹¥æœ¬æ¬¡é”æ¨™å‰‡é€£çºŒ+1ï¼Œå¦å‰‡æ­¸é›¶
                        if (winRate >= task.winRate) {
                            task.progress.streak = (task.progress.streak || 0) + 1;
                        } else {
                            task.progress.streak = 0;
                        }
                        if (task.progress.streak >= task.targetStreak) {
                            task.completed = true;
                        }
                        changed = true;
                    }
                }
            }
            if (task.type === 'achievement') {
                if (task.subType === 'exp') {
                    // ç´¯ç©ç¶“é©—ä»»å‹™
                    task.progress.exp = (task.progress.exp || 0) + (expGain || 0);
                    if (task.progress.exp >= task.targetExp) {
                        task.completed = true;
                    }
                    changed = true;
                } else if (task.subType === 'streak' && task.difficulty === difficulty) {
                    // æˆå°±é¡é€£å‹ä»»å‹™ï¼šèˆ‡ training streak æ–¹å¼ç›¸åŒ
                    if (winRate >= task.winRate) {
                        task.progress.streak = (task.progress.streak || 0) + 1;
                    } else {
                        task.progress.streak = 0;
                    }
                    if (task.progress.streak >= task.targetStreak) {
                        task.completed = true;
                    }
                    changed = true;
                }
            }
        } catch (e) { console.warn('æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆè¨“ç·´ï¼‰å¤±æ•—', e); }
    });
    if (changed) saveGameState();
}

// æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆç§˜å¢ƒè©¦ç…‰ï¼‰ï¼šæ ¹æ“šç­”å°é¡Œæ•¸åˆ¤å®š
function updateHeavenChallengeProgressTrial(correctCount, difficulty, expGain) {
    initHeavenChallenges();
    const tasks = gameState.heavenChallenges || [];
    let changed = false;
    tasks.forEach((task) => {
        if (!task.accepted || task.completed) return;
        const nowTime = Date.now();
        if ((task.cooldownUntil && nowTime < task.cooldownUntil) || (task.expireAt && nowTime > task.expireAt)) {
            return;
        }
        try {
            if (task.type === 'trial' && task.subType === 'sessions') {
                if (task.difficulty === difficulty) {
                    const threshold = task.correctThreshold || 1;
                    if (correctCount >= threshold) {
                        task.progress.sessions = (task.progress.sessions || 0) + 1;
                        if (task.progress.sessions >= task.targetSessions) {
                            task.completed = true;
                        }
                        changed = true;
                    }
                }
            }
            if (task.type === 'achievement' && task.subType === 'exp') {
                task.progress.exp = (task.progress.exp || 0) + (expGain || 0);
                if (task.progress.exp >= task.targetExp) {
                    task.completed = true;
                }
                changed = true;
            }
        } catch (e) { console.warn('æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆç§˜å¢ƒï¼‰å¤±æ•—', e); }
    });
    if (changed) saveGameState();
}

// æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆé“å…·ä½¿ç”¨ï¼‰ï¼šä½¿ç”¨é“å…·æ™‚èª¿ç”¨
function updateHeavenChallengeProgressItemUse(itemType, count) {
    initHeavenChallenges();
    const tasks = gameState.heavenChallenges || [];
    let changed = false;
    tasks.forEach((task) => {
        if (!task.accepted || task.completed) return;
        const nowTime = Date.now();
        if ((task.cooldownUntil && nowTime < task.cooldownUntil) || (task.expireAt && nowTime > task.expireAt)) {
            return;
        }
        try {
            if (task.type === 'item' && task.itemType === itemType) {
                task.progress.uses = (task.progress.uses || 0) + (count || 1);
                if (task.progress.uses >= task.targetItemUse) {
                    task.completed = true;
                }
                changed = true;
            }
        } catch (e) { console.warn('æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆé“å…·ï¼‰å¤±æ•—', e); }
    });
    if (changed) saveGameState();
}

// æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆç´¯ç©ç¶“é©—ï¼‰ï¼šå‚³å…¥ç²å¾—çš„ç¶“é©—å€¼
function updateHeavenChallengeProgressExp(expGain) {
    initHeavenChallenges();
    const tasks = gameState.heavenChallenges || [];
    let changed = false;
    tasks.forEach((task) => {
        if (!task.accepted || task.completed) return;
        const nowTime = Date.now();
        if ((task.cooldownUntil && nowTime < task.cooldownUntil) || (task.expireAt && nowTime > task.expireAt)) {
            return;
        }
        try {
            if (task.type === 'achievement' && task.subType === 'exp') {
                task.progress.exp = (task.progress.exp || 0) + (expGain || 0);
                if (task.progress.exp >= task.targetExp) {
                    task.completed = true;
                }
                changed = true;
            }
        } catch (e) { console.warn('æ›´æ–°å¤©å‘½æŒ‘æˆ°é€²åº¦ï¼ˆç¶“é©—ï¼‰å¤±æ•—', e); }
    });
    if (changed) saveGameState();
}


// ===================== å…¨åŸŸäº‹ä»¶è™•ç† =====================
document.body.addEventListener('click', (event) => {
    let target = event.target;
    // If the target itself doesn't have the action, check its parent
    if (!target.dataset.action) {
        target = target.closest('[data-action]');
    }
    if (!target) return;

    const action = target.dataset.action;
    
    const simpleActions = {
        'render-main-menu': renderMainMenu, 'render-test-luck-menu': renderTestLuckMenu,
        'show-stage-list': showStageList, 'show-rank-list': showRankList,
        'show-backpack': showBackpack, 'show-shop': showShop,
        'reset-stats': resetTrainingStats, 'clear-scores': clearMaxScores,
        'run-today-luck': runTodayLuck, 'show-luck-history': showLuckHistory,
        'show-upgrade-dialog': showUpgradeDialog, 'check-answer-multi': checkAnswerMulti,
        'show-use-item-dialog': showUseItemDialog, 'close-modal': () => modal.style.display = "none",
        'bulk-buy-items': bulkBuyItems,
        'use-exp-items': showUseExpDialog,
        'delete-items': showDeleteItemsDialog,
        'confirm-use-exp': confirmUseExp,
        'confirm-delete-items': confirmDeleteItems,
        'fill-all-exp': fillAllExpInputs,
        'confirm-use-exp-all': confirmUseExpAll,
        'confirm-sell-items': confirmSellItems,
        'show-sell-dialog': showSellDialog,
        'show-game-rules': showGameRules,
        'test-sfx': () => {
            try {
                if (typeof ensureAudio === 'function' && typeof playBeep === 'function') {
                    ensureAudio();
                    playBeep({ freq: 880 });
                }
            } catch (e) {}
        },
        // # æ–°å¢ç°¡æ˜“å‹•ä½œï¼šç§˜å¢ƒè©¦ç…‰é¸å–®ã€ç§˜å¢ƒæ’è¡Œæ¦œã€ç™»å…¥ä»‹é¢èˆ‡ç™»å…¥ç™»å‡º
        'render-secret-trial-menu': renderSecretTrialMenu,
        'show-trial-leaderboard': showTrialLeaderboard,
        'show-login-menu': showLoginMenu,
        'login-google': loginGoogle,
        'login-email': loginEmail,
        'login-yahoo': loginYahoo,
        'login-facebook': loginFacebook,
        'logout': logout,
        'login-anonymous': loginAnonymous,
        // å¿«æ·é“å…·è¨­å®šèˆ‡ä¿®ä»™æ’è¡Œæ¦œ
        'manage-quick-items': showQuickItemsManager,
        'confirm-set-quick-items': confirmSetQuickItems,
        'show-cultivation-leaderboard': showCultivationLeaderboard,
        // æ¯æ—¥ç°½åˆ°èˆ‡ä»»å‹™
        'handle-daily-signin': handleDailySignIn,
        'show-daily-task': showDailyTask,
        'accept-daily-task': acceptDailyTask,
        'claim-daily-task': claimDailyTaskReward,
        // å¤©å‘½æŒ‘æˆ°ç›¸é—œï¼šé¡¯ç¤ºæ¸…å–®ã€æ¥å—ã€æ”¾æ£„ã€é ˜ç
        'show-heaven-challenges': showHeavenChallenges,
        // ç°½åˆ°æ—¥æ›†ï¼šé¡¯ç¤ºç•¶æœˆç°½åˆ°ç‹€æ…‹
        'show-signin-calendar': showSignInCalendar,
        // # é–‹å§‹éˆæ ¹æ¸¬è©¦ï¼šæ–¼åˆå§‹åŒ–éšæ®µé»æ“ŠæŒ‰éˆ•
        'start-linggen-test': startLinggenTest,
        // # æ–°å¢å†æ¬¡æŒ‘æˆ°å‹•ä½œï¼šé‡æ–°é–‹å§‹ä¸Šä¸€å ´è¨“ç·´æˆ–ç§˜å¢ƒè©¦ç…‰
        'retry-training': () => {
            try {
                if (typeof startTraining === 'function' && trainingState && trainingState.difficulty) {
                    startTraining(trainingState.difficulty);
                }
            } catch (e) { console.warn('ç„¡æ³•å†æ¬¡æŒ‘æˆ°è¨“ç·´', e); }
        },
        'retry-trial': () => {
            try {
                if (typeof startTrial === 'function' && trainingState && trainingState.difficulty) {
                    startTrial(trainingState.difficulty);
                }
            } catch (e) { console.warn('ç„¡æ³•å†æ¬¡æŒ‘æˆ°ç§˜å¢ƒ', e); }
        },
    };

    if (simpleActions[action]) {
        simpleActions[action]();
        return;
    }

    // Actions with parameters
    switch(action) {
        case 'start-training':
            startTraining(parseInt(target.dataset.level, 10));
            break;
        case 'exchange-stones':
            exchangeStones(parseInt(target.dataset.count, 10));
            break;
        case 'redeem-tickets':
            redeemTickets(parseInt(target.dataset.pieces, 10), parseInt(target.dataset.cost, 10));
            break;
        case 'run-luck-draw':
            runLuckDraw(parseInt(target.dataset.draws, 10), target.dataset.mode);
            break;
        case 'upgrade-item':
            upgradeItem(target.dataset.current, target.dataset.next, parseInt(target.dataset.cost, 10));
            break;
        // å¤©å‘½æŒ‘æˆ°ä»»å‹™è™•ç†ï¼šæ¥å—ã€å–æ¶ˆã€é ˜ç
        case 'accept-heaven-challenge':
            acceptHeavenChallenge(parseInt(target.dataset.index || '0', 10));
            break;
        case 'cancel-heaven-challenge':
            cancelHeavenChallenge(parseInt(target.dataset.index || '0', 10));
            break;
        case 'claim-heaven-challenge':
            claimHeavenChallengeReward(parseInt(target.dataset.index || '0', 10));
            break;
        case 'refresh-heaven-challenge':
            refreshHeavenChallenge(parseInt(target.dataset.index || '0', 10));
            break;
        case 'use-item':
            useItem(target.dataset.itemName);
            break;
        case 'grid-btn': 
            onGridButtonClick(target);
            break;
        case 'start-trial':
            startTrial(parseInt(target.dataset.level, 10));
            break;
        case 'switch-use-item-filter':
            // åˆ‡æ›æˆ°é¬¥é“å…·åˆ†é¡éæ¿¾å™¨ï¼Œå†é‡æ–°æ¸²æŸ“ä½¿ç”¨é“å…·å°è©±æ¡†
            currentItemFilter = target.dataset.filter;
            showUseItemDialog();
            break;
        case 'switch-backpack-filter':
            // åˆ‡æ›èƒŒåŒ…é“å…·åˆ†é¡éæ¿¾å™¨ï¼Œå†é‡æ–°é¡¯ç¤ºèƒŒåŒ…
            currentBackpackFilter = target.dataset.filter;
            showBackpack();
            break;
    }
});


// ===================== å•Ÿå‹•éŠæˆ² =====================
loadGameState();
    // è¨­å®šå›é ‚éƒ¨æŒ‰éˆ•åŠŸèƒ½ï¼šé»æ“Šå¾Œå¹³æ»‘æ²å‹•å›é é¢é ‚éƒ¨
    try {
        const backBtnEl = document.getElementById('back-to-top');
        if (backBtnEl) {
            backBtnEl.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    } catch (e) { console.warn('ç„¡æ³•ç¶å®šå›é ‚éƒ¨æŒ‰éˆ•', e); }
    // å°‡æ–°å¢çš„å¤©å¹²ã€åœ°æ”¯èˆ‡å¹²æ”¯çµ„åˆéŠæˆ²åŠ å…¥éŠæˆ²åˆ—è¡¨
    try {
        if (Array.isArray(ALL_GAMES)) {
            ALL_GAMES.push(
                { name: "åå¤©å¹²", func: "game_tiangan" },
                { name: "åäºŒåœ°æ”¯", func: "game_dizhi" },
                { name: "å…­åå¹²æ”¯çµ„åˆ", func: "game_ganzhi" },
                { name: "äºŒåå››ç¯€æ°£", func: "game_solar_terms" }
            );
        }
    } catch (e) { console.warn('ç„¡æ³•åŠ å…¥æ–°å¢å¤©å¹²åœ°æ”¯éŠæˆ²', e); }
renderMainMenu();

}); // â–²â–²â–² End of DOMContentLoaded listener â–²â–²â–²
</script>

<!-- éŸ³æ•ˆèˆ‡ç®­é ­å¾Œæ´ç¨‹å¼ï¼šåœ¨è¡Œå‹•è£ç½®ä¸Šé¡¯ç¤ºç®­é ­ï¼Œä¸¦ç”ŸæˆéŸ³æ•ˆï¼ˆç„¡éœ€å¤–éƒ¨éŸ³æª”ï¼‰ -->
<script>
// ==== è¡Œå‹•è£ç½®ç®­é ­ SVG å¾Œæ´ ====
function svgArrow(dir, size = 18) {
    const pathMap = {
        up:   'M9 2 L16 14 H2 Z',
        right:'M2 2 L14 9 L2 16 Z',
        down: 'M2 2 L16 2 L9 16 Z',
        left: 'M2 9 L14 2 L14 16 Z'
    };
    const key = pathMap[dir] ? dir : 'up';
    const svg = `<svg viewBox="0 0 18 18" width="${size}" height="${size}" aria-hidden="true" style="display:inline-block;vertical-align:middle"><path d="${pathMap[key]}" fill="currentColor"/></svg>`;
    const el = document.createElement('span');
    el.className = 'luck-arrow-svg';
    el.innerHTML = svg;
    return el;
}

// å°‡å«æœ‰ç®­é ­å­—å…ƒæˆ–æŒ‡å®š data å±¬æ€§çš„ç¯€é»æ›¿æ›ç‚º SVG
function patchLuckArrows() {
    const selector = '.luck-arrow, [data-luck-arrow], [data-dir]';
    document.querySelectorAll(selector).forEach(node => {
        // å·²ç¶“æœ‰ SVG å°±ä¸é‡è¤‡æ›¿æ›
        if (node.querySelector('svg')) return;
        // åˆ¤æ–·æ–¹å‘
        let dir = node.dataset.luckArrow || node.dataset.dir || '';
        // è‹¥æœªæŒ‡å®šï¼Œæ ¹æ“šå…§å®¹åˆ¤æ–·
        if (!dir) {
            const text = node.textContent.trim();
            const map = {'â†‘': 'up', 'â†’': 'right', 'â†“': 'down', 'â†': 'left'};
            dir = map[text] || 'up';
        }
        // æ¸…ç©ºæ–‡å­—ä¸¦æ’å…¥ SVG
        node.textContent = '';
        node.appendChild(svgArrow(dir));
    });
}

// ==== WebAudio éŸ³æ•ˆå·¥å…· ====
let __audioCtx = null;
function ensureAudio() {
    if (!__audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        __audioCtx = new Ctx();
    }
    return __audioCtx;
}

function playBeep(opts) {
    const cfg = Object.assign({ freq: 880, dur: 0.12, type: 'sine', gain: 0.06 }, opts);
    const ctx = ensureAudio();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    osc.type = cfg.type;
    osc.frequency.value = cfg.freq;
    gainNode.gain.value = cfg.gain;
    osc.connect(gainNode).connect(ctx.destination);
    const t = ctx.currentTime;
    osc.start(t);
    osc.stop(t + cfg.dur);
}

function playLevelUp() {
    const ctx = ensureAudio();
    if (!ctx) return;
    const now = ctx.currentTime;
    // ä¸Šè¡Œå°å’Œå¼¦ï¼šC-E-G ä¾åºéŸ¿èµ·
    [[523.25, 0], [659.25, 0.08], [783.99, 0.16]].forEach(([freq, offset]) => {
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gainNode.gain.value = 0.05;
        osc.connect(gainNode).connect(ctx.destination);
        osc.start(now + offset);
        osc.stop(now + offset + 0.18);
    });
}

// ==== çå‹µéŸ³æ•ˆï¼šæ¨¡æ“¬æ¨‚é€ä¸­çéŸ³æ•ˆï¼Œæ’­æ”¾ä¸€é€£ä¸²æ¼¸é«˜çš„ beep éŸ³ ====
function playRewardSound() {
    try {
        // ç¢ºä¿éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–
        ensureAudio();
        // é€£çºŒæ’­æ”¾ä¸‰å€‹é »ç‡çš„ beepï¼Œå½¢æˆç°¡å–®çš„ä¸­çéŸ³æ•ˆ
        playBeep({ freq: 880, dur: 0.14, type: 'square', gain: 0.08 });
        setTimeout(() => playBeep({ freq: 1046.5, dur: 0.14, type: 'square', gain: 0.07 }), 160);
        setTimeout(() => playBeep({ freq: 1318.5, dur: 0.14, type: 'square', gain: 0.06 }), 320);
    } catch (e) {
        console.warn('playRewardSound failed', e);
    }
}

// ==== åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ====
window.addEventListener('DOMContentLoaded', () => {
    try {
        patchLuckArrows();
    } catch (e) {}
});
</script>


<!-- ==================== ç·šä¸Šç‰ˆæ•´åˆï¼šFirebaseï¼ˆAuth + Firestore + é›¢ç·šï¼‰ ==================== -->
<!-- # è‹¥æœªå¡«å…¥ä½ çš„ firebaseConfigï¼Œé›²ç«¯åŠŸèƒ½ä¸æœƒå•Ÿç”¨ï¼›ä¸å½±éŸ¿é›¢ç·šæœ¬åœ°åŠŸèƒ½ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// # Firebase åˆå§‹åŒ–ï¼ˆè«‹æŠŠ YOUR_* æ›æˆä½ çš„å°ˆæ¡ˆè¨­å®šï¼‰
var FIREBASE_ONLINE_ENABLED = true;  // # è‹¥è¦æš«æ™‚é—œé–‰é›²ç«¯ï¼Œå¯è¨­ç‚º false
// # å°‡ä»¥ä¸‹è¨­å®šæ”¹ç‚ºæ‚¨åœ¨ Firebase Console å»ºç«‹å°ˆæ¡ˆå¾Œå–å¾—çš„å¯¦éš›å€¼ã€‚
// # å¦‚æœæ‚¨æ˜¯ä¾ç…§å®˜æ–¹æŒ‡å¼•ä½¿ç”¨ npm æˆ– <script> æ¨™ç±¤è¼‰å…¥ Firebaseï¼Œ
// # å»ºè­°ä¿æŒæ­¤è™•æ ¼å¼ä¸€è‡´å³å¯å•Ÿç”¨é›²ç«¯åŠŸèƒ½ã€‚
var firebaseConfig = {
  apiKey: "AIzaSyBu3lcaLChWhzGmIPWE5CsZOIugPbhEg58",           // # å°ˆæ¡ˆçš„ API Key
  authDomain: "xiuxian-luck-trainer.firebaseapp.com",           // # å°ˆæ¡ˆæˆæ¬Šç¶²åŸŸ
  projectId: "xiuxian-luck-trainer",                           // # å°ˆæ¡ˆ ID
  storageBucket: "xiuxian-luck-trainer.firebasestorage.app",    // # (å¯é¸) å„²å­˜ç©ºé–“æ¡¶åç¨±
  messagingSenderId: "185296094422",                           // # (å¯é¸) Cloud Messaging ç™¼é€è€… ID
  appId: "1:185296094422:web:b86866eb98842e52e97577",          // # (å¯é¸) æ‡‰ç”¨ç¨‹å¼ ID
  measurementId: "G-QTDH5X3CMT"                               // # (å¯é¸) Google Analytics é‡æ¸¬ ID
};
try {
  if (FIREBASE_ONLINE_ENABLED) { firebase.initializeApp(firebaseConfig); }
} catch (e) { console.warn('Firebase init failed (å¯èƒ½æ˜¯æœªå¡« config)ï¼š', e); FIREBASE_ONLINE_ENABLED = false; }

// # Firestore & é›¢ç·šå¿«å–
var db = null;
try {
  if (FIREBASE_ONLINE_ENABLED) {
    db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(function(){ /* # ç„¡ç—•æ¨¡å¼æˆ–è¡çª */ });
  }
} catch (e) { console.warn('Firestore init failedï¼š', e); FIREBASE_ONLINE_ENABLED = false; }

// # Authï¼ˆåŒ¿åè‡ªå‹•ç™»å…¥ï¼›ä¹‹å¾Œå¯å‡ç´š Google/Email ä¸¦ä¿ç•™ç´€éŒ„ï¼‰
var auth = null;
try { if (FIREBASE_ONLINE_ENABLED) { auth = firebase.auth(); } } catch (e) {}

function ensureSignedIn() {
  return new Promise(function(resolve) {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return resolve(null);  // # é›²ç«¯é—œé–‰æ™‚ç›´æ¥ç•¥é
    var off = auth.onAuthStateChanged(async function(u) {
      if (u) { off(); return resolve(u); }
      try { var cred = await auth.signInAnonymously(); off(); resolve(cred.user); }
      catch (e) { off(); resolve(null); }
    });
  });
}

// # å‡ç´šç™»å…¥ï¼ˆGoogleï¼‰ä¿ç•™åŒ¿åè³‡æ–™
async function signInWithGoogleKeepData() {
  if (!FIREBASE_ONLINE_ENABLED || !auth) return null;
  var provider = new firebase.auth.GoogleAuthProvider();
  var u = auth.currentUser;
  if (u && u.isAnonymous) { await u.linkWithPopup(provider); return auth.currentUser; }
  var res = await auth.signInWithPopup(provider);
  return res.user;
}

// # å‡ç´šç™»å…¥ï¼ˆYahooï¼‰ä¿ç•™åŒ¿åè³‡æ–™
async function signInWithYahooKeepData() {
  // # è‹¥é›²ç«¯æœªå•Ÿç”¨å‰‡ç•¥é
  if (!FIREBASE_ONLINE_ENABLED || !auth) return null;
  try {
    var provider = new firebase.auth.OAuthProvider('yahoo.com');
    var u = auth.currentUser;
    // # è‹¥ç›®å‰ç‚ºåŒ¿åç”¨æˆ¶ï¼Œä½¿ç”¨ linkWithPopup ä¿ç•™æ—¢æœ‰è³‡æ–™
    if (u && u.isAnonymous) {
      await u.linkWithPopup(provider);
      return auth.currentUser;
    }
    // # å¦å‰‡ç›´æ¥ä»¥ Popup æ–¹å¼ç™»å…¥
    var res = await auth.signInWithPopup(provider);
    return res.user;
  } catch (e) {
    console.warn('Yahoo ç™»å…¥å¤±æ•—', e);
    throw e;
  }
}

// # å‡ç´šç™»å…¥ï¼ˆFacebookï¼‰ä¿ç•™åŒ¿åè³‡æ–™
async function signInWithFacebookKeepData() {
  if (!FIREBASE_ONLINE_ENABLED || !auth) return null;
  try {
    var provider = new firebase.auth.FacebookAuthProvider();
    var u = auth.currentUser;
    if (u && u.isAnonymous) {
      await u.linkWithPopup(provider);
      return auth.currentUser;
    }
    var res = await auth.signInWithPopup(provider);
    return res.user;
  } catch (e) {
    console.warn('Facebook ç™»å…¥å¤±æ•—', e);
    throw e;
  }
}

// # å‡ç´šç™»å…¥ï¼ˆEmail/Passwordï¼‰ä¿ç•™åŒ¿åè³‡æ–™
async function upgradeToEmailPassword(email, password) {
  if (!FIREBASE_ONLINE_ENABLED || !auth) return null;
  var u = auth.currentUser;
  var cred = firebase.auth.EmailAuthProvider.credential(email, password);
  if (u && u.isAnonymous) { await u.linkWithCredential(cred); return auth.currentUser; }
  var res = await auth.createUserWithEmailAndPassword(email, password);
  return res.user;
}

function signOutOnline() { if (auth) return auth.signOut(); }

// # é›²ç«¯è³‡æ–™æ¨¡å‹èˆ‡å¯«å…¥
async function saveRunRecord(rec) {
  // # rec: { level, score, mode, usedItems, durationSec, result, publishToLeaderboard }
  if (!FIREBASE_ONLINE_ENABLED || !db) return; // # æœªå•Ÿç”¨å‰‡ç•¥é
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return; // # ç„¡æ³•ç™»å…¥å‰‡ç•¥é
  var uid = u.uid;
  var now = firebase.firestore.Timestamp.now();
  var runRef = db.collection('users').doc(uid).collection('runs').doc(); // # è‡ªå‹• runId
  var statRef = db.collection('user_stats').doc(uid);

  return db.runTransaction(async function(tx) {
    tx.set(runRef, Object.assign({}, rec, {
      createdAt: now,
      clientAt: new Date().toISOString(),
      appVersion: 'web-1.0.0'
    }));
    var statSnap = await tx.get(statRef);
    var prev = statSnap.exists ? statSnap.data() : { totalRuns: 0, bestScore: -1 };
    var next = {
      totalRuns: (prev.totalRuns || 0) + 1,
      bestScore: Math.max(prev.bestScore || -1, rec.score || 0),
      lastPlayedAt: now
    };
    tx.set(statRef, next, { merge: true });
  }).then(async function() {
    if (rec.publishToLeaderboard) {
      var prof = await getOrInitUserProfile();
      await db.collection('leaderboard_public').doc(uid).set({
        bestScore: rec.score,
        displayName: prof.displayName || 'ç„¡åä¿®å£«',
        country: prof.country || 'TW',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }
  }).catch(function(e){ console.warn('saveRunRecord å¤±æ•—ï¼š', e); });
}

// # è®€å–æˆ‘çš„è³‡æ–™ï¼ˆå¯åœ¨ UI ä¸Šé¡¯ç¤ºç”¨ï¼‰
async function loadMyRecentRuns(limitN) {
  if (!FIREBASE_ONLINE_ENABLED || !db) return [];
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return [];
  var qs = await db.collection('users').doc(u.uid).collection('runs').orderBy('createdAt','desc').limit(limitN||50).get();
  return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

async function loadMyStats() {
  if (!FIREBASE_ONLINE_ENABLED || !db) return { totalRuns: 0, bestScore: 0 };
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return { totalRuns: 0, bestScore: 0 };
  var doc = await db.collection('user_stats').doc(u.uid).get();
  return doc.exists ? doc.data() : { totalRuns: 0, bestScore: 0 };
}

async function loadLeaderboardTopN(n) {
  if (!FIREBASE_ONLINE_ENABLED || !db) return [];
  var qs = await db.collection('leaderboard_public').orderBy('bestScore','desc').limit(n||100).get();
  return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

// # ä½¿ç”¨è€… profile æª”æ¡ˆ
async function getOrInitUserProfile() {
  if (!FIREBASE_ONLINE_ENABLED || !db) return { displayName: 'ç„¡åä¿®å£«', country: 'TW' };
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return { displayName: 'ç„¡åä¿®å£«', country: 'TW' };
  var ref = db.collection('users').doc(u.uid);
  var snap = await ref.get();
  if (snap.exists) return snap.data();
  var init = { displayName: u.displayName || 'ç„¡åä¿®å£«', createdAt: firebase.firestore.FieldValue.serverTimestamp(), avatarUrl: null, country: 'TW' };
  await ref.set(init, { merge: true });
  return init;
}

// # æœ¬æª”å°æ¥é»ï¼šéŠæˆ²çµæŸæ™‚å‘¼å«ï¼ˆå·²ç”± showTrainingResult() å…§éƒ¨æ³¨å…¥å‘¼å«ï¼‰
async function onGameFinished(payload) {
  try { await ensureSignedIn(); } catch (e) {}
  try { await saveRunRecord(payload); } catch (e) { console.warn(e); }
}

// # ä¸€æ¬¡æ€§é·ç§»ï¼šæŠŠæ—¢æœ‰ localStorage çš„ç´€éŒ„ï¼ˆå¦‚ä½ æœ‰ä¿å­˜ï¼‰ä¸Šå‚³åˆ°é›²ç«¯ï¼ˆå¯é¸ï¼‰
async function migrateLocalToCloud() {
  try { await ensureSignedIn(); } catch (e) {}
  // # è‹¥ä½ æœ‰èˆŠæ ¼å¼ï¼Œå¯åœ¨é€™è£¡è®€å– localStorage çš„èˆŠç´€éŒ„ key ä¸¦é€ç­† saveRunRecord
  // # ç›®å‰æ­¤å°ˆæ¡ˆçš„ä¸»è³‡æ–™å·²å­˜æ–¼ gameState / maxScoresï¼Œä¸åšé¡å¤–é·ç§»ä»¥é¿å…é‡è¦†ï¼›å¦‚éœ€è‡ªè¨‚ï¼Œè«‹åœ¨æ­¤æ“´å……ã€‚
}

// # å•Ÿå‹•æ™‚å˜—è©¦ç™»å…¥ï¼›è‹¥é›²ç«¯æœªå•Ÿç”¨å‰‡å®‰éœç•¥é
document.addEventListener('DOMContentLoaded', function() {
  ensureSignedIn().then(function(){ try { migrateLocalToCloud(); } catch(e){} });
});
</script>
<!-- ==================== /Firebase ç·šä¸Šç‰ˆæ•´åˆå€ ==================== -->

</body>
</html>
