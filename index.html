<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅãÊ∞£Ë®ìÁ∑¥Â∑•ÂÖ∑ V2-13-S3Ôºà‰øÆ‰ªôÁ∂≤È†ÅÁ∑ö‰∏äÁâàÔºâ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #545b62;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gold-color: #DAA520;
            --teal-color: #20c997;
            --purple-color: #6f42c1;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #app-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            text-align: center;
            margin-top: 0;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: var(--primary-color);
            color: white;
            -webkit-tap-highlight-color: transparent; /* ÁßªÈô§Ë°åÂãïË£ùÁΩÆÈªûÊìäÈ´ò‰∫Æ */
        }
        button:hover {
            background-color: var(--primary-hover);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #b22a38; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }


        .info-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .info-section p {
            margin: 6px 0;
        }

        progress {
            width: 100%;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            border: none;
        }
        progress::-webkit-progress-bar {
            background-color: #e9ecef;
        }
        progress::-webkit-progress-value {
            background-color: var(--success-color);
            transition: width 0.5s ease-in-out;
        }
        progress::-moz-progress-bar {
            background-color: var(--success-color);
        }

        .game-grid {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .grid-btn {
            width: 100%;
            height: 60px;
            font-size: 24px;
            padding: 0;
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid #ccc;
        }
        .grid-btn:hover {
            background-color: #e2e6ea;
        }
        .grid-btn.selected {
            border-color: var(--primary-color);
            background-color: #e0f7fa;
            box-shadow: 0 0 5px var(--primary-color);
        }
        .grid-btn.hint-correct {
            border: 2px solid var(--gold-color);
            background-color: #fff7d6;
        }
        .grid-btn.hint-wrong {
            border: 2px solid var(--danger-color);
            background-color: #ffe6e6;
        }
        .grid-btn.checked {
            background-color: #d1ecf1;
            border-color: var(--info-color);
        }


        .feedback {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .feedback.success { color: var(--success-color); }
        .feedback.error { color: var(--danger-color); }
        .feedback.info { color: var(--info-color); }
        
        .message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .msg-daily { color: #004085; background-color: #cce5ff; border: 1px solid #b8daff; }
        .msg-shop { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .msg-shop-fail { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .msg-levelup { color: var(--purple-color); font-weight: bold; }
        .msg-reward { color: var(--gold-color); font-weight: bold; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-item-row label { flex-grow: 1; }
        .modal-item-row input[type="number"] {
            width: 70px;
            padding: 5px;
            text-align: right;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .modal-footer {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: #000; }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="app"></div>
    </div>

    <!-- Modal Template -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="close-btn" id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>

<script>
// =================================================================================
// ÈÅãÊ∞£Ë®ìÁ∑¥Â∑•ÂÖ∑ V9-0 - JavaScript Èõ¢Á∑öÁ∂≤È†ÅÁâà
// ‰ΩúËÄÖÔºöGemini (ÁßªÊ§çËá™‰ΩøÁî®ËÄÖÊèê‰æõÁöÑ Python ËÖ≥Êú¨)
// ÁâàÊú¨Ôºö1.2 - ‰øÆÊ≠£Ë®ìÁ∑¥Ê®°Âºè‰∏≠Á≠îÊ°à‰ΩçÁΩÆË¶èÂæãÊéíÂàóÁöÑÂïèÈ°åÔºåÂØ¶ÁèæÁúüÊ≠£Èö®Ê©ü„ÄÇ
// =================================================================================

document.addEventListener('DOMContentLoaded', () => {

// ===================== ÈÅäÊà≤Ê†∏ÂøÉË®≠ÂÆöËàáÊï∏Êìö (‰æÜËá™ Python) =====================
const SCORE_FILE = "max_scores"; // localStorage key
const STATS_FILE = "training_stats"; // localStorage key
// # ÁßòÂ¢ÉË©¶ÁÖâÊúÄÈ´òÂàÜË≥áÊñôÂÑ≤Â≠òÈçµÔºåÁî®ÊñºË®òÈåÑÁé©ÂÆ∂Âú®ÂêÑÈõ£Â∫¶ÁßòÂ¢ÉË©¶ÁÖâ‰∏≠ÁöÑÊúÄ‰Ω≥ÊàêÁ∏æ„ÄÇ
const TRIAL_SCORE_FILE = "max_trial_scores";

// # ÁßòÂ¢ÉË©¶ÁÖâÊúÄÈ´òÁ¥ÄÈåÑËºâÂÖ•ÂæåÂ≠òÊîæÊñºÊ≠§Áâ©‰ª∂ÔºåÊ†ºÂºèÈ°û‰ººÊñº maxScores: { difficulty: bestScore }
let maxTrialScores = {};

const DIFFICULTY_WIN_RATE = {1:90, 2:80, 3:65, 4:50, 5:35, 6:25, 7:15, 8:10, 9:7, 10:5};
const REDEEM_1_COST = 50;
const REDEEM_10_COST = 500;
const REDEEM_100_COST = 5000;
const REDEEM_1000_COST = 50000;
const STONE_EXCHANGE_COST = 100;
const STONE_100_EXCHANGE_COST = 10000;
const STONE_1000_EXCHANGE_COST = 100000;

const TRAINING_MILESTONES = {
    5: {"rewards": 1, "title": "1.ÂÆóÈñÄÁöÑÂü∫Áü≥"}, 10: {"rewards": 1, "title": "2.Ë¶ãÁøíÂºüÂ≠ê"}, 25: {"rewards": 2, "title": "3.Â§ñÈñÄÈõúÂΩπ"}, 50: {"rewards": 2, "title": "4.Â§ñÈñÄÂºüÂ≠ê"}, 75: {"rewards": 3, "title": "5.Â§ñÈñÄÂ∏´ÂÖÑ"}, 100: {"rewards": 5, "title": "6.Â§ñÈñÄËèÅËã±"}, 150: {"rewards": 3, "title": "7.ÂÖßÈñÄÂÄôË£ú"}, 200: {"rewards": 4, "title": "8.ÂÖßÈñÄÂºüÂ≠ê"}, 300: {"rewards": 5, "title": "9.ÂÖßÈñÄÂ∏´ÂÖÑ"}, 400: {"rewards": 5, "title": "10.ÂÖßÈñÄËèÅËã±"}, 500: {"rewards": 10, "title": "11.ÂÆóÈñÄÂü∑‰∫ã"}, 600: {"rewards": 5, "title": "12.‰ªªÂãôÂ†ÇÂºüÂ≠ê"}, 700: {"rewards": 5, "title": "13.ÂÇ≥Ê≥ïÂ†ÇÂºüÂ≠ê"}, 800: {"rewards": 5, "title": "14.ÁÖâ‰∏πÈñ£ÂºüÂ≠ê"}, 900: {"rewards": 5, "title": "15.ÁÖâÂô®ÂùäÂºüÂ≠ê"}, 1000: {"rewards": 15, "title": "16.Ë¶™ÂÇ≥ÂºüÂ≠ê"}, 1200: {"rewards": 6, "title": "17.ÊàíÂæãÂ†ÇÂü∑‰∫ã"}, 1400: {"rewards": 6, "title": "18.ËóèÁ∂ìÈñ£Âü∑‰∫ã"}, 1600: {"rewards": 6, "title": "19.ÁôæËçâÂúíÁÆ°‰∫ã"}, 1800: {"rewards": 6, "title": "20.Ëê¨Áç∏Â±±ÁÆ°‰∫ã"}, 2000: {"rewards": 20, "title": "21.È¶ñÂ∏≠Â§ßÂºüÂ≠ê"}, 2500: {"rewards": 10, "title": "22.‰ªªÂãôÂ†ÇÈï∑ËÄÅ"}, 3000: {"rewards": 10, "title": "23.ÂÇ≥Ê≥ïÂ†ÇÈï∑ËÄÅ"}, 3500: {"rewards": 10, "title": "24.ÁÖâ‰∏πÈñ£Èï∑ËÄÅ"}, 4000: {"rewards": 10, "title": "25.ÁÖâÂô®ÂùäÈï∑ËÄÅ"}, 5000: {"rewards": 25, "title": "26.ÂÆóÈñÄÈï∑ËÄÅ"}, 6000: {"rewards": 12, "title": "27.ÂàëÊ≥ïÈï∑ËÄÅ"}, 7000: {"rewards": 12, "title": "28.ÂÇ≥ÂäüÈï∑ËÄÅ"}, 8000: {"rewards": 12, "title": "29.ÂÆ¢ÂçøÈï∑ËÄÅ"}, 9000: {"rewards": 12, "title": "30.Â∑°Â±±Èï∑ËÄÅ"}, 10000: {"rewards": 30, "title": "31.ÂÆóÈñÄË≠∑Ê≥ï"}, 12500: {"rewards": 15, "title": "32.‰∏πÈÅìÂ≥∞‰∏ª"}, 15000: {"rewards": 15, "title": "33.Âô®ÈÅìÂ≥∞‰∏ª"}, 17500: {"rewards": 15, "title": "34.ÂäçÈÅìÂ≥∞‰∏ª"}, 20000: {"rewards": 40, "title": "35.Â§™‰∏äÈï∑ËÄÅ"}, 25000: {"rewards": 20, "title": "36.ÂÆóÈñÄËÅñÂ≠ê"}, 30000: {"rewards": 20, "title": "37.ÂÆóÈñÄËÅñÂ•≥"}, 35000: {"rewards": 20, "title": "38.Ë°åËµ∞ÁöÑÂÇ≥Ë™™"}, 40000: {"rewards": 20, "title": "39.Ë≠∑ÈÅì‰∫∫"}, 50000: {"rewards": 50, "title": "40.‰ª£ÂÆó‰∏ª"}, 60000: {"rewards": 25, "title": "41.ÈéÆÊ¥æËÄÅÁ•ñ"}, 70000: {"rewards": 25, "title": "42.ÈñãÊ¥æÁ•ñÂ∏´"}, 80000: {"rewards": 25, "title": "43.Ê∏°Âä´Áúü‰ªô"}, 90000: {"rewards": 25, "title": "44.È£õÂçá‰πã‰∫∫"}, 100000: {"rewards": 100, "title": "45.‰∫∫Èñì‰πãÁ•û"}, 120000: {"rewards": 50, "title": "46.Â§©ÁïåË°åËÄÖ"}, 140000: {"rewards": 50, "title": "47.ÊòüÁïåÈÅäÁ•û"}, 160000: {"rewards": 50, "title": "48.‰ΩçÈù¢‰πã‰∏ª"}, 180000: {"rewards": 50, "title": "49.ÊôÇÁ©∫ÊóÖËÄÖ"}, 200000: {"rewards": 100, "title": "50.Ëê¨Âè§ÂÇ≥Ë™™"}, 250000: {"rewards": 100, "title": "51.Âõ†Êûú‰πãÊâã"}, 300000: {"rewards": 100, "title": "52.ÂëΩÈÅãÁ∑®ÁπîËÄÖ"}, 400000: {"rewards": 100, "title": "53Ë¶èÂâáÂà∂ÂÆöËÄÖ"}, 500000: {"rewards": 100, "title": "54.Â§ßÈÅì‰πãÊ∫ê"}, 1000000: {"rewards": 500, "title": "55.ÁµÇÊ•µÈÄ†Áâ©‰∏ª"},
};

const CULTIVATION_STAGES = (() => {
    let stages = [[0, 0, "Âá°‰∫∫ÂàùÂÖ•ÈÅì"]];
    const LEVELS_PER_STAGE = 10;
    const score_cycle = Object.values(DIFFICULTY_WIN_RATE);
    let base_need_exp = 0;
    let need_step = 10;
    const stage_names = ["1.Âá°‰∫∫", "2.Á∑¥Ê∞£", "3.ÁØâÂü∫", "4.Áµê‰∏π", "5.ÂÖÉÂ¨∞", "6.ÂåñÁ•û", "7.ÁÖâËôõ", "8.ÂêàÈ´î", "9.Â§ß‰πò", "10.Ê∏°Âä´", "11.Áúü‰ªô", "12.Èáë‰ªô", "13.Â§™‰πôÈáë‰ªô", "14.Â§ßÁæÖÈáë‰ªô", "15.Ê∑∑ÂÖÉÂ§ßÁæÖ", "16.‰ªôÁéã", "17.‰ªôÂ∏ù", "18.Â§©Â∞ä", "19.Á•ñ‰ªô", "20.ÁÑ°‰∏ä", "21.Ë∂ÖËÑ´Ëº™Ëø¥", "22.ÁÑ°‰∏äÊ•µÂ¢É", "23.Ê∑∑Ê≤åÁÑ°Ê•µ", "24.Â§ßÈÅìÊ≠∏‰∏Ä", "25.ÂÆáÂÆô‰πã‰∏ª", "26.Ââµ‰∏ñÁúüÁ•û", "27.ÁïåÂ§ñÂ§©Â∞ä", "28.Ê∑∑ÂÖÉÈÅìÂ∞ä", "29.ÂßãÊ∫êÂ∏ùÂ∞ä", "30.Â§™ÂàùËÅñÁöá", "31.Ê∞∏ÊÅÜ‰πãÁ•û", "32.Ê∑∑Ê≤å‰∏ªÂÆ∞", "33.Ëê¨ÈÅìÊ≠∏ÂÆó", "34.ÁµÇÊ•µÈÄ†Áâ©‰∏ª", "35.ÁÑ°ÈôêÊ∞∏Â≠òËÄÖ", "36.Ë∂ÖÁ∂≠ËßÄÂØüËÄÖ", "37.Ë∂ÖË∂äËÄÖ", "38.ÁúüÁêÜÂåñË∫´", "39.ËôõÁÑ°‰πãÁ•û", "40.Áïå‰∏äÁïå‰∏ª", "41.ÂîØ‰∏ÄÁúüÁ•û","42.Â§™‰∏äÈÅìÁ•ñ","43.Ê∞∏Âä´‰∏çÊúΩ","44.ÁÑ°Ê•µÊú¨Ê∫ê","45.Â§öÂÖÉÂΩºÂ≤∏‰∏ª","46.ÂéüÂàùÊÑèÂøó", "47.Ëê¨ÁïåÂßãÁ•ñ","48.ÁµÇÁÑâÂâµ‰∏ñËÄÖ","49.ÁµïÂ∞çÁúüÁêÜ","50.Ë∂ÖË∂äÂîØ‰∏Ä","51.Ê∞∏ÊÅÜÁéãÂ∫ß"];
    stage_names.forEach(stage => {
        for (let sub = 1; sub <= LEVELS_PER_STAGE; sub++) {
            base_need_exp += need_step;
            const need_score = score_cycle[stages.length % score_cycle.length];
            stages.push([base_need_exp, need_score, `${stage}${sub}Â±§`]);
        }
        need_step = Math.max(need_step + 1, Math.floor(need_step * 1.5));
    });
    return stages;
})();

const GRADE_NAMES = ["ÂÖ•ÂìÅ", "‰∏ãÂìÅ", "‰∏≠ÂìÅ", "‰∏äÂìÅ", "Ê•µÂìÅ", "Ë∂ÖÂìÅ", "ÁµïÂìÅ", "ÂØ∂ÂìÅ", "Âú∞ÂìÅ", "Â§©ÂìÅ"];
const ITEM_TYPE_ORDER = ['ÂÖµÂô®', 'ÂäüÊ≥ï', 'Èô£Ê≥ï', '‰ªô‰∏π', 'ÈùàÂô®', 'ÈùàÁ¨¶'];

const WEAPONS = {
    "ÂÖ•ÂìÅÈùíÁ´πÂäç": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "Â¢ûÂä†1Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÂÖ•ÂìÅÈäÖËÉåÂàÄ": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "Â¢ûÂä†1Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÂÖ•ÂìÅÁ¢éÈõ≤Êßç": {"type": "multi_choice", "n": 1, "exp_cost": 100, "upgrade_cost": 2000, "desc": "Â¢ûÂä†1Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "‰∏ãÂìÅÂØíÈãíÂäç": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "Â¢ûÂä†2Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏ãÂìÅË£ÇÁü≥ÂàÄ": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "Â¢ûÂä†2Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏ãÂìÅÊ∏∏ÈæçÊßç": {"type": "multi_choice", "n": 2, "exp_cost": 200, "upgrade_cost": 4000, "desc": "Â¢ûÂä†2Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "‰∏≠ÂìÅÈùíÈúúÂäç": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "Â¢ûÂä†3Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏≠ÂìÅËµ§ÁÑ∞ÂàÄ": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "Â¢ûÂä†3Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏≠ÂìÅÈúÜÁΩ°Êßç": {"type": "multi_choice", "n": 3, "exp_cost": 400, "upgrade_cost": 8000, "desc": "Â¢ûÂä†3Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "‰∏äÂìÅÊµÅÂÖâÂäç": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "Â¢ûÂä†4Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏äÂìÅËíºÈØ®ÂàÄ": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "Â¢ûÂä†4Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "‰∏äÂìÅÁ†¥ËªçÊßç": {"type": "multi_choice", "n": 4, "exp_cost": 800, "upgrade_cost": 16000, "desc": "Â¢ûÂä†4Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "Ê•µÂìÅÈõ¢ÁÅ´È£õÂäç": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "Â¢ûÂä†5Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Ê•µÂìÅÁéÑÂÜ•È¨ºÂàÄ": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "Â¢ûÂä†5Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Ê•µÂìÅÁ¥´ÈõªÁ•ûÊßç": {"type": "multi_choice", "n": 5, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "Â¢ûÂä†5Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "Ë∂ÖÂìÅÂ§™ËôõÂäçËÉö": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "Â¢ûÂä†6Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Ë∂ÖÂìÅÁÑ°Áõ∏ÂàÄËÉé": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "Â¢ûÂä†6Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Ë∂ÖÂìÅÂ§©ÁΩ°ÊßçÈ≠Ç": {"type": "multi_choice", "n": 6, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "Â¢ûÂä†6Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "ÁµïÂìÅÂ§™ÁôΩÊòüÂäç": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "Â¢ûÂä†7Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÁµïÂìÅÁéÑÊ≠¶ÈéÆÊµ∑ÂàÄ": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "Â¢ûÂä†7Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÁµïÂìÅÈùíÈæçÈ©öÈõ∑Êßç": {"type": "multi_choice", "n": 7, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "Â¢ûÂä†7Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "ÂØ∂ÂìÅÊá∏Â§©È£õ‰ªôÂäç": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "Â¢ûÂä†8Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÂØ∂ÂìÅÊàÆÁ•ûË°ÄÊúàÂàÄ": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "Â¢ûÂä†8Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "ÂØ∂ÂìÅÁ†¥ÁïåÈéèÈáëÊßç": {"type": "multi_choice", "n": 8, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "Â¢ûÂä†8Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "Âú∞ÂìÅÂ¥ëÂ¥ôÊñ¨ÈÇ™Âäç": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "Â¢ûÂä†9Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Âú∞ÂìÅÂéöÂúüÈéÆÂ≤≥ÂàÄ": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "Â¢ûÂä†9Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Âú∞ÂìÅÂæåÂúüË™ìÁõüÊßç": {"type": "multi_choice", "n": 9, "exp_cost": 25600, "upgrade_cost": 512000, "desc": "Â¢ûÂä†9Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
    "Â§©ÂìÅÂ§™Ê∏ÖË™Ö‰ªôÂäç": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "Â¢ûÂä†10Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Â§©ÂìÅÂ§©ÈÅìÂØ©ÂàëÂàÄ": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "Â¢ûÂä†10Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"}, "Â§©ÂìÅ‰πæÂù§ÂÆöÊµ∑Êßç": {"type": "multi_choice", "n": 10, "exp_cost": 51200, "upgrade_cost": 0, "desc": "Â¢ûÂä†10Ê¨°‰ΩúÁ≠îÊ¨°Êï∏"},
};
const TECHNIQUES = {
    "ÂÖ•ÂìÅÁØâÂü∫ÂêêÁ¥çË®£": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "È°ØÁèæ1ÂÄãÈåØË™§Á≠îÊ°à"}, "ÂÖ•ÂìÅÊùæÈπ§Èï∑ÈùíÂäü": {"type": "reveal_wrong", "n": 1, "exp_cost": 0, "upgrade_cost": 1000, "desc": "È°ØÁèæ1ÂÄãÈåØË™§Á≠îÊ°à"},
    "‰∏ãÂìÅÂ∞èÂë®Â§©Ë°åÊ∞£": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "È°ØÁèæ2ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏ãÂìÅÈùíÊú®È§äÂÖÉË°ì": {"type": "reveal_wrong", "n": 2, "exp_cost": 100, "upgrade_cost": 2000, "desc": "È°ØÁèæ2ÂÄãÈåØË™§Á≠îÊ°à"},
    "‰∏≠ÂìÅÁéÑÊÅØÊ≠∏‰∏ÄË®£": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "È°ØÁèæ3ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏≠ÂìÅËµ§ÈôΩÁÖâÈ´îÁØá": {"type": "reveal_wrong", "n": 3, "exp_cost": 200, "upgrade_cost": 4000, "desc": "È°ØÁèæ3ÂÄãÈåØË™§Á≠îÊ°à"},
    "‰∏äÂìÅ‰∏âËä±ËÅöÈ†ÇË®£": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "È°ØÁèæ4ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏äÂìÅÁ¥´Â∫úÈÇÑÁúüÁ∂ì": {"type": "reveal_wrong", "n": 4, "exp_cost": 400, "upgrade_cost": 8000, "desc": "È°ØÁèæ4ÂÄãÈåØË™§Á≠îÊ°à"},
    "Ê•µÂìÅÂ§™Èô∞ÁÖâÊúàÁ∂ì": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "È°ØÁèæ5ÂÄãÈåØË™§Á≠îÊ°à"}, "Ê•µÂìÅÈõ¢ÁÅ´ÂÜ•Èõ∑Á∂ì": {"type": "reveal_wrong", "n": 5, "exp_cost": 800, "upgrade_cost": 16000, "desc": "È°ØÁèæ5ÂÄãÈåØË™§Á≠îÊ°à"},
    "Ë∂ÖÂìÅÂ§™‰πôÊ≠∏ÂÖÉÁ∂ì": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "È°ØÁèæ6ÂÄãÈåØË™§Á≠îÊ°à"}, "Ë∂ÖÂìÅÁÑ°Áõ∏ÁéÑÂäü": {"type": "reveal_wrong", "n": 6, "exp_cost": 1600, "upgrade_cost": 32000, "desc": "È°ØÁèæ6ÂÄãÈåØË™§Á≠îÊ°à"},
    "ÁµïÂìÅ‰πùËΩâÈáëË∫´Ë®£": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "È°ØÁèæ7ÂÄãÈåØË™§Á≠îÊ°à"}, "ÁµïÂìÅ‰∫îÈõ∑Ê≠£Ê≥ï": {"type": "reveal_wrong", "n": 7, "exp_cost": 3200, "upgrade_cost": 64000, "desc": "È°ØÁèæ7ÂÄãÈåØË™§Á≠îÊ°à"},
    "ÂØ∂ÂìÅÊ¥ûÂ§©ÈÄ†ÂåñÁ∂ì": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "È°ØÁèæ8ÂÄãÈåØË™§Á≠îÊ°à"}, "ÂØ∂ÂìÅÂÖàÂ§©‰∏ÄÁÇÅË®£": {"type": "reveal_wrong", "n": 8, "exp_cost": 6400, "upgrade_cost": 128000, "desc": "È°ØÁèæ8ÂÄãÈåØË™§Á≠îÊ°à"},
    "Âú∞ÂìÅÂú∞ËóèÂÜ•ÂøÉÁ∂ì": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "È°ØÁèæ9ÂÄãÈåØË™§Á≠îÊ°à"}, "Âú∞ÂìÅÂéöÂúüÁÑ°ÁñÜË®£": {"type": "reveal_wrong", "n": 9, "exp_cost": 12800, "upgrade_cost": 256000, "desc": "È°ØÁèæ9ÂÄãÈåØË™§Á≠îÊ°à"},
    "Â§©ÂìÅÂ§ßÈÅìÊ∑∑ÂÖÉËóè": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "È°ØÁèæ10ÂÄãÈåØË™§Á≠îÊ°à"}, "Â§©ÂìÅÁÑ°Ê•µÊú¨Ê∫êÁ∂ì": {"type": "reveal_wrong", "n": 10, "exp_cost": 25600, "upgrade_cost": 0, "desc": "È°ØÁèæ10ÂÄãÈåØË™§Á≠îÊ°à"},
};
const FORMATIONS = {
    "ÂÖ•ÂìÅ‰∏âÊâçËÅöÈùàÈô£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "Â¢ûÂä†1Áßí‰ΩúÁ≠îÊôÇÈñì"}, "ÂÖ•ÂìÅÂõõÈñÄÈô∑ÊïµÈô£": {"type": "add_time", "n": 1, "exp_cost": 10, "upgrade_cost": 200, "desc": "Â¢ûÂä†1Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "‰∏ãÂìÅ‰∫îË°åË≠∑Â±±Èô£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "Â¢ûÂä†2Áßí‰ΩúÁ≠îÊôÇÈñì"}, "‰∏ãÂìÅÂÖ≠Áî≤Ëø∑Ë∏™Èô£": {"type": "add_time", "n": 2, "exp_cost": 20, "upgrade_cost": 400, "desc": "Â¢ûÂä†2Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "‰∏≠ÂìÅ‰∏ÉÊõúÊòüÈñÄÈô£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "Â¢ûÂä†3Áßí‰ΩúÁ≠îÊôÇÈñì"}, "‰∏≠ÂìÅÂÖ´ÈñÄÈáëÈéñÈô£": {"type": "add_time", "n": 3, "exp_cost": 40, "upgrade_cost": 800, "desc": "Â¢ûÂä†3Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "‰∏äÂìÅ‰πùÂÆÆÂπªÂ§©Èô£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "Â¢ûÂä†4Áßí‰ΩúÁ≠îÊôÇÈñì"}, "‰∏äÂìÅÂçÅ‰∫åÂ§©ÁΩ°Èô£": {"type": "add_time", "n": 4, "exp_cost": 80, "upgrade_cost": 1600, "desc": "Â¢ûÂä†4Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "Ê•µÂìÅÁéÑÊ≠¶ÈéÆÊµ∑Èô£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "Â¢ûÂä†5Áßí‰ΩúÁ≠îÊôÇÈñì"}, "Ê•µÂìÅÁôΩËôéË£ÇÂ§©Èô£": {"type": "add_time", "n": 5, "exp_cost": 160, "upgrade_cost": 3200, "desc": "Â¢ûÂä†5Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "Ë∂ÖÂìÅÈùíÈæçÈ®∞Èõ≤Èô£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "Â¢ûÂä†6Áßí‰ΩúÁ≠îÊôÇÈñì"}, "Ë∂ÖÂìÅÊú±ÈõÄÁÑöÂ§©Èô£": {"type": "add_time", "n": 6, "exp_cost": 320, "upgrade_cost": 6400, "desc": "Â¢ûÂä†6Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "ÁµïÂìÅÂõõË±°Âêà‰∏ÄÈéÆÂüüÈô£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "Â¢ûÂä†7Áßí‰ΩúÁ≠îÊôÇÈñì"}, "ÁµïÂìÅÂ§™‰πôÊ∑∑ÂÖÉÂ∞ÅÂ§©Èô£": {"type": "add_time", "n": 7, "exp_cost": 640, "upgrade_cost": 12800, "desc": "Â¢ûÂä†7Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "ÂØ∂ÂìÅËê¨ÈùàÊ≠∏Ê∫êÈô£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "Â¢ûÂä†8Áßí‰ΩúÁ≠îÊôÇÈñì"}, "ÂØ∂ÂìÅÂÖàÂ§©ÂÖ©ÂÑÄÂèçÊºîÈô£": {"type": "add_time", "n": 8, "exp_cost": 1280, "upgrade_cost": 25600, "desc": "Â¢ûÂä†8Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "Âú∞ÂìÅ‰πùÂú∞ÈéÆÈ≠îÂ§ßÈô£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "Â¢ûÂä†9Áßí‰ΩúÁ≠îÊôÇÈñì"}, "Âú∞ÂìÅÂéöÂúüÊ≠∏Â¢üÈô£": {"type": "add_time", "n": 9, "exp_cost": 2560, "upgrade_cost": 51200, "desc": "Â¢ûÂä†9Áßí‰ΩúÁ≠îÊôÇÈñì"},
    "Â§©ÂìÅÂÖàÂ§©‰∏ÄÁÇÅÂåñÂä´Â§ßÈô£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "Â¢ûÂä†10Áßí‰ΩúÁ≠îÊôÇÈñì"}, "Â§©ÂìÅÁÑ°Ê•µ‰πæÂù§ÁïåÂüüÈô£": {"type": "add_time", "n": 10, "exp_cost": 5120, "upgrade_cost": 0, "desc": "Â¢ûÂä†10Áßí‰ΩúÁ≠îÊôÇÈñì"},
};

const UPGRADE_PATHS = {
    "ÂÖ•ÂìÅÈùíÁ´πÂäç": "‰∏ãÂìÅÂØíÈãíÂäç", "‰∏ãÂìÅÂØíÈãíÂäç": "‰∏≠ÂìÅÈùíÈúúÂäç", "‰∏≠ÂìÅÈùíÈúúÂäç": "‰∏äÂìÅÊµÅÂÖâÂäç", "‰∏äÂìÅÊµÅÂÖâÂäç": "Ê•µÂìÅÈõ¢ÁÅ´È£õÂäç", "Ê•µÂìÅÈõ¢ÁÅ´È£õÂäç": "Ë∂ÖÂìÅÂ§™ËôõÂäçËÉö", "Ë∂ÖÂìÅÂ§™ËôõÂäçËÉö": "ÁµïÂìÅÂ§™ÁôΩÊòüÂäç", "ÁµïÂìÅÂ§™ÁôΩÊòüÂäç": "ÂØ∂ÂìÅÊá∏Â§©È£õ‰ªôÂäç", "ÂØ∂ÂìÅÊá∏Â§©È£õ‰ªôÂäç": "Âú∞ÂìÅÂ¥ëÂ¥ôÊñ¨ÈÇ™Âäç", "Âú∞ÂìÅÂ¥ëÂ¥ôÊñ¨ÈÇ™Âäç": "Â§©ÂìÅÂ§™Ê∏ÖË™Ö‰ªôÂäç",
    "ÂÖ•ÂìÅÈäÖËÉåÂàÄ": "‰∏ãÂìÅË£ÇÁü≥ÂàÄ", "‰∏ãÂìÅË£ÇÁü≥ÂàÄ": "‰∏≠ÂìÅËµ§ÁÑ∞ÂàÄ", "‰∏≠ÂìÅËµ§ÁÑ∞ÂàÄ": "‰∏äÂìÅËíºÈØ®ÂàÄ", "‰∏äÂìÅËíºÈØ®ÂàÄ": "Ê•µÂìÅÁéÑÂÜ•È¨ºÂàÄ", "Ê•µÂìÅÁéÑÂÜ•È¨ºÂàÄ": "Ë∂ÖÂìÅÁÑ°Áõ∏ÂàÄËÉé", "Ë∂ÖÂìÅÁÑ°Áõ∏ÂàÄËÉé": "ÁµïÂìÅÁéÑÊ≠¶ÈéÆÊµ∑ÂàÄ", "ÁµïÂìÅÁéÑÊ≠¶ÈéÆÊµ∑ÂàÄ": "ÂØ∂ÂìÅÊàÆÁ•ûË°ÄÊúàÂàÄ", "ÂØ∂ÂìÅÊàÆÁ•ûË°ÄÊúàÂàÄ": "Âú∞ÂìÅÂéöÂúüÈéÆÂ≤≥ÂàÄ", "Âú∞ÂìÅÂéöÂúüÈéÆÂ≤≥ÂàÄ": "Â§©ÂìÅÂ§©ÈÅìÂØ©ÂàëÂàÄ",
    "ÂÖ•ÂìÅÁ¢éÈõ≤Êßç": "‰∏ãÂìÅÊ∏∏ÈæçÊßç", "‰∏ãÂìÅÊ∏∏ÈæçÊßç": "‰∏≠ÂìÅÈúÜÁΩ°Êßç", "‰∏≠ÂìÅÈúÜÁΩ°Êßç": "‰∏äÂìÅÁ†¥ËªçÊßç", "‰∏äÂìÅÁ†¥ËªçÊßç": "Ê•µÂìÅÁ¥´ÈõªÁ•ûÊßç", "Ê•µÂìÅÁ¥´ÈõªÁ•ûÊßç": "Ë∂ÖÂìÅÂ§©ÁΩ°ÊßçÈ≠Ç", "Ë∂ÖÂìÅÂ§©ÁΩ°ÊßçÈ≠Ç": "ÁµïÂìÅÈùíÈæçÈ©öÈõ∑Êßç", "ÁµïÂìÅÈùíÈæçÈ©öÈõ∑Êßç": "ÂØ∂ÂìÅÁ†¥ÁïåÈéèÈáëÊßç", "ÂØ∂ÂìÅÁ†¥ÁïåÈéèÈáëÊßç": "Âú∞ÂìÅÂæåÂúüË™ìÁõüÊßç", "Âú∞ÂìÅÂæåÂúüË™ìÁõüÊßç": "Â§©ÂìÅ‰πæÂù§ÂÆöÊµ∑Êßç",
    "ÂÖ•ÂìÅÁØâÂü∫ÂêêÁ¥çË®£": "‰∏ãÂìÅÂ∞èÂë®Â§©Ë°åÊ∞£", "‰∏ãÂìÅÂ∞èÂë®Â§©Ë°åÊ∞£": "‰∏≠ÂìÅÁéÑÊÅØÊ≠∏‰∏ÄË®£", "‰∏≠ÂìÅÁéÑÊÅØÊ≠∏‰∏ÄË®£": "‰∏äÂìÅ‰∏âËä±ËÅöÈ†ÇË®£", "‰∏äÂìÅ‰∏âËä±ËÅöÈ†ÇË®£": "Ê•µÂìÅÂ§™Èô∞ÁÖâÊúàÁ∂ì", "Ê•µÂìÅÂ§™Èô∞ÁÖâÊúàÁ∂ì": "Ë∂ÖÂìÅÂ§™‰πôÊ≠∏ÂÖÉÁ∂ì", "Ë∂ÖÂìÅÂ§™‰πôÊ≠∏ÂÖÉÁ∂ì": "ÁµïÂìÅ‰πùËΩâÈáëË∫´Ë®£", "ÁµïÂìÅ‰πùËΩâÈáëË∫´Ë®£": "ÂØ∂ÂìÅÊ¥ûÂ§©ÈÄ†ÂåñÁ∂ì", "ÂØ∂ÂìÅÊ¥ûÂ§©ÈÄ†ÂåñÁ∂ì": "Âú∞ÂìÅÂú∞ËóèÂÜ•ÂøÉÁ∂ì", "Âú∞ÂìÅÂú∞ËóèÂÜ•ÂøÉÁ∂ì": "Â§©ÂìÅÂ§ßÈÅìÊ∑∑ÂÖÉËóè",
    "ÂÖ•ÂìÅÊùæÈπ§Èï∑ÈùíÂäü": "‰∏ãÂìÅÈùíÊú®È§äÂÖÉË°ì", "‰∏ãÂìÅÈùíÊú®È§äÂÖÉË°ì": "‰∏≠ÂìÅËµ§ÈôΩÁÖâÈ´îÁØá", "‰∏≠ÂìÅËµ§ÈôΩÁÖâÈ´îÁØá": "‰∏äÂìÅÁ¥´Â∫úÈÇÑÁúüÁ∂ì", "‰∏äÂìÅÁ¥´Â∫úÈÇÑÁúüÁ∂ì": "Ê•µÂìÅÈõ¢ÁÅ´ÂÜ•Èõ∑Á∂ì", "Ê•µÂìÅÈõ¢ÁÅ´ÂÜ•Èõ∑Á∂ì": "Ë∂ÖÂìÅÁÑ°Áõ∏ÁéÑÂäü", "Ë∂ÖÂìÅÁÑ°Áõ∏ÁéÑÂäü": "ÁµïÂìÅ‰∫îÈõ∑Ê≠£Ê≥ï", "ÁµïÂìÅ‰∫îÈõ∑Ê≠£Ê≥ï": "ÂØ∂ÂìÅÂÖàÂ§©‰∏ÄÁÇÅË®£", "ÂØ∂ÂìÅÂÖàÂ§©‰∏ÄÁÇÅË®£": "Âú∞ÂìÅÂéöÂúüÁÑ°ÁñÜË®£", "Âú∞ÂìÅÂéöÂúüÁÑ°ÁñÜË®£": "Â§©ÂìÅÁÑ°Ê•µÊú¨Ê∫êÁ∂ì",
    "ÂÖ•ÂìÅ‰∏âÊâçËÅöÈùàÈô£": "‰∏ãÂìÅ‰∫îË°åË≠∑Â±±Èô£", "‰∏ãÂìÅ‰∫îË°åË≠∑Â±±Èô£": "‰∏≠ÂìÅ‰∏ÉÊõúÊòüÈñÄÈô£", "‰∏≠ÂìÅ‰∏ÉÊõúÊòüÈñÄÈô£": "‰∏äÂìÅ‰πùÂÆÆÂπªÂ§©Èô£", "‰∏äÂìÅ‰πùÂÆÆÂπªÂ§©Èô£": "Ê•µÂìÅÁéÑÊ≠¶ÈéÆÊµ∑Èô£", "Ê•µÂìÅÁéÑÊ≠¶ÈéÆÊµ∑Èô£": "Ë∂ÖÂìÅÈùíÈæçÈ®∞Èõ≤Èô£", "Ë∂ÖÂìÅÈùíÈæçÈ®∞Èõ≤Èô£": "ÁµïÂìÅÂõõË±°Âêà‰∏ÄÈéÆÂüüÈô£", "ÁµïÂìÅÂõõË±°Âêà‰∏ÄÈéÆÂüüÈô£": "ÂØ∂ÂìÅËê¨ÈùàÊ≠∏Ê∫êÈô£", "ÂØ∂ÂìÅËê¨ÈùàÊ≠∏Ê∫êÈô£": "Âú∞ÂìÅ‰πùÂú∞ÈéÆÈ≠îÂ§ßÈô£", "Âú∞ÂìÅ‰πùÂú∞ÈéÆÈ≠îÂ§ßÈô£": "Â§©ÂìÅÂÖàÂ§©‰∏ÄÁÇÅÂåñÂä´Â§ßÈô£",
    "ÂÖ•ÂìÅÂõõÈñÄÈô∑ÊïµÈô£": "‰∏ãÂìÅÂÖ≠Áî≤Ëø∑Ë∏™Èô£", "‰∏ãÂìÅÂÖ≠Áî≤Ëø∑Ë∏™Èô£": "‰∏≠ÂìÅÂÖ´ÈñÄÈáëÈéñÈô£", "‰∏≠ÂìÅÂÖ´ÈñÄÈáëÈéñÈô£": "‰∏äÂìÅÂçÅ‰∫åÂ§©ÁΩ°Èô£", "‰∏äÂìÅÂçÅ‰∫åÂ§©ÁΩ°Èô£": "Ê•µÂìÅÁôΩËôéË£ÇÂ§©Èô£", "Ê•µÂìÅÁôΩËôéË£ÇÂ§©Èô£": "Ë∂ÖÂìÅÊú±ÈõÄÁÑöÂ§©Èô£", "Ë∂ÖÂìÅÊú±ÈõÄÁÑöÂ§©Èô£": "ÁµïÂìÅÂ§™‰πôÊ∑∑ÂÖÉÂ∞ÅÂ§©Èô£", "ÁµïÂìÅÂ§™‰πôÊ∑∑ÂÖÉÂ∞ÅÂ§©Èô£": "ÂØ∂ÂìÅÂÖàÂ§©ÂÖ©ÂÑÄÂèçÊºîÈô£", "ÂØ∂ÂìÅÂÖàÂ§©ÂÖ©ÂÑÄÂèçÊºîÈô£": "Âú∞ÂìÅÂéöÂúüÊ≠∏Â¢üÈô£", "Âú∞ÂìÅÂéöÂúüÊ≠∏Â¢üÈô£": "Â§©ÂìÅÁÑ°Ê•µ‰πæÂù§ÁïåÂüüÈô£",
};

const ITEM_EFFECTS = {
    "ÂÖ•ÂìÅ‰ªô‰∏π": {"type": "exp", "n": 10, "desc": "Â¢ûÂä† 10 ‰øÆÁÖâÁ∂ìÈ©ó"}, "‰∏ãÂìÅ‰ªô‰∏π": {"type": "exp", "n": 30, "desc": "Â¢ûÂä† 30 ‰øÆÁÖâÁ∂ìÈ©ó"}, "‰∏≠ÂìÅ‰ªô‰∏π": {"type": "exp", "n": 70, "desc": "Â¢ûÂä† 70 ‰øÆÁÖâÁ∂ìÈ©ó"}, "‰∏äÂìÅ‰ªô‰∏π": {"type": "exp", "n": 150, "desc": "Â¢ûÂä† 150 ‰øÆÁÖâÁ∂ìÈ©ó"}, "Ê•µÂìÅ‰ªô‰∏π": {"type": "exp", "n": 310, "desc": "Â¢ûÂä† 310 ‰øÆÁÖâÁ∂ìÈ©ó"}, "Ë∂ÖÂìÅ‰ªô‰∏π": {"type": "exp", "n": 630, "desc": "Â¢ûÂä† 630 ‰øÆÁÖâÁ∂ìÈ©ó"}, "ÁµïÂìÅ‰ªô‰∏π": {"type": "exp", "n": 1270, "desc": "Â¢ûÂä† 1270 ‰øÆÁÖâÁ∂ìÈ©ó"}, "ÂØ∂ÂìÅ‰ªô‰∏π": {"type": "exp", "n": 2550, "desc": "Â¢ûÂä† 2550 ‰øÆÁÖâÁ∂ìÈ©ó"}, "Âú∞ÂìÅ‰ªô‰∏π": {"type": "exp", "n": 5110, "desc": "Â¢ûÂä† 5110 ‰øÆÁÖâÁ∂ìÈ©ó"}, "Â§©ÂìÅ‰ªô‰∏π": {"type": "exp", "n": 10230, "desc": "Â¢ûÂä† 10230 ‰øÆÁÖâÁ∂ìÈ©ó"},
    "ÂÖ•ÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 1, "desc": "ÊéíÈô§ 1 ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏ãÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 2, "desc": "ÊéíÈô§ 2 ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏≠ÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 3, "desc": "ÊéíÈô§ 3 ÂÄãÈåØË™§Á≠îÊ°à"}, "‰∏äÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 4, "desc": "ÊéíÈô§ 4 ÂÄãÈåØË™§Á≠îÊ°à"}, "Ê•µÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 5, "desc": "ÊéíÈô§ 5 ÂÄãÈåØË™§Á≠îÊ°à"}, "Ë∂ÖÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 6, "desc": "ÊéíÈô§ 6 ÂÄãÈåØË™§Á≠îÊ°à"}, "ÁµïÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 7, "desc": "ÊéíÈô§ 7 ÂÄãÈåØË™§Á≠îÊ°à"}, "ÂØ∂ÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 8, "desc": "ÊéíÈô§ 8 ÂÄãÈåØË™§Á≠îÊ°à"}, "Âú∞ÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 9, "desc": "ÊéíÈô§ 9 ÂÄãÈåØË™§Á≠îÊ°à"}, "Â§©ÂìÅÈùàÁ¨¶": {"type": "wrong", "n": 10, "desc": "ÊéíÈô§ 10 ÂÄãÈåØË™§Á≠îÊ°à"},
    "ÂÖ•ÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "‰∏ãÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "‰∏≠ÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "‰∏äÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "Ê•µÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "Ë∂ÖÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "ÁµïÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "ÂØ∂ÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "Âú∞ÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"}, "Â§©ÂìÅÈùàÂô®": {"type": "correct", "n": 0, "desc": "È°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à"},
    ...WEAPONS, ...TECHNIQUES, ...FORMATIONS
};

const ITEM_STONE_PRICES = {
    "ÂÖ•ÂìÅ‰ªô‰∏π": 3, "‰∏ãÂìÅ‰ªô‰∏π": 6, "‰∏≠ÂìÅ‰ªô‰∏π": 12, "‰∏äÂìÅ‰ªô‰∏π": 24, "Ê•µÂìÅ‰ªô‰∏π": 48, "Ë∂ÖÂìÅ‰ªô‰∏π": 96, "ÁµïÂìÅ‰ªô‰∏π": 192, "ÂØ∂ÂìÅ‰ªô‰∏π": 384, "Âú∞ÂìÅ‰ªô‰∏π": 768, "Â§©ÂìÅ‰ªô‰∏π": 1536,
    "ÂÖ•ÂìÅÈùàÁ¨¶": 1, "‰∏ãÂìÅÈùàÁ¨¶": 2, "‰∏≠ÂìÅÈùàÁ¨¶": 4, "‰∏äÂìÅÈùàÁ¨¶": 8, "Ê•µÂìÅÈùàÁ¨¶": 16, "Ë∂ÖÂìÅÈùàÁ¨¶": 32, "ÁµïÂìÅÈùàÁ¨¶": 64, "ÂØ∂ÂìÅÈùàÁ¨¶": 128, "Âú∞ÂìÅÈùàÁ¨¶": 256, "Â§©ÂìÅÈùàÁ¨¶": 512,
    "ÂÖ•ÂìÅÈùàÂô®": 5, "‰∏ãÂìÅÈùàÂô®": 10, "‰∏≠ÂìÅÈùàÂô®": 20, "‰∏äÂìÅÈùàÂô®": 40, "Ê•µÂìÅÈùàÂô®": 80, "Ë∂ÖÂìÅÈùàÂô®": 160, "ÁµïÂìÅÈùàÂô®": 320, "ÂØ∂ÂìÅÈùàÂô®": 640, "Âú∞ÂìÅÈùàÂô®": 1280, "Â§©ÂìÅÈùàÂô®": 2560,
};

const ITEM_RENAME_MAP = {
    "ÊôÆÈÄö‰ªô‰∏π": "ÂÖ•ÂìÅ‰ªô‰∏π", "ÊôÆÈÄöÈùàÁ¨¶": "ÂÖ•ÂìÅÈùàÁ¨¶", "ÊôÆÈÄöÈùàÂô®": "ÂÖ•ÂìÅÈùàÂô®",
};

const EMOJIS = ["üòÄ","üòÇ","üòé","üò°","üò≠","üòç","üò±","üò¥","üòá","ü§ñ"];
const ANIMALS = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","ü¶Ñ","üêî","üêß","üê¶","üê§"];
const FOODS = ["üçé","üçä","üçå","üçâ","üçá","üçì","ü•ë","üçç","ü•ù","üçí","üçî","üçü","üçï","üå≠","ü•™","ü•ó","üç£","üç±","ü•ü","üçú"];
const COLORS = ["üî¥","üü†","üü°","üü¢","üîµ","üü£","‚ö´","‚ö™","üü§","üü•","üüß","üü®","üü©","üü¶","üü™","‚¨õ","‚¨ú","üü´","üî∂","üî∑"];
const SHAPES = ["üî∫","üîµ","‚¨õ","‚≠ê","üü©","üüß","üü•","‚¨ú","üî∂","üî∑","üî≥","üî≤","üü´","üî∏","üîπ","‚¨ü","‚¨¢","‚¨£","‚è∫","‚èπ"];
const PLACES = ["üè†","üè¢","üè¨","üè≠","üè∞","üèØ","üèùÔ∏è","üèñÔ∏è","‚õ©Ô∏è","üé°","üé¢","üé†","üóΩ","üóº","‚õ≤","üïå","‚õ™","üõï","üèïÔ∏è"];
const FLAGS = ["üáπüáº","üáØüáµ","üá∞üá∑","üá®üá≥","üá∫üá∏","üá¨üáß","üá´üá∑","üá©üá™","üáÆüáπ","üá™üá∏","üáßüá∑","üá®üá¶","üá¶üá∫","üá≥üáø","üá∑üá∫","üá∏üá™","üá≥üá¥","üáÆüá≥","üá≤üáΩ","üáøüá¶"];
const NATURE = ["üåû","üåù","üåßÔ∏è","‚õàÔ∏è","üå™Ô∏è","üåà","üåä","üåã","‚ùÑÔ∏è","üçÉ"];
const CARDS = ["üÇ±","üÇ≤","üÇ≥","üÇ¥","üÇµ","üÇ∂","üÇ∑","üÇ∏","üÇπ","üÇ∫","üÇª","üÇº","üÇΩ","üÇæ","üÇ°","üÇ¢","üÇ£","üÇ§","üÇ•","üÇ¶","üÇß","üÇ®","üÇ©","üÇ™","üÇ´","üÇ¨","üÇ≠","üÇÆ","üÉÅ","üÉÇ","üÉÉ","üÉÑ","üÉÖ","üÉÜ","üÉá","üÉà","üÉâ","üÉä","üÉã","üÉå","üÉç","üÉé","üÉë","üÉí","üÉì","üÉî","üÉï","üÉñ","üÉó","üÉò","üÉô","üÉö","üÉõ","üÉú","üÉù","üÉû","üÇ†","üÉè","üÉü"];
const MAHJONG = ["üÄá","üÄà","üÄâ","üÄä","üÄã","üÄå","üÄç","üÄé","üÄè","üÄô","üÄö","üÄõ","üÄú","üÄù","üÄû","üÄü","üÄ†","üÄ°","üÄê","üÄë","üÄí","üÄì","üÄî","üÄï","üÄñ","üÄó","üÄò","üÄÄ","üÄÅ","üÄÇ","üÄÉ","üÄÑ","üÄÖ","üÄÜ"];
const VEHICLES = ["üöó","üöï","üöô","üöå","üöé","üèéÔ∏è","üöì","üöë","üöí","üöê","üöö","üöõ","üöú","üõª","üõ∫","üö≤","üõµ","üèçÔ∏è","üöî","üöç","‚úàÔ∏è","üõ´","üõ¨","üõ©Ô∏è","üöÅ","üõ∂","üö§","‚õµ","üõ≥Ô∏è","üöÄ"];
const ZODIACS = ["‚ôà","‚ôâ","‚ôä","‚ôã","‚ôå","‚ôç","‚ôé","‚ôè","‚ôê","‚ôë","‚ôí","‚ôì"];
const CLOCKS = ["üïõ","üïê","üïë","üïí","üïì","üïî","üïï","üïñ","üïó","üïò","üïô","üïö"];
const PROFESSIONS = ["üßë‚Äç‚öïÔ∏è","üßë‚Äçüè´","üßë‚Äçüç≥","üßë‚Äçüíª","üßë‚Äçüî¨","üßë‚Äçüé®","üßë‚Äçüöí","üßë‚Äç‚úàÔ∏è","üßë‚ÄçüöÄ","üßë‚Äçüîß","üßë‚Äçüåæ","üßë‚Äçüè≠","üßë‚Äç‚öñÔ∏è","üßë‚Äçüé§","üßë‚Äçüéì","üëÆ‚Äç‚ôÇÔ∏è","üë∑‚Äç‚ôÇÔ∏è"];
const SPORTS = ["üéñÔ∏è","üèÜ","üèÖ","ü•á","ü•à","ü•â","‚öΩ","‚öæ","ü•é","üèÄ","üèê","üèà","üèâ","üéæ","ü•è","üé≥","üèè","üèë","üèí","ü•ç","üèì","üè∏","ü•ä","ü•ã","ü•Ö","‚õ≥","‚õ∏Ô∏è","üé£","ü§ø","üéΩ","üéø","üõ∑","ü•å","üéØ"];
const OFFICE = ["üìî","üìï","üìñ","üìó","üìò","üìô","üìö","üìì","üìí","üìÉ","üìú","üìÑ","üì∞","üóûÔ∏è","üìë","üîñ","üè∑Ô∏è","‚úâÔ∏è","üìß","üì®","üì©","üì§","üì•","üì¶","üì´","üì™","üì¨","üì≠","üìÆ","üó≥Ô∏è","‚úèÔ∏è","‚úíÔ∏è","üñãÔ∏è","üñäÔ∏è","üñåÔ∏è","üñçÔ∏è","üìù","üíº","üìÅ","üìÇ","üóÇÔ∏è","üìÖ","üìÜ","üóíÔ∏è","üóìÔ∏è","üìá","üìà","üìâ","üìä","üìã","üìå","üìç","üìé","üñáÔ∏è","üìè","üìê","‚úÇÔ∏è","üóÉÔ∏è","üóÑÔ∏è","üóëÔ∏è","ü™™"];
const TOOLS = ["üß≥","üå°Ô∏è","üß∏","üß∂","ü™¢","üîç","üîé","üïØÔ∏è","üí°","üî¶","üîí","üîì","üîè","üîê","üîë","üóùÔ∏è","üî®","ü™ì","‚õèÔ∏è","‚öíÔ∏è","üõ†Ô∏è","üó°Ô∏è","‚öîÔ∏è","üí£","ü™É","üèπ","üõ°Ô∏è","ü™ö","üîß","ü™õ","üî©","‚öôÔ∏è","üóúÔ∏è","‚öñÔ∏è","üîó","‚õìÔ∏è","üí•","ü™ù","üß∞","üß≤","ü™ú","ü™è","‚öóÔ∏è","üß™","üß´","üî¨","üî≠","üì°","üíâ","ü©π","ü©º","ü©∫","ü©ª","üö™","ü™û","ü™ü","üõèÔ∏è","üõãÔ∏è","ü™ë","üöΩ","ü™†","üöø","üõÅ","ü™§","ü™í","üß¥","üß∑","üßπ","üß∫","üßª","ü™£","üßº","ü´ß","ü™•","üßΩ","üßØ","üõí","üö¨","‚ö∞Ô∏è","ü™¶","‚ö±Ô∏è","ü™ß"];
// Ëá™ÂãïÊãÜÂàÜËæ¶ÂÖ¨ÊñáÂÖ∑ËàáÂ∑•ÂÖ∑/ÂÆ∂Â±ÖÁî®ÂìÅÁÇ∫ÂâçÂçä(A)ËàáÂæåÂçä(B)
const OFFICE_A = OFFICE.slice(0, Math.ceil(OFFICE.length / 2));
const OFFICE_B = OFFICE.slice(Math.ceil(OFFICE.length / 2));
const TOOLS_A = TOOLS.slice(0, Math.ceil(TOOLS.length / 2));
const TOOLS_B = TOOLS.slice(Math.ceil(TOOLS.length / 2));

// # === Êñ∞Â¢ûÁ¨¶ËôüËàáÂ≠óÊØçË®ìÁ∑¥È°åÂ∫´ ===
// ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ§ßÂØ´ 1‚Äì12Ôºâ
const ROMAN_NUMERALS_U = ["‚Ö†","‚Ö°","‚Ö¢","‚Ö£","‚Ö§","‚Ö•","‚Ö¶","‚Öß","‚Ö®","‚Ö©","‚Ö™","‚Ö´"];
// ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ∞èÂØ´ 1‚Äì12Ôºâ
const ROMAN_NUMERALS_L = ["‚Ö∞","‚Ö±","‚Ö≤","‚Ö≥","‚Ö¥","‚Öµ","‚Ö∂","‚Ö∑","‚Ö∏","‚Öπ","‚Ö∫","‚Öª"];
// Êï∏Â≠∏Á¨¶Ëôü
const MATH_SYMBOLS = ["+","‚àí","√ó","√∑","¬±","=","‚â†","‚âà","‚âí","‚àΩ","‚â¶","‚âß","‚â§","‚â•","‚àµ","‚à¥","Ôºã","Ôºç","Ôπ¢","Ôπ£","Ôºú","Ôºû","Ôπ§","Ôπ•","‚âÆ","‚âØ","^","‚àö","‚àû","‚àù"];
// # ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ§ßÂØ´ 1-12Ôºâ
const ROMAN_U = ["‚Ö†","‚Ö°","‚Ö¢","‚Ö£","‚Ö§","‚Ö•","‚Ö¶","‚Öß","‚Ö®","‚Ö©","‚Ö™","‚Ö´"];
// # ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ∞èÂØ´ 1-12Ôºâ
const ROMAN_L = ["‚Ö∞","‚Ö±","‚Ö≤","‚Ö≥","‚Ö¥","‚Öµ","‚Ö∂","‚Ö∑","‚Ö∏","‚Öπ","‚Ö∫","‚Öª"];
// ÂñÆ‰ΩçÁ¨¶Ëôü
const UNIT_SYMBOLS = ["‚ÑÉ","‚Ñâ","„éô","„éö","„éõ","„éú","„éù","„éû","„éü","„é†","„é°","„é¢","„é£","„é§","„é•","„é¶","„èé","„èï","„éç","„éé","„éè","„èÑ"];
// Êúà‰ªΩÁ¨¶ËôüÔºà‰ΩøÁî® CJK ÂúàÂ≠óÊúà‰ªΩ 1‚Äì12Ôºâ
const MONTH_SYMBOLS = ["„ãÄ","„ãÅ","„ãÇ","„ãÉ","„ãÑ","„ãÖ","„ãÜ","„ãá","„ãà","„ãâ","„ãä","„ãã"];
// Êó•ÊúüÁ¨¶ËôüÔºà1ÔΩû31 Ëàá 0Ôºâ
const DATE_SYMBOLS = ["„è†","„è°","„è¢","„è£","„è§","„è•","„è¶","„èß","„è®","„è©","„è™","„è´","„è¨","„è≠","„èÆ","„èØ","„è∞","„è±","„è≤","„è≥","„è¥","„èµ","„è∂","„è∑","„è∏","„èπ","„è∫","„èª","„èº","„èΩ","„èæ"];
// ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´ A‚ÄìZÔºâ
const BOLD_SERIF_U = ["ùêÄ","ùêÅ","ùêÇ","ùêÉ","ùêÑ","ùêÖ","ùêÜ","ùêá","ùêà","ùêâ","ùêä","ùêã","ùêå","ùêç","ùêé","ùêè","ùêê","ùêë","ùêí","ùêì","ùêî","ùêï","ùêñ","ùêó","ùêò","ùêô"];
// ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´ a‚ÄìzÔºâ
const BOLD_SERIF_L = ["ùêö","ùêõ","ùêú","ùêù","ùêû","ùêü","ùê†","ùê°","ùê¢","ùê£","ùê§","ùê•","ùê¶","ùêß","ùê®","ùê©","ùê™","ùê´","ùê¨","ùê≠","ùêÆ","ùêØ","ùê∞","ùê±","ùê≤","ùê≥"];
// ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ
const SCRIPT_U = ["ùíú","ùêµ","ùíû","ùíü","ùê∏","ùêπ","ùí¢","ùêª","ùêº","ùí•","ùí¶","ùêø","ùëÄ","ùí©","ùí™","ùí´","ùí¨","ùëÖ","ùíÆ","ùíØ","ùí∞","ùí±","ùí≤","ùí≥","ùí¥","ùíµ"];
// ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ
const SCRIPT_L = ["ùí∂","ùí∑","ùí∏","ùíπ","ùëí","ùíª","ùëî","ùíΩ","ùíæ","ùíø","ùìÄ","ùìÅ","ùìÇ","ùìÉ","ùëú","ùìÖ","ùìÜ","ùìá","ùìà","ùìâ","ùìä","ùìã","ùìå","ùìç","ùìé","ùìè"];
// Â∏åËáòÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ
const GREEK_U = ["Œë","Œí","Œì","Œî","Œï","Œñ","Œó","Œò","Œô","Œö","Œõ","Œú","Œù","Œû","Œü","Œ†","Œ°","Œ£","Œ§","Œ•","Œ¶","Œß","Œ®","Œ©"];
// Â∏åËáòÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ
const GREEK_L = ["Œ±","Œ≤","Œ≥","Œ¥","Œµ","Œ∂","Œ∑","Œ∏","Œπ","Œ∫","Œª","Œº","ŒΩ","Œæ","Œø","œÄ","œÅ","œÉ","œÑ","œÖ","œÜ","œá","œà","œâ"];
// Ê≥®Èü≥Á¨¶Ëôü
const BOPOMOFO = ["„ÑÖ","„ÑÜ","„Ñá","„Ñà","„Ñâ","„Ñä","„Ñã","„Ñå","„Ñç","„Ñé","„Ñè","„Ñê","„Ñë","„Ñí","„Ñì","„Ñî","„Ñï","„Ññ","„Ñó","„Ñò","„Ñô","„Ñö","„Ñõ","„Ñú","„Ñù","„Ñû","„Ñü","„Ñ†","„Ñ°","„Ñ¢","„Ñ£","„Ñ§","„Ñ•","„Ñ¶","„Ñß","„Ñ®","„Ñ©","Àô","Àä","Àá","Àã"];
// Êó•ÊñáÂπ≥ÂÅáÂêç
const HIRAGANA = ["„ÅÇ","„ÅÑ","„ÅÜ","„Åà","„Åä","„Åã","„Åç","„Åè","„Åë","„Åì","„Åå","„Åé","„Åê","„Åí","„Åî","„Åï","„Åó","„Åô","„Åõ","„Åù","„Åñ","„Åò","„Åö","„Åú","„Åû","„Åü","„Å°","„Å§","„Å¶","„Å®","„Å†","„Å¢","„Å•","„Åß","„Å©","„Å™","„Å´","„Å¨","„Å≠","„ÅÆ","„ÅØ","„Å≤","„Åµ","„Å∏","„Åª","„Å∞","„Å≥","„Å∂","„Åπ","„Åº","„Å±","„Å¥","„Å∑","„Å∫","„ÅΩ","„Åæ","„Åø","„ÇÄ","„ÇÅ","„ÇÇ","„ÇÑ","„ÇÜ","„Çà","„Çâ","„Çä","„Çã","„Çå","„Çç","„Çè","„Çê","„Çë","„Çí","„Çì"];
// Êó•ÊñáÁâáÂÅáÂêç
const KATAKANA = ["„Ç¢","„Ç§","„Ç¶","„Ç®","„Ç™","„Ç´","„Ç≠","„ÇØ","„Ç±","„Ç≥","„Ç¨","„ÇÆ","„Ç∞","„Ç≤","„Ç¥","„Çµ","„Ç∑","„Çπ","„Çª","„ÇΩ","„Ç∂","„Ç∏","„Ç∫","„Çº","„Çæ","„Çø","„ÉÅ","„ÉÑ","„ÉÜ","„Éà","„ÉÄ","„ÉÇ","„ÉÖ","„Éá","„Éâ","„Éä","„Éã","„Éå","„Éç","„Éé","„Éè","„Éí","„Éï","„Éò","„Éõ","„Éê","„Éì","„Éñ","„Éô","„Éú","„Éë","„Éî","„Éó","„Éö","„Éù","„Éû","„Éü","„É†","„É°","„É¢","„É§","„É¶","„É®","„É©","„É™","„É´","„É¨","„É≠","„ÉØ","„É∞","„É±","„É≤","„É≥"];
// ÈüìÊñáÂÖÉÈü≥ËàáËºîÈü≥Á¨¶ËôüÔºàÂÆåÊï¥ Jamo ÂàóË°®Ôºâ
const KOREAN_JAMO = ["„Ñ±","„Ñ≤","„Ñ≥","„Ñ¥","„Ñµ","„Ñ∂","„Ñ∑","„Ñ∏","„Ñπ","„Ñ∫","„Ñª","„Ñº","„ÑΩ","„Ñæ","„Ñø","„ÖÄ","„ÖÅ","„ÖÇ","„ÖÉ","„ÖÑ","„ÖÖ","„ÖÜ","„Öá","„Öà","„Öâ","„Öä","„Öã","„Öå","„Öç","„Öé","„Öè","„Öê","„Öë","„Öí","„Öì","„Öî","„Öï","„Öñ","„Öó","„Öò","„Öô","„Öö","„Öõ","„Öú","„Öù","„Öû","„Öü","„Ö†","„Ö°","„Ö¢","„Ö•","„Ö¶","„Öß","„Ö®","„Ö©","„Ö™","„Ö´","„Ö¨","„Ö≠","„ÖÆ","„ÖØ","„Ö∞","„Ö±","„Ö≤","„Ö≥","„Ö¥","„Öµ","„Ö∂","„Ö∑","„Ö∏","„Öπ","„Ö∫","„Öª","„Öº","„ÖΩ","„Öæ","„Öø","„ÜÄ","„ÜÅ","„ÜÇ","„ÜÉ","„ÜÑ","„ÜÖ","„ÜÜ","„Üá","„Üà","„Üâ","„Üä"];
// Ë≤®Âπ£Á¨¶Ëôü
const CURRENCY_SYMBOLS = ["¬§","¬¢","$","‡∏ø","‚Ç´","‡ß≥","‚Ç≠","‚Ç•","‚Ç±","‚Çπ","‚Ç®","‚Ç™","‚Ç∏","‚ÇÆ","‚Ç©","¬•","·üõ","‚Ç†","‚ÇØ","‚Ç¨","∆í","‚Ç£","‚Ç¥","‚Ñ≥","‚Çß","‚Ç∞","¬£","‚ÇΩ","‚Ç≥","‚Ç°","‚Ç¢","‚Ç≤","‚Çµ","‚Ç¶"];
// Èü≥Ê®ÇÁ¨¶Ëôü
const MUSIC_SYMBOLS = ["‚ô™","‚ô´","‚ô¨","‚ô≠","‚ôØ","ùÑû","ùÑ¢","ùÑ´","‚ôÆ","ùÑ™","ùÑ≠","ùÑÆ","ùÑØ","ùÑ∞ùÑ±","ùÑ≤","ùÑ≥"];
// ÂúãÈöõË±°Ê£ãÁ¨¶Ëôü
const CHESS_SYMBOLS = ["‚ôî","‚ôï","‚ôñ","‚ôó","‚ôò","‚ôô","‚ôö","‚ôõ","‚ôú","‚ôù","‚ôû","‚ôü"];

// # Êñ∞Â¢ûÔºöÁîüËÇñÁ¨¶ËôüÔºàÂçÅ‰∫åÁîüËÇñÔºâ
const CHINESE_ZODIAC = ["üê≠","üêÆ","üêØ","üê∞","üê≤","üêç","üê¥","üêë","üêµ","üêî","üê∂","üê∑"];
// # Êñ∞Â¢ûÔºöÈáëÂ∫∏Â∞èË™™ÂçÅÂõõÈÉ®ÔºàÈ£õÈõ™ÈÄ£Â§©Â∞ÑÁôΩÈπøÁ¨ëÊõ∏Á•û‰ø†ÂÄöÁ¢ßÈ¥õÔºâ
const JINYONG_BOOKS = ["È£õ","Èõ™","ÈÄ£","Â§©","Â∞Ñ","ÁôΩ","Èπø","Á¨ë","Êõ∏","Á•û","‰ø†","ÂÄö","Á¢ß","È¥õ"];
// # Êñ∞Â¢ûÔºö‰∏≠ÊñáÊï∏Â≠óÔºàÂ§ßÂØ´Ôºâ
const CHINESE_BIG_NUMERALS = ["Â£π","Ë≤≥","ÂèÉ","ËÇÜ","‰ºç","Èô∏","Êüí","Êçå","Áéñ","Êãæ","‰Ω∞","‰ªü","Ëê¨","ÂÑÑ","ÂÖÜ","Âúì","Ëßí","ÂàÜ","Èõ∂","Êï¥"];

// # Êñ∞Â¢ûÔºöÂ∞áÊó•ÊñáÂíåÈüìÊñáÁ¨¶ËôüÊãÜÂàÜÁÇ∫ A„ÄÅB ÂÖ©ÈÉ®ÂàÜ
const HIRAGANA_A = HIRAGANA.slice(0, Math.ceil(HIRAGANA.length / 2));
const HIRAGANA_B = HIRAGANA.slice(Math.ceil(HIRAGANA.length / 2));
const KATAKANA_A = KATAKANA.slice(0, Math.ceil(KATAKANA.length / 2));
const KATAKANA_B = KATAKANA.slice(Math.ceil(KATAKANA.length / 2));
const KOREAN_JAMO_A = KOREAN_JAMO.slice(0, Math.ceil(KOREAN_JAMO.length / 2));
const KOREAN_JAMO_B = KOREAN_JAMO.slice(Math.ceil(KOREAN_JAMO.length / 2));


const ALL_GAMES = [
    { name: "Âæû 1ÔΩû10 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", func: "game_guess_hidden" }, { name: "Âæû 1ÔΩû20 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", func: "game_guess_20" }, { name: "Âæû 1ÔΩû30 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", func: "game_guess_30" }, { name: "ÂØ∂ÁÆ±Ë®ìÁ∑¥ÔºöÈÅ∏Âá∫Ê≠£Á¢∫ÁöÑ", func: "game_treasure_box" }, { name: "ÈÅ∏Âá∫Â•ΩÈÅãË°®ÊÉÖÁ¨¶Ëôü", func: "game_emoji_pick" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÂãïÁâ©", func: "game_animals" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÈ£üÁâ©", func: "game_foods" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÂú∞Èªû", func: "game_places" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÂúñÂΩ¢", func: "game_shape_select" }, { name: "ÊâæÂá∫Âπ∏ÈÅãÈ°èËâ≤", func: "game_color_select" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÂúãÊóó", func: "game_flags" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãËá™ÁÑ∂ÁèæË±°", func: "game_nature" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÊí≤ÂÖãÁâåÁ¨¶Ëôü", func: "game_cards" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÈ∫ªÂ∞áÂúñÊ°à", func: "game_mahjong" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅã‰∫§ÈÄöÂ∑•ÂÖ∑", func: "game_vehicles" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãÊòüÂ∫ßÁ¨¶Ëôü", func: "game_zodiacs" }, { name: "Á¶ÆÁâ©Ë®ìÁ∑¥ÔºöÈÅ∏Âá∫Âπ∏ÈÅãÁ¶ÆÁâ©ËôüÁ¢º", func: "game_gift_box" }, { name: "ÊåëÈÅ∏‰ªäÂ§©Âπ∏ÈÅãÊôÇÊÆµ", func: "game_lucky_period" }, { name: "ÈÅ∏Âá∫Âπ∏ÈÅãËÅ∑Ê•≠", func: "game_professions" }, { name: "ÈÅ∏Âá∫È´îËÇ≤ËàáÁçéÈ†Ö", func: "game_sports_awards" }, { name: "ÈÅ∏Âá∫Ëæ¶ÂÖ¨ÊñáÂÖ∑A", func: "game_office_a" }, { name: "ÈÅ∏Âá∫Ëæ¶ÂÖ¨ÊñáÂÖ∑B", func: "game_office_b" }, { name: "ÈÅ∏Âá∫Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñA", func: "game_tools_a" }, { name: "ÈÅ∏Âá∫Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñB", func: "game_tools_b" }, 
    { name: "ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ§ßÂØ´Ôºâ", func: "game_roman_u" }, { name: "ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ∞èÂØ´Ôºâ", func: "game_roman_l" }, { name: "Êï∏Â≠∏Á¨¶Ëôü", func: "game_math_symbols" }, { name: "ÂñÆ‰ΩçÁ¨¶Ëôü", func: "game_unit_symbols" }, { name: "Êúà‰ªΩÁ¨¶Ëôü", func: "game_month_symbols" }, { name: "Êó•ÊúüÁ¨¶Ëôü", func: "game_date_symbols" }, { name: "ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", func: "game_bold_serif_u" }, { name: "ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", func: "game_bold_serif_l" }, { name: "ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", func: "game_script_u" }, { name: "ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", func: "game_script_l" }, { name: "Â∏åËáòÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", func: "game_greek_u" }, { name: "Â∏åËáòÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", func: "game_greek_l" }, { name: "Ê≥®Èü≥Á¨¶Ëôü", func: "game_bopomofo" }, { name: "Êó•ÊñáÂπ≥ÂÅáÂêç", func: "game_hiragana" }, { name: "Êó•ÊñáÁâáÂÅáÂêç", func: "game_katakana" }, { name: "ÈüìÊñáÂÖÉÈü≥ËºîÈü≥", func: "game_korean_jamo" }, { name: "Ë≤®Âπ£Á¨¶Ëôü", func: "game_currency_symbols" }, { name: "Èü≥Ê®ÇÁ¨¶Ëôü", func: "game_music_symbols" }, { name: "ÂúãÈöõË±°Ê£ãÁ¨¶Ëôü", func: "game_chess_symbols" } ];


// ===================== ÈÅäÊà≤ÁãÄÊÖãÁÆ°ÁêÜ =====================
let gameState;
let maxScores;
let trainingState;
let timers = {
    answer: null,
    nextRound: null,
};

// È†êË®≠ÈÅäÊà≤ÁãÄÊÖã
const defaultStats = {
    total: 0, exp: 0, bonus: 0, luck_tests_total: 0,
    luck_history: [], luck_tickets: 0, luck_tickets_total: 0,
    stage_idx: 0, last_daily_ticket_date: "", inventory: {},
    inventory_order: [], stones: 0, current_title: "1.ÂÆóÈñÄÁöÑÂü∫Áü≥",
    last_luck_date: "", last_luck_reward_msg: ""
    , personalName: ""
    , gender: ""
    , createDate: ""
    , linggen: null
};

function saveToLocalStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save to localStorage", e);
    }
}

function loadFromLocalStorage(key, defaultValue = {}) {
    const data = localStorage.getItem(key);
    try {
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error("Failed to parse from localStorage", e);
        return defaultValue;
    }
}

function saveGameState() {
    saveToLocalStorage(STATS_FILE, gameState);
    saveToLocalStorage(SCORE_FILE, maxScores);
    // # ÂêåÊ≠•ÁßòÂ¢ÉË©¶ÁÖâÊúÄÈ´òÁ¥ÄÈåÑÂà∞ localStorage
    saveToLocalStorage(TRIAL_SCORE_FILE, maxTrialScores);
}

function loadGameState() {
    gameState = loadFromLocalStorage(STATS_FILE, JSON.parse(JSON.stringify(defaultStats)));
    maxScores = loadFromLocalStorage(SCORE_FILE, {});
    // # ËºâÂÖ•ÁßòÂ¢ÉË©¶ÁÖâÊúÄÈ´òÁ¥ÄÈåÑÔºåÂ¶ÇÊûúÂ∞öÁÑ°ÂâáÁµ¶Á©∫Áâ©‰ª∂
    maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, {});
    // ÂÖºÂÆπËàäÁâàÈÅìÂÖ∑ÂêçÁ®±
    const newInv = {};
    for (const [key, value] of Object.entries(gameState.inventory)) {
        const newName = ITEM_RENAME_MAP[key] || key;
        newInv[newName] = (newInv[newName] || 0) + value;
    }
    gameState.inventory = newInv;
    gameState.stage_idx = getStageIndex(gameState.exp);
}


// ===================== Ê†∏ÂøÉÈÇèËºØÂáΩÂºè (ÁßªÊ§çËá™ Python) =====================
// ‰æùÊìöÊâÄÈúÄ‰øÆÁÖâÁ∂ìÈ©óË®àÁÆóË®ìÁ∑¥Ê¨°Êï∏ÈñÄÊ™ªÔºàÂçÅÂàÜ‰πã‰∏ÄÔºåÂêë‰∏äÂèñÊï¥ÔºåËá≥Â∞ëÁÇ∫ 1Ôºâ„ÄÇ
// ‰æãÂ¶ÇÈúÄË¶Å 10 EXP ÁöÑÂ±§Á¥öÔºåÈúÄË¶Å 1 Ê¨°Ë®ìÁ∑¥ÔºõÈúÄË¶Å 25 EXP ÁöÑÂ±§Á¥öÔºåÈúÄË¶Å 3 Ê¨°Ë®ìÁ∑¥„ÄÇ
function getRequiredTrainingsForExp(needExp) {
    // needExp ÂèØËÉΩÁÇ∫ undefined Êàñ 0ÔºåÁöÜËøîÂõû 1
    if (!needExp || needExp <= 0) return 1;
    return Math.max(1, Math.ceil(needExp / 10));
}

function getStageIndex(exp) {
    // Ê†πÊìöÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÈñÄÊ™ªÂà§Êñ∑Áé©ÂÆ∂Áï∂Ââç‰øÆÁÇ∫Â±§Á¥ö„ÄÇ
    // ÂøÖÈ†àÂêåÊôÇÊªøË∂≥Á∂ìÈ©óÂÄºËàáË®ìÁ∑¥Ê¨°Êï∏Ê¢ù‰ª∂ÊâçÂèØÈÄ≤ÂÖ•‰∏ã‰∏ÄÂ±§„ÄÇ
    let idx = 0;
    for (let i = 0; i < CULTIVATION_STAGES.length; i++) {
        const [need_exp] = CULTIVATION_STAGES[i];
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp >= need_exp && gameState.total >= requiredTrain) {
            idx = i;
        } else {
            break;
        }
    }
    return idx;
}

function getCultivationStage(exp) {
    return CULTIVATION_STAGES[getStageIndex(exp)][2];
}

function getNextCultivationInfo(exp) {
    // Ê†πÊìöÁ∂ìÈ©óÂÄºËàáÁ∏ΩË®ìÁ∑¥Ê¨°Êï∏ÔºåË®àÁÆóË∑ùÈõ¢‰∏ã‰∏ÄÂ±§ÊâÄÈúÄÁöÑÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏
    for (const [need_exp,, name] of CULTIVATION_STAGES) {
        const requiredTrain = getRequiredTrainingsForExp(need_exp);
        if (exp < need_exp || gameState.total < requiredTrain) {
            return {
                next_stage: name,
                exp_needed: Math.max(0, need_exp - exp),
                train_needed: Math.max(0, requiredTrain - gameState.total)
            };
        }
    }
    return null;
}

function getCultivationBonusExp(score, requiredScore) {
    const diff = score - requiredScore;
    if (diff < 5) return [0, ""];
    const capped = Math.min(diff, 95);
    const n = Math.floor(capped / 5);
    const exp = Math.pow(2, n - 1);
    return [Math.floor(exp), `ÂàÜÊï∏Ë∂ÖÈÅéÈñÄÊ™ª ${capped} ÂàÜÔºåÁç≤ÂæóÈ°çÂ§ñ +${Math.floor(exp)} ‰øÆÁÖâÁ∂ìÈ©óÔºÅ`];
}

function getItemSortKey(itemName) {
    let itemType = 'Êú™Áü•', itemGrade = 'Êú™Áü•';
    for (const t of ITEM_TYPE_ORDER) {
        if (t === 'ÂÖµÂô®') {
            if (itemName.includes('Âäç') || itemName.includes('ÂàÄ') || itemName.includes('Êßç')) {
                itemType = t; break;
            }
        } else if (itemName.includes(t)) {
            itemType = t; break;
        }
    }
    for (const g of GRADE_NAMES) {
        if (itemName.includes(g)) {
            itemGrade = g; break;
        }
    }
    const typeIndex = ITEM_TYPE_ORDER.includes(itemType) ? ITEM_TYPE_ORDER.indexOf(itemType) : ITEM_TYPE_ORDER.length;
    const gradeIndex = GRADE_NAMES.includes(itemGrade) ? GRADE_NAMES.indexOf(itemGrade) : GRADE_NAMES.length;
    return [typeIndex, gradeIndex, itemName];
}
// ÊØîËºÉÈÅìÂÖ∑ÂêçÁ®±ÁöÑÂáΩÂºèÔºö‰æùÁÖßÈ°ûÂûãÁ¥¢Âºï„ÄÅÂìÅÈöéÁ¥¢Âºï„ÄÅÊúÄÂæå‰ª•ÂêçÁ®±ÔºàÂ≠óÂÖ∏Â∫èÔºâÊéíÂ∫è„ÄÇ
// Ëàá 8-8 Áâà Python get_item_sort_key ÈÖçÂêàÔºåÈÅøÂÖç‰ΩøÁî® join ÊØîÂ∞çÈÄ†ÊàêÊéíÂ∫èÈåØ‰∫Ç„ÄÇ
function compareItemNames(nameA, nameB) {
    const keyA = getItemSortKey(nameA);
    const keyB = getItemSortKey(nameB);
    // ÂÖàÊØîÈ°ûÂûã
    if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
    // ÂÜçÊØîÂìÅÈöé
    if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
    // ÊúÄÂæåÊØîÂêçÁ®±
    return nameA.localeCompare(nameB, 'zh-Hant');
}

function getGradeByDifficulty(difficulty) {
    const idx = Math.max(0, Math.min(GRADE_NAMES.length - 1, difficulty - 1));
    return GRADE_NAMES[idx];
}


// ===================== ÈÅäÊà≤ÊµÅÁ®ãÊéßÂà∂ =====================
const app = document.getElementById('app');
let temporaryMessages = []; // Áî®ÊñºÈ°ØÁ§∫Ëá®ÊôÇË®äÊÅØÔºå‰æãÂ¶ÇÊØèÊó•ÁçéÂãµ

function clearApp() {
    app.innerHTML = '';
    Object.values(timers).forEach(timer => clearTimeout(timer));
}

function addTemporaryMessage(html, type) {
    temporaryMessages.push({ html, type });
}

function showTemporaryMessages() {
    temporaryMessages.forEach(({html, type}) => {
        const p = document.createElement('p');
        p.className = `message ${type}`;
        p.innerHTML = html;
        app.appendChild(p);
    });
    temporaryMessages = [];
}

function handleLevelUp(prevExp, newExp) {
    const prevIdx = getStageIndex(prevExp);
    const newIdx = getStageIndex(newExp);
    if (newIdx <= prevIdx) {
        gameState.stage_idx = newIdx;
        saveGameState();
        return "";
    }
    
    let ticketsGain = 0;
    for (let k = prevIdx + 1; k <= newIdx; k++) {
        const prevName = CULTIVATION_STAGES[k - 1][2];
        const match = prevName.match(/(\d+)Â±§$/);
        ticketsGain += match ? parseInt(match[1], 10) : 1;
    }
    
    const stonesGain = newIdx - prevIdx;
    
    gameState.stage_idx = newIdx;
    gameState.luck_tickets += ticketsGain;
    gameState.luck_tickets_total += ticketsGain;
    gameState.stones += stonesGain;
    saveGameState();

    // Êí≠ÊîæÂçáÁ¥öÈü≥Êïà
    try {
        if (typeof playLevelUp === 'function') {
            playLevelUp();
        }
    } catch (e) {}
    
    let parts = [];
    if (ticketsGain > 0) parts.push(`+${ticketsGain} Á•®`);
    if (stonesGain > 0) parts.push(`+${stonesGain} ÈùàÁü≥`);

    return `üéüÔ∏è ÂçáÂ±§ÁçéÂãµÔºö${parts.join('„ÄÅ')}ÔºàÁõÆÂâçÁ•® ${gameState.luck_tickets}ÔºåÈùàÁü≥ ${gameState.stones}Ôºâ`;
}

function grantDailyTicketIfNeeded() {
    // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_daily_ticket_date !== today) {
        gameState.luck_tickets += 1;
        gameState.luck_tickets_total += 1;
        gameState.stones += 1;
        gameState.last_daily_ticket_date = today;
        saveGameState();
        addTemporaryMessage(`üéÅ ‰ªäÊó•ÁôªÂÖ•Ë¥àÈÄÅ +1 Ê∏¨Ë©¶Ê©üÊúÉÂèä +1 ÈùàÁü≥ÔºàÁõÆÂâçÁ•® ${gameState.luck_tickets}ÔºåÈùàÁü≥ ${gameState.stones}Ôºâ`, 'msg-daily');
    }
}

// ===================== ‰∏ªÈÅ∏ÂñÆÊ∏≤Êüì =====================
// ===================== ÈùàÊ†πÊ∏¨Ë©¶ËàáÂÄã‰∫∫Ë≥áÊñô =====================
// # Êèê‰æõÂàùÂßãË®≠ÂÆö‰ªãÈù¢ÔºåÊî∂ÈõÜÂßìÂêçËàáÊÄßÂà•‰∏¶ÂïüÂãïÈùàÊ†πÊ∏¨Ë©¶
function showInitialSetup() {
    clearApp();
    let html = `<h1>üå± ÈùàÊ†πÊ∏¨Ë©¶</h1>`;
    html += `<p style="text-align:center;">Ê≠°ËøéÊñ∞‰øÆÂ£´ÔºÅË´ãÂ°´ÂØ´‰Ω†ÁöÑÂßìÂêçËàáÊÄßÂà•ÔºåÂÜçÈñãÂßãÈùàÊ†πÊ∏¨Ë©¶„ÄÇ</p>`;
    html += `<p style="text-align:center;"><label>ÂßìÂêçÔºö<input type="text" id="initial-name" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç" /></label></p>`;
    html += `<p style="text-align:center;"><label>ÊÄßÂà•Ôºö<select id="initial-gender"><option value="">Êú™Áü•</option><option value="Áî∑">Áî∑</option><option value="Â•≥">Â•≥</option><option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option></select></label></p>`;
    html += `<button data-action="start-linggen-test">üå± ÈñãÂßãÈùàÊ†πÊ∏¨Ë©¶</button>`;
    app.innerHTML = html;
}

// # ÈñãÂßãÈùàÊ†πÊ∏¨Ë©¶Ôºö‰øùÂ≠òÂü∫Êú¨Ë≥áÊñô‰∏¶ÂæûÈõ£Â∫¶ 1 Ê∏¨Ë©¶Ëµ∑
function startLinggenTest() {
    try {
        const nameInput = document.getElementById('initial-name');
        const genderSelect = document.getElementById('initial-gender');
        const nameVal = nameInput ? nameInput.value.trim() : '';
        const genderVal = genderSelect ? genderSelect.value : '';
        gameState.personalName = nameVal || 'ÁÑ°Âêç‰øÆÂ£´';
        gameState.gender = genderVal || '';
        const todayStr = new Date().toISOString().slice(0,10);
        gameState.createDate = todayStr;
        gameState.linggen = null;
        saveGameState();
        if (typeof updateUserProfile === 'function') {
            try { updateUserProfile({ personalName: gameState.personalName, gender: gameState.gender, createDate: gameState.createDate }); } catch (e) {}
        }
    } catch (e) {}
    try {
        startTraining(1);
        if (trainingState) {
            trainingState.isLinggenTest = true;
            trainingState.linggenLevel = 1;
            trainingState.totalRounds = 1;
        }
    } catch (e) { console.warn('ÈùàÊ†πÊ∏¨Ë©¶ÂïüÂãïÂ§±Êïó', e); }
}

// # Â∞çÈõ≤Á´Ø‰ΩøÁî®ËÄÖÊ™îÊ°àÈÄ≤Ë°åÂêà‰ΩµÊõ¥Êñ∞
async function updateUserProfile(fields) {
    // Â∞á‰ΩøÁî®ËÄÖÊ™îÊ°àË≥áË®äÂØ´ÂÖ• Supabase„ÄÇÁï∂Èõ≤Á´ØÊú™ÂïüÁî®ÊôÇÁõ¥Êé•Ë∑≥Âá∫„ÄÇ
    if (!ONLINE_ENABLED || !supabaseClient) return;
    try {
        const user = await ensureSignedIn();
        if (!user) return;
        // upsert Âà∞ user_stats Ë°®ÊàñÂÖ∂‰ªñË°®ÔºõÊ≠§ËôïÂÅáÂÆö id ÁÇ∫‰∏ªÈçµ
        await supabaseClient.from('user_stats').upsert(Object.assign({ id: user.id }, fields));
    } catch (e) {
        console.warn('Êõ¥Êñ∞‰ΩøÁî®ËÄÖË≥áÊñôÂ§±Êïó', e);
    }
}
function renderMainMenu() {
    clearApp();
    grantDailyTicketIfNeeded();
    // # Ëã•Â∞öÊú™Ë®≠ÂÆöÂßìÂêçÊàñÂ∞öÊú™Ê∏¨Ë©¶ÈùàÊ†πÔºåÈÄ≤ÂÖ•ÂàùÂßãÂåñÊµÅÁ®ã
    if (!gameState.personalName || gameState.personalName === "" || gameState.linggen === null || gameState.linggen === undefined) {
        if (typeof showInitialSetup === 'function') {
            showInitialSetup();
            return;
        }
    }
    
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    
    let nextStageProgress = 100;
    let progressTip = "üåü ‰Ω†Â∑≤ÈÅîÂà∞ÊúÄÁµÇ‰øÆÁÇ∫ÔºÅ";

    if (nextInfo) {
        progressTip = `‚¨ÜÔ∏è Ë∑ùÈõ¢„Äå${nextInfo.next_stage}„ÄçÈÇÑÂ∑Æ ${nextInfo.exp_needed} ‰øÆÁÖâÁ∂ìÈ©ó„ÄÅË®ìÁ∑¥ ${nextInfo.train_needed} Ê¨°`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            nextStageProgress = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    
    let html = `
        <h1>üéØ ÈÅãÊ∞£Ë®ìÁ∑¥Â∑•ÂÖ∑</h1>
        <h2>V2-13-S3Ôºà‰øÆ‰ªôÁ∂≤È†ÅÁ∑ö‰∏äÁâàÔºâ</h2>
        <!-- È°ØÁ§∫ÁõÆÂâçÁ∑ö‰∏ä‰∫∫Êï∏ÔºöÈÄèÈÅé Supabase Presence Ë®àÁÆó
             Ê≠§ÊÆµÂú® initPresence() ‰∏≠ÊúÉÊõ¥Êñ∞ÂÖ∂ÊñáÂ≠óÂÖßÂÆπ -->
        <p id="onlineUsersCount" style="text-align:center;">üë• ÁõÆÂâçÁ∑ö‰∏ä‰∫∫Êï∏Ôºö${onlineUsersCount}</p>
        <p style="text-align:center;">Ë´ãÈÅ∏ÊìáË®ìÁ∑¥Èõ£Â∫¶Ôºà1 ÊúÄÁ∞°ÂñÆÔΩû10 ÊúÄÂõ∞Èõ£Ôºâ</p>
    `;

    for (let i = 1; i <= 10; i++) {
        const score = maxScores[i] || 0;
        html += `<button data-action="start-training" data-level="${i}">Èõ£Â∫¶ ${i}ÔºàÊúÄÈ´òÂàÜÔºö${score}Ôºâ ÂãùÁéáÔºöÁ¥Ñ ${DIFFICULTY_WIN_RATE[i]}%</button>`;
    }

    // # Êñ∞Â¢ûÁßòÂ¢ÉË©¶ÁÖâÈÅ∏È†ÖËàáÊéíË°åÊ¶úÔºöÊîæÁΩÆÊñºÈõ£Â∫¶ 1~10 ÊåâÈàï‰πãÂæå
    html += `<button data-action="render-secret-trial-menu">üåå ÁßòÂ¢ÉË©¶ÁÖâ</button>`;
    html += `<button data-action="show-trial-leaderboard">üèÜ ÁßòÂ¢ÉÊéíË°åÊ¶ú</button>`;


    html += `
        <div class="info-section">
            <p style="font-size: 1.2em; color: var(--teal-color);">üßò‚Äç‚ôÇÔ∏è ÁõÆÂâç‰øÆÁÇ∫Ôºö${currentStage}</p>
            <p style="font-size: 1.2em; color: var(--gold-color);">üéñÔ∏è ÁõÆÂâç‰ªôÈñÄ‰ΩçÈöéÔºö${gameState.current_title}</p>
            <p style="font-size: 0.9em; color: var(--secondary-color);">${progressTip}</p>
            <progress value="${nextStageProgress}" max="100"></progress>
            <p>üèãÔ∏è Á¥ØÁ©çË®ìÁ∑¥Ê¨°Êï∏Ôºö${gameState.total} | ‚öîÔ∏è ‰øÆÁÖâÁ∂ìÈ©óÔºö${gameState.exp} | ‚≠ê ÊúÄÈ´òÂàÜÔºö${highestScore}</p>
            <p>üéüÔ∏è Ê∏¨Ë©¶Ê©üÊúÉÔºö${gameState.luck_tickets} Ê¨° (Á¥ØÁ©çÁç≤ÂæóÔºö${gameState.luck_tickets_total})</p>
            <p>üíé ÈùàÁü≥Ôºö${gameState.stones}</p>
            <p>üë§ ÂßìÂêçÔºö${gameState.personalName || 'Êú™Ë®≠ÂÆö'} | ÊÄßÂà•Ôºö${gameState.gender || 'Êú™Ë®≠ÂÆö'} | üå± ÈùàÊ†πÔºö${(gameState.linggen === undefined || gameState.linggen === null) ? 'Êú™Ê∏¨' : ((gameState.linggen <= 0) ? 'ÁÑ°ÈùàÊ†π' : gameState.linggen + ' ÈùàÊ†π')}</p>
        </div>
        <button data-action="show-stage-list">üìú Êü•Áúã‰øÆ‰ªôÁ≠âÁ¥ö‰∏ÄË¶Ω</button>
        <button data-action="show-game-rules">üìñ ÈÅäÊà≤Ë¶èÂâáË™™Êòé</button>
        <button data-action="show-rank-list">üëë Êü•Áúã‰ªôÈñÄ‰ΩçÈöéÂ∞ÅËôü</button>
        <button data-action="show-backpack">üéí ËÉåÂåÖ</button>
        <button data-action="show-shop">üõí ÂïÜÂ∫ó</button>
        <button data-action="render-test-luck-menu">üîç Ê∏¨Ë©¶ÈÅãÊ∞£</button>
        <button data-action="test-sfx">üîä Ê∏¨Ë©¶Èü≥Êïà</button>
        <button data-action="show-login-menu">üë§ Â∏≥Ëôü</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="1">ü™ô ÂÖåÊèõ 1 ÈùàÁü≥ (-${STONE_EXCHANGE_COST} EXP)</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="100">ü™ô ÂÖåÊèõ 100 ÈùàÁü≥ (-${STONE_100_EXCHANGE_COST} EXP)</button>
        <button class="btn-secondary" data-action="exchange-stones" data-count="1000">ü™ô ÂÖåÊèõ 1000 ÈùàÁü≥ (-${STONE_1000_EXCHANGE_COST} EXP)</button>
        <hr>
        <button class="btn-warning" data-action="reset-stats">Ê≠∏Èõ∂Ë®ìÁ∑¥/Á∂ìÈ©óÁµ±Ë®à</button>
        <button class="btn-danger" data-action="clear-scores">üóëÔ∏è Ê∏ÖÈô§ÊâÄÊúâÊúÄÈ´òÂàÜÁ¥ÄÈåÑ</button>
    `;
    
    app.innerHTML = html;
    showTemporaryMessages();
    // ‰øÆË£úË°åÂãïË£ùÁΩÆÁÆ≠È†≠ÂúñÁ§∫ÔºàÁî® SVG ÊõøÊèõÔºâ
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

// ===================== Ë®ìÁ∑¥ÊµÅÁ®ã =====================

function startTraining(level) {
    trainingState = {
        difficulty: level,
        round: 0,
        success: 0,
        fail: 0,
        totalRounds: 20,
        hasAnswered: false,
        correctAnswers: [],
        gameGridButtons: [],
        // Per-round state
        hasUsedSingleUseItem: false,
        allowedChoices: 1,
        selectedChoices: [],
    };
    // # Á∑ö‰∏äÁâàÊñ∞Â¢ûÔºöÁ¥ÄÈåÑÈñãÂßãÊôÇÈñìËàáÊú¨Â±Ä‰ΩøÁî®ÈÅìÂÖ∑Ê∏ÖÂñÆÔºà‰∏çÂΩ±ÈüøËàäÁâàÈÇèËºØÔºâ
    try {
        trainingState.startedAt = Date.now();       // # Êú¨Â±ÄÈñãÂßãÊôÇÈñì
        trainingState.usedItems = [];               // # Êú¨Â±Ä‰ΩøÁî®ÈÅéÁöÑÈÅìÂÖ∑ÔºàÂÖµÂô®/ÂäüÊ≥ï/Èô£Ê≥ïÔºâ
    } catch (e) { /* # ignore */ }

    trainingNext();
}

function trainingNext() {
    if (trainingState.round >= trainingState.totalRounds) {
        timers.nextRound = setTimeout(showTrainingResult, 400);
        return;
    }
    trainingState.round++;
    
    // ÈáçÁΩÆÊØèÈ°åÁãÄÊÖã
    trainingState.hasAnswered = false;
    trainingState.hasUsedSingleUseItem = false;
    trainingState.allowedChoices = 1;
    trainingState.selectedChoices = [];
    // Êú¨È°åÈ°çÂ§ñÊôÇÈñìÈáçÁΩÆ
    trainingState.roundExtraTime = 0;
    // ÈáçÁΩÆÂÄíÊï∏Áî®ÁöÑÂâ©È§òÊôÇÈñì (ÈÅøÂÖçÂª∂Á∫åÂà∞‰∏ã‰∏ÄÈ°å)
    trainingState.countdownRemaining = null;

    const gameDef = ALL_GAMES[Math.floor(Math.random() * ALL_GAMES.length)];
    const gameFunc = window[gameDef.func];
    gameFunc(); // This function will call renderTrainingScreen
}

function updateGameInfo() {
    const infoLabel = document.getElementById('game-info-label');
    if (infoLabel) {
        // # Ëã•ÁÇ∫ÁßòÂ¢ÉË©¶ÁÖâÊ®°ÂºèÔºåÈ°ØÁ§∫Áï∂ÂâçÈ°åËôü„ÄÅ‰∏çÈ°ØÁ§∫Á∏ΩÈ°åÊï∏Ôºå‰∏¶È°çÂ§ñÈ°ØÁ§∫Ë©≤Èõ£Â∫¶ÊúÄÈ´òÁ≠îÂ∞çÈ°åÊï∏
        if (trainingState.mode === 'secretTrial') {
            const best = (maxTrialScores && maxTrialScores[trainingState.difficulty]) ? maxTrialScores[trainingState.difficulty] : 0;
            infoLabel.innerHTML = `Á¨¨ ${trainingState.round} È°å | ‚úÖ Ê≠£Á¢∫: ${trainingState.success} ‚ùå ÈåØË™§: ${trainingState.fail} | ÂèØÈÅ∏Ê¨°Êï∏: ${trainingState.allowedChoices - trainingState.selectedChoices.length} | üéØ ÊúÄÈ´òÔºö${best} È°å`;
        } else if (trainingState.totalRounds === Infinity) {
            // # ÂÖ∂‰ªñÁÑ°ÈôêÂõûÂêàÊ®°ÂºèÔºàÁêÜË´ñ‰∏ä‰∏çÊúÉÁî®Âà∞ÔºâÔºå‰∏çÈ°ØÁ§∫Á∏ΩÈ°åÊï∏
            infoLabel.innerHTML = `Á¨¨ ${trainingState.round} È°å | ‚úÖ Ê≠£Á¢∫: ${trainingState.success} ‚ùå ÈåØË™§: ${trainingState.fail} | ÂèØÈÅ∏Ê¨°Êï∏: ${trainingState.allowedChoices - trainingState.selectedChoices.length}`;
        } else {
            infoLabel.innerHTML = `Á¨¨ ${trainingState.round}/${trainingState.totalRounds} È°å | ‚úÖ Ê≠£Á¢∫: ${trainingState.success} ‚ùå ÈåØË™§: ${trainingState.fail} | ÂèØÈÅ∏Ê¨°Êï∏: ${trainingState.allowedChoices - trainingState.selectedChoices.length}`;
        }
    }
}

function renderTrainingScreen(title, items, correctAnswers, columns=5, btnSize=60) {
    clearApp();
    trainingState.correctAnswers = correctAnswers;
    
    let gridTemplateColumns = `repeat(${columns}, 1fr)`;

    let buttonsHTML = '';
    items.forEach((item) => {
        // Use data-choice to avoid issues with special characters in IDs
        buttonsHTML += `<button class="grid-btn" data-action="grid-btn" data-choice="${item}" style="height:${btnSize}px;">${item}</button>`;
    });

    app.innerHTML = `
        <p id="difficulty-info-label" style="text-align:center;"></p>
        <p id="game-info-label" style="text-align:center;"></p>
        <h3 style="text-align:center;">${title} (${correctAnswers.length} ÂÄã)</h3>
        <p id="feedback-label" class="feedback"></p>
        <p id="countdown-label" style="text-align:center; color:grey;"></p>
        <div class="game-grid" style="grid-template-columns: ${gridTemplateColumns};">
            ${buttonsHTML}
        </div>
        <div id="action-buttons">
            <button data-action="show-use-item-dialog">üéí ‰ΩøÁî®ÈÅìÂÖ∑</button>
        </div>
    `;

    updateGameInfo();
    trainingState.gameGridButtons = Array.from(document.querySelectorAll('.grid-btn'));
    startAnswerCountdown(10);

    // Êõ¥Êñ∞Èõ£Â∫¶Ëàá‰∏ã‰∏ÄÈöéÊÆµÈñÄÊ™ªË≥áË®ä
    const diffLabel = document.getElementById('difficulty-info-label');
    if (diffLabel) {
        const difficulty = trainingState.difficulty || 1;
        const nextInfoStage = getNextCultivationInfo(gameState.exp);
        if (nextInfoStage) {
            diffLabel.innerHTML = `Èõ£Â∫¶ ${difficulty}ÔΩú‰∏ã‰∏ÄÈöéÊÆµ„Äå${nextInfoStage.next_stage}„ÄçÈñÄÊ™ªÔºöÈÇÑÂ∑Æ ${nextInfoStage.exp_needed} ‰øÆÁÖâÁ∂ìÈ©ó„ÄÅË®ìÁ∑¥ ${nextInfoStage.train_needed} Ê¨°`;
        } else {
            diffLabel.innerHTML = `Èõ£Â∫¶ ${difficulty}ÔΩúÂ∑≤ÈÅîÊúÄÈ´òÈöéÊÆµ`;
        }
    }
}

function onGridButtonClick(button) {
    if (trainingState.hasAnswered) return;

    if (trainingState.allowedChoices > 1) {
        const choice = button.dataset.choice;
        button.classList.toggle('checked');
        if (button.classList.contains('checked')) {
            if (trainingState.selectedChoices.length < trainingState.allowedChoices) {
                trainingState.selectedChoices.push(choice);
            } else {
                button.classList.remove('checked'); // Exceeded choices
            }
        } else {
            trainingState.selectedChoices = trainingState.selectedChoices.filter(c => c !== choice);
        }
        updateGameInfo();
        // ‰∏çÂÜçÁî®„ÄåÈÅ∏ÊªøÂ∞±Ëá™ÂãïÁµêÊùü„ÄçÔºåÊîπÁî±Êåâ‰∏ãÁ¢∫Ë™çÊàñÂÄíÊï∏ÁµêÊùüÂæå‰ΩúÁ≠î
    } else {
        checkAnswerSingle(button.dataset.choice);
    }
}

function startAnswerCountdown(seconds) {
    // Êú¨È°åÂÄíÊï∏ÊôÇÈñìÔºöÂü∫Á§éÁßíÊï∏ + roundExtraTimeÔºà‰∏ä‰∏ÄÈ°åÂä†ÊôÇÂ∑≤Âú® trainingNext() ÈáçÁΩÆÔºâ
    let remaining = seconds + (trainingState.roundExtraTime || 0);
    // ‰ΩøÁî® state ÂÑ≤Â≠òÂâ©È§òÁßíÊï∏ÔºåÊñπ‰æøÂú®‰ΩøÁî®Èô£Ê≥ïÊôÇÂç≥ÊôÇÂ¢ûÂä†
    trainingState.countdownRemaining = remaining;
    const countdownLabel = document.getElementById('countdown-label');
    
    if (timers.answer) clearTimeout(timers.answer);

    const update = () => {
        // Ëã• UI Ë¢´ÂàáÊèõÂ∞±ÂÅúÊ≠¢Ë®àÊôÇ
        if (!document.getElementById('countdown-label')) return;
        // Ëã•Â∑≤ÂõûÁ≠îÂâáÂÅúË°®
        if (trainingState.hasAnswered) {
            countdownLabel.textContent = "‰ΩúÁ≠îÁµêÊùü";
            return;
        }
        // ‰ª• state ‰∏≠ÁöÑÂâ©È§òÁßíÊï∏ÁÇ∫Ê∫ñÔºàÂèØËÉΩË¢´Èô£Ê≥ï‰∏≠ÈÄîÂä†ÊôÇ‰øÆÊîπÔºâ
        remaining = trainingState.countdownRemaining || 0;
        if (remaining >= 0) {
            countdownLabel.textContent = `‰ΩúÁ≠îÂÄíÊï∏Ôºö${remaining} Áßí`;
            trainingState.countdownRemaining = remaining - 1;
            timers.answer = setTimeout(update, 1000);
        } else {
            countdownLabel.textContent = "ÊôÇÈñìÂà∞ÔºÅ";
            if (trainingState.allowedChoices > 1) {
                checkAnswerMulti();
            } else {
                checkAnswerSingle(null); // null means timeout
            }
        }
    };
    update();
}

function checkAnswerSingle(choice) {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    const feedbackLabel = document.getElementById('feedback-label');
    let correct = false;

    if (choice === null) { // Timeout
        trainingState.fail++;
        feedbackLabel.innerHTML = `‚ùå ÊôÇÈñìÂà∞ÔºÅÊ≠£Á¢∫Á≠îÊ°àÔºö${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
        // # Âú®ÂñÆÈ°åÁµêÊùüÂæåÊ®ôË®òÈÄôÈ°åÁÇ∫ÈåØË™§ÔºåÁî®ÊñºÁßòÂ¢ÉË©¶ÁÖâÂà§Êñ∑
        trainingState._lastCorrect = false;
    } else {
        correct = trainingState.correctAnswers.includes(choice);
        if (correct) {
            trainingState.success++;
            feedbackLabel.innerHTML = `‚úÖ ÊÅ≠Âñú‰Ω†ÈÅ∏Â∞ç‰∫ÜÔºÅ‰Ω†ÈÅ∏ÁöÑÊòØÔºö${choice}`;
            feedbackLabel.className = "feedback success";
        } else {
            trainingState.fail++;
            feedbackLabel.innerHTML = `‚ùå ÈåØ‰∫ÜÔºå‰Ω†ÈÅ∏ÁöÑÊòØÔºö${choice} Ê≠£Á¢∫Á≠îÊ°àÔºö${trainingState.correctAnswers.join(', ')}`;
            feedbackLabel.className = "feedback error";
        }
        // Query selector needs to handle special characters in data attributes
        document.querySelector(`.grid-btn[data-choice="${choice}"]`).classList.add('selected');
        // # Âú®ÂñÆÈ°åÁµêÊùüÂæåÊ®ôË®òÈÄôÈ°åÁöÑÂ∞çÈåØ
        trainingState._lastCorrect = correct;
    }
    
    finalizeRound();
}

function checkAnswerMulti() {
    if (trainingState.hasAnswered) return;
    trainingState.hasAnswered = true;
    
    document.getElementById('confirm-btn')?.remove();

    const feedbackLabel = document.getElementById('feedback-label');
    const isCorrect = trainingState.selectedChoices.some(c => trainingState.correctAnswers.includes(c));
    // # Âú®ÁµêÊùüÂæåÊ®ôË®òÊ≠§È°åÁöÑÂ∞çÈåØÔºå‰æõÁßòÂ¢ÉË©¶ÁÖâÊ®°ÂºèÂà§Êñ∑
    trainingState._lastCorrect = isCorrect;

    if (isCorrect) {
        trainingState.success++;
        feedbackLabel.innerHTML = `‚úÖ Á≠îÂ∞ç‰∫ÜÔºÅ‰Ω†ÁöÑÈÅ∏Êìá‰∏≠ÂåÖÂê´‰∫ÜÊ≠£Á¢∫Á≠îÊ°à„ÄÇ`;
        feedbackLabel.className = "feedback success";
    } else {
        trainingState.fail++;
        feedbackLabel.innerHTML = `‚ùå Á≠îÈåØ‰∫ÜÔºÅÊ≠£Á¢∫Á≠îÊ°àÊòØÔºö${trainingState.correctAnswers.join(', ')}`;
        feedbackLabel.className = "feedback error";
    }
    finalizeRound();
}

function finalizeRound() {
    updateGameInfo();
    // ÁµêÁÆóÂõûÂêàÂæåÊ∏ÖÈô§Êú¨È°åÂä†ÊôÇÔºåÈÅøÂÖçÂª∂Á∫åÂà∞‰∏ã‰∏ÄÈ°åÔºàÈõôÈáç‰øùÈöúÔºâ
    trainingState.roundExtraTime = 0;
    // Ê∏ÖÈô§ÂÄíÊï∏Ââ©È§òÊôÇÈñìÁãÄÊÖã
    trainingState.countdownRemaining = null;
    if (timers.nextRound) clearTimeout(timers.nextRound);
    // # ÁßòÂ¢ÉË©¶ÁÖâÊ®°Âºè‰∏ãÔºåËã•Á≠îÈåØÂâáÁµêÊùü‰∏¶È°ØÁ§∫Ë©¶ÁÖâÁµêÊûúÔºõËã•Á≠îÂ∞çÂâáÁπºÁ∫å‰∏ã‰∏ÄÈ°å
    if (trainingState.mode === 'secretTrial' || trainingState.totalRounds === Infinity) {
        if (trainingState._lastCorrect) {
            timers.nextRound = setTimeout(trialNext, 2000);
        } else {
            timers.nextRound = setTimeout(showTrialResult, 2000);
        }
    } else {
        timers.nextRound = setTimeout(trainingNext, 2000);
    }
}

function enterMultiChoiceMode() {
    if (trainingState.allowedChoices <= 1) return;
    if (document.getElementById('confirm-btn')) return;

    const confirmBtn = document.createElement('button');
    confirmBtn.id = 'confirm-btn';
    confirmBtn.textContent = 'Á¢∫Ë™çÈÅ∏Êìá';
    confirmBtn.dataset.action = "check-answer-multi";
    document.getElementById('action-buttons').appendChild(confirmBtn);
}


function showTrainingResult() {
    // # Ëã•Ê≠£Âú®ÈÄ≤Ë°åÈùàÊ†πÊ∏¨Ë©¶Ôºå‰∏çË®àÁÆóÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÔºåÁõ¥Êé•Ê†πÊìöÁ≠îÈ°åÁµêÊûúÂà§Êñ∑‰∏ã‰∏ÄÊ≠•
    if (trainingState && trainingState.isLinggenTest) {
        const wasCorrect = (trainingState.success >= trainingState.totalRounds);
        const currLv = trainingState.linggenLevel || trainingState.difficulty || 1;
        if (wasCorrect && currLv < 10) {
            // ÂâçÂæÄ‰∏ã‰∏ÄÈõ£Â∫¶Ê∏¨Ë©¶
            startTraining(currLv + 1);
            if (trainingState) {
                trainingState.isLinggenTest = true;
                trainingState.linggenLevel = currLv + 1;
                trainingState.totalRounds = 1;
            }
        } else {
            // Ê∏¨Ë©¶ÁµêÊùüÔºåË®àÁÆóÈùàÊ†π
            let rootVal = wasCorrect ? currLv : (currLv - 1);
            if (rootVal < 0) rootVal = 0;
            gameState.linggen = rootVal;
            // Ëã•Â∞öÊú™Ë®òÈåÑÂàùÂßãÊó•ÊúüÔºåË£úÈåÑ
            if (!gameState.createDate) {
                gameState.createDate = new Date().toISOString().slice(0,10);
            }
            saveGameState();
            try {
                if (typeof updateUserProfile === 'function') {
                    updateUserProfile({ linggen: gameState.linggen, createDate: gameState.createDate, personalName: gameState.personalName, gender: gameState.gender });
                }
            } catch (e) {}
            const msg = (rootVal <= 0) ? 'ÁÑ°ÈùàÊ†π' : (rootVal + ' ÈùàÊ†π');
            showModal('üå± ÈùàÊ†πÊ∏¨Ë©¶ÁµêÊûú', `<p>‰Ω†ÁöÑÈùàÊ†πÁÇ∫Ôºö${msg}</p>`, `<button data-action="render-main-menu">Á¢∫Ë™ç</button>`);
        }
        return;
    }
    clearApp();
    const score = Math.floor((trainingState.success / trainingState.totalRounds) * 100);
    const prevTotalTrainCount = gameState.total;
    gameState.total++;

    if (score > (maxScores[trainingState.difficulty] || 0)) {
        maxScores[trainingState.difficulty] = score;
    }
    
    const required = DIFFICULTY_WIN_RATE[trainingState.difficulty] || 0;
    const [bonusExp, bonusMsg] = getCultivationBonusExp(score, required);
    const prevExp = gameState.exp;
    const baseExp = 1;
    const totalGain = baseExp + Math.max(0, bonusExp);
    gameState.exp += totalGain;
    if (bonusExp > 0) gameState.bonus = (gameState.bonus || 0) + bonusExp;

    // === Êñ∞Â¢ûËôïÁΩ∞Ê©üÂà∂ ===
    // Ëã•ÂæóÂàÜ‰ΩéÊñºË©≤Èõ£Â∫¶ÁöÑÂãùÁéáÈñÄÊ™ªÔºå‰æùÂ∑ÆË∑ùÊâ£Ê∏õ‰øÆÁÖâÂÄº
    let penaltyMsg = "";
    if (score < required) {
        const diffLow = required - score;
        if (diffLow >= 5) {
            const steps = Math.floor(diffLow / 5);
            const penaltyPercent = Math.pow(2, steps - 1);
            let penaltyExp = Math.floor(gameState.exp * penaltyPercent / 100);
            if (penaltyExp > 0) {
                gameState.exp = Math.max(0, gameState.exp - penaltyExp);
                penaltyMsg = `‚ùå ÂàÜÊï∏‰ΩéÊñºÈñÄÊ™ª ${diffLow} ÂàÜÔºåÊâ£Èô§ ${penaltyExp} ‰øÆÁÖâÂÄº (${penaltyPercent}%)`;
            }
        }
    }

    // Âú®Êâ£Èô§ËôïÁΩ∞ÂæåÈÄ≤Ë°åÂçáÁ¥öÂà§ÂÆö
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    
    let resultHTML = `
        <h2>üèÅ Ë®ìÁ∑¥ÂÆåÊàê</h2>
        <div class="feedback success">ÂæóÂàÜÔºö${score} / 100</div>
        <p style="text-align:center;">üí° Âü∫Êú¨‰øÆÁÖâÁ∂ìÈ©ó +${baseExp}</p>
    `;
    if (bonusMsg) resultHTML += `<p style="text-align:center; color:green;">üéâ ${bonusMsg}</p>`;
    if (penaltyMsg) resultHTML += `<p style="text-align:center; color:red;">${penaltyMsg}</p>`;
    if (levelupMsg) resultHTML += `<p class="message msg-levelup">${levelupMsg}</p>`;

    let rewardsHTML = '';
    
    // ÈÄ±ÊúüÁçéÂãµ
    if (gameState.total > 0 && gameState.total % 5 === 0) {
        const [rewardsList] = grantRandomRewards(1);
        rewardsHTML += `<div class="message msg-reward">üéâ Á¥ØÁ©çË®ìÁ∑¥ÈÅî ${gameState.total} Ê¨°ÔºåÈÅîÊàêÈÄ±ÊúüÁçéÂãµÔºÅ<br>${rewardsList.join('<br>')}</div>`;
    }
    
    // ÈáåÁ®ãÁ¢ëÁçéÂãµ
    if (TRAINING_MILESTONES[gameState.total]) {
        const milestone = TRAINING_MILESTONES[gameState.total];
        gameState.current_title = milestone.title;
        const [rewardsList] = grantRandomRewards(milestone.rewards);
        rewardsHTML += `<div class="message msg-reward">üèÜ ÊÅ≠ÂñúÔºÅË®ìÁ∑¥ÈÅî ${gameState.total} Ê¨°ÔºåÈÅîÊàêÈáåÁ®ãÁ¢ëÔºÅ<br>Áç≤ÂæóÊñ∞‰ΩçÈöéÔºö„Äê${milestone.title}„Äë<br>Áç≤ÂæóÁçéÂãµÔºö<br>${rewardsList.join('<br>')}</div>`;
    }

    // ÁâπÂÆöÊ¨°Êï∏ÁçéÂãµ
    const countRewards = checkTrainingCountRewards(prevTotalTrainCount, gameState.total);
    if (countRewards) rewardsHTML += `<div class="message msg-reward">${countRewards}</div>`;

    // ÈùàÁü≥ÁçéÂãµ
    let stonesAward = 0;
    if (score >= 90) stonesAward = 3;
    else if (score >= 70) stonesAward = 2;
    else if (score >= 50) stonesAward = 1;
    if (score === 100) stonesAward += 3;
    const randomDrop = Math.random() < 0.10 ? 1 : 0;
    const totalStonesGain = stonesAward + randomDrop;
    if (totalStonesGain > 0) {
        gameState.stones += totalStonesGain;
        let parts = [];
        if (stonesAward > 0) parts.push(`Ê†πÊìöË°®ÁèæÁç≤Âæó ${stonesAward} ÈùàÁü≥`);
        if (randomDrop > 0) parts.push("ÂÅ∂ÈÅáÈ©öÂñúÔºö+1 ÈùàÁü≥");
        rewardsHTML += `<p style="text-align:center; color:darkorchid">üíé ${parts.join('Ôºõ')}</p>`;
    }

    // # Â¶ÇÊûúÂæóÂàÜÊòØ 100 ÂàÜÔºå‰æùÁÖßÊåëÊà∞Èõ£Â∫¶Áµ¶‰∫àÈ°çÂ§ñÁçéÂãµÔºàÈõ£Â∫¶Ë∂äÈ´òÁçéÂãµË∂äÂ§öÔºâ
    if (score === 100) {
        try {
            const diffLvl = trainingState.difficulty || 1;
            const [perfRewards] = grantRandomRewards(diffLvl);
            rewardsHTML += `<div class="message msg-reward">üåü ÂÆåÁæéÊºîÂá∫ÔºÅÈõ£Â∫¶ ${diffLvl} ÂÆåÁæéÁ≠îÈ°åÔºåÁç≤Âæó ${diffLvl} ‰ªΩÈ°çÂ§ñÁçéÂãµÔºö<br>${perfRewards.join('<br>')}</div>`;
            // # ÊªøÂàÜÈÅîÊàêÊôÇÊí≠ÊîæÁâπÊÆäÁçéÂãµÈü≥ÊïàÔºàËàáÊ®ÇÈÄèÂ∞çÁçé‰∏≠ÁçéÁõ∏‰ººÔºâ
            try { if (typeof playRewardSound === 'function') playRewardSound(); } catch (_) {}
        } catch (e) { console.warn('ÊªøÂàÜÁçéÂãµË®àÁÆóÈåØË™§', e); }
    }

    saveGameState();
    // # Á∑ö‰∏äÁâàÊñ∞Â¢ûÔºöË®ìÁ∑¥ÁµêÊùüÊôÇÔºå‰∏äÂÇ≥Èõ≤Á´ØÁ¥ÄÈåÑÔºàFirebase FirestoreÔºâ
    try {
        if (typeof onGameFinished === 'function') {
            const _durationSec = Math.max(0, Math.floor((Date.now() - (trainingState.startedAt || Date.now())) / 1000));  // # Êú¨Â±ÄËÄóÊôÇÔºàÁßíÔºâ
            const _result = (score >= (DIFFICULTY_WIN_RATE[trainingState.difficulty] || 0)) ? 'pass' : 'fail';             // # ÊòØÂê¶ÈÅîÊ®ô
            const _usedItems = Array.isArray(trainingState.usedItems) ? trainingState.usedItems.slice(0) : [];            // # ‰ΩøÁî®ÈÅìÂÖ∑Ê∏ÖÂñÆÔºàÊú¨Â±ÄÔºâ
            onGameFinished({
                level: trainingState.difficulty,
                score: score,
                mode: 'Ê∑∑ÂêàË®ìÁ∑¥',                 // # ÁõÆÂâçÈ°åÁõÆÊ∑∑ÂêàÔºàÊú™Á¥∞ÂàÜÂêÑÈÅäÊà≤ÔºâÔºåÂæåÁ∫åÂèØÂÇ≥Êõ¥Á≤æÁ¥∞ÁöÑÊ®°ÂºèÂêçÁ®±
                usedItems: _usedItems,
                durationSec: _durationSec,
                result: _result,
                publishToLeaderboard: false     // # È†êË®≠‰∏çÂÖ¨ÈñãÂà∞ÊéíË°åÊ¶úÔºõÂèØÂú® UI Â¢ûÂä†ÈñãÈóúÂÜçÊîπÁÇ∫ true
            });
        }
    } catch (e) { console.warn('‰∏äÂÇ≥Èõ≤Á´ØÂ§±Êïó', e); }

    // Êõ¥Êñ∞‰∏ªÁï´Èù¢Ë≥áË®äÔºå‰ª•ÂèçÊò†ËôïÁΩ∞ËàáÁçéÂãµ
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch (e) {}
    }
    
    const comment = commentForScore(score, required);

    resultHTML += rewardsHTML;
    resultHTML += `<p style="text-align:center; color:purple; font-style:italic;">"${comment}"</p>`;
    // # Êñ∞Â¢ûÂÜçÊ¨°ÊåëÊà∞ÊåâÈàïÔºöÂèØÁõ¥Êé•ÈáçË§áÁõÆÂâçÈõ£Â∫¶‰πãË®ìÁ∑¥
    resultHTML += `<button data-action="retry-training">üîÑ ÂÜçÊ¨°ÊåëÊà∞</button>`;
    resultHTML += `<button data-action="render-main-menu">üîÅ Âõû‰∏ªÈÅ∏ÂñÆ</button>`;
    app.innerHTML = resultHTML;
}

function checkTrainingCountRewards(prev, current) {
    let msg = [];
    const addItem = (itemName) => {
        gameState.inventory[itemName] = (gameState.inventory[itemName] || 0) + 1;
        if (!gameState.inventory_order.includes(itemName)) {
            gameState.inventory_order.push(itemName);
            gameState.inventory_order.sort((a, b) => {
                const keyA = getItemSortKey(a);
                const keyB = getItemSortKey(b);
                if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
                if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
                return a.localeCompare(b, 'zh-Hant');
            });
        }
    };

    if (prev < 100 && current >= 100) {
        const item = Math.random() < 0.5 ? "ÂÖ•ÂìÅ‰∏âÊâçËÅöÈùàÈô£" : "ÂÖ•ÂìÅÂõõÈñÄÈô∑ÊïµÈô£";
        addItem(item);
        msg.push(`üéÅ ÁôæÁÖâÊàêÈãºÔºÅË®ìÁ∑¥ÈÅî 100 Ê¨°ÔºåÈ†òÊÇüÈô£Ê≥ïÔºö„Äê${item}„Äë`);
    }
    if (prev < 200 && current >= 200) {
        const item = Math.random() < 0.5 ? "ÂÖ•ÂìÅÁØâÂü∫ÂêêÁ¥çË®£" : "ÂÖ•ÂìÅÊùæÈπ§Èï∑ÈùíÂäü";
        addItem(item);
        msg.push(`üéÅ ÈÅìÂøÉÁ©©Âõ∫ÔºÅË®ìÁ∑¥ÈÅî 200 Ê¨°ÔºåÁøíÂæóÂäüÊ≥ïÔºö„Äê${item}„Äë`);
    }
    if (prev < 500 && current >= 500) {
        const item = ["ÂÖ•ÂìÅÈùíÁ´πÂäç", "ÂÖ•ÂìÅÈäÖËÉåÂàÄ", "ÂÖ•ÂìÅÁ¢éÈõ≤Êßç"][Math.floor(Math.random() * 3)];
        addItem(item);
        msg.push(`üéÅ ÈãíËäíÂàùÈú≤ÔºÅË®ìÁ∑¥ÈÅî 500 Ê¨°ÔºåÁç≤ÂæóÂÖµÂô®Ôºö„Äê${item}„Äë`);
    }
    return msg.join('<br>');
}

function commentForScore(score, expected) {
    const diff = score - expected;
    const feedbacks = {
        95:"ÈÅãÊ∞£Ë∂ÖÁ•ûÔºåÁÑ°‰∫∫ËÉΩÊïµÔºÅ", 90:"ÈÅãÊ∞£Á•ûÂåñÔºåÁÑ°‰∫∫ËÉΩÊïµÔºÅ", 85:"ÈÅãÊ∞£ÁàÜÊ£öÔºåÁæ®ÁÖûÁúæ‰∫∫ÔºÅ", 80:"Â§©ÈÅ∏‰πã‰∫∫ÔºåÈùû‰Ω†Ëé´Â±¨ÔºÅ", 75:"ÁµïÂ∞çÁöÑÈÅãÊ∞£ÊéåÊè°ËÄÖÔºÅ", 70:"ÈÅãÂã¢Â¶ÇËôπÔºåÁÑ°‰∫∫ËÉΩÊìã„ÄÇ", 65:"Âº∑ÈÅã‰æÜË•≤ÔºåÂã¢‰∏çÂèØÊìã„ÄÇ", 60:"‰Ω†ÁöÑÈÅãÂã¢Â¶ÇÊó•‰∏≠Â§©„ÄÇ", 55:"Âπ∏ÈÅãÊòüÈ´òÁÖßÔºåÂâçÈÄî‰ººÈå¶„ÄÇ", 50:"Â•ΩÈÅãÈÄ£ÈÄ£ÔºåÂã¢È†≠Ê≠£Êó∫„ÄÇ", 45:"Áï•Âãù‰∏ÄÁ±åÔºåÂâçÊôØÂèØÊúü„ÄÇ", 40:"ÂØ¶ÂäõËàáÈÅãÊ∞£ÂÖºÂÖ∑„ÄÇ", 35:"Á©©Á¥ÆÁ©©ÊâìÔºåÈÄêÊ≠•ÊôâÂçá„ÄÇ", 30:"ÈÅãÊ∞£Â∞ö‰Ω≥ÔºåÂèØÂÜçÊé•ÂÜçÂé≤„ÄÇ", 25:"Áï•È´ò‰∏ÄÁ∑öÔºåÂ∞öÊúâÈÄ≤Ê≠•Á©∫Èñì„ÄÇ", 20:"ÂãâÂº∑Ë∂ÖÊ®ôÔºåÁπºÁ∫åÂä™Âäõ„ÄÇ", 15:"Á®çÁ®çÈ†òÂÖàÔºåÈÇÑÈúÄÊãºÊêè„ÄÇ", 10:"ÂâõÂâõÂ•ΩÈÅéÁ∑öÔºåÂà•È¨ÜÊáà„ÄÇ", 5:"Èö™‰∏≠Ê±ÇÂãùÔºåÈ©öÈö™ÈÅéÈóú„ÄÇ", 0:"‰∏≠Ë¶è‰∏≠Áü©ÔºåÂâõÂ•ΩÁ¨¶ÂêàÈ†êÊúü„ÄÇ",
        [-5]:"‰∫õÂæÆËêΩÂæåÔºåË™øÊï¥ÂøÉÊÖã„ÄÇ",[-10]:"Â∑ÆÂº∑‰∫∫ÊÑèÔºåÈÇÑÈúÄÂä™Âäõ„ÄÇ",[-15]:"Â∞èÊúâÂ§±Âà©ÔºåÁ©©‰ΩèÈô£ËÖ≥„ÄÇ", [-20]:"Áï•‰ΩéÊñºÂπ≥ÂùáÔºåÂÜçÊé•ÂÜçÂé≤„ÄÇ",[-25]:"ÈÅãÂã¢ÂÅèÂº±ÔºåÁπºÁ∫åÊåëÊà∞„ÄÇ",[-30]:"Ë°®ÁèæÂπ≥Âπ≥ÔºåÈúÄË¶ÅÂä†Âº∑„ÄÇ", [-35]:"Á®çÂ´åÈÅúËâ≤Ôºå‰∏çÂ¶ÇÈ†êÊúü„ÄÇ",[-40]:"ÊúâÈªûËÉåÈÅãÔºåÊåØ‰ΩúËµ∑‰æÜ„ÄÇ",[-45]:"ÈÅãÊ∞£‰∏çÊøüÔºåÂÜçÊà∞‰∏ÄÂ†¥„ÄÇ", [-50]:"ÊòéÈ°ØËêΩÂæåÔºåÈáçÊï¥ÊóóÈºì„ÄÇ",[-55]:"ÂØ¶ÂäõÊú™Â±ïÔºå‰∏ãÊ¨°ÂÜç‰æÜ„ÄÇ",[-60]:"ÁãÄÊ≥Å‰∏ç‰Ω≥ÔºåÈúÄË¶ÅÂèçÊÄù„ÄÇ", [-65]:"ÈÅãÊ∞£‰ΩéËø∑ÔºåÊ≥®ÊÑèËΩâÈÅã„ÄÇ",[-70]:"Â§ßÂπÖÂ§±Âà©ÔºåÂÜçÊé•ÂÜçÂé≤„ÄÇ",[-75]:"‰ªäÊó•‰∏çÂÆúÂá∫ÈñÄ‚Ä¶", [-80]:"Ë´∏‰∫ã‰∏çÈ†ÜÔºåÂøçËÄêÁÇ∫‰∏ä„ÄÇ",[-85]:"ËÉåÈÅãÁ∫èË∫´ÔºåË´ãÂ∞èÂøÉË°å‰∫ã„ÄÇ",[-90]:"Ê•µÂ∫¶ËÉåÈÅãÔºåÂø´ÂéªÊ±ÇÁ•ûÂïèÂçú„ÄÇ"
    };
    const closest = Object.keys(feedbacks).reduce((prev, curr) => Math.abs(curr - diff) < Math.abs(prev - diff) ? curr : prev);
    return feedbacks[closest] || "ÈÅãÂã¢Êú™Áü•Ôºå‰øùÊåÅÂπ≥Â∏∏ÂøÉ„ÄÇ";
}


// ===================== ÈÅäÊà≤È°åÂ∫´ÁîüÊàê =====================
// ‚ñº‚ñº‚ñº MAJOR FIX: Corrected the logic to ensure answer positions are truly random. ‚ñº‚ñº‚ñº
function game_template(title, pool, total, columns=5, btnSize=60) {
    // 1. ÂæûÈ°åÂ∫´‰∏≠Èö®Ê©üÈÅ∏Âá∫Êú¨Ê¨°Ë¶ÅÈ°ØÁ§∫ÁöÑÊâÄÊúâÈÅ∏È†Ö
    const itemsForDisplay = [...pool].sort(() => 0.5 - Math.random()).slice(0, total);

    // 2. Ê±∫ÂÆöÊ≠£Á¢∫Á≠îÊ°àÁöÑÊï∏Èáè
    const correctCount = generateCorrectChoices(total);

    // 3. ÂæûÂâõÂâõÈÅ∏Âá∫ÁöÑÈÅ∏È†Ö‰∏≠Ôºå**ÂÜçÊ¨°Èö®Ê©üÊåëÈÅ∏**Âá∫Ê≠£Á¢∫Á≠îÊ°à
    //    ÈÄôÊòØ‰øÆÊ≠£ÁöÑÊ†∏ÂøÉÔºåÁ¢∫‰øùÊ≠£Á¢∫Á≠îÊ°à‰∏çÊòØÂõ∫ÂÆöÂú®ÂâçÂπæÂÄã
    const correctAnswers = [...itemsForDisplay].sort(() => 0.5 - Math.random()).slice(0, correctCount);

    // 4. Â∞áÈö®Ê©üÊéíÂàóÁöÑÈÅ∏È†ÖÂíåÈö®Ê©üÈÅ∏ÂÆöÁöÑÁ≠îÊ°àÂÇ≥ÈÅûÁµ¶Ê∏≤ÊüìÂáΩÂºè
    renderTrainingScreen(title, itemsForDisplay, correctAnswers, columns, btnSize);
}

function generateCorrectChoices(total) {
    const ratio = 1 - (trainingState.difficulty / 10);
    let correctCount = Math.max(1, Math.floor(total * ratio));
    if (trainingState.difficulty === 1 && correctCount === total) {
        correctCount--;
    }
    return correctCount;
}

// Assign game functions to the window object so they can be called by string name
window.game_guess_hidden = () => { const n = 10; game_template("Âæû 1ÔΩû10 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_20 = () => { const n = 20; game_template("Âæû 1ÔΩû20 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", Array.from({length: n}, (_, i) => String(i + 1)), n, 5); }
window.game_guess_30 = () => { const n = 30; game_template("Âæû 1ÔΩû30 ÈÅ∏Âá∫Ê≠£Á¢∫ËôüÁ¢º", Array.from({length: n}, (_, i) => String(i + 1)), n, 6); }
window.game_treasure_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("ÂØ∂ÁÆ±Ë®ìÁ∑¥", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_gift_box = () => { const n = [10, 20, 30][Math.floor(Math.random()*3)]; game_template("Á¶ÆÁâ©Ë®ìÁ∑¥", Array.from({length: n}, (_, i) => String(i + 1)), n, n > 20 ? 6 : 5); }
window.game_emoji_pick = () => { game_template("ÈÅ∏Âá∫Â•ΩÈÅãË°®ÊÉÖÁ¨¶Ëôü", EMOJIS, EMOJIS.length, 5); }
window.game_animals = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÂãïÁâ©", ANIMALS, ANIMALS.length, 5); }
window.game_foods = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÈ£üÁâ©", FOODS, FOODS.length, 5); }
window.game_places = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÂú∞Èªû", PLACES, PLACES.length, 5); }
window.game_shape_select = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÂúñÂΩ¢", SHAPES, SHAPES.length, 5); }
window.game_color_select = () => { game_template("ÊâæÂá∫Âπ∏ÈÅãÈ°èËâ≤", COLORS, COLORS.length, 5); }
window.game_flags = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÂúãÊóó", FLAGS, FLAGS.length, 5); }
window.game_nature = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãËá™ÁÑ∂ÁèæË±°", NATURE, NATURE.length, 5); }
window.game_cards = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÊí≤ÂÖãÁâå", CARDS, CARDS.length, 10, 48); }
window.game_mahjong = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÈ∫ªÂ∞á", MAHJONG, MAHJONG.length, 7); }
window.game_vehicles = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅã‰∫§ÈÄöÂ∑•ÂÖ∑", VEHICLES, VEHICLES.length, 6); }
window.game_zodiacs = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãÊòüÂ∫ß", ZODIACS, ZODIACS.length, 6); }
window.game_lucky_period = () => { game_template("ÊåëÈÅ∏Âπ∏ÈÅãÊôÇÊÆµ", CLOCKS, CLOCKS.length, 6, 48); }
window.game_professions = () => { game_template("ÈÅ∏Âá∫Âπ∏ÈÅãËÅ∑Ê•≠", PROFESSIONS, PROFESSIONS.length, 7, 56); }
window.game_sports = () => { game_template("ÊåëÈÅ∏ÈÅãÂãïËàáÁçéÈ†Ö", SPORTS, SPORTS.length, 6, 48); }
window.game_office = () => { game_template("ÊåëÈÅ∏Ëæ¶ÂÖ¨ÊñáÂÖ∑", OFFICE, OFFICE.length, 6, 48); }
window.game_tools = () => { game_template("ÊåëÈÅ∏Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñ", TOOLS, TOOLS.length, 6, 48); }

// Êñ∞Â¢û‰∏âÁ®ÆÂúñÁ§∫Ë®ìÁ∑¥ÂáΩÂºè
// Ëá™ÂãïÊãÜÂàÜÂæåÁöÑÂõõÂÄãÈ°åÂ∫´ÂáΩÂºè
window.game_office_a = () => { game_template("ÈÅ∏Âá∫Ëæ¶ÂÖ¨ÊñáÂÖ∑A", OFFICE_A, OFFICE_A.length, 6, 48); };
window.game_office_b = () => { game_template("ÈÅ∏Âá∫Ëæ¶ÂÖ¨ÊñáÂÖ∑B", OFFICE_B, OFFICE_B.length, 6, 48); };
window.game_tools_a = () => { game_template("ÈÅ∏Âá∫Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñA", TOOLS_A, TOOLS_A.length, 6, 48); };
window.game_tools_b = () => { game_template("ÈÅ∏Âá∫Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñB", TOOLS_B, TOOLS_B.length, 6, 48); };

window.game_sports_awards = () => { game_template("ÈÅ∏Âá∫È´îËÇ≤ËàáÁçéÈ†Ö", SPORTS, SPORTS.length, 6, 48); };
window.game_office_supplies = () => { game_template("ÈÅ∏Âá∫Ëæ¶ÂÖ¨ÊñáÂÖ∑", OFFICE, OFFICE.length, 6, 48); };
window.game_tools_others = () => { game_template("ÈÅ∏Âá∫Â∑•ÂÖ∑„ÄÅÂÆ∂Â±ÖÁî®ÂìÅÂèäÂÖ∂‰ªñ", TOOLS, TOOLS.length, 6, 48); };

// # Êñ∞Â¢ûÁ¨¶ËôüÈ°ûË®ìÁ∑¥ÈÅäÊà≤ÂáΩÂºè
// # ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ§ßÂØ´Ôºâ
window.game_roman_u = () => { game_template("ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ§ßÂØ´Ôºâ", ROMAN_U, ROMAN_U.length, 6); };
// # ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ∞èÂØ´Ôºâ
window.game_roman_l = () => { game_template("ÁæÖÈ¶¨Êï∏Â≠óÔºàÂ∞èÂØ´Ôºâ", ROMAN_L, ROMAN_L.length, 6); };
// # Êï∏Â≠∏Á¨¶Ëôü
window.game_math_symbols = () => { game_template("Êï∏Â≠∏Á¨¶Ëôü", MATH_SYMBOLS, MATH_SYMBOLS.length, 6); };
// # ÂñÆ‰ΩçÁ¨¶Ëôü
window.game_unit_symbols = () => { game_template("ÂñÆ‰ΩçÁ¨¶Ëôü", UNIT_SYMBOLS, UNIT_SYMBOLS.length, 6); };
// # Êúà‰ªΩÁ¨¶Ëôü
window.game_month_symbols = () => { game_template("Êúà‰ªΩÁ¨¶Ëôü", MONTH_SYMBOLS, MONTH_SYMBOLS.length, 6); };
// # Êó•ÊúüÁ¨¶Ëôü
window.game_date_symbols = () => { game_template("Êó•ÊúüÁ¨¶Ëôü", DATE_SYMBOLS, DATE_SYMBOLS.length, 6); };
// # ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ
window.game_bold_serif_u = () => { game_template("ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", BOLD_SERIF_U, BOLD_SERIF_U.length, 6); };
// # ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ
window.game_bold_serif_l = () => { game_template("ÊúâË•ØÁ∑öÁ≤óÈ´îËã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", BOLD_SERIF_L, BOLD_SERIF_L.length, 6); };
// # ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ
window.game_script_u = () => { game_template("ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", SCRIPT_U, SCRIPT_U.length, 6); };
// # ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ
window.game_script_l = () => { game_template("ËçâÊõ∏Ëã±ÊñáÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", SCRIPT_L, SCRIPT_L.length, 6); };
// # Â∏åËáòÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ
window.game_greek_u = () => { game_template("Â∏åËáòÂ≠óÊØçÔºàÂ§ßÂØ´Ôºâ", GREEK_U, GREEK_U.length, 6); };
// # Â∏åËáòÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ
window.game_greek_l = () => { game_template("Â∏åËáòÂ≠óÊØçÔºàÂ∞èÂØ´Ôºâ", GREEK_L, GREEK_L.length, 6); };
// # Ê≥®Èü≥Á¨¶Ëôü
window.game_bopomofo = () => { game_template("Ê≥®Èü≥Á¨¶Ëôü", BOPOMOFO, BOPOMOFO.length, 7, 48); };
// # Êó•ÊñáÂπ≥ÂÅáÂêç
window.game_hiragana = () => { game_template("Êó•ÊñáÂπ≥ÂÅáÂêç", HIRAGANA, HIRAGANA.length, 8, 48); };
// # Êó•ÊñáÁâáÂÅáÂêç
window.game_katakana = () => { game_template("Êó•ÊñáÁâáÂÅáÂêç", KATAKANA, KATAKANA.length, 8, 48); };
// # ÈüìÊñáÂÖÉÈü≥ËºîÈü≥
window.game_korean_jamo = () => { game_template("ÈüìÊñáÂÖÉÈü≥ËºîÈü≥", KOREAN_JAMO, KOREAN_JAMO.length, 9, 48); };
// # Ë≤®Âπ£Á¨¶Ëôü
window.game_currency_symbols = () => { game_template("Ë≤®Âπ£Á¨¶Ëôü", CURRENCY_SYMBOLS, CURRENCY_SYMBOLS.length, 6); };
// # Èü≥Ê®ÇÁ¨¶Ëôü
window.game_music_symbols = () => { game_template("Èü≥Ê®ÇÁ¨¶Ëôü", MUSIC_SYMBOLS, MUSIC_SYMBOLS.length, 5); };
// # ÂúãÈöõË±°Ê£ãÁ¨¶Ëôü
window.game_chess_symbols = () => { game_template("ÂúãÈöõË±°Ê£ãÁ¨¶Ëôü", CHESS_SYMBOLS, CHESS_SYMBOLS.length, 6); };

// # Êñ∞Â¢ûÔºöÁîüËÇñÁ¨¶ËôüÈÅäÊà≤
window.game_chinese_zodiacs = () => { game_template("ÁîüËÇñÁ¨¶Ëôü", CHINESE_ZODIAC, CHINESE_ZODIAC.length, 4, 48); };
// # Êñ∞Â¢ûÔºöÈáëÂ∫∏Â∞èË™™ÂçÅÂõõÈÉ®ÈÅäÊà≤
window.game_jinyong = () => { game_template("ÈáëÂ∫∏Â∞èË™™14ÈÉ®", JINYONG_BOOKS, JINYONG_BOOKS.length, 7, 48); };
// # Êñ∞Â¢ûÔºö‰∏≠ÊñáÊï∏Â≠óÔºàÂ§ßÂØ´ÔºâÈÅäÊà≤
window.game_chinese_big_digits = () => { game_template("‰∏≠ÊñáÊï∏Â≠óÔºàÂ§ßÂØ´Ôºâ", CHINESE_BIG_NUMERALS, CHINESE_BIG_NUMERALS.length, 6, 48); };
// # Êñ∞Â¢ûÔºöÊó•Êñá„ÄÅÈüìÊñáÁ¨¶ËôüÊãÜÂàÜÂæåÁöÑÈÅäÊà≤ÂÆöÁæ©
window.game_hiragana_a = () => { game_template("Êó•ÊñáÂπ≥ÂÅáÂêçA", HIRAGANA_A, HIRAGANA_A.length, 8, 48); };
window.game_hiragana_b = () => { game_template("Êó•ÊñáÂπ≥ÂÅáÂêçB", HIRAGANA_B, HIRAGANA_B.length, 8, 48); };
window.game_katakana_a = () => { game_template("Êó•ÊñáÁâáÂÅáÂêçA", KATAKANA_A, KATAKANA_A.length, 8, 48); };
window.game_katakana_b = () => { game_template("Êó•ÊñáÁâáÂÅáÂêçB", KATAKANA_B, KATAKANA_B.length, 8, 48); };
window.game_korean_jamo_a = () => { game_template("ÈüìÊñáÂ≠óÁ¨¶ËôüA", KOREAN_JAMO_A, KOREAN_JAMO_A.length, 9, 48); };
window.game_korean_jamo_b = () => { game_template("ÈüìÊñáÂ≠óÁ¨¶ËôüB", KOREAN_JAMO_B, KOREAN_JAMO_B.length, 9, 48); };

// # Ë™øÊï¥ÈÅäÊà≤ÂàóË°®ÔºöÂà™Èô§ÂéüÊú¨ÁöÑÊó•ÊñáÂπ≥ÂÅáÂêç„ÄÅÁâáÂÅáÂêç„ÄÅÈüìÊñáÂÖÉÈü≥ËºîÈü≥È†ÖÁõÆÔºå‰∏¶Âä†ÂÖ•ÊãÜÂàÜÁâàËàáÊñ∞Â¢ûÁöÑÁ¨¶ËôüÈÅäÊà≤
(function() {
    try {
        if (Array.isArray(ALL_GAMES)) {
            const filtered = ALL_GAMES.filter(it => !['Êó•ÊñáÂπ≥ÂÅáÂêç', 'Êó•ÊñáÁâáÂÅáÂêç', 'ÈüìÊñáÂÖÉÈü≥ËºîÈü≥'].includes(it.name));
            filtered.push(
                { name: 'Êó•ÊñáÂπ≥ÂÅáÂêçA', func: 'game_hiragana_a' },
                { name: 'Êó•ÊñáÂπ≥ÂÅáÂêçB', func: 'game_hiragana_b' },
                { name: 'Êó•ÊñáÁâáÂÅáÂêçA', func: 'game_katakana_a' },
                { name: 'Êó•ÊñáÁâáÂÅáÂêçB', func: 'game_katakana_b' },
                { name: 'ÈüìÊñáÂ≠óÁ¨¶ËôüA', func: 'game_korean_jamo_a' },
                { name: 'ÈüìÊñáÂ≠óÁ¨¶ËôüB', func: 'game_korean_jamo_b' },
                { name: 'ÁîüËÇñÁ¨¶Ëôü', func: 'game_chinese_zodiacs' },
                { name: 'ÈáëÂ∫∏Â∞èË™™14ÈÉ®', func: 'game_jinyong' },
                { name: '‰∏≠ÊñáÊï∏Â≠óÔºàÂ§ßÂØ´Ôºâ', func: 'game_chinese_big_digits' }
            );
            ALL_GAMES.length = 0;
            filtered.forEach(it => ALL_GAMES.push(it));
        }
    } catch (e) {
        console.warn('ALL_GAMES modify failed', e);
    }
})();


// ===================== Ê∏¨Ë©¶ÈÅãÊ∞£Á≥ªÁµ± =====================

function renderTestLuckMenu() {
    clearApp();
    grantDailyTicketIfNeeded();
    const tickets = gameState.luck_tickets;
    app.innerHTML = `
        <h2>üß™ Ê∏¨Ë©¶‰Ω†ÁöÑÈÅãÊ∞£</h2>
        <div class="info-section" style="padding:10px;">
            <p>ÊäΩÂç°Ê®°ÂºèÂ∞áÈö®Ê©üÁç≤Âæó‰øÆÁÖâÁ∂ìÈ©ó„ÄÅÈùàÁü≥„ÄÅÁ•®Âà∏ÊàñÈÅìÂÖ∑„ÄÇ</p>
            <p>üéüÔ∏è ÁõÆÂâçÊ∏¨Ë©¶Ê©üÊúÉÔºö${tickets} Ê¨°</p>
            <p>üìÖ ‰ªäÊó•ÈÅãÂã¢‰∏çÊ∂àËÄóÁ•®„ÄÇ</p>
        </div>
        <button data-action="run-luck-draw" data-draws="1" data-mode="Âπ∏ÈÅãÊäΩÂç°ÂñÆÊäΩ" ${tickets < 1 ? 'disabled' : ''}>üÉè ÂñÆÊäΩ (Ê∂àËÄó 1 Á•®)</button>
        <button data-action="run-luck-draw" data-draws="3" data-mode="Âπ∏ÈÅãÊäΩÂç°‰∏âÊäΩ" ${tickets < 3 ? 'disabled' : ''}>üÉè ‰∏âÊäΩ (Ê∂àËÄó 3 Á•®)</button>
        <button data-action="run-luck-draw" data-draws="10" data-mode="Âπ∏ÈÅãÊäΩÂç°10ÈÄ£ÊäΩ" ${tickets < 10 ? 'disabled' : ''}>üÉè ÂçÅÈÄ£ÊäΩ (Ê∂àËÄó 10 Á•®)</button>
        <button data-action="run-luck-draw" data-draws="100" data-mode="Âπ∏ÈÅãÊäΩÂç°100ÈÄ£ÊäΩ" ${tickets < 100 ? 'disabled' : ''}>üÉè ÁôæÈÄ£ÊäΩ (Ê∂àËÄó 100 Á•®)</button>
        <button data-action="run-luck-draw" data-draws="1000" data-mode="Âπ∏ÈÅãÊäΩÂç°1000ÈÄ£ÊäΩ" ${tickets < 1000 ? 'disabled' : ''}>üÉè ÂçÉÈÄ£ÊäΩ (Ê∂àËÄó 1000 Á•®)</button>
        <button data-action="run-luck-draw" data-draws="${tickets}" data-mode="Âπ∏ÈÅãÊäΩÂç°ÂÖ®ÈÉ®ÊäΩ" ${tickets < 1 ? 'disabled' : ''}>üÉè ÂÖ®ÈÉ®ÊäΩ (Ê∂àËÄó ${tickets} Á•®)</button>
        <button data-action="run-today-luck">üìÖ ‰ªäÊó•ÈÅãÂã¢ (ÊØèÊó•‰∏ÄÊ¨°ÔΩúÂÖçË≤ª)</button>
        <hr>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1" data-cost="${REDEEM_1_COST}">üé´ ÂÖåÊèõ 1 Âºµ (-${REDEEM_1_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="10" data-cost="${REDEEM_10_COST}">üé´ ÂÖåÊèõ 10 Âºµ (-${REDEEM_10_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="100" data-cost="${REDEEM_100_COST}">üé´ ÂÖåÊèõ 100 Âºµ (-${REDEEM_100_COST} EXP)</button>
        <button class="btn-secondary" data-action="redeem-tickets" data-pieces="1000" data-cost="${REDEEM_1000_COST}">üé´ ÂÖåÊèõ 1000 Âºµ (-${REDEEM_1000_COST} EXP)</button>
        <hr>
        <button data-action="show-luck-history">üìà Êü•ÁúãÊ≠∑Âè≤ËàáÁµ±Ë®à</button>
        <button data-action="render-main-menu">üîô ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
    `;
    showTemporaryMessages();
    // Â∞çË°åÂãïË£ùÁΩÆ‰øÆË£úÁÆ≠È†≠ÂúñÁ§∫
    if (typeof patchLuckArrows === 'function') {
        try { patchLuckArrows(); } catch (e) {}
    }
}

function redeemTickets(pieces, cost) {
    if (gameState.exp < cost) {
        addTemporaryMessage(`‚ö†Ô∏è EXP ‰∏çË∂≥ (ÈúÄË¶Å ${cost}ÔºåÁõÆÂâç ${gameState.exp})`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.luck_tickets += pieces;
        gameState.luck_tickets_total += pieces;
        addTemporaryMessage(`‚úÖ ÂÖåÊèõÊàêÂäüÔºö-${cost} EXP ‚Üí +${pieces} Á•®`, 'msg-shop');
        saveGameState();
    }
    renderTestLuckMenu();
}

function runLuckDraw(draws, mode) {
    if (gameState.luck_tickets < draws || draws <= 0) {
        addTemporaryMessage(`‚ö†Ô∏è Ê∏¨Ë©¶Ê©üÊúÉ‰∏çË∂≥ÔºÅ`, 'msg-shop-fail');
        renderTestLuckMenu();
        return;
    }
    gameState.luck_tickets -= draws;
    
    const [details, totals] = grantRandomRewards(draws);
    
    let summaryParts = [];
    if (totals.exp > 0) summaryParts.push(`+${totals.exp} EXP`);
    if (totals.stones > 0) summaryParts.push(`+${totals.stones} ÈùàÁü≥`);
    if (totals.tickets > 0) summaryParts.push(`+${totals.tickets} Á•®Âà∏`);
    if (Object.keys(totals.items).length > 0) {
        const totalItems = Object.values(totals.items).reduce((a, b) => a + b, 0);
        summaryParts.push(`+${totalItems} ‰ª∂ÈÅìÂÖ∑`);
    }

    const summaryMsg = summaryParts.length > 0 ? summaryParts.join('„ÄÅ') : "‰ªÄÈ∫ºÈÉΩÊ≤íÊúâ...";
    addLuckHistory(mode, 0, "", totals.exp, summaryMsg);
    
    renderDrawResult(summaryMsg, details, mode, draws);
}

function addLuckHistory(mode, value, category, expGain, rewardMsg) {
    gameState.luck_tests_total++;
    gameState.luck_history.push({
        time: new Date().toLocaleString('sv-SE'), // YYYY-MM-DD HH:MM:SS
        mode, value, category, exp: expGain, reward_msg: rewardMsg
    });
    if (gameState.luck_history.length > 200) {
        gameState.luck_history.shift();
    }
    saveGameState();
}

function grantRandomRewards(count) {
    let rewardsList = [], totals = { exp: 0, stones: 0, tickets: 0, items: {} };
    
    const itemPool = Object.keys(ITEM_STONE_PRICES);
    const weights = itemPool.map(item => {
        const price = ITEM_STONE_PRICES[item] || 1;
        const grade = GRADE_NAMES.findIndex(g => item.startsWith(g)) + 1 || 1;
        return 1000 / (price * grade + 1);
    });

    const getScaledRandomAmount = (min, max) => {
        const bias_factor = Math.pow(gameState.stage_idx / CULTIVATION_STAGES.length, 2);
        const mode = min + (max - min) * bias_factor;
        const u = Math.random();
        // triangular distribution formula
        return Math.ceil(u < (mode - min) / (max - min) ? min + Math.sqrt(u * (max - min) * (mode - min)) : max - Math.sqrt((1 - u) * (max - min) * (max - mode)));
    };

    for (let i = 0; i < count; i++) {
        const rand = Math.random() * 100;
        let rewardType;
        if (rand < 40) rewardType = "exp";
        else if (rand < 70) rewardType = "stones";
        else if (rand < 85) rewardType = "tickets";
        else rewardType = "item";

        if (rewardType === 'exp') {
            const amount = getScaledRandomAmount(1, 1000);
            totals.exp += amount;
            rewardsList.push(`Áç≤Âæó ‰øÆÁÖâÁ∂ìÈ©ó +${amount}`);
        } else if (rewardType === 'stones') {
            const amount = getScaledRandomAmount(1, 100);
            totals.stones += amount;
            rewardsList.push(`Áç≤Âæó ÈùàÁü≥ +${amount}`);
        } else if (rewardType === 'tickets') {
            const amount = getScaledRandomAmount(1, 5);
            totals.tickets += amount;
            rewardsList.push(`Áç≤Âæó Á•®Âà∏ +${amount}`);
        } else if (rewardType === 'item') {
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let randWeight = Math.random() * totalWeight;
            let itemName = itemPool[itemPool.length - 1];
            for(let j=0; j<weights.length; j++){
                if(randWeight < weights[j]){
                    itemName = itemPool[j];
                    break;
                }
                randWeight -= weights[j];
            }
            const amount = getScaledRandomAmount(1, 10);
            totals.items[itemName] = (totals.items[itemName] || 0) + amount;
            rewardsList.push(`Áç≤Âæó ÈÅìÂÖ∑ [${itemName}] √ó${amount}`);
        }
    }

    const prevExp = gameState.exp;
    gameState.exp += totals.exp;
    gameState.stones += totals.stones;
    gameState.luck_tickets += totals.tickets;
    Object.entries(totals.items).forEach(([name, qty]) => {
        gameState.inventory[name] = (gameState.inventory[name] || 0) + qty;
         if (!gameState.inventory_order.includes(name)) gameState.inventory_order.push(name);
    });
    if(Object.keys(totals.items).length > 0){
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }

    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    if (levelupMsg) rewardsList.push(`<span class="msg-levelup">${levelupMsg}</span>`);
    
    saveGameState();
    return [rewardsList, totals];
}

function runTodayLuck() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];

    if (gameState.last_luck_date === today) {
        showTodayLuckResult(true);
        return;
    }

    const [rewardsList, totals] = grantRandomRewards(1);
    const rewardMsg = rewardsList[0] || "‰ªäÊó•Âπ≥Ê∑°ÁÑ°Â•á...";

    gameState.last_luck_date = today;
    gameState.last_luck_reward_msg = rewardMsg;

    addLuckHistory("‰ªäÊó•ÈÅãÂã¢", 0, "ÂãïÊÖãÁçéÂãµ", totals.exp, rewardMsg);
    showTodayLuckResult(false);
}

function renderDrawResult(summary, details, mode, draws) {
    clearApp();
    const currentStage = getCultivationStage(gameState.exp);
    
    app.innerHTML = `
        <h2>üÉè ${mode} ÁµêÊûú</h2>
        <div class="feedback info">üéÅ Á∏ΩË®àÔºö${summary}</div>
        <div style="height: 150px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px; margin-bottom:15px;">
            ${details.join('<br>')}
        </div>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">üßò‚Äç‚ôÇÔ∏è ÁõÆÂâç‰øÆÁÇ∫Ôºö${currentStage}</p>
            <p>Á¥ØÁ©ç EXPÔºö${gameState.exp}</p>
        </div>
        <button data-action="run-luck-draw" data-draws="${draws}" data-mode="${mode}" ${gameState.luck_tickets < draws ? 'disabled' : ''}>üîÅ ÂÜç‰æÜ‰∏ÄÊ¨° (${draws} Á•®)</button>
        <button data-action="show-luck-history">üìà Êü•ÁúãÊ≠∑Âè≤ËàáÁµ±Ë®à</button>
        <button data-action="render-test-luck-menu">üîô ËøîÂõûÊ∏¨Ë©¶ÈÅ∏ÂñÆ</button>
        <button data-action="render-main-menu">üè† Âõû‰∏ªÈÅ∏ÂñÆ</button>
    `;
}

function showTodayLuckResult(isRepeat) {
    clearApp();
    const luckySuggestion = () => {
        const seed = parseInt(new Date().toISOString().slice(0, 10).replace(/-/g, ''), 10);
        const rng = (s) => () => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
        const rand = rng(seed);
        const lucky_num = Math.floor(rand() * 39) + 1;
        const lucky_color = COLORS[Math.floor(rand() * COLORS.length)];
        const lucky_emoji = EMOJIS[Math.floor(rand() * EMOJIS.length)];
        const lucky_dir = ["‰∏ä", "‰∏ã", "Â∑¶", "Âè≥", "Â∑¶‰∏ä", "Âè≥‰∏ä", "Âè≥‰∏ã", "Â∑¶‰∏ã"][Math.floor(rand() * 8)];
        return `Âπ∏ÈÅãËôüÁ¢ºÔºö${lucky_num} | Âπ∏ÈÅãËâ≤Ôºö${lucky_color} | Âπ∏ÈÅãË°®ÊÉÖÔºö${lucky_emoji} | Âπ∏ÈÅãÊñπ‰ΩçÔºö${lucky_dir}`;
    };

    app.innerHTML = `
        <h2>üìÖ ‰ªäÊó•ÈÅãÂã¢</h2>
        <div class="feedback" style="color:darkorange">${isRepeat ? '(‰ªäÊó•Â∑≤Ê∏¨) ' : ''}${gameState.last_luck_reward_msg}</div>
        <p style="text-align:center;">${luckySuggestion()}</p>
        <div class="info-section" style="padding:10px;">
            <p style="font-size: 1.1em; color: var(--teal-color);">üßò‚Äç‚ôÇÔ∏è ÁõÆÂâç‰øÆÁÇ∫Ôºö${getCultivationStage(gameState.exp)}</p>
        </div>
        <button data-action="render-test-luck-menu">üîô ËøîÂõûÊ∏¨Ë©¶ÈÅ∏ÂñÆ</button>
        <button data-action="render-main-menu">üè† Âõû‰∏ªÈÅ∏ÂñÆ</button>
    `;
}

// ===================== ÈõúÈ†ÖÂäüËÉΩ & ÈáçÁΩÆ =====================
function exchangeStones(count) {
    const cost = STONE_EXCHANGE_COST * count;
    if (gameState.exp < cost) {
        addTemporaryMessage(`‚ö†Ô∏è EXP ‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂÖåÊèõ`, 'msg-shop-fail');
    } else {
        gameState.exp -= cost;
        gameState.stones += count;
        handleLevelUp(gameState.exp + cost, gameState.exp); // Recalculate level
        addTemporaryMessage(`‚úÖ ÂÖåÊèõÊàêÂäüÔºö-${cost} EXP ‚Üí +${count} ÈùàÁü≥`, 'msg-shop');
        saveGameState();
    }
    renderMainMenu();
}

function resetTrainingStats() {
    if (confirm("Á¢∫ÂÆöË¶ÅÊ≠∏Èõ∂ÊâÄÊúâË®ìÁ∑¥Áµ±Ë®à„ÄÅÁ∂ìÈ©ó„ÄÅÈÅìÂÖ∑ÂíåÁ≠âÁ¥öÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ")) {
        gameState = JSON.parse(JSON.stringify(defaultStats));
        saveGameState();
        renderMainMenu();
    }
}

function clearMaxScores() {
    if (confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÈõ£Â∫¶ÁöÑÊúÄÈ´òÂàÜÁ¥ÄÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ")) {
        maxScores = {};
        saveGameState();
        renderMainMenu();
    }
}


// ===================== Modal (ÂΩàÂá∫Ë¶ñÁ™ó) Á≥ªÁµ± =====================
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalFooter = document.getElementById('modal-footer');
const modalCloseBtn = document.getElementById('modal-close-btn');

modalCloseBtn.onclick = () => modal.style.display = "none";
window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function showModal(title, bodyHTML, footerHTML = '') {
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHTML;
    modalFooter.innerHTML = footerHTML;
    modal.style.display = "flex";
}

function showStageList() {
    // ÂàóÂá∫ÂêÑÂ±§Á¥öÊâÄÈúÄÁöÑ‰øÆÁÖâÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÈñÄÊ™ª
    const content = CULTIVATION_STAGES.map(([exp,, name]) => {
        const requiredTrain = getRequiredTrainingsForExp(exp);
        return `<li><b>${name}</b>ÔºöÈúÄ‰øÆÁÖâÁ∂ìÈ©ó ${exp}ÔºåË®ìÁ∑¥Ê¨°Êï∏ÈñÄÊ™ª ${requiredTrain}</li>`;
    }).join('');
    showModal("‰øÆ‰ªôÁ≠âÁ¥ö‰∏ÄË¶ΩË°®", `<ul style="padding-left: 20px;">${content}</ul>`, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

function showRankList() {
    let content = '‰ªôÈñÄ‰ΩçÈöéÊòØÊ†πÊìöÊÇ®ÁöÑÁ∏ΩË®ìÁ∑¥Ê¨°Êï∏Êéà‰∫àÁöÑÊ¶ÆË≠ΩÁ®±ËôüÔºö<br><br><ul style="padding-left: 20px;">';
    content += Object.entries(TRAINING_MILESTONES).map(([count, data]) => `<li>Ë®ìÁ∑¥ <b>${count}</b> Ê¨°ÔºöÊéà‰∫à‰ΩçÈöé„Äê${data.title}„Äë</li>`).join('');
    showModal("‰ªôÈñÄ‰ΩçÈöéÂ∞ÅËôü‰∏ÄË¶ΩË°®", `${content}</ul>`, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

function showLuckHistory() {
    let content = '';
    if (!gameState.luck_history || gameState.luck_history.length === 0) {
      content = "Â∞öÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ„ÄÇ";
    } else {
      const totalExp = gameState.luck_history.reduce((s, h) => s + (h.exp || 0), 0);
      content += `<p><b>Á¥ØÁ©çÁ∂ìÈ©ó +${totalExp}</b></p><hr>`;
      content += '<ul style="padding-left: 20px; word-break: break-all;">';
      gameState.luck_history.slice().reverse().slice(0, 50).forEach(h => {
        content += `<li>[${h.time}] <b>${h.mode}</b> ‚Üí ${h.reward_msg || `${h.value} (${h.category})`} (EXP +${h.exp})</li>`;
      });
      content += '</ul>';
    }
    showModal("Ê∏¨Ë©¶ÈÅãÊ∞£Ê≠∑Âè≤", content, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

// ÈÅäÊà≤Ë¶èÂâáË™™ÊòéÔºöË©≥Á¥∞Ë™™ÊòéÂçáÁ¥öÁçéÂãµ„ÄÅÈóúÂç°„ÄÅÈÅìÂÖ∑ÂäüËÉΩ‰ª•ÂèäËôïÁΩ∞Ê©üÂà∂„ÄÇ
// # Êñ∞Â¢ûÈÅäÊà≤Ë¶èÂâáË™™ÊòéÊåâÈàïÂ∞çÊáâÁöÑÂáΩÂºè
function showGameRules() {
    /* # ÈÅäÊà≤Ë¶èÂâáÔºö
       1. ÂçáÁ¥öÁçéÂãµË™™ÊòéÔºöÁï∂‰Ω†ÁöÑ‰øÆÁÖâÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÂêåÊôÇÈÅîÂà∞‰∏ã‰∏ÄÂ±§ÈñÄÊ™ªÔºå
          ‰øÆÁÇ∫ÊúÉËá™ÂãïÁ™ÅÁ†¥„ÄÇÊØèÁ™ÅÁ†¥‰∏ÄÂ±§ÔºåÂ∞áÁç≤Âæó‰∏ÄÂÆöÊï∏ÈáèÁöÑÊ∏¨Ë©¶Ê©üÊúÉËàáÈùàÁü≥ÁçéÂãµ„ÄÇ
       2. ÈÅäÊà≤ÈóúÂç°Ë™™ÊòéÔºöË®ìÁ∑¥ÂÖ±Êúâ 10 Á®ÆÈõ£Â∫¶ÔºåÊØèÂõûÂêàÂåÖÂê´ 20 È°åÂúñÁ§∫ÔºåË´ãÂú®ÂÄíÊï∏ÊôÇÈñìÂÖßÈÅ∏Âá∫ÁõÆÊ®ô„ÄÇÁ≠îÂ∞çÂèØÁ¥ØÁ©ç‰øÆÁÖâÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÔºåÈÅîÂà∞Ë©≤Èõ£Â∫¶Ë¶ÅÊ±ÇÁöÑÂãùÁéáÂèØÁç≤ÂæóÈ°çÂ§ñÁ∂ìÈ©óÂä†Êàê„ÄÇ
       3. ÈÅìÂÖ∑ÂçáÁ¥öÂèäÂäüËÉΩË™™ÊòéÔºöÈÅìÂÖ∑ÂàÜÁÇ∫ÂÖµÂô®„ÄÅÂäüÊ≥ï„ÄÅÈô£Ê≥ï„ÄÅÈùàÂô®„ÄÅÈùàÁ¨¶„ÄÅ‰ªô‰∏πÁ≠âÈ°ûÔºö
          - ÂÖµÂô®ÔºöÂ¢ûÂä†ÂèØÈÅ∏Á≠îÊ°àÊï∏ÔºåÂèØÂú®Â§öÈÅ∏È°å‰∏≠‰ΩøÁî®Ôºõ
          - ÂäüÊ≥ïÔºöÊéíÈô§ÈÉ®ÂàÜÈåØË™§Á≠îÊ°àÔºõ
          - Èô£Ê≥ïÔºöÂ¢ûÂä†Áï∂È°å‰ΩúÁ≠îÊôÇÈñìÔºõ
          - ÈùàÂô®ÔºöÈ°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°àÔºõ
          - ÈùàÁ¨¶ÔºöÈ°ØÁ§∫ÈÉ®ÂàÜÈåØË™§Á≠îÊ°àÔºõ
          - ‰ªô‰∏πÔºöÁ´ãÂç≥Â¢ûÂä†‰øÆÁÖâÁ∂ìÈ©ó„ÄÇ
          ÈÅìÂÖ∑ÂèØ‰ª•Âú®ÂïÜÂ∫óË≥ºË≤∑ÔºåÊàñÈÄèÈÅéÊ∂àËÄóÈùàÁü≥ÂçáÁ¥öÁÇ∫Êõ¥È´òÂìÅÈöéÔºåÊïàÊûúÂ∞áÊõ¥Âº∑„ÄÇÂçáÁ¥öÊ∂àËÄóÁöÑÈùàÁü≥ÊúÉÂç≥ÊôÇÊâ£Èô§‰∏¶Êõ¥Êñ∞È°ØÁ§∫„ÄÇ
       4. ËôïÁΩ∞Ê©üÂà∂ÔºöËã•Ë®ìÁ∑¥ÁµêÊùüÊôÇÂæóÂàÜ‰ΩéÊñºË©≤Èõ£Â∫¶Ë¶ÅÊ±ÇÁöÑÂãùÁéáÈñÄÊ™ªÔºåÂ∞áÊâ£Ê∏õ‰øÆÁÖâÁ∂ìÈ©ó„ÄÇÂ∑ÆË∑ùÊØèÂ¢ûÂä† 5 ÂàÜÔºåËôïÁΩ∞ÁéáÁøªÂÄçÔºöÂ∑Æ 5 ÂàÜÊâ£ 1%ÔºåÂ∑Æ 10 ÂàÜÊâ£ 2%ÔºåÂ∑Æ 15 ÂàÜÊâ£ 4%ÔºåÂ∑Æ 20 ÂàÜÊâ£ 8%ÔºåÂ∑Æ 25 ÂàÜÊâ£ 16%ÔºåÂ∑Æ 30 ÂàÜÊâ£ 32%Ôºå‰ª•Ê≠§È°ûÊé®„ÄÇÁï∂‰øÆÁÖâÁ∂ìÈ©óÁÇ∫ 0 ÊôÇ‰∏çÂÜçÊâ£Ê∏õ„ÄÇ*/
    const content = `
        <div style="text-align:left;">
            <h3>1. ÂçáÁ¥öÁçéÂãµË™™Êòé</h3>
            <p>Áï∂‰Ω†ÁöÑ‰øÆÁÖâÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÂêåÊôÇÈÅîÂà∞‰∏ã‰∏ÄÂ±§ÈñÄÊ™ªÊôÇÔºå‰øÆÁÇ∫ÊúÉËá™ÂãïÁ™ÅÁ†¥„ÄÇÊØèÁ™ÅÁ†¥‰∏ÄÂ±§Ôºå‰æùÊìöÁ™ÅÁ†¥Â±§Á¥öÂ∑ÆË∑ùÁç≤ÂæóÁõ∏ÊáâÊï∏ÈáèÁöÑÊ∏¨Ë©¶Ê©üÊúÉËàáÈùàÁü≥„ÄÇ</p>
            <h3>2. ÈÅäÊà≤ÈóúÂç°Ë™™Êòé</h3>
            <p>Ë®ìÁ∑¥ÂÖ±Êúâ 10 ÂÄãÈõ£Â∫¶ÔºåÊØèÂõûÂêàÂåÖÂê´ 20 È°åÂúñÁ§∫ÔºåË´ãÂú®ÂÄíÊï∏ÊôÇÈñìÂÖßÈÅ∏Âá∫ÁõÆÊ®ô„ÄÇÁ≠îÂ∞çËÉΩÁ¥ØÁ©ç‰øÆÁÖâÁ∂ìÈ©óËàáË®ìÁ∑¥Ê¨°Êï∏ÔºõÈÅîÂà∞Ë©≤Èõ£Â∫¶Ë¶ÅÊ±ÇÁöÑÂãùÁéáÔºåÂèØÈ°çÂ§ñÁç≤Âæó‰øÆÁÖâÁ∂ìÈ©óÁçéÂãµ„ÄÇ</p>
            <h3>3. ÈÅìÂÖ∑ÂçáÁ¥öÂèäÂäüËÉΩË™™Êòé</h3>
            <p>ÈÅìÂÖ∑ÂàÜÁÇ∫ÂÖµÂô®„ÄÅÂäüÊ≥ï„ÄÅÈô£Ê≥ï„ÄÅÈùàÂô®„ÄÅÈùàÁ¨¶„ÄÅ‰ªô‰∏πÁ≠âÈ°ûÔºåÊØèÁ®ÆÈÅìÂÖ∑ÂäüËÉΩÂ¶Ç‰∏ãÔºö</p>
            <ul>
                <li><b>ÂÖµÂô®</b>ÔºöÂ¢ûÂä†ÂèØÈÅ∏Á≠îÊ°àÊï∏ÔºåÂèØÁî®ÊñºÂ§öÈÅ∏È°å„ÄÇ</li>
                <li><b>ÂäüÊ≥ï</b>ÔºöÊéíÈô§ÈÉ®ÂàÜÈåØË™§Á≠îÊ°à„ÄÇ</li>
                <li><b>Èô£Ê≥ï</b>ÔºöÂ¢ûÂä†‰ΩúÁ≠îÊôÇÈñìÔºåÂÉÖÂ∞çÁï∂È°åÊúâÊïà„ÄÇ</li>
                <li><b>ÈùàÂô®</b>ÔºöÈ°ØÁ§∫ÂÖ®ÈÉ®Ê≠£Á¢∫Á≠îÊ°à„ÄÇ</li>
                <li><b>ÈùàÁ¨¶</b>ÔºöÈ°ØÁ§∫ÈÉ®ÂàÜÈåØË™§Á≠îÊ°à„ÄÇ</li>
                <li><b>‰ªô‰∏π</b>ÔºöÁ´ãÂç≥Â¢ûÂä†‰øÆÁÖâÁ∂ìÈ©ó„ÄÇ</li>
            </ul>
            <p>ÈÅìÂÖ∑ÂèØÂú®ÂïÜÂ∫óË≥ºË≤∑ÔºåÊàñ‰ΩøÁî®ÈùàÁü≥ÈÄ≤Ë°åÂçáÁ¥ö‰ª•ÊèêÂçáÊïàÊûú„ÄÇÂçáÁ¥öÊôÇÊ∂àËÄóÁöÑÈùàÁü≥ÊúÉÂç≥ÂàªÂæû‰Ω†ÁöÑÂ∏≥Êà∂Êâ£Èô§‰∏¶Âà∑Êñ∞‰∏ªÁï´Èù¢„ÄÇ</p>
            <h3>4. ËôïÁΩ∞Ê©üÂà∂</h3>
            <p>Ëã•Ë®ìÁ∑¥ÁµêÁÆóÂæóÂàÜ‰ΩéÊñºË©≤Èõ£Â∫¶Ë¶ÅÊ±ÇÁöÑÂãùÁéáÈñÄÊ™ªÔºå‰Ω†ÁöÑ‰øÆÁÖâÁ∂ìÈ©óÂ∞áË¢´Êâ£Ê∏õ„ÄÇËàáÈñÄÊ™ªÂ∑ÆË∑ùÊØèÂ¢ûÂä† 5 ÂàÜÔºåËôïÁΩ∞ÁéáÁøªÂÄçÔºöÂ∑Æ 5 ÂàÜÊâ£ 1%ÔºåÂ∑Æ 10 ÂàÜÊâ£ 2%ÔºåÂ∑Æ 15 ÂàÜÊâ£ 4%ÔºåÂ∑Æ 20 ÂàÜÊâ£ 8%ÔºåÂ∑Æ 25 ÂàÜÊâ£ 16%ÔºåÂ∑Æ 30 ÂàÜÊâ£ 32%Ôºå‰æùÊ≠§È°ûÊé®„ÄÇÁï∂‰øÆÁÖâÁ∂ìÈ©óÁÇ∫ 0 ÊôÇ‰∏çÂÜçÊâ£Ê∏õ„ÄÇ</p>

            <h3>5. ÂÆåÁæéËàáÁßòÂ¢ÉÁçéÂãµ</h3>
            <p>Âú®ÊôÆÈÄöË®ìÁ∑¥‰∏≠ÔºåËã•Âú® 20 È°å‰∏≠ÂèñÂæó 100 ÂàÜÊªøÂàÜÔºåÂ∞áÊ†πÊìöÊåëÊà∞Èõ£Â∫¶È°çÂ§ñÁç≤ÂæóÈö®Ê©üÁçéÂãµÔºöÈõ£Â∫¶ 1 ÊôÇÈ°çÂ§ñ 1 ‰ªΩÁçéÂãµÔºåÈõ£Â∫¶ 2 ÊôÇ 2 ‰ªΩÔºå‰ª•Ê≠§È°ûÊé®„ÄÇ</p>
            <p>Âú®ÁßòÂ¢ÉË©¶ÁÖâ‰∏≠ÔºåËã•Êú¨Ê¨°ÈÄ£Á∫åÁ≠îÂ∞çÈ°åÊï∏Ë∂ÖË∂äÊó¢ÂæÄÊúÄÈ´òÁ¥ÄÈåÑÔºåÂ∞áÁç≤ÂæóÈ°çÂ§ñÁçéÂãµÔºåÊñ∞Á¥ÄÈåÑË∂äÈ´òÁçéÂãµË∂äË±êÂéö„ÄÇÊØèÁ™ÅÁ†¥ 100 È°åÂ∞áÈ°çÂ§ñÂ¢ûÂä† 2 ‰ªΩÁçéÂãµÔºåË∂ÖË∂ä 500 È°å‰ª•‰∏äÂèØÁç≤ÂæóÊõ¥Â§öÂÄçÁçéÂãµ„ÄÇ</p>
            <p>ÈÄ≤ÂÖ•ÁßòÂ¢ÉË©¶ÁÖâÈúÄË¶ÅÊ∂àËÄóÈùàÁü≥ÔºöÁßòÂ¢ÉÈõ£Â∫¶ 1 Ê∂àËÄó 10 È°ÜÈùàÁü≥Ôºå‰πãÂæåÊØèÊèêÈ´ò 1 Á¥öÊâÄÈúÄÊ∂àËÄóÁøªÂÄç„ÄÇ‰æãÂ¶ÇÈõ£Â∫¶ 2 Ê∂àËÄó 20 È°ÜÔºåÈõ£Â∫¶ 3 Ê∂àËÄó 40 È°Ü„ÄÇ</p>
        </div>
    `;
    showModal("üìú ÈÅäÊà≤Ë¶èÂâáË™™Êòé", content, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

// ===================== ÁßòÂ¢ÉË©¶ÁÖâËàáÊéíË°åÊ¶ú / ÁôªÂÖ•Á≥ªÁµ± =====================

// # ÁßòÂ¢ÉË©¶ÁÖâ‰∏ªÈÅ∏ÂñÆÔºöËÆìÁé©ÂÆ∂ÊåëÈÅ∏Èõ£Â∫¶ÂæåÈñãÂßãÁßòÂ¢ÉË©¶ÁÖâ
function renderSecretTrialMenu() {
    clearApp();
    // Âú®Ê∏≤ÊüìÁßòÂ¢ÉÈÅ∏ÂñÆÂâçÔºåÈáçÊñ∞ËÆÄÂèñÊú¨Âú∞ÁßòÂ¢ÉÁ¥ÄÈåÑÔºåÁ¢∫‰øùÊåâÈàï‰∏äÈ°ØÁ§∫ÁöÑÊúÄÈ´òÁ≠îÈ°åÊï∏ÊúÄÊñ∞
    try {
        maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, maxTrialScores || {});
    } catch (e) { /* ignore */ }
    let html = `<h1>üåå ÁßòÂ¢ÉË©¶ÁÖâ</h1>`;
    html += `<p style="text-align:center;">Ë´ãÈÅ∏ÊìáÁßòÂ¢ÉÈõ£Â∫¶Ôºà1 ÊúÄÁ∞°ÂñÆÔΩû10 ÊúÄÂõ∞Èõ£Ôºâ</p>`;
    for (let i = 1; i <= 10; i++) {
        const best = maxTrialScores[i] || 0;
        // # ÊØèÂÄãÁßòÂ¢ÉÈõ£Â∫¶ÁöÑÊ∂àËÄóÔºöÈõ£Â∫¶ 1 ÁÇ∫ 10 È°ÜÈùàÁü≥Ôºå‰πãÂæåÊØè‰∏ÄÁ¥öÁøªÂÄç
        const cost = 10 * Math.pow(2, i - 1);
        // # Â∞áÊâÄÈúÄÈùàÁü≥ËàáÊúÄÈ´òÁ≠îÂ∞çÈ°åÊï∏Ê®ôË®ªÂú®ÊåâÈàïÊñáÂ≠ó‰∏≠
        html += `<button data-action="start-trial" data-level="${i}">ÁßòÂ¢ÉÈõ£Â∫¶ ${i}Ôºà${cost}ÈùàÁü≥Ôºâ(ÊúÄÈ´òÁ≠îÂ∞çÔºö${best} È°å)</button>`;
    }
    html += `<button data-action="render-main-menu">üîô ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>`;
    app.innerHTML = html;
}

// # ÈñãÂßãÁßòÂ¢ÉË©¶ÁÖâÔºöÈ°åÊï∏ÁÑ°ÈôêÂà∂ÔºåÁõ¥Âà∞Á≠îÈåØÁÇ∫Ê≠¢
function startTrial(level) {
    // # ÈÄ≤ÂÖ•ÁßòÂ¢ÉË©¶ÁÖâÈúÄÊ∂àËÄóÈùàÁü≥ÔºöÈõ£Â∫¶ 1 Ê∂àËÄó 10Ôºå‰πãÂæåÊØèÊèêÈ´ò 1 Á¥öÈúÄÊ±ÇÁøªÂÄç
    try {
        var cost = 10 * Math.pow(2, (level - 1));
        // # Ëã•ÈùàÁü≥‰∏çË∂≥ÂâáÊãíÁµïÈÄ≤ÂÖ•Ë©¶ÁÖâ
        if (typeof gameState !== 'undefined' && gameState.stones < cost) {
            alert('üíé ÈùàÁü≥‰∏çË∂≥ÔºåÁÑ°Ê≥ïÈÄ≤ÂÖ•ÁßòÂ¢ÉË©¶ÁÖâÔºÅ');
            return;
        }
        if (typeof gameState !== 'undefined') {
            gameState.stones -= cost;
            try { saveGameState(); } catch (e) {}
            // # Êõ¥Êñ∞‰∏ªÁï´Èù¢È°ØÁ§∫ÈùàÁü≥Êï∏ÈáèÔºàËã•ÂèØÁî®Ôºâ
            if (typeof updateMainMenuInfo === 'function') {
                try { updateMainMenuInfo(); } catch (e) {}
            }
        }
    } catch (e) {}
    trainingState = {
        mode: 'secretTrial',
        difficulty: level,
        round: 0,
        success: 0,
        fail: 0,
        totalRounds: Infinity,
        hasAnswered: false,
        correctAnswers: [],
        gameGridButtons: [],
        hasUsedSingleUseItem: false,
        allowedChoices: 1,
        selectedChoices: [],
    };
    // # Ë®òÈåÑÈñãÂßãÊôÇÈñìËàá‰ΩøÁî®ÈÅéÁöÑÈÅìÂÖ∑
    try {
        trainingState.startedAt = Date.now();
        trainingState.usedItems = [];
    } catch (e) {}
    trialNext();
}

// # ÁßòÂ¢ÉË©¶ÁÖâ‰∏ã‰∏ÄÈ°åÔºöÈ°û‰ººÊñº trainingNextÔºå‰ΩÜÊ≤íÊúâÈ°åÊï∏ÈôêÂà∂
function trialNext() {
    trainingState.round++;
    // ÈáçÁΩÆÊØèÈ°åÁãÄÊÖã
    trainingState.hasAnswered = false;
    trainingState.hasUsedSingleUseItem = false;
    trainingState.allowedChoices = 1;
    trainingState.selectedChoices = [];
    trainingState.roundExtraTime = 0;
    trainingState.countdownRemaining = null;
    const gameDef = ALL_GAMES[Math.floor(Math.random() * ALL_GAMES.length)];
    const gameFunc = window[gameDef.func];
    gameFunc();
}

// # ÁßòÂ¢ÉË©¶ÁÖâÁµêÊùüËàáÁçéÂãµÁµêÁÆó
function showTrialResult() {
    clearApp();
    const correctCount = trainingState.success || 0;
    // Ë®òÈåÑÊúÄÈ´òÁ¥ÄÈåÑ
    const diff = trainingState.difficulty;
    const prevBestTrial = maxTrialScores[diff] || 0;
    if (!maxTrialScores[diff] || correctCount > maxTrialScores[diff]) {
        maxTrialScores[diff] = correctCount;
        // # ÂÑ≤Â≠òÂà∞ localStorage
        try { saveToLocalStorage(TRIAL_SCORE_FILE, maxTrialScores); } catch (e) {}
    }
    const prevTotalTrainCount = gameState.total;
    gameState.total++;
    // Âü∫Á§éÁ∂ìÈ©ó
    const baseExp = 1;
    // È°çÂ§ñÁ∂ìÈ©óÔºöÊØè 10 È°å +1
    const bonusExp = Math.floor(correctCount / 10);
    const prevExp = gameState.exp;
    gameState.exp += baseExp + bonusExp;
    if (bonusExp > 0) gameState.bonus = (gameState.bonus || 0) + bonusExp;
    // ÁôºÊîæÈö®Ê©üÁçéÂãµÔºöÊØè 20 È°å 1 ÂÄã
    let rewardsHTML = '';
    const rewardCount = Math.floor(correctCount / 20);
    if (rewardCount > 0) {
        const rewardsList = grantRandomRewards(rewardCount)[0];
        rewardsHTML += `<div class="message msg-reward">üéÅ ÁßòÂ¢ÉË°®ÁèæÁç≤Âæó ${rewardCount} ÂÄãÈö®Ê©üÁçéÂãµÔºö<br>${rewardsList.join('<br>')}</div>`;
    }
    // Áï∂Ë∂ÖÈÅéÈÅéÂæÄÊúÄÈ´òÁ¥ÄÈåÑÊôÇÔºåÁµ¶‰∫àÈ°çÂ§ñÁçéÂãµÔºåÈõ£Â∫¶Ë∂äÈ´ò„ÄÅÁ≠îÂ∞çË∂äÂ§öÈ°åÔºåÁçéÂãµË∂äÂ§ö
    let recordRewardHTML = '';
    try {
        if (correctCount > prevBestTrial) {
            // # Ë®≠ÂÆöË∂ÖË∂äÁ¥ÄÈåÑÁöÑÁçéÂãµÊï∏ÈáèÔºöÂü∫ÊñºÊñ∞Á¥ÄÈåÑÁöÑÈ°åÊï∏ÔºåÊØè 100 È°åÂ¢ûÂä† 2 ‰ªΩÁçéÂãµ
            const rewardCountRecord = 1 + Math.floor(correctCount / 100) * 2;
            const [recordRewards] = grantRandomRewards(rewardCountRecord);
            recordRewardHTML = `<div class="message msg-reward">üèÖ Ë∂ÖË∂äÊ≠∑Âè≤Á¥ÄÈåÑÔºÅÁç≤Âæó ${rewardCountRecord} ÂÄãÈ°çÂ§ñÁçéÂãµÔºö<br>${recordRewards.join('<br>')}</div>`;
        }
    } catch (e) { console.warn('Á¥ÄÈåÑÁçéÂãµË®àÁÆóÈåØË™§', e); }

    // ÁôºÊîæÈùàÁü≥ÔºöÊØè 30 È°å 1 È°Ü
    const stonesAward = Math.floor(correctCount / 30);
    if (stonesAward > 0) {
        gameState.stones += stonesAward;
        rewardsHTML += `<p style="text-align:center; color:darkorchid">üíé ÁßòÂ¢ÉË°®ÁèæÁç≤Âæó ${stonesAward} ÈùàÁü≥</p>`;
    }

    // # Ëã•ÈÄôÊ¨°Á≠îÈ°åÊï∏Ë∂ÖÈÅé‰ª•ÂæÄÊúÄÈ´òÁ¥ÄÈåÑÔºåÂ∞áÁ¥ÄÈåÑÁçéÂãµÂä†ÂÖ•È°ØÁ§∫
    if (recordRewardHTML) {
        rewardsHTML += recordRewardHTML;
        // # Êí≠ÊîæÁâπÊÆäÁçéÂãµÈü≥ÊïàÔºàËàáÊ®ÇÈÄèÂ∞çÁçé‰∏≠ÁçéÁõ∏‰ººÔºâ
        try { if (typeof playRewardSound === 'function') playRewardSound(); } catch (_) {}
    }

    // =============== Ë®ìÁ∑¥Ê¨°Êï∏ÁçéÂãµËàá‰ªôÈñÄ‰ΩçÈöéÊõ¥Êñ∞ ===============
    // # Âú®ÁßòÂ¢ÉË©¶ÁÖâ‰∏≠‰πüË®àÁÆóÈÄ±ÊúüÁçéÂãµ„ÄÅÈáåÁ®ãÁ¢ëÁçéÂãµ‰ª•ÂèäÁâπÂÆöÊ¨°Êï∏ÁçéÂãµÔºåËàáÊôÆÈÄöË®ìÁ∑¥Áõ∏Âêå
    try {
        if (gameState.total > 0 && gameState.total % 5 === 0) {
            const [cycleRewards] = grantRandomRewards(1);
            rewardsHTML += `<div class="message msg-reward">üéâ Á¥ØÁ©çË®ìÁ∑¥ÈÅî ${gameState.total} Ê¨°ÔºåÈÅîÊàêÈÄ±ÊúüÁçéÂãµÔºÅ<br>${cycleRewards.join('<br>')}</div>`;
        }
        if (TRAINING_MILESTONES[gameState.total]) {
            const milestone = TRAINING_MILESTONES[gameState.total];
            gameState.current_title = milestone.title;
            const [milestoneRewards] = grantRandomRewards(milestone.rewards);
            rewardsHTML += `<div class="message msg-reward">üèÜ ÊÅ≠ÂñúÔºÅË®ìÁ∑¥ÈÅî ${gameState.total} Ê¨°ÔºåÈÅîÊàêÈáåÁ®ãÁ¢ëÔºÅ<br>Áç≤ÂæóÊñ∞‰ΩçÈöéÔºö„Äê${milestone.title}„Äë<br>Áç≤ÂæóÁçéÂãµÔºö<br>${milestoneRewards.join('<br>')}</div>`;
        }
        const countRewards = checkTrainingCountRewards(prevTotalTrainCount, gameState.total);
        if (countRewards) rewardsHTML += `<div class="message msg-reward">${countRewards}</div>`;
    } catch (e) { console.warn('ÁßòÂ¢ÉË®ìÁ∑¥ÁçéÂãµÈåØË™§', e); }

    // ÂçáÁ¥öÂà§ÂÆö
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    let resultHTML = `<h2>üåå ÁßòÂ¢ÉË©¶ÁÖâÂÆåÊàê</h2>`;
    resultHTML += `<div class="feedback success">ÈÄ£Á∫åÁ≠îÂ∞çÈ°åÊï∏Ôºö${correctCount}</div>`;
    resultHTML += `<p style="text-align:center;">üí° ‰øÆÁÖâÁ∂ìÈ©ó +${baseExp + bonusExp}</p>`;
    if (levelupMsg) resultHTML += `<p class="message msg-levelup">${levelupMsg}</p>`;
    resultHTML += rewardsHTML;
    // È°ØÁ§∫Âõû‰∏ªÈÅ∏ÂñÆÊåâÈàï
    // # Êñ∞Â¢ûÂÜçÊ¨°ÊåëÊà∞ÊåâÈàïÔºöËã•ÈùàÁü≥Ë∂≥Â§†ÔºåÂâáÂèØÂÜçÊ¨°ÊåëÊà∞Êú¨Èõ£Â∫¶
    try {
        const diff = trainingState.difficulty || 1;
        const cost = 10 * Math.pow(2, diff - 1);
        const disabledAttr = (typeof gameState !== 'undefined' && gameState.stones < cost) ? 'disabled' : '';
        resultHTML += `<button data-action="retry-trial" data-level="${diff}" ${disabledAttr}>üîÑ ÂÜçÊ¨°ÊåëÊà∞</button>`;
    } catch (e) {
        // Ëã•Âá∫ÁèæÈåØË™§‰ªçÈ°ØÁ§∫ÂèØÂÜçÊ¨°ÊåëÊà∞
        resultHTML += `<button data-action="retry-trial">üîÑ ÂÜçÊ¨°ÊåëÊà∞</button>`;
    }
    resultHTML += `<button data-action="render-main-menu">üîÅ Âõû‰∏ªÈÅ∏ÂñÆ</button>`;
    app.innerHTML = resultHTML;
    saveGameState();
    // # ‰∏äÂÇ≥ÁßòÂ¢ÉÁ¥ÄÈåÑËá≥Èõ≤Á´Ø (Firestore)
    try {
        if (typeof saveTrialRecord === 'function') {
            const _durationSec = Math.max(0, Math.floor((Date.now() - (trainingState.startedAt || Date.now())) / 1000));
            const _usedItems = Array.isArray(trainingState.usedItems) ? trainingState.usedItems.slice(0) : [];
            saveTrialRecord({
                level: trainingState.difficulty,
                score: correctCount,
                mode: 'ÁßòÂ¢ÉË©¶ÁÖâ',
                usedItems: _usedItems,
                durationSec: _durationSec,
                result: 'fail',
                publishToLeaderboard: true
            });
        }
    } catch (e) { console.warn('saveTrialRecord failed', e); }
    // Êõ¥Êñ∞‰∏ªÁï´Èù¢Ë≥áË®ä
    if (typeof updateMainMenuInfo === 'function') {
        try { updateMainMenuInfo(); } catch(e) {}
    }
}

// # Â∞áÁßòÂ¢ÉË©¶ÁÖâÁ¥ÄÈåÑÂØ´ÂÖ•Èõ≤Á´ØÔºö
async function saveTrialRecord(rec) {
    // rec: { level, score, mode, usedItems, durationSec, result, publishToLeaderboard }
    if (!FIREBASE_ONLINE_ENABLED || !db) return;
    var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
    if (!u) return;
    var uid = u.uid;
    var now = firebase.firestore.Timestamp.now();
    var runRef = db.collection('users').doc(uid).collection('trials').doc();
    var statRef = db.collection('user_trial_stats').doc(uid);
    return db.runTransaction(async function(tx) {
        tx.set(runRef, Object.assign({}, rec, {
            createdAt: now,
            clientAt: new Date().toISOString(),
            appVersion: 'web-1.0.0'
        }));
        var statSnap = await tx.get(statRef);
        var prev = statSnap.exists ? statSnap.data() : { totalTrials: 0, bestScore: -1 };
        var next = {
            totalTrials: (prev.totalTrials || 0) + 1,
            bestScore: Math.max(prev.bestScore || -1, rec.score || 0),
            lastPlayedAt: now
        };
        tx.set(statRef, next, { merge: true });
    }).then(async function() {
        // # Êõ¥Êñ∞ÂÖ¨ÈñãÊéíË°åÊ¶úÔºöÂä†ÂÖ•ÊàñÊõ¥Êñ∞ÂêÑÈõ£Â∫¶ÊúÄÈ´òÁ≠îÂ∞çÈ°åÊï∏ËàáÁé©ÂÆ∂Âü∫Êú¨Ë≥áÊñô
        if (rec.publishToLeaderboard) {
            try {
                var prof = await getOrInitUserProfile();
                var leaderRef = db.collection('leaderboard_trial_public').doc(uid);
                await db.runTransaction(async function(tx2) {
                    var snap = await tx2.get(leaderRef);
                    var data = snap.exists ? snap.data() : {};
                    var bestScores = Object.assign({}, data.bestScores || {});
                    // # Êõ¥Êñ∞Áï∂ÂâçÈõ£Â∫¶ÊúÄÈ´òÂàÜ
                    var prevScore = bestScores[rec.level] || 0;
                    var newScore = Math.max(prevScore, rec.score || 0);
                    bestScores[rec.level] = newScore;
                    // # ÂÖ®ÂüüÊúÄÈ´òÂàÜ
                    var bestScoreOverall = data.bestScore || 0;
                    bestScoreOverall = Math.max(bestScoreOverall, rec.score || 0);
                    // # ÊßãÂª∫Êõ¥Êñ∞Ë≥áÊñô
                    var updateData = {
                        bestScores: bestScores,
                        // # ÂêåÊ≠•‰∏Ä‰ªΩÂà∞ bestByLevel ‰æõËàäÁâàËÆÄÂèñ
                        bestByLevel: bestScores,
                        bestScore: bestScoreOverall,
                        displayName: (prof.personalName && prof.personalName !== '') ? prof.personalName : (prof.displayName || 'ÁÑ°Âêç‰øÆÂ£´'),
                        gender: prof.gender || '',
                        linggen: (typeof prof.linggen !== 'undefined' ? prof.linggen : ((typeof gameState !== 'undefined' && gameState.linggen !== undefined) ? gameState.linggen : null)),
                        createDate: prof.createDate || firebase.firestore.FieldValue.serverTimestamp(),
                        country: prof.country || 'TW',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    tx2.set(leaderRef, updateData, { merge: true });
                });
            } catch (e) {
                console.warn('Êõ¥Êñ∞ÊéíË°åÊ¶úÂ§±Êïó', e);
            }
        }
    }).catch(function(e){ console.warn('saveTrialRecord Â§±ÊïóÔºö', e); });
}

// # ËÆÄÂèñÁßòÂ¢ÉÊéíË°åÊ¶ú Top N
async function loadTrialLeaderboardTopN(n) {
    if (!FIREBASE_ONLINE_ENABLED || !db) return [];
    var qs = await db.collection('leaderboard_trial_public').orderBy('bestScore','desc').limit(n||100).get();
    return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

// # ËÆÄÂèñÁßòÂ¢ÉÊéíË°åÊ¶úÔºöÂèñÂæóÂêÑÈõ£Â∫¶ Top 3 ÂêçÔºàÂê´Áé©ÂÆ∂Ë≥áË®äÔºâ
async function loadTrialLeaderboardGrouped() {
    if (!FIREBASE_ONLINE_ENABLED || !db) return {};
    try {
        var qs = await db.collection('leaderboard_trial_public').get();
        var result = {};
        qs.docs.forEach(function(doc) {
            var d = doc.data() || {};
        // # ÂèñÂæóÂêÑÈõ£Â∫¶ÊúÄ‰Ω≥Á¥ÄÈåÑÔºõÂÖºÂÆπËàäÁâàÂ±¨ÊÄß bestByLevel
        var bestScores = d.bestScores || d.bestByLevel || {};
            // # ÈÅçÊ≠∑ 1~10 Èõ£Â∫¶
            for (var i = 1; i <= 10; i++) {
                var s = bestScores[i];
                if (typeof s === 'number' && s > 0) {
                    if (!result[i]) result[i] = [];
                    // # Â∞áÊó•ÊúüÊ†ºÂºèÂåñÔºàÊé°Áî® createDate Êàñ updatedAtÔºâ
                    var dateStr = '';
                    var dt = d.updatedAt || d.createDate;
                    try {
                        if (dt && typeof dt.toDate === 'function') {
                            var dd = dt.toDate();
                            dateStr = dd.getFullYear() + '-' + String(dd.getMonth()+1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
                        } else if (typeof dt === 'string') {
                            dateStr = dt.split('T')[0];
                        }
                    } catch (_) {}
                    result[i].push({
                        displayName: d.displayName || 'ÁÑ°Âêç‰øÆÂ£´',
                        gender: d.gender || '',
                        linggen: (typeof d.linggen !== 'undefined' && d.linggen !== null) ? d.linggen : '',
                        score: s,
                        date: dateStr
                    });
                }
            }
        });
        // # ÊéíÂ∫è‰∏¶Êà™ÂèñÂâç 3 Âêç
        Object.keys(result).forEach(function(k) {
            result[k].sort(function(a,b) {
                // # ÊåâÂàÜÊï∏ÈôçÂ∫èÔºõËã•ÂàÜÊï∏Áõ∏ÂêåÂâáÊó•ÊúüËøëËÄÖÂú®Ââç
                if (b.score !== a.score) return b.score - a.score;
                if (a.date && b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return 0;
            });
            result[k] = result[k].slice(0, 3);
        });
        return result;
    } catch (e) {
        console.warn('ËÆÄÂèñÊéíË°åÊ¶úÂàÜÁµÑÂ§±Êïó', e);
        return {};
    }
}

// # È°ØÁ§∫ÁßòÂ¢ÉÊéíË°åÊ¶úÔºàÂê´Èõ¢Á∑öË≥áË®äÔºâ
async function showTrialLeaderboard() {
    // ÂÖàÂòóË©¶ÈáçÊñ∞ËÆÄÂèñÊú¨Âú∞ÁßòÂ¢ÉÁ¥ÄÈåÑÔºåÁ¢∫‰øùÊéíË°åÊ¶úË≥áÊñôÊòØÊúÄÊñ∞ÁöÑ
    try {
        // Ëã• localStorage ÂèØÁî®ÔºåÂ∞áÊú¨Âú∞Á¥ÄÈåÑËºâÂÖ• maxTrialScoresÔºõÂ§±ÊïóÊôÇ‰øùÊåÅÂéüÂÄº
        maxTrialScores = loadFromLocalStorage(TRIAL_SCORE_FILE, maxTrialScores || {});
    } catch (e) { /* ignore */ }

    // Â¶ÇÊûúÈõ≤Á´ØÊú™ÂïüÁî®ÂâáÈ°ØÁ§∫Èõ¢Á∑öÁ¥ÄÈåÑ
    if (!FIREBASE_ONLINE_ENABLED || !db) {
        let content = '';
        if (Object.keys(maxTrialScores || {}).length > 0) {
            content += '<p>ÊÇ®ÁöÑÊú¨Âú∞ÁßòÂ¢ÉÊúÄÈ´òÁ¥ÄÈåÑÔºö</p><ul style="padding-left:20px;">';
            for (let i = 1; i <= 10; i++) {
                const s = maxTrialScores[i] || 0;
                content += `<li>ÁßòÂ¢ÉÈõ£Â∫¶ ${i}Ôºö${s} È°å</li>`;
            }
            content += '</ul>';
        } else {
            content = 'Â∞öÁÑ°Êú¨Âú∞ÁßòÂ¢ÉÁ¥ÄÈåÑ„ÄÇ';
        }
        showModal('ÁßòÂ¢ÉÊéíË°åÊ¶ú (Èõ¢Á∑ö)', content, `<button data-action="close-modal">ÈóúÈñâ</button>`);
        return;
    }
    let content = '';
    // # ÂæûÈõ≤Á´ØËÆÄÂèñÂêÑÈõ£Â∫¶Ââç‰∏âÂêçË≥áÊñô
    let grouped = {};
    try {
        grouped = await loadTrialLeaderboardGrouped();
    } catch (e) { console.warn(e); grouped = {}; }
    if (!grouped || Object.keys(grouped).length === 0) {
        // # Ëã•Èõ≤Á´ØÁÑ°Ë≥áÊñôÔºåÂòóË©¶È°ØÁ§∫Êú¨Âú∞Á¥ÄÈåÑ
        if (maxTrialScores && Object.keys(maxTrialScores).length > 0) {
            content += '<p>ÊÇ®ÁöÑÊú¨Âú∞ÁßòÂ¢ÉÊúÄÈ´òÁ¥ÄÈåÑÔºö</p><ul style="padding-left:20px;">';
            for (let i = 1; i <= 10; i++) {
                const s = maxTrialScores[i] || 0;
                content += `<li>ÁßòÂ¢ÉÈõ£Â∫¶ ${i}Ôºö${s} È°å</li>`;
            }
            content += '</ul>';
        } else {
            content = 'ÁõÆÂâçÊö´ÁÑ°ÊéíË°åÊ¶úË≥áÊñô„ÄÇ';
        }
    } else {
        // # Âª∫Á´ãÊØèÂÄãÈõ£Â∫¶ÁöÑÊéíË°åÊ¶úË°®Ê†º
        for (let i = 1; i <= 10; i++) {
            const entries = grouped[i] || [];
            content += `<h3 style="text-align:left; margin-top:10px;">Èõ£Â∫¶ ${i}</h3>`;
            if (entries.length === 0) {
                content += '<p>Êö´ÁÑ°Ë≥áÊñô„ÄÇ</p>';
                continue;
            }
            content += '<table style="width:100%; text-align:center; border-collapse:collapse; margin-bottom:10px;">';
            content += '<tr><th style="border-bottom:1px solid #ccc;">ÂêçÊ¨°</th><th style="border-bottom:1px solid #ccc;">ÂßìÂêç</th><th style="border-bottom:1px solid #ccc;">ÊÄßÂà•</th><th style="border-bottom:1px solid #ccc;">ÈùàÊ†π</th><th style="border-bottom:1px solid #ccc;">ÊúÄÈ´òÁ≠îÂ∞çÈ°åÊï∏</th><th style="border-bottom:1px solid #ccc;">‰∏äÊ¶úÊó•Êúü</th></tr>';
            entries.forEach(function(item, idx) {
                content += `<tr><td>${idx + 1}</td><td>${item.displayName || 'ÁÑ°Âêç‰øÆÂ£´'}</td><td>${item.gender || ''}</td><td>${(item.linggen === null || item.linggen === undefined || item.linggen === '') ? '' : item.linggen}</td><td>${item.score}</td><td>${item.date || ''}</td></tr>`;
            });
            content += '</table>';
        }
    }
    showModal('ÁßòÂ¢ÉÊéíË°åÊ¶ú', content, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

// # È°ØÁ§∫ÁôªÂÖ•/Â∏≥ËôüÁÆ°ÁêÜ‰ªãÈù¢
function showLoginMenu() {
    // Ëã•Èõ≤Á´ØÊú™ÂïüÁî®ÂâáÈ°ØÁ§∫ÊèêÁ§∫
    if (!ONLINE_ENABLED || !supabaseClient) {
        showModal('Â∏≥Ëôü', 'Èõ≤Á´ØÊú™ÂïüÁî®ÔºåÁÑ°Ê≥ïÁôªÂÖ•„ÄÇ', `<button data-action="close-modal">ÈóúÈñâ</button>`);
        return;
    }
    // ÈÄèÈÅé ensureSignedIn() ÂèñÂæóÁõÆÂâç‰ΩøÁî®ËÄÖÂæåÂÜçÂãïÊÖãÁî¢ÁîüÂÖßÂÆπ
    ensureSignedIn().then(function(user) {
        let content = '';
        if (user) {
            const meta = user.user_metadata || {};
            const name = meta.full_name || meta.displayName || user.email || 'Â∑≤ÁôªÂÖ•';
            content += `<p>Â∑≤ÁôªÂÖ•ÁÇ∫Ôºö${name}</p>`;
            content += `<button data-action="logout">ÁôªÂá∫</button>`;
        } else {
            // Â∞öÊú™ÁôªÂÖ•ÔºöÊèê‰æõÁôªÂÖ•ÈÅ∏È†Ö„ÄÇSupabase ‰∏çÊîØÊè¥ÂåøÂêçÁôªÂÖ•„ÄÇ
            content += `<button data-action="login-google">‰ª• Google ÁôªÂÖ•</button>`;
            content += `<button data-action="login-yahoo">‰ª• Yahoo ÁôªÂÖ•</button>`;
            content += `<button data-action="login-facebook">‰ª• Facebook ÁôªÂÖ•</button>`;
            content += `<button data-action="login-email">‰ª• Email/ÂØÜÁ¢ºË®ªÂÜäÁôªÂÖ•</button>`;
        }
        showModal('ÁôªÂÖ• / Â∏≥Ëôü', content, `<button data-action="close-modal">ÈóúÈñâ</button>`);
    });
}


let { data, error } = await supabase.auth.signInWithOAuth({
  provider: 'github'
})

// # Google ÁôªÂÖ•
function loginGoogle() {
    if (!ONLINE_ENABLED || !supabaseClient) return;
    signInWithGoogleKeepData().then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Google ÁôªÂÖ•Â§±Êïó', e);
        alert('Google ÁôªÂÖ•Â§±Êïó');
    });
}

// # ÂåøÂêçÁôªÂÖ•ÔºöÊâãÂãïÂëºÂè´ signInAnonymouslyÔºàÈÄöÂ∏∏Ëá™ÂãïÔºå‰ΩÜÊèê‰æõÈ°ØÂºèÊìç‰ΩúÔºâ
function loginAnonymous() {
    // Supabase ‰∏çÊîØÊè¥ÂåøÂêçÁôªÂÖ•
    alert('Ê≠§Âπ≥Âè∞‰∏çÊîØÊè¥ÂåøÂêçÁôªÂÖ•ÔºåË´ã‰ΩøÁî®ÂÖ∂‰ªñÊñπÂºèÁôªÂÖ•');
}
// # Email/ÂØÜÁ¢º ÁôªÂÖ•ÊàñË®ªÂÜäÔºàÁ∞°Êòì promptÔºâ
function loginEmail() {
    if (!ONLINE_ENABLED || !supabaseClient) return;
    const email = prompt('Ë´ãËº∏ÂÖ• Email');
    if (!email) return;
    const password = prompt('Ë´ãËº∏ÂÖ•ÂØÜÁ¢º (Ëá≥Â∞ë 6 Â≠ó)');
    if (!password) return;
    upgradeToEmailPassword(email, password).then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Email ÁôªÂÖ•ÊàñË®ªÂÜäÂ§±Êïó', e);
        alert('Email ÁôªÂÖ•ÊàñË®ªÂÜäÂ§±Êïó');
    });
}

// # Yahoo ÁôªÂÖ•
function loginYahoo() {
    if (!ONLINE_ENABLED || !supabaseClient) return;
    signInWithYahooKeepData().then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Yahoo ÁôªÂÖ•Â§±Êïó', e);
        alert('Yahoo ÁôªÂÖ•Â§±Êïó');
    });
}

// # Facebook ÁôªÂÖ•
function loginFacebook() {
    if (!ONLINE_ENABLED || !supabaseClient) return;
    signInWithFacebookKeepData().then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('Facebook ÁôªÂÖ•Â§±Êïó', e);
        alert('Facebook ÁôªÂÖ•Â§±Êïó');
    });
}

// # ÁôªÂá∫
function logout() {
    if (!ONLINE_ENABLED || !supabaseClient) return;
    signOutOnline().then(function(){
        try { modal.style.display = 'none'; } catch (_) {}
        if (typeof renderMainMenu === 'function') renderMainMenu();
    }).catch(function(e){
        console.warn('ÁôªÂá∫Â§±Êïó', e);
        alert('ÁôªÂá∫Â§±Êïó');
    });
}

// Êõ¥Êñ∞‰∏ªÈÅ∏ÂñÆË≥áÊñôÔºå‰æãÂ¶Ç‰øÆÁÖâÁ∂ìÈ©ó„ÄÅÈùàÁü≥ËàáË®ìÁ∑¥Ê¨°Êï∏Á≠â„ÄÇ
// # Áï∂Ê∂àËÄóÊàñÂ¢ûÂä†‰øÆÁÖâÁ∂ìÈ©ó/ÈùàÁü≥ÂæåÔºåÂèØË™øÁî®Ê≠§ÂáΩÂºèÂç≥ÊôÇÊõ¥Êñ∞‰∏ªÈÅ∏ÂñÆÈ°ØÁ§∫„ÄÇ
function updateMainMenuInfo() {
    const info = document.querySelector('.info-section');
    if (!info) return;
    const highestScore = Object.keys(maxScores).length > 0 ? Math.max(...Object.values(maxScores)) : 0;
    const currentStage = getCultivationStage(gameState.exp);
    const nextInfo = getNextCultivationInfo(gameState.exp);
    const ps = info.querySelectorAll('p');
    if (ps[0]) ps[0].innerHTML = `üßò‚Äç‚ôÇÔ∏è ÁõÆÂâç‰øÆÁÇ∫Ôºö${currentStage}`;
    if (ps[1]) ps[1].innerHTML = `üéñÔ∏è ÁõÆÂâç‰ªôÈñÄ‰ΩçÈöéÔºö${gameState.current_title}`;
    let tip = "üåü ‰Ω†Â∑≤ÈÅîÂà∞ÊúÄÁµÇ‰øÆÁÇ∫ÔºÅ";
    let progressVal = 100;
    if (nextInfo) {
        tip = `‚¨ÜÔ∏è Ë∑ùÈõ¢„Äå${nextInfo.next_stage}„ÄçÈÇÑÂ∑Æ ${nextInfo.exp_needed} ‰øÆÁÖâÁ∂ìÈ©ó„ÄÅË®ìÁ∑¥ ${nextInfo.train_needed} Ê¨°`;
        let prevNeed = 0;
        for (const [need_exp] of CULTIVATION_STAGES) {
            if (gameState.exp >= need_exp) prevNeed = need_exp;
            else break;
        }
        let nextNeed = CULTIVATION_STAGES.find(([need_exp]) => gameState.exp < need_exp)?.[0];
        if (nextNeed !== undefined) {
            const span = Math.max(1, nextNeed - prevNeed);
            progressVal = Math.floor((gameState.exp - prevNeed) * 100 / span);
        }
    }
    if (ps[2]) ps[2].innerHTML = tip;
    const progressEl = info.querySelector('progress');
    if (progressEl) progressEl.value = progressVal;
    if (ps[3]) ps[3].innerHTML = `üèãÔ∏è Á¥ØÁ©çË®ìÁ∑¥Ê¨°Êï∏Ôºö${gameState.total} | ‚öîÔ∏è ‰øÆÁÖâÁ∂ìÈ©óÔºö${gameState.exp} | ‚≠ê ÊúÄÈ´òÂàÜÔºö${highestScore}`;
    if (ps[4]) ps[4].innerHTML = `üéüÔ∏è Ê∏¨Ë©¶Ê©üÊúÉÔºö${gameState.luck_tickets} Ê¨° (Á¥ØÁ©çÁç≤ÂæóÔºö${gameState.luck_tickets_total})`;
    if (ps[5]) ps[5].innerHTML = `üíé ÈùàÁü≥Ôºö${gameState.stones}`;
    // # Êõ¥Êñ∞ÂÄã‰∫∫Ë≥áË®äËàáÈùàÊ†π
    if (ps[6]) {
        const nameVal = gameState.personalName || 'Êú™Ë®≠ÂÆö';
        const genderVal = gameState.gender || 'Êú™Ë®≠ÂÆö';
        let ling = '';
        if (gameState.linggen === undefined || gameState.linggen === null) {
            ling = 'Êú™Ê∏¨';
        } else if (gameState.linggen <= 0) {
            ling = 'ÁÑ°ÈùàÊ†π';
        } else {
            ling = gameState.linggen + ' ÈùàÊ†π';
        }
        ps[6].innerHTML = `üë§ ÂßìÂêçÔºö${nameVal} | ÊÄßÂà•Ôºö${genderVal} | üå± ÈùàÊ†πÔºö${ling}`;
    }
}

function showBackpack() {
    const sortedInventory = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      // ‰ΩøÁî® compareItemNames Á¢∫‰øù‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
      .sort(([a], [b]) => compareItemNames(a, b));
    let content = '';
    if (sortedInventory.length === 0) {
      content = "<p>ËÉåÂåÖÁ©∫Á©∫Â¶Ç‰πü</p>";
    } else {
      content = '<ul style="padding-left: 20px;">' +
        sortedInventory.map(([name, qty]) => `<li>${name} √ó${qty}</li>`).join('') +
        '</ul>';
    }
    const footer = `
      <button data-action="use-exp-items">üçµ ‰ΩøÁî®‰ªô‰∏π</button>
      <button class="btn-danger" data-action="delete-items">üóëÔ∏è Âà™Èô§ÈÅìÂÖ∑</button>`;
    showModal("üéí ËÉåÂåÖ", content, footer);
}

// === ‰ΩøÁî®‰ªô‰∏πÔºàEXP È°ûÔºâ===
function showUseExpDialog() {
  const expItems = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp'))
    // ‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (expItems.length === 0) {
    content = "<p>Ê≤íÊúâÂèØÁî®ÁöÑ‰ªô‰∏πÈ°ûÈÅìÂÖ∑</p>";
  } else {
    content = expItems.map(([name, qty]) => {
      const eff = ITEM_EFFECTS[name] || {};
      const addExp = eff.n || 0;
      return `
        <div class="modal-item-row">
          <label for="useexp-${name}">${name}ÔºàÊåÅÊúâ ${qty}Ôºâ‚Üí ÊØèÈ°Ü +${addExp} EXP</label>
          <input type="number" id="useexp-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
  }
  const footer = `
    <button data-action="fill-all-exp">ÂÖ®ÈÉ®Â°´Êªø</button>
    <button data-action="confirm-use-exp">Á¢∫Ë™ç‰ΩøÁî®</button>
    <button data-action="confirm-use-exp-all" class="btn-warning">ÂÖ®ÈÉ®‰ΩøÁî®</button>`;
  showModal("üçµ ‰ΩøÁî®‰ªô‰∏π", content, footer);
}

function confirmUseExp() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  let totalGain = 0;
  const inv = gameState.inventory;
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('useexp-', '');
    const eff = ITEM_EFFECTS[name] || {};
    const add = (eff.n || 0) * qty;
    const cur = inv[name] || 0;
    inv[name] = Math.max(0, cur - qty);
    totalGain += add;
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("üçµ ‰ΩøÁî®ÁµêÊûú",
      `<p>ÂÖ±Áç≤Âæó +${totalGain} EXP</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">ÈóúÈñâ</button>`);
  } else {
    showModal("üçµ ‰ΩøÁî®ÁµêÊûú", "<p>Êú™ÈÅ∏Êìá‰ªª‰Ωï‰ªô‰∏π„ÄÇ</p>", `<button data-action="close-modal">ÈóúÈñâ</button>`);
  }
}

// === ÊâπÈáèÂ°´ÊªøËàáÂÖ®ÈÉ®‰ΩøÁî® EXP È°û‰ªô‰∏π ===
function fillAllExpInputs() {
  const inputs = modalBody.querySelectorAll('input[id^="useexp-"]');
  inputs.forEach(input => {
    const max = parseInt(input.getAttribute('max') || '0', 10);
    if (max > 0) input.value = String(max);
  });
}

function confirmUseExpAll() {
  const inv = gameState.inventory;
  let totalGain = 0;
  Object.entries(inv).forEach(([name, qty]) => {
    if (qty > 0 && (ITEM_EFFECTS[name]?.type === 'exp')) {
      const eff = ITEM_EFFECTS[name];
      const add = (eff.n || 0) * qty;
      inv[name] = 0;
      totalGain += add;
    }
  });
  if (totalGain > 0) {
    const prevExp = gameState.exp;
    gameState.exp += totalGain;
    saveGameState();
    const levelupMsg = handleLevelUp(prevExp, gameState.exp);
    showModal("üçµ ‰ΩøÁî®ÁµêÊûú",
      `<p>ÂÖ±Áç≤Âæó +${totalGain} EXPÔºàÂÖ®ÈÉ®‰ΩøÁî®Ôºâ</p>${levelupMsg ? `<p class="msg-levelup">${levelupMsg}</p>` : ''}`,
      `<button data-action="close-modal">ÈóúÈñâ</button>`);
  } else {
    showModal("üçµ ‰ΩøÁî®ÁµêÊûú", "<p>Ê≤íÊúâÂèØÁî®ÁöÑ‰ªô‰∏π„ÄÇ</p>", `<button data-action="close-modal">ÈóúÈñâ</button>`);
  }
}

// === Âà™Èô§ÈÅìÂÖ∑ ===
function showDeleteItemsDialog() {
  const deletables = Object.entries(gameState.inventory)
    .filter(([, qty]) => qty > 0)
    // ‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (deletables.length === 0) {
    content = "<p>ËÉåÂåÖÊ≤íÊúâÂèØ‰ª•Âà™Èô§ÁöÑÈÅìÂÖ∑</p>";
  } else {
    content = deletables.map(([name, qty]) => `
      <div class="modal-item-row">
        <label for="del-${name}">${name}ÔºàÊåÅÊúâ ${qty}Ôºâ</label>
        <input type="number" id="del-${name}" min="0" max="${qty}" value="0" />
      </div>`).join('');
  }
  const footer = `<button data-action="confirm-delete-items">Á¢∫Ë™çÂà™Èô§</button>`;
  showModal("üóëÔ∏è Âà™Èô§ÈÅìÂÖ∑", content, footer);
}

function confirmDeleteItems() {
  const inputs = modalBody.querySelectorAll('input[type="number"]');
  const inv = gameState.inventory;
  let removedList = [];
  inputs.forEach(input => {
    const qty = Math.max(0, parseInt(input.value || '0', 10));
    if (!qty) return;
    const name = input.id.replace('del-', '');
    const cur = inv[name] || 0;
    const rm = Math.min(qty, cur);
    if (rm > 0) {
      inv[name] = cur - rm;
      removedList.push(`${name} √ó${rm}`);
    }
  });
  saveGameState();
  showModal("üóëÔ∏è Âà™Èô§ÁµêÊûú",
    removedList.length ? `<p>Â∑≤Âà™Èô§Ôºö${removedList.join('„ÄÅ')}</p>` : "<p>Êú™Âà™Èô§‰ªª‰ΩïÈÅìÂÖ∑</p>",
    `<button data-action="close-modal">ÈóúÈñâ</button>`);
}

function showShop() {
    const sortedItems = Object.entries(ITEM_STONE_PRICES).sort(([a], [b]) => {
        const keyA = getItemSortKey(a);
        const keyB = getItemSortKey(b);
        if (keyA[0] !== keyB[0]) return keyA[0] - keyB[0];
        if (keyA[1] !== keyB[1]) return keyA[1] - keyB[1];
        return a.localeCompare(b, 'zh-Hant');
    });

    let content = `<p style="text-align:center;"><b>Áï∂ÂâçÈùàÁü≥Ôºö${gameState.stones}</b></p>`;
    content += sortedItems.map(([item, cost]) => {
        const desc = ITEM_EFFECTS[item]?.desc || '';
        return `<div class="modal-item-row">
            <label for="shop-${item}">${item} - ${cost} ÈùàÁü≥ (${desc})</label>
            <input type="number" id="shop-${item}" min="0" value="0" placeholder="0">
        </div>`;
    }).join('');

    let footer = `<button data-action="bulk-buy-items">Ë≥ºË≤∑ÈÅ∏Êìá</button>
                  <button class="btn-warning" data-action="show-sell-dialog">Ë≤©Ë≥£ÈÅìÂÖ∑</button>
                  <button class="btn-secondary" data-action="show-upgrade-dialog">ÂìÅÈöéÂçáÁ¥ö</button>`;
    
    showModal("üõí ÂïÜÂ∫ó", content, footer);
}

function bulkBuyItems() {
    const inputs = modalBody.querySelectorAll('input[type="number"]');
    let totalCost = 0;
    const purchase = {};

    inputs.forEach(input => {
        const qty = parseInt(input.value, 10);
        if (qty > 0) {
            const itemName = input.id.replace('shop-', '');
            const price = ITEM_STONE_PRICES[itemName] || 0;
            totalCost += price * qty;
            purchase[itemName] = qty;
        }
    });

    if (totalCost > gameState.stones) {
        alert(`ÈùàÁü≥‰∏çË∂≥ÔºÅÈúÄË¶Å ${totalCost}ÔºåÊÇ®Âè™Êúâ ${gameState.stones}„ÄÇ`);
        return;
    }

    if (Object.keys(purchase).length > 0) {
        gameState.stones -= totalCost;
        Object.entries(purchase).forEach(([item, qty]) => {
            gameState.inventory[item] = (gameState.inventory[item] || 0) + qty;
            if (!gameState.inventory_order.includes(item)) {
                gameState.inventory_order.push(item);
                 gameState.inventory_order.sort((a, b) => compareItemNames(a, b));
            }
        });
        saveGameState();
        addTemporaryMessage(`‚úÖ Ë≥ºË≤∑ÊàêÂäüÔºåËä±Ë≤ª ${totalCost} ÈùàÁü≥ÔºÅ`, 'msg-shop');
    }
    modal.style.display = "none";
    renderMainMenu();
}

function showUpgradeDialog() {
    const upgradable = Object.keys(UPGRADE_PATHS)
        .filter(item => (gameState.inventory[item] || 0) > 0 && !(gameState.inventory[UPGRADE_PATHS[item]] > 0))
        // ‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
        .sort((a,b) => compareItemNames(a, b));

    let content = `<p style="text-align:center;"><b>Áï∂ÂâçÈùàÁü≥Ôºö${gameState.stones}</b></p>`;
    if (upgradable.length === 0) {
        content += `<p>Ê≤íÊúâÂèØÂçáÁ¥öÁöÑÈÅìÂÖ∑„ÄÇ</p>`;
    } else {
        content += upgradable.map(item => {
            const nextItem = UPGRADE_PATHS[item];
            const cost = ITEM_EFFECTS[item].upgrade_cost || 0;
            return `<div class="modal-item-row">
                <span>ÂçáÁ¥ö ${item} ‚Üí ${nextItem}</span>
                <button data-action="upgrade-item" data-current="${item}" data-next="${nextItem}" data-cost="${cost}" ${gameState.stones < cost ? 'disabled' : ''}>${cost} ÈùàÁü≥</button>
            </div>`;
        }).join('');
    }
    showModal("‚ú® ÂìÅÈöéÂçáÁ¥ö", content, `<button data-action="show-shop">ËøîÂõûÂïÜÂ∫ó</button>`);
}

function upgradeItem(currentItem, nextItem, cost) {
    if (gameState.stones < cost) {
        alert("ÈùàÁü≥‰∏çË∂≥ÔºÅ");
        return;
    }
    gameState.stones -= cost;
    gameState.inventory[nextItem] = (gameState.inventory[nextItem] || 0) + 1;
    // Don't remove old item
    if (!gameState.inventory_order.includes(nextItem)) {
        gameState.inventory_order.push(nextItem);
        gameState.inventory_order.sort((a,b) => compareItemNames(a,b));
    }
    saveGameState();
    // Êâ£ÈùàÁü≥ÂæåÁ´ãÂç≥Êõ¥Êñ∞‰∏ªÁï´Èù¢Ë≥áË®äÔºàÂ∞§ÂÖ∂ÊòØÈùàÁü≥È°ØÁ§∫Ôºâ
    if (typeof updateMainMenuInfo === 'function') {
        updateMainMenuInfo();
    }
    alert(`ÂçáÁ¥öÊàêÂäüÔºÅÁç≤Âæó ${nextItem}`);
    showUpgradeDialog(); // Refresh modal
}

// ===================== ÈÅäÊà≤‰∏≠ÈÅìÂÖ∑‰ΩøÁî® =====================

function showUseItemDialog() {
    const usableItems = Object.entries(gameState.inventory)
      .filter(([, qty]) => qty > 0)
      .map(([name]) => name)
      .filter(name => {
        const type = ITEM_EFFECTS[name]?.type;
        return ["correct", "wrong", "multi_choice", "reveal_wrong", "add_time"].includes(type);
      })
      // ‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
      .sort((a, b) => compareItemNames(a, b));
    let content = '';
    if (usableItems.length === 0) {
      content = '<p>Ê≤íÊúâÂèØÁî®ÁöÑÊà∞È¨•ÈÅìÂÖ∑</p>';
    } else {
      content = usableItems.map(item => {
        const eff = ITEM_EFFECTS[item];
        const cost = eff.exp_cost || 0;
        let disabled = '';
        let tooltip = '';
        if (gameState.exp < cost) {
          disabled = 'disabled';
          tooltip = ` (‰øÆÁÖâÁ∂ìÈ©ó‰∏çË∂≥: ${cost})`;
        }
        if (['correct', 'wrong', 'multi_choice'].includes(eff.type) && trainingState.hasUsedSingleUseItem) {
          disabled = 'disabled';
          tooltip = ' (Êú¨È°åÂ∑≤Áî®ÈÅéÊ≠§È°ûÈÅìÂÖ∑)';
        }
        if (['correct', 'wrong'].includes(eff.type)) {
          const allowedGrade = getGradeByDifficulty(trainingState.difficulty);
          if (!item.startsWith(allowedGrade)) {
            disabled = 'disabled';
            tooltip = ` (Ê≠§Èõ£Â∫¶ÈúÄÁî® ${allowedGrade} ÈÅìÂÖ∑)`;
          }
        }
        return `<button data-action="use-item" data-item-name="${item}" ${disabled}>
          ${item} √ó${gameState.inventory[item]}
          <br><small>${eff.desc || ''}${cost > 0 ? ` (Ê∂àËÄó${cost} EXP)` : ''}${tooltip}</small>
        </button>`;
      }).join('');
    }
    showModal('üéí ‰ΩøÁî®ÈÅìÂÖ∑', content);
}

function useItem(itemName) {
    const eff  = ITEM_EFFECTS[itemName];
    if (!eff) return;
    const cost = eff.exp_cost || 0;
    if (gameState.exp < cost) return;
    if (['correct', 'wrong', 'multi_choice'].includes(eff.type)) {
      if (trainingState.hasUsedSingleUseItem) return;
      trainingState.hasUsedSingleUseItem = true;
    }
    gameState.exp -= cost;
    if (['correct', 'wrong'].includes(eff.type)) {
      gameState.inventory[itemName] = Math.max(0, (gameState.inventory[itemName] || 0) - 1);
    }
    saveGameState();
    // # Á∑ö‰∏äÁâàÊñ∞Â¢ûÔºöË®òÈåÑÊú¨Â±Ä‰ΩøÁî®ÈÅéÁöÑÈÅìÂÖ∑ÂêçÁ®±ÔºàÂéªÈáçÁî±ÂâçÁ´Ø/Èõ≤Á´ØËá™Ë°åËôïÁêÜÔºâ
    try {
        if (typeof trainingState !== 'undefined') {
            trainingState.usedItems = trainingState.usedItems || [];
            if (!trainingState.usedItems.includes(itemName)) {
                trainingState.usedItems.push(itemName);
            }
        }
    } catch (e) { /* # ignore */ }

    const fb = document.getElementById('feedback-label');
    let msg = '';
    if (eff.type === 'multi_choice') {
      trainingState.allowedChoices += (eff.n || 1);
      enterMultiChoiceMode();
      msg = `‚öîÔ∏è ÂÖµÂô®ÊïàÊûúÔºöÊú¨È°åÂèØÈÅ∏Á≠îÊ°àÊï∏Â¢ûÂä† ${eff.n}ÔºàÁ∏ΩÂÖ± ${trainingState.allowedChoices} Ê¨°Ôºâ`;
    } else if (eff.type === 'reveal_wrong') {
      const buttons = trainingState.gameGridButtons || [];
      let remain = eff.n || 1;
      for (const b of buttons) {
        if (remain <= 0) break;
        const choice = b.dataset.choice;
        if (!trainingState.correctAnswers.includes(choice) && !b.classList.contains('hint-wrong')) {
          b.classList.add('hint-wrong');
          remain--;
        }
      }
      msg = `üìú ÂäüÊ≥ïÊïàÊûúÔºöÂ∑≤Ê®ôÁ§∫ ${eff.n} ÂÄãÈåØË™§Á≠îÊ°à`;
    } else if (eff.type === 'add_time') {
      // Èô£Ê≥ïÂ¢ûÂä†‰ΩúÁ≠îÊôÇÈñìÂÉÖÈôêÊú¨È°åÊúâÊïàÔºö‰∏≠ÈÄîÂèØ‰ª•ÁñäÂä†‰∏¶Âç≥ÊôÇÁîüÊïà
      const inc = eff.n || 0;
      trainingState.roundExtraTime = (trainingState.roundExtraTime || 0) + inc;
      // Ëã•ÂÄíÊï∏Ê≠£Âú®Ë∑ëÔºåÁ´ãÂç≥Â¢ûÂä†Ââ©È§òÁßíÊï∏
      if (typeof trainingState.countdownRemaining === 'number') {
        trainingState.countdownRemaining += inc;
        const label = document.getElementById('countdown-label');
        if (label && trainingState.countdownRemaining >= 0) {
          label.textContent = `‰ΩúÁ≠îÂÄíÊï∏Ôºö${trainingState.countdownRemaining} Áßí`;
        }
      }
      msg = `‚õ©Ô∏è Èô£Ê≥ïÊïàÊûúÔºö‰ΩúÁ≠îÊôÇÈñìÂ¢ûÂä† ${inc} ÁßíÔºàÂÉÖÊú¨È°åÔºâ`;
    } else if (eff.type === 'correct') {
// ÈùàÂô®ÔºöÈ°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°à„ÄÇn <= 0 Ë¶ñÁÇ∫ÂÖ®ÈÉ®ÔºåÂê¶ÂâáÈ°ØÁ§∫ n ÂÄã
const buttons = trainingState.gameGridButtons || [];
// ÊâæÂá∫ÊâÄÊúâÂ∞öÊú™Ê®ôÁ§∫ÁöÑÊ≠£Á¢∫ÊåâÈàï
const correctButtons = buttons.filter(b =>
  trainingState.correctAnswers.includes(b.dataset.choice) && !b.classList.contains('hint-correct')
);
let toReveal;
if (eff.n <= 0) {
  // n <= 0 Ë°®Á§∫ÂÖ®ÈÉ®‰∫ÆÈ°Ø
  toReveal = correctButtons;
} else {
  // Âê¶ÂâáÂè™È°ØÁ§∫Ââç n ÂÄã
  toReveal = correctButtons.slice(0, eff.n);
}
// Â∞áÈÅ∏‰∏≠ÁöÑÊåâÈàïÊ®ôË®òÁÇ∫Ê≠£Á¢∫
toReveal.forEach(b => b.classList.add('hint-correct'));
msg = `ü™¨ ÈùàÂô®ÊïàÊûúÔºöÂ∑≤Ê®ôÁ§∫ ${eff.n <= 0 ? 'ÂÖ®ÈÉ®' : toReveal.length} ÂÄãÊ≠£Á¢∫Á≠îÊ°à`;
    } else if (eff.type === 'wrong') {
      const buttons = trainingState.gameGridButtons || [];
      let remain = eff.n || 1;
      for (const b of buttons) {
        if (remain <= 0) break;
        const choice = b.dataset.choice;
        if (!trainingState.correctAnswers.includes(choice) && !b.classList.contains('hint-wrong')) {
          b.classList.add('hint-wrong');
          remain--;
        }
      }
      msg = `üßø ÈùàÁ¨¶ÊïàÊûúÔºöÂ∑≤ÊéíÈô§ ${eff.n} ÂÄãÈåØË™§Á≠îÊ°à`;
    }
    if (fb) { fb.textContent = msg; fb.className = "feedback info"; }
    modal.style.display = 'none';
}

// Stubs for unimplemented modal functions
function useExpItems() { showUseExpDialog(); }
function deleteItems() { showDeleteItemsDialog(); }
function showSellDialog() {
  const sellable = Object.entries(gameState.inventory)
    .filter(([name, qty]) => qty > 0 && ITEM_STONE_PRICES[name] !== undefined)
    // ‰æùÈ°ûÂûãËàáÂìÅÈöéÊéíÂ∫è
    .sort(([a], [b]) => compareItemNames(a, b));
  let content = '';
  if (sellable.length === 0) {
    content = '<p>ËÉåÂåÖ‰∏≠Ê≤íÊúâÂèØË≤©Ë≥£ÁöÑÈÅìÂÖ∑„ÄÇ</p>';
  } else {
    content = sellable.map(([name, qty]) => {
      const sellPriceSingle = Math.floor((ITEM_STONE_PRICES[name] || 0) / 2);
      return `
        <div class="modal-item-row">
          <label for="sell-${name}">${name}ÔºàÊåÅÊúâ ${qty}Ôºâ - Ë≥£ÂÉπ: ${sellPriceSingle} ÈùàÁü≥/ÂÄã</label>
          <input type="number" id="sell-${name}" min="0" max="${qty}" value="0" />
        </div>`;
    }).join('');
    content += `<p id="sell-total" style="margin-top:10px;text-align:center;">È†êË®àÂèØÁç≤ÂæóÔºö0 ÈùàÁü≥</p>`;
  }
  const footer = `<button data-action="confirm-sell-items">Á¢∫Ë™çË≤©Ë≥£</button>`;
  showModal("üí∞ Ë≤©Ë≥£ÈÅìÂÖ∑", content, footer);
  // attach update for predicted sell value
  setTimeout(() => {
    const totalLabel = document.getElementById('sell-total');
    function updateTotal() {
      let totalBuyValue = 0;
      sellable.forEach(([name]) => {
        const input = modalBody.querySelector(`#sell-${name}`);
        if (input) {
          const count = parseInt(input.value || '0', 10);
          if (count > 0) {
            const price = ITEM_STONE_PRICES[name] || 0;
            totalBuyValue += price * count;
          }
        }
      });
      const sellValue = Math.floor(totalBuyValue / 2);
      if (totalLabel) {
        totalLabel.textContent = `È†êË®àÂèØÁç≤ÂæóÔºö${sellValue} ÈùàÁü≥`;
      }
    }
    sellable.forEach(([name]) => {
      const input = modalBody.querySelector(`#sell-${name}`);
      if (input) {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
      }
    });
    updateTotal();
  }, 0);
}

function confirmSellItems() {
  const toSell = [];
  let totalBuyValue = 0;
  Object.entries(gameState.inventory).forEach(([name, qty]) => {
    const input = modalBody.querySelector(`#sell-${name}`);
    if (input) {
      const count = Math.max(0, parseInt(input.value || '0', 10));
      if (count > 0) {
        toSell.push({name: name, qty: count});
        totalBuyValue += (ITEM_STONE_PRICES[name] || 0) * count;
      }
    }
  });
  if (toSell.length === 0) {
    showModal("üí∞ Ë≤©Ë≥£ÁµêÊûú", "<p>Êú™Ë≤©Ë≥£‰ªª‰ΩïÈÅìÂÖ∑</p>", `<button data-action="close-modal">ÈóúÈñâ</button>`);
    return;
  }
  const sellValue = Math.floor(totalBuyValue / 2);
  toSell.forEach(item => {
    gameState.inventory[item.name] = Math.max(0, (gameState.inventory[item.name] || 0) - item.qty);
  });
  gameState.stones += sellValue;
  saveGameState();
  const soldItemsDesc = toSell.map(item => `${item.name} √ó${item.qty}`);
  showModal("üí∞ Ë≤©Ë≥£ÁµêÊûú", `<p>Â∑≤Ë≤©Ë≥£Ôºö${soldItemsDesc.join('„ÄÅ')}</p><p>Áç≤Âæó ${sellValue} ÈùàÁü≥</p>`, `<button data-action="close-modal">ÈóúÈñâ</button>`);
}


// ===================== ÂÖ®Âüü‰∫ã‰ª∂ËôïÁêÜ =====================
document.body.addEventListener('click', (event) => {
    let target = event.target;
    // If the target itself doesn't have the action, check its parent
    if (!target.dataset.action) {
        target = target.closest('[data-action]');
    }
    if (!target) return;

    const action = target.dataset.action;
    
    const simpleActions = {
        'render-main-menu': renderMainMenu, 'render-test-luck-menu': renderTestLuckMenu,
        'show-stage-list': showStageList, 'show-rank-list': showRankList,
        'show-backpack': showBackpack, 'show-shop': showShop,
        'reset-stats': resetTrainingStats, 'clear-scores': clearMaxScores,
        'run-today-luck': runTodayLuck, 'show-luck-history': showLuckHistory,
        'show-upgrade-dialog': showUpgradeDialog, 'check-answer-multi': checkAnswerMulti,
        'show-use-item-dialog': showUseItemDialog, 'close-modal': () => modal.style.display = "none",
        'bulk-buy-items': bulkBuyItems,
        'use-exp-items': showUseExpDialog,
        'delete-items': showDeleteItemsDialog,
        'confirm-use-exp': confirmUseExp,
        'confirm-delete-items': confirmDeleteItems,
        'fill-all-exp': fillAllExpInputs,
        'confirm-use-exp-all': confirmUseExpAll,
        'confirm-sell-items': confirmSellItems,
        'show-sell-dialog': showSellDialog,
        'show-game-rules': showGameRules,
        'test-sfx': () => {
            try {
                if (typeof ensureAudio === 'function' && typeof playBeep === 'function') {
                    ensureAudio();
                    playBeep({ freq: 880 });
                }
            } catch (e) {}
        },
        // # Êñ∞Â¢ûÁ∞°ÊòìÂãï‰ΩúÔºöÁßòÂ¢ÉË©¶ÁÖâÈÅ∏ÂñÆ„ÄÅÁßòÂ¢ÉÊéíË°åÊ¶ú„ÄÅÁôªÂÖ•‰ªãÈù¢ËàáÁôªÂÖ•ÁôªÂá∫
        'render-secret-trial-menu': renderSecretTrialMenu,
        'show-trial-leaderboard': showTrialLeaderboard,
        'show-login-menu': showLoginMenu,
        'login-google': loginGoogle,
        'login-email': loginEmail,
        'login-yahoo': loginYahoo,
        'login-facebook': loginFacebook,
        'logout': logout,
        'login-anonymous': loginAnonymous,
        // # ÈñãÂßãÈùàÊ†πÊ∏¨Ë©¶ÔºöÊñºÂàùÂßãÂåñÈöéÊÆµÈªûÊìäÊåâÈàï
        'start-linggen-test': startLinggenTest,
        // # Êñ∞Â¢ûÂÜçÊ¨°ÊåëÊà∞Âãï‰ΩúÔºöÈáçÊñ∞ÈñãÂßã‰∏ä‰∏ÄÂ†¥Ë®ìÁ∑¥ÊàñÁßòÂ¢ÉË©¶ÁÖâ
        'retry-training': () => {
            try {
                if (typeof startTraining === 'function' && trainingState && trainingState.difficulty) {
                    startTraining(trainingState.difficulty);
                }
            } catch (e) { console.warn('ÁÑ°Ê≥ïÂÜçÊ¨°ÊåëÊà∞Ë®ìÁ∑¥', e); }
        },
        'retry-trial': () => {
            try {
                if (typeof startTrial === 'function' && trainingState && trainingState.difficulty) {
                    startTrial(trainingState.difficulty);
                }
            } catch (e) { console.warn('ÁÑ°Ê≥ïÂÜçÊ¨°ÊåëÊà∞ÁßòÂ¢É', e); }
        },
    };

    if (simpleActions[action]) {
        simpleActions[action]();
        return;
    }

    // Actions with parameters
    switch(action) {
        case 'start-training':
            startTraining(parseInt(target.dataset.level, 10));
            break;
        case 'exchange-stones':
            exchangeStones(parseInt(target.dataset.count, 10));
            break;
        case 'redeem-tickets':
            redeemTickets(parseInt(target.dataset.pieces, 10), parseInt(target.dataset.cost, 10));
            break;
        case 'run-luck-draw':
            runLuckDraw(parseInt(target.dataset.draws, 10), target.dataset.mode);
            break;
        case 'upgrade-item':
            upgradeItem(target.dataset.current, target.dataset.next, parseInt(target.dataset.cost, 10));
            break;
        case 'use-item':
            useItem(target.dataset.itemName);
            break;
        case 'grid-btn': 
            onGridButtonClick(target);
            break;
        case 'start-trial':
            startTrial(parseInt(target.dataset.level, 10));
            break;
    }
});


// ===================== ÂïüÂãïÈÅäÊà≤ =====================
loadGameState();
renderMainMenu();

}); // ‚ñ≤‚ñ≤‚ñ≤ End of DOMContentLoaded listener ‚ñ≤‚ñ≤‚ñ≤
</script>

<!-- Èü≥ÊïàËàáÁÆ≠È†≠ÂæåÊè¥Á®ãÂºèÔºöÂú®Ë°åÂãïË£ùÁΩÆ‰∏äÈ°ØÁ§∫ÁÆ≠È†≠Ôºå‰∏¶ÁîüÊàêÈü≥ÊïàÔºàÁÑ°ÈúÄÂ§ñÈÉ®Èü≥Ê™îÔºâ -->
<script>
// ==== Ë°åÂãïË£ùÁΩÆÁÆ≠È†≠ SVG ÂæåÊè¥ ====
function svgArrow(dir, size = 18) {
    const pathMap = {
        up:   'M9 2 L16 14 H2 Z',
        right:'M2 2 L14 9 L2 16 Z',
        down: 'M2 2 L16 2 L9 16 Z',
        left: 'M2 9 L14 2 L14 16 Z'
    };
    const key = pathMap[dir] ? dir : 'up';
    const svg = `<svg viewBox="0 0 18 18" width="${size}" height="${size}" aria-hidden="true" style="display:inline-block;vertical-align:middle"><path d="${pathMap[key]}" fill="currentColor"/></svg>`;
    const el = document.createElement('span');
    el.className = 'luck-arrow-svg';
    el.innerHTML = svg;
    return el;
}

// Â∞áÂê´ÊúâÁÆ≠È†≠Â≠óÂÖÉÊàñÊåáÂÆö data Â±¨ÊÄßÁöÑÁØÄÈªûÊõøÊèõÁÇ∫ SVG
function patchLuckArrows() {
    const selector = '.luck-arrow, [data-luck-arrow], [data-dir]';
    document.querySelectorAll(selector).forEach(node => {
        // Â∑≤Á∂ìÊúâ SVG Â∞±‰∏çÈáçË§áÊõøÊèõ
        if (node.querySelector('svg')) return;
        // Âà§Êñ∑ÊñπÂêë
        let dir = node.dataset.luckArrow || node.dataset.dir || '';
        // Ëã•Êú™ÊåáÂÆöÔºåÊ†πÊìöÂÖßÂÆπÂà§Êñ∑
        if (!dir) {
            const text = node.textContent.trim();
            const map = {'‚Üë': 'up', '‚Üí': 'right', '‚Üì': 'down', '‚Üê': 'left'};
            dir = map[text] || 'up';
        }
        // Ê∏ÖÁ©∫ÊñáÂ≠ó‰∏¶ÊèíÂÖ• SVG
        node.textContent = '';
        node.appendChild(svgArrow(dir));
    });
}

// ==== WebAudio Èü≥ÊïàÂ∑•ÂÖ∑ ====
let __audioCtx = null;
function ensureAudio() {
    if (!__audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        __audioCtx = new Ctx();
    }
    return __audioCtx;
}

function playBeep(opts) {
    const cfg = Object.assign({ freq: 880, dur: 0.12, type: 'sine', gain: 0.06 }, opts);
    const ctx = ensureAudio();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    osc.type = cfg.type;
    osc.frequency.value = cfg.freq;
    gainNode.gain.value = cfg.gain;
    osc.connect(gainNode).connect(ctx.destination);
    const t = ctx.currentTime;
    osc.start(t);
    osc.stop(t + cfg.dur);
}

function playLevelUp() {
    const ctx = ensureAudio();
    if (!ctx) return;
    const now = ctx.currentTime;
    // ‰∏äË°åÂ∞èÂíåÂº¶ÔºöC-E-G ‰æùÂ∫èÈüøËµ∑
    [[523.25, 0], [659.25, 0.08], [783.99, 0.16]].forEach(([freq, offset]) => {
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gainNode.gain.value = 0.05;
        osc.connect(gainNode).connect(ctx.destination);
        osc.start(now + offset);
        osc.stop(now + offset + 0.18);
    });
}

// ==== ÁçéÂãµÈü≥ÊïàÔºöÊ®°Êì¨Ê®ÇÈÄè‰∏≠ÁçéÈü≥ÊïàÔºåÊí≠Êîæ‰∏ÄÈÄ£‰∏≤Êº∏È´òÁöÑ beep Èü≥ ====
function playRewardSound() {
    try {
        // Á¢∫‰øùÈü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñ
        ensureAudio();
        // ÈÄ£Á∫åÊí≠Êîæ‰∏âÂÄãÈ†ªÁéáÁöÑ beepÔºåÂΩ¢ÊàêÁ∞°ÂñÆÁöÑ‰∏≠ÁçéÈü≥Êïà
        playBeep({ freq: 880, dur: 0.14, type: 'square', gain: 0.08 });
        setTimeout(() => playBeep({ freq: 1046.5, dur: 0.14, type: 'square', gain: 0.07 }), 160);
        setTimeout(() => playBeep({ freq: 1318.5, dur: 0.14, type: 'square', gain: 0.06 }), 320);
    } catch (e) {
        console.warn('playRewardSound failed', e);
    }
}

// ==== ÂàùÂßãÂåñËàá‰∫ã‰ª∂Á∂ÅÂÆö ====
window.addEventListener('DOMContentLoaded', () => {
    try {
        patchLuckArrows();
    } catch (e) {}
});
</script>


<!-- ==================== Á∑ö‰∏äÁâàÊï¥ÂêàÔºöFirebaseÔºàAuth + Firestore + Èõ¢Á∑öÔºâ ==================== -->
<!-- # Ëã•Êú™Â°´ÂÖ•‰Ω†ÁöÑ firebaseConfigÔºåÈõ≤Á´ØÂäüËÉΩ‰∏çÊúÉÂïüÁî®Ôºõ‰∏çÂΩ±ÈüøÈõ¢Á∑öÊú¨Âú∞ÂäüËÉΩ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// # Firebase ÂàùÂßãÂåñÔºàË´ãÊää YOUR_* ÊèõÊàê‰Ω†ÁöÑÂ∞àÊ°àË®≠ÂÆöÔºâ
var FIREBASE_ONLINE_ENABLED = true;  // # Ëã•Ë¶ÅÊö´ÊôÇÈóúÈñâÈõ≤Á´ØÔºåÂèØË®≠ÁÇ∫ false
// # Â∞á‰ª•‰∏ãË®≠ÂÆöÊîπÁÇ∫ÊÇ®Âú® Firebase Console Âª∫Á´ãÂ∞àÊ°àÂæåÂèñÂæóÁöÑÂØ¶ÈöõÂÄº„ÄÇ
// # Â¶ÇÊûúÊÇ®ÊòØ‰æùÁÖßÂÆòÊñπÊåáÂºï‰ΩøÁî® npm Êàñ <script> Ê®ôÁ±§ËºâÂÖ• FirebaseÔºå
// # Âª∫Ë≠∞‰øùÊåÅÊ≠§ËôïÊ†ºÂºè‰∏ÄËá¥Âç≥ÂèØÂïüÁî®Èõ≤Á´ØÂäüËÉΩ„ÄÇ
var firebaseConfig = {
  apiKey: "AIzaSyBu3lcaLChWhzGmIPWE5CsZOIugPbhEg58",           // # Â∞àÊ°àÁöÑ API Key
  authDomain: "xiuxian-luck-trainer.firebaseapp.com",           // # Â∞àÊ°àÊéàÊ¨äÁ∂≤Âüü
  projectId: "xiuxian-luck-trainer",                           // # Â∞àÊ°à ID
  storageBucket: "xiuxian-luck-trainer.firebasestorage.app",    // # (ÂèØÈÅ∏) ÂÑ≤Â≠òÁ©∫ÈñìÊ°∂ÂêçÁ®±
  messagingSenderId: "185296094422",                           // # (ÂèØÈÅ∏) Cloud Messaging ÁôºÈÄÅËÄÖ ID
  appId: "1:185296094422:web:b86866eb98842e52e97577",          // # (ÂèØÈÅ∏) ÊáâÁî®Á®ãÂºè ID
  measurementId: "G-QTDH5X3CMT"                               // # (ÂèØÈÅ∏) Google Analytics ÈáèÊ∏¨ ID
};
try {
  if (FIREBASE_ONLINE_ENABLED) { firebase.initializeApp(firebaseConfig); }
} catch (e) { console.warn('Firebase init failed (ÂèØËÉΩÊòØÊú™Â°´ config)Ôºö', e); FIREBASE_ONLINE_ENABLED = false; }

// # Firestore & Èõ¢Á∑öÂø´Âèñ
var db = null;
try {
  if (FIREBASE_ONLINE_ENABLED) {
    db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(function(){ /* # ÁÑ°ÁóïÊ®°ÂºèÊàñË°ùÁ™Å */ });
  }
} catch (e) { console.warn('Firestore init failedÔºö', e); FIREBASE_ONLINE_ENABLED = false; }

// # AuthÔºàÂåøÂêçËá™ÂãïÁôªÂÖ•Ôºõ‰πãÂæåÂèØÂçáÁ¥ö Google/Email ‰∏¶‰øùÁïôÁ¥ÄÈåÑÔºâ
var auth = null;
try { if (FIREBASE_ONLINE_ENABLED) { auth = firebase.auth(); } } catch (e) {}

function ensureSignedIn() {
  return new Promise(function (resolve) {
    if (!FIREBASE_ONLINE_ENABLED || !auth) return resolve(null);

    var off = auth.onAuthStateChanged(async function (u) {
      if (u) { off(); return resolve(u); }

      try {
        var cred = await auth.signInAnonymously();  // # ÂåøÂêçÁôªÂÖ•
        off();
        return resolve(cred.user);
      } catch (e) {
        off();
        console.warn('ÂåøÂêçÁôªÂÖ•Â§±ÊïóÔºàÊîπÁÇ∫Èõ¢Á∑öÊ®°ÂºèÔºâÔºö', e);
        FIREBASE_ONLINE_ENABLED = false;

        var code = (e && e.code) || '';
        var host = (location && location.hostname) ? location.hostname : '';
        var msg = 'Èõ≤Á´ØÈÄ£Á∑öÊú™ÂïüÁî®ÔºåÂ∑≤ÂàáÊèõÁÇ∫Êú¨Ê©üÊ®°Âºè„ÄÇ';

        if (code === 'auth/unauthorized-domain') {
          msg = 'ÁõÆÂâçÁ∂≤ÂüüÊú™Âä†ÂÖ• Firebase ÊéàÊ¨äÁ∂≤Âüü„ÄÇË´ãÂà∞ Firebase Console > Authentication > Settings > Authorized domainsÔºåÂä†ÂÖ•Ôºö' + host;
        } else if (code === 'auth/operation-not-allowed') {
          msg = 'ÂåøÂêçÁôªÂÖ•Â∞öÊú™ÂïüÁî®„ÄÇË´ãÂà∞ Firebase Console > Authentication > Sign-in methodÔºåÈñãÂïü„ÄåÂåøÂêç„Äç„ÄÇ';
        } else if (code === 'auth/network-request-failed') {
          msg = 'Á∂≤Ë∑ØË´ãÊ±ÇÂ§±ÊïóÔºåÂèØËÉΩË¢´ÁÄèË¶ΩÂô®ÈòªÊìãÁ¨¨‰∏âÊñπ Cookie ÊàñÁ∂≤Ë∑Ø‰∏≠Êñ∑„ÄÇ';
        }

        // # Âª∫Á´ãÂè≥‰∏ãËßíÈõ¢Á∑öÊèêÁ§∫
        try {
          var badge = document.getElementById('onlineStatusBadge');
          if (!badge) {
            badge = document.createElement('div');
            badge.id = 'onlineStatusBadge';
            badge.style.cssText = 'position:fixed;right:8px;bottom:8px;background:#222;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:.9;z-index:10000;';
            document.body.appendChild(badge);
          }
          badge.textContent = 'Èõ≤Á´ØÔºöÈõ¢Á∑öÔºà' + host + 'Ôºâ';
          badge.title = msg;
        } catch (_) {}

        return resolve(null);
      }
    });
  });
}

// # ÂçáÁ¥öÁôªÂÖ•ÔºàGoogleÔºâ‰øùÁïôÂåøÂêçË≥áÊñô
async function signInWithGoogleKeepData() {
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.href }
    });
    if (error) { throw error; }
    return data && data.user ? data.user : null;
  } catch (e) {
    console.warn('Google ÁôªÂÖ•Â§±Êïó', e);
    throw e;
  }
}

// # ÂçáÁ¥öÁôªÂÖ•ÔºàYahooÔºâ‰øùÁïôÂåøÂêçË≥áÊñô
async function signInWithYahooKeepData() {
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'yahoo',
      options: { redirectTo: window.location.href }
    });
    if (error) { throw error; }
    return data && data.user ? data.user : null;
  } catch (e) {
    console.warn('Yahoo ÁôªÂÖ•Â§±Êïó', e);
    throw e;
  }
}

// # ÂçáÁ¥öÁôªÂÖ•ÔºàFacebookÔºâ‰øùÁïôÂåøÂêçË≥áÊñô
async function signInWithFacebookKeepData() {
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'facebook',
      options: { redirectTo: window.location.href }
    });
    if (error) { throw error; }
    return data && data.user ? data.user : null;
  } catch (e) {
    console.warn('Facebook ÁôªÂÖ•Â§±Êïó', e);
    throw e;
  }
}

// # ÂçáÁ¥öÁôªÂÖ•ÔºàEmail/PasswordÔºâ‰øùÁïôÂåøÂêçË≥áÊñô
async function upgradeToEmailPassword(email, password) {
  // Email/ÂØÜÁ¢ºË®ªÂÜäÊàñÁôªÂÖ•ÔºàSupabaseÔºâ
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    // ÂòóË©¶‰ª•ÂØÜÁ¢ºÁôªÂÖ•ÔºåËã•Â§±ÊïóÂâáË®ªÂÜäÊñ∞Â∏≥Ëôü
    let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) {
      let { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({ email, password });
      if (signUpError) { console.warn('Ë®ªÂÜäÂ§±ÊïóÔºö', signUpError); return null; }
      return signUpData.user;
    }
    return data.user;
  } catch (e) {
    console.warn('Email/ÂØÜÁ¢ºÁôªÂÖ•Â§±Êïó', e);
    return null;
  }
}

function signOutOnline() {
  // ÁôªÂá∫ Supabase
  if (supabaseClient) {
    return supabaseClient.auth.signOut();
  }
}

// # Èõ≤Á´ØË≥áÊñôÊ®°ÂûãËàáÂØ´ÂÖ•
async function saveRunRecord(rec) {
  // # rec: { level, score, mode, usedItems, durationSec, result, publishToLeaderboard }
  if (!FIREBASE_ONLINE_ENABLED || !db) return; // # Êú™ÂïüÁî®ÂâáÁï•ÈÅé
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return; // # ÁÑ°Ê≥ïÁôªÂÖ•ÂâáÁï•ÈÅé
  var uid = u.uid;
  var now = firebase.firestore.Timestamp.now();
  var runRef = db.collection('users').doc(uid).collection('runs').doc(); // # Ëá™Âãï runId
  var statRef = db.collection('user_stats').doc(uid);

  return db.runTransaction(async function(tx) {
    tx.set(runRef, Object.assign({}, rec, {
      createdAt: now,
      clientAt: new Date().toISOString(),
      appVersion: 'web-1.0.0'
    }));
    var statSnap = await tx.get(statRef);
    var prev = statSnap.exists ? statSnap.data() : { totalRuns: 0, bestScore: -1 };
    var next = {
      totalRuns: (prev.totalRuns || 0) + 1,
      bestScore: Math.max(prev.bestScore || -1, rec.score || 0),
      lastPlayedAt: now
    };
    tx.set(statRef, next, { merge: true });
  }).then(async function() {
    if (rec.publishToLeaderboard) {
      var prof = await getOrInitUserProfile();
      await db.collection('leaderboard_public').doc(uid).set({
        bestScore: rec.score,
        displayName: prof.displayName || 'ÁÑ°Âêç‰øÆÂ£´',
        country: prof.country || 'TW',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }
  }).catch(function(e){ console.warn('saveRunRecord Â§±ÊïóÔºö', e); });
}

// # ËÆÄÂèñÊàëÁöÑË≥áÊñôÔºàÂèØÂú® UI ‰∏äÈ°ØÁ§∫Áî®Ôºâ
async function loadMyRecentRuns(limitN) {
  if (!FIREBASE_ONLINE_ENABLED || !db) return [];
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return [];
  var qs = await db.collection('users').doc(u.uid).collection('runs').orderBy('createdAt','desc').limit(limitN||50).get();
  return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

async function loadMyStats() {
  if (!FIREBASE_ONLINE_ENABLED || !db) return { totalRuns: 0, bestScore: 0 };
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return { totalRuns: 0, bestScore: 0 };
  var doc = await db.collection('user_stats').doc(u.uid).get();
  return doc.exists ? doc.data() : { totalRuns: 0, bestScore: 0 };
}

async function loadLeaderboardTopN(n) {
  if (!FIREBASE_ONLINE_ENABLED || !db) return [];
  var qs = await db.collection('leaderboard_public').orderBy('bestScore','desc').limit(n||100).get();
  return qs.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
}

// # ‰ΩøÁî®ËÄÖ profile Ê™îÊ°à
async function getOrInitUserProfile() {
  if (!FIREBASE_ONLINE_ENABLED || !db) return { displayName: 'ÁÑ°Âêç‰øÆÂ£´', country: 'TW' };
  var u = auth && auth.currentUser ? auth.currentUser : await ensureSignedIn();
  if (!u) return { displayName: 'ÁÑ°Âêç‰øÆÂ£´', country: 'TW' };
  var ref = db.collection('users').doc(u.uid);
  var snap = await ref.get();
  if (snap.exists) return snap.data();
  var init = { displayName: u.displayName || 'ÁÑ°Âêç‰øÆÂ£´', createdAt: firebase.firestore.FieldValue.serverTimestamp(), avatarUrl: null, country: 'TW' };
  await ref.set(init, { merge: true });
  return init;
}

// # Êú¨Ê™îÂ∞çÊé•ÈªûÔºöÈÅäÊà≤ÁµêÊùüÊôÇÂëºÂè´ÔºàÂ∑≤Áî± showTrainingResult() ÂÖßÈÉ®Ê≥®ÂÖ•ÂëºÂè´Ôºâ
async function onGameFinished(payload) {
  try { await ensureSignedIn(); } catch (e) {}
  try { await saveRunRecord(payload); } catch (e) { console.warn(e); }
}

// # ‰∏ÄÊ¨°ÊÄßÈÅ∑ÁßªÔºöÊääÊó¢Êúâ localStorage ÁöÑÁ¥ÄÈåÑÔºàÂ¶Ç‰Ω†Êúâ‰øùÂ≠òÔºâ‰∏äÂÇ≥Âà∞Èõ≤Á´ØÔºàÂèØÈÅ∏Ôºâ
async function migrateLocalToCloud() {
  try { await ensureSignedIn(); } catch (e) {}
  // # Ëã•‰Ω†ÊúâËàäÊ†ºÂºèÔºåÂèØÂú®ÈÄôË£°ËÆÄÂèñ localStorage ÁöÑËàäÁ¥ÄÈåÑ key ‰∏¶ÈÄêÁ≠Ü saveRunRecord
  // # ÁõÆÂâçÊ≠§Â∞àÊ°àÁöÑ‰∏ªË≥áÊñôÂ∑≤Â≠òÊñº gameState / maxScoresÔºå‰∏çÂÅöÈ°çÂ§ñÈÅ∑Áßª‰ª•ÈÅøÂÖçÈáçË¶ÜÔºõÂ¶ÇÈúÄËá™Ë®ÇÔºåË´ãÂú®Ê≠§Êì¥ÂÖÖ„ÄÇ
}

// # ÂïüÂãïÊôÇÂòóË©¶ÁôªÂÖ•ÔºõËã•Èõ≤Á´ØÊú™ÂïüÁî®ÂâáÂÆâÈùúÁï•ÈÅé
document.addEventListener('DOMContentLoaded', function() {
  // È†ÅÈù¢ËºâÂÖ•ÂæåÂÖàÁ¢∫Ë™çÁôªÂÖ•ÁãÄÊÖãÔºåÂÜçÈÄ≤Ë°åË≥áÊñôÈÅ∑ÁßªËàá presence ÂàùÂßãÂåñ
  ensureSignedIn().then(function() {
    try { migrateLocalToCloud(); } catch(e){}
    // ÂàùÂßãÂåñ presence ‰ª•Áµ±Ë®àÁ∑ö‰∏ä‰∫∫Êï∏
    try { initPresence(); } catch(e){}
  });
});
</script>
<!-- ==================== /Firebase Á∑ö‰∏äÁâàÊï¥ÂêàÂçÄ ==================== -->
<!-- ==================== Supabase Êï¥ÂêàÂçÄ ==================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Supabase Ë®≠ÂÆö =====
// üö® Ë´ãÂ∞á‰ª•‰∏ãÂÖ©ÂÄãÂ∏∏Êï∏ÊõøÊèõÁÇ∫ÊÇ®Âú® Supabase Â∞àÊ°àË®≠ÂÆöÈ†ÅÂèñÂæóÁöÑ URL Ëàá ANON ÈáëÈë∞
const SUPABASE_URL = 'https://twwvcgcbmupsvtnixzmj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3d3ZjZ2NibXVwc3Z0bml4em1qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDAwNzgsImV4cCI6MjA3NjA3NjA3OH0.lCH_ht6jHJ7nf2yqOmLmoz441tMWv7b5Q6YRVDNkn_A';

// ÂÅúÁî® Firebase Áõ∏ÈóúËÆäÊï∏‰ª•ÈÅøÂÖçÁ®ãÂºèÁ¢ºÈåØË™§
window.FIREBASE_ONLINE_ENABLED = false;
window.db = null;
window.auth = null;

// ÊéßÂà∂ÊòØÂê¶ÂïüÁî®Èõ≤Á´ØÊ®°Âºè
window.ONLINE_ENABLED = true;

// ÂàùÂßãÂåñ Supabase Client
var supabaseClient = null;
// # Áî®ÊñºËøΩËπ§ÁõÆÂâçÁ∑ö‰∏ä‰∫∫Êï∏ÁöÑÂÖ®ÂüüËÆäÊï∏ÔºõÂ∞áÂú® presence ‰∫ã‰ª∂Ëß∏ÁôºÊôÇÊõ¥Êñ∞
var onlineUsersCount = 0;
try {
  if (ONLINE_ENABLED) {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
} catch (e) {
  console.warn('ÂàùÂßãÂåñ Supabase Â§±ÊïóÔºö', e);
  ONLINE_ENABLED = false;
}

async function ensureSignedIn() {
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) { console.warn('ÂèñÂæó Supabase ‰ΩøÁî®ËÄÖÂ§±ÊïóÔºö', error); return null; }
    return data.user || null;
  } catch (e) {
    console.warn('ensureSignedIn ÁôºÁîüÈåØË™§Ôºö', e);
    return null;
  }
}

async function upgradeToEmailPassword(email, password) {
  if (!ONLINE_ENABLED || !supabaseClient) return null;
  try {
    let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) {
      let { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({ email, password });
      if (signUpError) { console.warn('Ë®ªÂÜäÂ§±ÊïóÔºö', signUpError); return null; }
      return signUpData.user;
    }
    return data.user;
  } catch (e) {
    console.warn('Email/ÂØÜÁ¢ºÁôªÂÖ•Â§±Êïó', e);
    return null;
  }
}

function signOutOnline() {
  if (supabaseClient) {
    return supabaseClient.auth.signOut();
  }
}

async function loadMyStats() {
  if (!ONLINE_ENABLED || !supabaseClient) return { totalRuns: 0, bestScore: 0 };
  const user = await ensureSignedIn();
  if (!user) return { totalRuns: 0, bestScore: 0 };
  try {
    const { data, error } = await supabaseClient
      .from('user_stats')
      .select()
      .eq('id', user.id)
      .single();
    if (error && error.code !== 'PGRST116') {
      console.warn('ËÆÄÂèñ user_stats Â§±ÊïóÔºö', error);
      return { totalRuns: 0, bestScore: 0 };
    }
    return data || { totalRuns: 0, bestScore: 0 };
  } catch (e) {
    console.warn('loadMyStats ÁôºÁîüÈåØË™§Ôºö', e);
    return { totalRuns: 0, bestScore: 0 };
  }
}

async function loadLeaderboardTopN(n) {
  if (!ONLINE_ENABLED || !supabaseClient) return [];
  try {
    const { data, error } = await supabaseClient
      .from('leaderboard_public')
      .select()
      .order('bestScore', { ascending: false })
      .limit(n || 100);
    if (error) { console.warn('ËÆÄÂèñÊéíË°åÊ¶úÂ§±ÊïóÔºö', error); return []; }
    return (data || []).map(function(row) {
      return Object.assign({ id: row.id }, row);
    });
  } catch (e) {
    console.warn('loadLeaderboardTopN ÁôºÁîüÈåØË™§Ôºö', e);
    return [];
  }
}

// ==================== Presence ÂàùÂßãÂåñ ====================
// ‰ΩøÁî® Supabase Realtime Presence ÂäüËÉΩ‰æÜËøΩËπ§Áï∂ÂâçÁ∑ö‰∏ä‰∫∫Êï∏„ÄÇ
// ÈÄ≤ÂÖ• main menu ÊôÇÊúÉÂú® initPresence() ‰∏≠Ë®ÇÈñ± presence ‰∫ã‰ª∂„ÄÇ
async function initPresence() {
  // Âè™ÊúâÂú®ÂïüÁî®Èõ≤Á´ØÊ®°Âºè‰∏î supabaseClient ÂàùÂßãÂåñÊàêÂäüÊôÇÊâçÂïüÂãï presence„ÄÇ
  if (!ONLINE_ENABLED || !supabaseClient) return;
  try {
    // Á¢∫‰øù‰ΩøÁî®ËÄÖÁôªÂÖ•ÁãÄÊÖãÔºõËã•Êú™ÁôªÂÖ•ÂâáÊúÉÂõûÂÇ≥ null
    const user = await ensureSignedIn();
    // ‰ΩøÁî®ËÄÖË∫´‰ªΩ ID ‰ΩúÁÇ∫ presence keyÔºõËã•Êú™ÁôªÂÖ•ÂâáÈö®Ê©üÁî¢Áîü anon- ÈñãÈ†≠ÁöÑ key
    const presenceKey = (user && user.id) ? user.id : ('anon-' + Math.random().toString(36).substring(2, 10));
    // Âª∫Á´ãÂØ¶ÊôÇÈ†ªÈÅìÔºåÂïüÁî® presence Ë®≠ÂÆö
    const channel = supabaseClient.channel('online_users', {
      config: {
        presence: { key: presenceKey }
      }
    });
    // Âú® sync ‰∫ã‰ª∂ÊôÇÊõ¥Êñ∞Á∑ö‰∏ä‰∫∫Êï∏Áµ±Ë®à
    channel.on('presence', { event: 'sync' }, () => {
      try {
        const state = channel.presenceState();
        // presenceState ‰ª• key ÁÇ∫Á¥¢ÂºïÔºõÁ∑ö‰∏ä‰∫∫Êï∏Âç≥ÁÇ∫ÈçµÁöÑÊï∏Èáè
        onlineUsersCount = Object.keys(state).length;
        const countEl = document.getElementById('onlineUsersCount');
        if (countEl) {
          countEl.textContent = `üë• ÁõÆÂâçÁ∑ö‰∏ä‰∫∫Êï∏Ôºö${onlineUsersCount}`;
        }
      } catch (err) {
        console.warn('Êõ¥Êñ∞Á∑ö‰∏ä‰∫∫Êï∏Â§±Êïó', err);
      }
    });
    // Ë®ÇÈñ±È†ªÈÅì‰∏¶Âú®ÊàêÂäüË®ÇÈñ±ÂæåËøΩËπ§Ëá™Â∑±ÁöÑ presence
    await channel.subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        // track() ÁöÑ payload ÂèØÂåÖÂê´Ëá™Ë®ÇË≥áÊñôÔºåÊ≠§Ëôï‰∏çÈúÄË¶ÅÈ°çÂ§ñË≥áË®ä
        channel.track({});
      }
    });
  } catch (e) {
    console.warn('ÂàùÂßãÂåñ presence ÁôºÁîüÈåØË™§Ôºö', e);
  }
}

async function getOrInitUserProfile() {
  if (!ONLINE_ENABLED || !supabaseClient) return { displayName: 'ÁÑ°Âêç‰øÆÂ£´', country: 'TW' };
  const user = await ensureSignedIn();
  if (!user) return { displayName: 'ÁÑ°Âêç‰øÆÂ£´', country: 'TW' };
  const meta = user.user_metadata || {};
  return {
    displayName: meta.full_name || meta.displayName || user.email || 'ÁÑ°Âêç‰øÆÂ£´',
    country: meta.country || 'TW'
  };
}

async function saveRunRecord(rec) {
  if (!ONLINE_ENABLED || !supabaseClient) return;
  const user = await ensureSignedIn();
  if (!user) return;
  const uid = user.id;
  try {
    // ÂÑ≤Â≠òÈÅäÊà≤Á¥ÄÈåÑÂà∞ runs Ë°®ÔºõËã•‰∏çÂ≠òÂú®ÂèØÂøΩÁï•
    try {
      await supabaseClient.from('runs').insert([Object.assign({}, rec, {
        user_id: uid,
        createdAt: new Date().toISOString(),
        clientAt: new Date().toISOString(),
        appVersion: 'web-1.0.0'
      })]);
    } catch (_) {
      // runs Ë°®ÂèØËÉΩ‰∏çÂ≠òÂú®ÔºåÂøΩÁï•ÈåØË™§
    }
    // Êõ¥Êñ∞ user_stats
    let totalRuns = 0;
    let bestScore = rec.score || 0;
    try {
      const { data: statsRow, error } = await supabaseClient
        .from('user_stats')
        .select('totalRuns, bestScore')
        .eq('id', uid)
        .single();
      if (!error && statsRow) {
        totalRuns = (statsRow.totalRuns || 0) + 1;
        bestScore = Math.max(statsRow.bestScore || -1, rec.score || 0);
      } else {
        totalRuns = 1;
        bestScore = rec.score || 0;
      }
    } catch (_) {
      totalRuns = 1;
      bestScore = rec.score || 0;
    }
    await supabaseClient.from('user_stats').upsert({
      id: uid,
      totalRuns: totalRuns,
      bestScore: bestScore,
      lastPlayedAt: new Date().toISOString()
    });
    // ÁôºÂ∏ÉÂà∞ÊéíË°åÊ¶ú
    if (rec.publishToLeaderboard) {
      const prof = await getOrInitUserProfile();
      await supabaseClient.from('leaderboard_public').upsert({
        id: uid,
        bestScore: rec.score,
        displayName: prof.displayName || 'ÁÑ°Âêç‰øÆÂ£´',
        country: prof.country || 'TW',
        updatedAt: new Date().toISOString()
      });
    }
  } catch (e) {
    console.warn('saveRunRecord ÁôºÁîüÈåØË™§Ôºö', e);
  }
}

async function migrateLocalToCloud() {
  // Êö´‰∏çÂØ¶‰ΩúÔºõÂ¶ÇÈúÄÈÅ∑ÁßªÊú¨Ê©üË≥áÊñôÔºåË´ãÊñºÊ≠§Ë™øÁî® saveRunRecord()„ÄÇ
}

document.addEventListener('DOMContentLoaded', function() {
  ensureSignedIn().then(function(){ try { migrateLocalToCloud(); } catch(e){} });
});
</script>
<!-- ==================== /Supabase Êï¥ÂêàÂçÄ ==================== -->

</body>
</html>
